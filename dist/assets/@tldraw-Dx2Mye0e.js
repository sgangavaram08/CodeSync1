var da=Object.defineProperty;var ha=(n,t,e)=>t in n?da(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var u=(n,t,e)=>ha(n,typeof t!="symbol"?t+"":t,e);import{R as ht,r as M,j as S}from"./react-D4eHrszB.js";import{i as ua}from"./lodash.isequal-CWPzDpkQ.js";import{c as ve}from"./classnames-C5re8Ct7.js";import{c as pa,w as fa,p as ga}from"./@use-gesture-Bwv92teB.js";import{t as ma}from"./lodash.throttle-yuuEgjvB.js";import{_ as ya}from"./lodash.uniq-BHEsPF9E.js";import{e as Sa}from"./eventemitter3-D4IiiiOJ.js";import{c as xa,r as wa}from"./react-dom-BnvxbSMe.js";import{o as ba,d as Ia}from"./idb-Bn1DMRyg.js";import"./core-js-Dkw2Z0CP.js";function Bi(n){return n&&typeof n=="object"&&"parents"in n}function zi(n){for(let t=0,e=n.parents.length;t<e;t++)if(n.parents[t].__unsafe__getWithoutCapture(!0),n.parents[t].lastChangedEpoch!==n.parentEpochs[t])return!0;return!1}const qn=(n,t)=>{if(n.children.remove(t)&&n.children.isEmpty&&Bi(n))for(let e=0,s=n.parents.length;e<s;e++)qn(n.parents[e],n)},lr=(n,t)=>{if(n.children.add(t)&&Bi(n))for(let e=0,s=n.parents.length;e<s;e++)lr(n.parents[e],n)};function Ni(n,t){return n===t||Object.is(n,t)||!!(n&&t&&typeof n.equals=="function"&&n.equals(t))}function bt(n,t){const e=Symbol.for(`com.tldraw.state/${n}`),s=globalThis;return s[e]??(s[e]=t()),s[e]}const ut=bt("empty_array",()=>Object.freeze([])),Fr=8;class Wn{constructor(){u(this,"arraySize",0);u(this,"array",Array(Fr));u(this,"set",null)}get isEmpty(){if(this.array)return this.arraySize===0;if(this.set)return this.set.size===0;throw new Error("no set or array")}add(t){if(this.array)return this.array.indexOf(t)!==-1?!1:this.arraySize<Fr?(this.array[this.arraySize]=t,this.arraySize++,!0):(this.set=new Set(this.array),this.array=null,this.set.add(t),!0);if(this.set)return this.set.has(t)?!1:(this.set.add(t),!0);throw new Error("no set or array")}remove(t){if(this.array){const e=this.array.indexOf(t);return e===-1?!1:(this.array[e]=void 0,this.arraySize--,e!==this.arraySize&&(this.array[e]=this.array[this.arraySize],this.array[this.arraySize]=void 0),!0)}if(this.set)return this.set.has(t)?(this.set.delete(t),!0):!1;throw new Error("no set or array")}visit(t){if(this.array){for(let e=0;e<this.arraySize;e++){const s=this.array[e];typeof s<"u"&&t(s)}return}if(this.set){this.set.forEach(t);return}throw new Error("no set or array")}has(t){return this.array?this.array.indexOf(t)!==-1:this.set.has(t)}clear(){this.set?this.set.clear():(this.arraySize=0,this.array=[])}size(){return this.set?this.set.size:this.arraySize}}const Fe=Symbol.for("com.tldraw.state/RESET_VALUE");class Ui{constructor(t){u(this,"index",0);u(this,"buffer");this.capacity=t,this.buffer=new Array(t)}pushEntry(t,e,s){if(s!==void 0){if(s===Fe){this.clear();return}this.buffer[this.index]=[t,e,s],this.index=(this.index+1)%this.capacity}}clear(){this.index=0,this.buffer.fill(void 0)}getChangesSince(t){const{index:e,capacity:s,buffer:r}=this;for(let i=0;i<s;i++){const o=(e-1+s-i)%s,a=r[o];if(!a)return Fe;const[c,l]=a;if(i===0&&t>=l)return[];if(c<=t&&t<l){const d=i+1,h=new Array(d);for(let p=0;p<d;p++)h[p]=r[(o+p)%s][2];return h}}return Fe}}class Pa{constructor(t,e){u(this,"offset",0);u(this,"maybeRemoved");this.below=t,this.child=e}}const se=bt("capture",()=>({stack:null}));function $i(n){se.stack=new Pa(se.stack,n),n.parentSet.clear()}function Hi(){const n=se.stack;if(se.stack=n.below,n.offset<n.child.parents.length){for(let t=n.offset;t<n.child.parents.length;t++){const e=n.child.parents[t];n.child.parentSet.has(e)||qn(e,n.child)}n.child.parents.length=n.offset,n.child.parentEpochs.length=n.offset}if(n.maybeRemoved)for(let t=0;t<n.maybeRemoved.length;t++){const e=n.maybeRemoved[t];n.child.parentSet.has(e)||qn(e,n.child)}}function Vn(n){if(se.stack){if(se.stack.child.parentSet.has(n))return;if(se.stack.child.parentSet.add(n),se.stack.child.isActivelyListening&&lr(n,se.stack.child),se.stack.offset<se.stack.child.parents.length){const e=se.stack.child.parents[se.stack.offset];e!==n&&(se.stack.maybeRemoved?se.stack.maybeRemoved.push(e):se.stack.maybeRemoved=[e])}se.stack.child.parents[se.stack.offset]=n,se.stack.child.parentEpochs[se.stack.offset]=n.lastChangedEpoch,se.stack.offset++}}const Mt=-1;class va{constructor(t,e,s){u(this,"_isActivelyListening",!1);u(this,"lastTraversedEpoch",Mt);u(this,"lastReactedEpoch",Mt);u(this,"_scheduleCount",0);u(this,"parentSet",new Wn);u(this,"parentEpochs",[]);u(this,"parents",[]);u(this,"_scheduleEffect");u(this,"maybeExecute",()=>{this._isActivelyListening&&this.execute()});this.name=t,this.runEffect=e,this._scheduleEffect=s==null?void 0:s.scheduleEffect}get isActivelyListening(){return this._isActivelyListening}get scheduleCount(){return this._scheduleCount}maybeScheduleEffect(){if(this._isActivelyListening&&this.lastReactedEpoch!==be()){if(this.parents.length&&!zi(this)){this.lastReactedEpoch=be();return}this.scheduleEffect()}}scheduleEffect(){this._scheduleCount++,this._scheduleEffect?this._scheduleEffect(this.maybeExecute):this.execute()}attach(){this._isActivelyListening=!0;for(let t=0,e=this.parents.length;t<e;t++)lr(this.parents[t],this)}detach(){this._isActivelyListening=!1;for(let t=0,e=this.parents.length;t<e;t++)qn(this.parents[t],this)}execute(){try{$i(this);const t=this.runEffect(this.lastReactedEpoch);return this.lastReactedEpoch=be(),t}finally{Hi()}}}const nn=bt("EffectScheduler",()=>va);function ls(n,t,e){const s=new nn(n,t,e);return s.attach(),s.scheduleEffect(),()=>{s.detach()}}function Ca(n,t,e){const s=new nn(n,t,e);return{scheduler:s,start:r=>{const i=(r==null?void 0:r.force)??!1;s.attach(),i?s.scheduleEffect():s.maybeScheduleEffect()},stop:()=>{s.detach()}}}class _a{constructor(t){u(this,"initialAtomValues",new Map);this.parent=t}get isRoot(){return this.parent===null}commit(){if(this.isRoot){const t=this.initialAtomValues;this.initialAtomValues=new Map,Ki(t.keys())}else this.initialAtomValues.forEach((t,e)=>{this.parent.initialAtomValues.has(e)||this.parent.initialAtomValues.set(e,t)})}abort(){me.globalEpoch++,this.initialAtomValues.forEach((t,e)=>{var s;e.set(t),(s=e.historyBuffer)==null||s.clear()}),this.commit()}}const me=bt("transactions",()=>({globalEpoch:Mt+1,globalIsReacting:!1,currentTransaction:null}));function be(){return me.globalEpoch}function Ki(n){if(me.globalIsReacting)throw new Error("cannot change atoms during reaction cycle");try{me.globalIsReacting=!0;const t=new Set,e=s=>{s.lastTraversedEpoch!==me.globalEpoch&&(s.lastTraversedEpoch=me.globalEpoch,s instanceof nn?t.add(s):s.children.visit(e))};for(const s of n)s.children.visit(e);for(const s of t)s.maybeScheduleEffect()}finally{me.globalIsReacting=!1}}function Ea(n,t){me.currentTransaction?me.currentTransaction.initialAtomValues.has(n)||me.currentTransaction.initialAtomValues.set(n,t):Ki([n])}function Ta(){me.globalEpoch++}function ka(n){const t=new _a(me.currentTransaction);me.currentTransaction=t;try{let e=!1;const s=n(()=>e=!0);return e?t.abort():t.commit(),s}catch(e){throw t.abort(),e}finally{me.currentTransaction=me.currentTransaction.parent}}function Xe(n){return me.currentTransaction?n():ka(n)}class Ma{constructor(t,e,s){u(this,"isEqual");u(this,"computeDiff");u(this,"lastChangedEpoch",be());u(this,"children",new Wn);u(this,"historyBuffer");this.name=t,this.current=e,this.isEqual=(s==null?void 0:s.isEqual)??null,s&&(s.historyLength&&(this.historyBuffer=new Ui(s.historyLength)),this.computeDiff=s.computeDiff)}__unsafe__getWithoutCapture(t){return this.current}get(){return Vn(this),this.current}set(t,e){var r,i;if(((r=this.isEqual)==null?void 0:r.call(this,this.current,t))??Ni(this.current,t))return this.current;Ta(),this.historyBuffer&&this.historyBuffer.pushEntry(this.lastChangedEpoch,be(),e??((i=this.computeDiff)==null?void 0:i.call(this,this.current,t,this.lastChangedEpoch,be()))??Fe),this.lastChangedEpoch=be();const s=this.current;return this.current=t,Ea(this,s),t}update(t){return this.set(t(this.current))}getDiffSince(t){var e;return Vn(this),t>=this.lastChangedEpoch?ut:((e=this.historyBuffer)==null?void 0:e.getChangesSince(t))??Fe}}const Aa=bt("Atom",()=>Ma);function Te(n,t,e){return new Aa(n,t,e)}let Lr=!1;function Ra(){Lr||(Lr=!0,console.warn(`Using \`@computed\` as a decorator for getters is deprecated and will be removed in the near future. Please refactor to use \`@computed\` as a decorator for methods.

// Before
@computed
get foo() {
	return 'foo'
}

// After
@computed
getFoo() {
	return 'foo'
}
`))}const mn=Symbol.for("com.tldraw.state/UNINITIALIZED"),At=n=>n===mn,Vs=bt("WithDiff",()=>class{constructor(t,e){this.value=t,this.diff=e}});function yn(n,t){return new Vs(n,t)}class Da{constructor(t,e,s){u(this,"lastChangedEpoch",Mt);u(this,"lastTraversedEpoch",Mt);u(this,"lastCheckedEpoch",Mt);u(this,"parentSet",new Wn);u(this,"parents",[]);u(this,"parentEpochs",[]);u(this,"children",new Wn);u(this,"historyBuffer");u(this,"state",mn);u(this,"error",null);u(this,"computeDiff");u(this,"isEqual");this.name=t,this.derive=e,s!=null&&s.historyLength&&(this.historyBuffer=new Ui(s.historyLength)),this.computeDiff=s==null?void 0:s.computeDiff,this.isEqual=(s==null?void 0:s.isEqual)??Ni}get isActivelyListening(){return!this.children.isEmpty}__unsafe__getWithoutCapture(t){var s;if(!(this.lastChangedEpoch===Mt)&&(this.lastCheckedEpoch===be()||!zi(this)))if(this.lastCheckedEpoch=be(),this.error){if(t)return this.state;throw this.error.thrownValue}else return this.state;try{$i(this);const r=this.derive(this.state,this.lastCheckedEpoch),i=r instanceof Vs?r.value:r,o=this.state===mn;if(o||!this.isEqual(i,this.state)){if(this.historyBuffer&&!o){const a=r instanceof Vs?r.diff:void 0;this.historyBuffer.pushEntry(this.lastChangedEpoch,be(),a??((s=this.computeDiff)==null?void 0:s.call(this,this.state,i,this.lastCheckedEpoch,be()))??Fe)}this.lastChangedEpoch=be(),this.state=i}return this.error=null,this.lastCheckedEpoch=be(),this.state}catch(r){if(this.state!==mn&&(this.state=mn,this.lastChangedEpoch=be()),this.lastCheckedEpoch=be(),this.historyBuffer&&this.historyBuffer.clear(),this.error={thrownValue:r},!t)throw r;return this.state}finally{Hi()}}get(){try{return this.__unsafe__getWithoutCapture()}finally{Vn(this)}}getDiffSince(t){var e;return this.__unsafe__getWithoutCapture(!0),Vn(this),t>=this.lastChangedEpoch?ut:((e=this.historyBuffer)==null?void 0:e.getChangesSince(t))??Fe}}const dr=bt("Computed",()=>Da);function Oa(n={},t,e,s){const r=s.value,i=Symbol.for("__@tldraw/state__computed__"+e);return s.value=function(){let o=this[i];return o||(o=new dr(e,r.bind(this),n),Object.defineProperty(this,i,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s.value[Fa]=!0,s}function Br(n={},t,e,s){return s.get?(Ra(),ja(n,t,e,s)):Oa(n,t,e,s)}function ja(n={},t,e,s){const r=s.get,i=Symbol.for("__@tldraw/state__computed__"+e);return s.get=function(){let o=this[i];return o||(o=new dr(e,r.bind(this),n),Object.defineProperty(this,i,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s}const Fa="@@__isComputedMethod__@@";function T(){if(arguments.length===1){const n=arguments[0];return(t,e,s)=>Br(n,t,e,s)}else return typeof arguments[0]=="string"?new dr(arguments[0],arguments[1],arguments[2]):Br(void 0,arguments[0],arguments[1],arguments[2])}const Yi=1,La=bt("apiVersion",()=>Yi);if(La!==Yi)throw new Error("You have multiple incompatible versions of @tldraw/state in your app. Please deduplicate the package.");function ds(n,t){const e=ht.useRef(t);e.current=t;const[s,r,i]=ht.useMemo(()=>{let o=null;const a=d=>(o=d,()=>{o=null}),c=new nn(`useStateTracking(${n})`,()=>{var d;return(d=e.current)==null?void 0:d.call(e)},{scheduleEffect(){o==null||o()}});return[c,a,()=>c.scheduleCount]},[n]);return ht.useSyncExternalStore(r,i,i),ht.useEffect(()=>(s.attach(),s.maybeScheduleEffect(),()=>{s.detach()}),[s]),s.execute()}const zr={apply(n,t,e){return ds(n.displayName??n.name??"tracked(???)",()=>n.apply(t,e))}},Ba=Symbol.for("react.memo"),za=Symbol.for("react.forward_ref");function hs(n){let t=null;const e=n.$$typeof;return e===Ba&&(n=n.type,t=n.compare),e===za?M.memo(M.forwardRef(new Proxy(n.render,zr))):M.memo(new Proxy(n,zr),t)}function Na(){const n=arguments[0],t=arguments[1],e=arguments.length===3?void 0:arguments[2],s=arguments.length===3?arguments[2]:arguments[3];return M.useMemo(()=>T(`useComputed(${n})`,t,e),s)}function Rt(n,t,e=ut){M.useEffect(()=>{const s=new nn(n,t);return s.attach(),s.execute(),()=>{s.detach()}},e)}function z(){const n=arguments,t=n.length===3?n[2]:[n[0]],e=n.length===3?n[0]:`useValue(${n[0].name})`,s=M.useRef(!0);s.current=!0;const r=M.useMemo(()=>n.length===1?n[0]:T(e,()=>{if(s.current)return n[1]();try{return n[1]()}catch{return{}}}),t);try{const{subscribe:i,getSnapshot:o}=M.useMemo(()=>({subscribe:a=>ls(`useValue(${e})`,()=>{r.get(),a()}),getSnapshot:()=>r.get()}),[r]);return M.useSyncExternalStore(i,o,o)}finally{s.current=!1}}class Kn{constructor(t){u(this,"nextValue");u(this,"diff");this.previousValue=t}get(){var s,r,i,o;const t=((r=(s=this.diff)==null?void 0:s.removed)==null?void 0:r.size)??0,e=((o=(i=this.diff)==null?void 0:i.added)==null?void 0:o.size)??0;if(!(t===0&&e===0))return{value:this.nextValue,diff:this.diff}}_add(t,e){var s,r;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.add(t),this.diff??(this.diff={}),e?(s=this.diff.removed)==null||s.delete(t):((r=this.diff).added??(r.added=new Set),this.diff.added.add(t))}add(t){var r,i,o;const e=this.previousValue.has(t);if(e)return((i=(r=this.diff)==null?void 0:r.removed)==null?void 0:i.has(t))?this._add(t,e):void 0;(o=this.nextValue)!=null&&o.has(t)||this._add(t,e)}_remove(t,e){var s,r;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.delete(t),this.diff??(this.diff={}),e?((s=this.diff).removed??(s.removed=new Set),this.diff.removed.add(t)):(r=this.diff.added)==null||r.delete(t)}remove(t){var r,i,o,a;const e=this.previousValue.has(t);if(!e)return((i=(r=this.diff)==null?void 0:r.added)==null?void 0:i.has(t))?this._remove(t,e):void 0;(a=(o=this.diff)==null?void 0:o.removed)!=null&&a.has(t)||this._remove(t,e)}}function Zn(n,t){const e=[];e:for(const s of n){for(const r of e)if(t?t(s,r):s===r)continue e;e.push(s)}return e}function G(n){return n.filter(t=>t!=null)}function Jp(n){return n[n.length-1]}function ef(n,t){let e,s=1/0;for(const r of n){const i=t(r);i<s&&(e=r,s=i)}return e}function Ua(n,t){if(n===t)return!0;if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!Object.is(n[e],t[e]))return!1;return!0}function tf(n,t){let e,s;return function(...r){return e||(e=!0,setTimeout(()=>e=!1,t),s=n(...r)),s}}function Xi(n){const t=(...e)=>{try{return n(...e)}catch(s){throw s instanceof Error&&Error.captureStackTrace&&Error.captureStackTrace(s,t),s}};return t}const Qt={ok(n){return{ok:!0,value:n}},err(n){return{ok:!1,error:n}}};function us(n,t){const e=t&&n&&typeof n=="object"&&t in n?n[t]:n;throw new Error(`Unknown switch case ${e}`)}const ke=Xi((n,t)=>{if(!n)throw new Error(t||"Assertion Error")}),Gt=Xi((n,t)=>{if(n==null)throw new Error(t??"value must be defined");return n});function $a(n,t){let e;const s=(...r)=>(e||(e={},e.promise=new Promise((i,o)=>{e.resolve=i,e.reject=o})),clearTimeout(e.timeout),e.latestArgs=r,e.timeout=setTimeout(()=>{const i=e;e=void 0;try{i.resolve(n(...i.latestArgs))}catch(o){i.reject(o)}},t),e.promise);return s.cancel=()=>{e&&clearTimeout(e.timeout)},s}const Nr=new WeakMap;function hr(n,t){if(typeof n!="object"||n===null)return;let e=Nr.get(n);e||(e={tags:{},extras:{}},Nr.set(n,e)),t.tags&&(e.tags={...e.tags,...t.tags}),t.extras&&(e.extras={...e.extras,...t.extras})}class nf{static async dataUrlToArrayBuffer(t){return fetch(t).then(function(e){return e.arrayBuffer()})}static async blobToDataUrl(t){return await new Promise((e,s)=>{if(t){const r=new FileReader;r.onload=()=>e(r.result),r.onerror=i=>s(i),r.onabort=i=>s(i),r.readAsDataURL(t)}})}static async blobToText(t){return await new Promise((e,s)=>{if(t){const r=new FileReader;r.onload=()=>e(r.result),r.onerror=i=>s(i),r.onabort=i=>s(i),r.readAsText(t)}})}}function sf(n){let t=0;for(let e=0;e<n.length;e++)t=(t<<5)-t+n.charCodeAt(e),t|=0;return t+""}function rf(n){const t=new DataView(n);let e=0;for(let s=0;s<t.byteLength;s++)e=(e<<5)-e+t.getUint8(s),e|=0;return e+""}let Zs=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(Zs=new Int32Array(Zs));const Ha=(n,t)=>{let e=-1;for(let s=0;s<n.length;s++)e=Zs[(e^n[s])&255]^e>>>8;return e^-1},Ur=4,$r=4;class dt{static isPng(t,e){return t.getUint8(e+0)===137&&t.getUint8(e+1)===80&&t.getUint8(e+2)===78&&t.getUint8(e+3)===71&&t.getUint8(e+4)===13&&t.getUint8(e+5)===10&&t.getUint8(e+6)===26&&t.getUint8(e+7)===10}static getChunkType(t,e){return[String.fromCharCode(t.getUint8(e)),String.fromCharCode(t.getUint8(e+1)),String.fromCharCode(t.getUint8(e+2)),String.fromCharCode(t.getUint8(e+3))].join("")}static readChunks(t,e=0){const s={};if(!dt.isPng(t,e))throw new Error("Not a PNG");for(e+=8;e<=t.buffer.byteLength;){const r=e,i=t.getInt32(e);e+=4;const o=dt.getChunkType(t,e);if(o==="IDAT"&&s[o]){e+=i+Ur+$r;continue}if(o==="IEND")break;s[o]={start:r,dataOffset:e+4,size:i},e+=i+Ur+$r}return s}static parsePhys(t,e){return{ppux:t.getUint32(e),ppuy:t.getUint32(e+4),unit:t.getUint8(e+4)}}static findChunk(t,e){return dt.readChunks(t)[e]}static setPhysChunk(t,e=1,s){let r=46,i=0;const o=dt.findChunk(t,"pHYs");o&&(r=o.start,i=o.size);const a=dt.findChunk(t,"IDAT");a&&(r=a.start,i=0);const c=new ArrayBuffer(21),l=new DataView(c);l.setUint32(0,9),l.setUint8(4,112),l.setUint8(5,72),l.setUint8(6,89),l.setUint8(7,115);const d=2835.5;l.setInt32(8,d*e),l.setInt32(12,d*e),l.setInt8(16,1);const h=new Uint8Array(c.slice(4,17));l.setInt32(17,Ha(h));const p=t.buffer.slice(0,r),f=t.buffer.slice(r+i);return new Blob([p,c,f],s)}}class Sn{static loadVideo(t){return new Promise((e,s)=>{const r=document.createElement("video");r.onloadeddata=()=>e(r),r.onerror=i=>{console.error(i),s(new Error("Could not load video"))},r.crossOrigin="anonymous",r.src=t})}static loadImage(t){return new Promise((e,s)=>{const r=new Image;r.onload=()=>e(r),r.onerror=i=>{console.error(i),s(new Error("Could not load image"))},r.crossOrigin="anonymous",r.src=t})}static async getVideoSize(t){return Sn.usingObjectURL(t,async e=>{const s=await Sn.loadVideo(e);return{w:s.videoWidth,h:s.videoHeight}})}static async getImageSize(t){const e=await Sn.usingObjectURL(t,Sn.loadImage);try{if(t.type==="image/png"){const s=new DataView(await t.arrayBuffer());if(dt.isPng(s,0)){const r=dt.findChunk(s,"pHYs");if(r){const i=dt.parsePhys(s,r.dataOffset);if(i.unit===0&&i.ppux===i.ppuy){const o=Math.max(i.ppux/2834.5,1);return{w:Math.round(e.naturalWidth/o),h:Math.round(e.naturalHeight/o)}}}}}}catch(s){return console.error(s),{w:e.naturalWidth,h:e.naturalHeight}}return{w:e.naturalWidth,h:e.naturalHeight}}static async usingObjectURL(t,e){const s=URL.createObjectURL(t);try{return await e(s)}finally{URL.revokeObjectURL(s)}}}function of(n=""){let t=0,e=0,s=0,r=0;function i(){const o=t^t<<11;return t=e,e=s,s=r,r^=(r>>>19^o^o>>>8)>>>0,r/4294967296*2}for(let o=0;o<n.length+64;o++)t^=n.charCodeAt(o)|0,i();return i}function Qn(n,t,e,s=!1){const[r,i]=t,[o,a]=e,c=o+(n-r)/(i-r)*(a-o);return s?o<a?Math.max(Math.min(c,a),o):Math.max(Math.min(c,o),a):c}function Je(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function We(n,t){if(Je(n,t))return n[t]}function Hr(n){return Object.keys(n)}function oe(n){return Object.values(n)}function Ve(n){return Object.entries(n)}function ur(n){return Object.fromEntries(n)}function As(n,t){const e={};let s=!1;for(const[r,i]of Ve(n))t(r,i)?e[r]=i:s=!0;return s?e:n}function Gi(n,t){const e={};for(const[s,r]of Ve(n)){const i=t(s,r);e[s]=i}return e}function qi(n,t){if(n===t)return!0;const e=new Set(Object.keys(n)),s=new Set(Object.keys(t));if(e.size!==s.size)return!1;for(const r of e)if(!s.has(r)||!Object.is(n[r],t[r]))return!1;return!0}const je="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",Wi="a0",Vi="A00000000000000000000000000";function Zi(n){if(n>="a"&&n<="z")return n.charCodeAt(0)-97+2;if(n>="A"&&n<="Z")return 90-n.charCodeAt(0)+2;throw new Error("Invalid index key head: "+n)}function Qi(n){if(n.length!==Zi(n.charAt(0)))throw new Error("invalid integer part of index key: "+n)}function Kr(n){if(n===void 0)throw Error("n is undefined")}function Yr(n){Qi(n);const[t,...e]=n.split("");let s=!0;for(let r=e.length-1;s&&r>=0;r--){const i=je.indexOf(e[r])+1;i===je.length?e[r]="0":(e[r]=je.charAt(i),s=!1)}if(s){if(t==="Z")return"a0";if(t==="z")return;const r=String.fromCharCode(t.charCodeAt(0)+1);return r>"a"?e.push("0"):e.pop(),r+e.join("")}else return t+e.join("")}function Ka(n){Qi(n);const[t,...e]=n.split("");let s=!0;for(let r=e.length-1;s&&r>=0;r--){const i=je.indexOf(e[r])-1;i===-1?e[r]=je.slice(-1):(e[r]=je.charAt(i),s=!1)}if(s){if(t==="a")return"Z"+je.slice(-1);if(t==="A")return;const r=String.fromCharCode(t.charCodeAt(0)-1);return r<"Z"?e.push(je.slice(-1)):e.pop(),r+e.join("")}else return t+e.join("")}function qt(n,t){if(t!==void 0&&n>=t)throw new Error(n+" >= "+t);if(n.slice(-1)==="0"||t&&t.slice(-1)==="0")throw new Error("trailing zero");if(t){let r=0;for(;(n.charAt(r)||"0")===t.charAt(r);)r++;if(r>0)return t.slice(0,r)+qt(n.slice(r),t.slice(r))}const e=n?je.indexOf(n.charAt(0)):0,s=t!==void 0?je.indexOf(t.charAt(0)):je.length;if(s-e>1){const r=Math.round(.5*(e+s));return je.charAt(r)}else return t&&t.length>1?t.slice(0,1):je.charAt(e)+qt(n.slice(1),void 0)}function xn(n){const t=Zi(n.charAt(0));if(t>n.length)throw new Error("invalid index: "+n);return n.slice(0,t)}function Qs(n){if(n===Vi)throw new Error("invalid index: "+n);const t=xn(n);if(n.slice(t.length).slice(-1)==="0")throw new Error("invalid index: "+n)}function Bt(n,t){if(n!==void 0&&Qs(n),t!==void 0&&Qs(t),n!==void 0&&t!==void 0&&n>=t)throw new Error(n+" >= "+t);if(n===void 0&&t===void 0)return Wi;if(n===void 0){if(t===void 0)throw Error("b is undefined");const a=xn(t),c=t.slice(a.length);if(a===Vi)return a+qt("",c);if(a<t)return a;const l=Ka(a);return Kr(l),l}if(t===void 0){const a=xn(n),c=n.slice(a.length),l=Yr(a);return l===void 0?a+qt(c,void 0):l}const e=xn(n),s=n.slice(e.length),r=xn(t),i=t.slice(r.length);if(e===r)return e+qt(s,i);const o=Yr(e);return Kr(o),o<t?o:e+qt(s,void 0)}function xt(n,t,e){if(e===0)return[];if(e===1)return[Bt(n,t)];if(t===void 0){let i=Bt(n,t);const o=[i];for(let a=0;a<e-1;a++)i=Bt(i,t),o.push(i);return o}if(n===void 0){let i=Bt(n,t);const o=[i];for(let a=0;a<e-1;a++)i=Bt(n,i),o.push(i);return o.reverse(),o}const s=Math.floor(e/2),r=Bt(n,t);return[...xt(n,r,s),r,...xt(r,t,e-s-1)]}const af=Wi;function Ya(n){Qs(n)}function tn(n,t,e){return xt(n,t,e)}function Rs(n,t){return xt(n,void 0,t)}function Ds(n,t){return xt(n,t,1)[0]}function zt(n){return xt(n,void 0,1)[0]}function cf(n){return xt(void 0,n,1)[0]}function Js(n,t="a1"){return[t,...xt(t,void 0,n)]}function ze(n,t){return n.index<t.index?-1:n.index>t.index?1:0}function Xa(n,t){return n.id>t.id?1:-1}function Ji(n){try{return localStorage.getItem(n)}catch{return null}}function eo(n,t){try{localStorage.setItem(n,t)}catch{}}function Ga(){try{localStorage.clear()}catch{}}function to(n){try{return sessionStorage.getItem(n)}catch{return null}}function pr(n,t){try{sessionStorage.setItem(n,t)}catch{}}function no(n){try{sessionStorage.removeItem(n)}catch{}}function qa(){try{sessionStorage.clear()}catch{}}const Wt=[],Wa=60,Yn=Math.ceil(1e3/Wa);let ln,Os=0,er=0;const Va=()=>{const n=Wt.splice(0,Wt.length);for(const t of n)t()};function so(){if(ln)return;const n=Date.now(),t=n-er;if(Os+t<Yn){ln=requestAnimationFrame(()=>{ln=void 0,so()});return}ln=requestAnimationFrame(()=>{ln=void 0,er=n,Os=Math.min(Os+t-Yn,Yn*10),Va()})}let Xr=!1;function ro(n){return Wt.includes(n)||(Wt.push(n),Xr||(Xr=!0,er=Date.now()-Yn-1),so()),()=>{const t=Wt.indexOf(n);t>-1&&Wt.splice(t,1)}}function lf(n){return n!==null}function Za(){return typeof globalThis<"u"&&globalThis.structuredClone?[globalThis.structuredClone,!0]:typeof global<"u"&&global.structuredClone?[global.structuredClone,!0]:typeof window<"u"&&window.structuredClone?[window.structuredClone,!0]:[n=>n&&JSON.parse(JSON.stringify(n)),!1]}const io=Za(),he=io[0];io[1];const Qa=Object.getPrototypeOf(he({}));let oo=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((t,e)=>(e&=63,e<36?t+=e.toString(36):e<62?t+=(e-26).toString(36).toUpperCase():e>62?t+="-":t+="_",t),"");class fr{constructor(t,e){u(this,"createDefaultProperties");u(this,"validator");u(this,"scope");u(this,"isInstance",t=>(t==null?void 0:t.typeName)===this.typeName);this.typeName=t,this.createDefaultProperties=e.createDefaultProperties,this.validator=e.validator??{validate:s=>s},this.scope=e.scope??"document"}create(t){const e={...this.createDefaultProperties(),id:this.createId()};for(const[s,r]of Object.entries(t))r!==void 0&&(e[s]=r);return e.typeName=this.typeName,e}clone(t){return{...he(t),id:this.createId()}}createId(t){return this.typeName+":"+(t??oo())}createCustomId(t){return this.typeName+":"+t}parseId(t){if(!this.isId(t))throw new Error(`ID "${t}" is not a valid ID for type "${this.typeName}"`);return t.slice(this.typeName.length+1)}isId(t){if(!t)return!1;for(let e=0;e<this.typeName.length;e++)if(t[e]!==this.typeName[e])return!1;return t[this.typeName.length]===":"}withDefaultProperties(t){return new fr(this.typeName,{createDefaultProperties:t,validator:this.validator,scope:this.scope})}validate(t,e){return e&&this.validator.validateUsingKnownGoodVersion?this.validator.validateUsingKnownGoodVersion(e,t):this.validator.validate(t)}}function pt(n,t){return new fr(n,{createDefaultProperties:()=>({}),validator:t.validator,scope:t.scope})}class Gr{constructor(){u(this,"items",new WeakMap)}get(t,e){return this.items.has(t)||this.items.set(t,e(t)),this.items.get(t)}}function Ja(n){if(n.length===0)return new Set;const t=n[0],e=n.slice(1),s=new Set;for(const r of t)e.every(i=>i.has(r))&&s.add(r);return s}function ec(n,t){const e={};for(const s of t)n.has(s)||(e.added??(e.added=new Set),e.added.add(s));for(const s of n)t.has(s)||(e.removed??(e.removed=new Set),e.removed.add(s));return e.added||e.removed?e:void 0}function qr(n,t){for(const[e,s]of Object.entries(n)){const r=s,i=t[e];if("eq"in r&&i!==r.eq||"neq"in r&&i===r.neq||"gt"in r&&(typeof i!="number"||i<=r.gt))return!1}return!0}function Wr(n,t,e){const s=Object.fromEntries(Object.keys(e).map(r=>[r,new Set]));for(const[r,i]of Object.entries(e))if("eq"in i){const a=n.index(t,r).get().get(i.eq);if(a)for(const c of a)s[r].add(c)}else if("neq"in i){const o=n.index(t,r);for(const[a,c]of o.get())if(a!==i.neq)for(const l of c)s[r].add(l)}else if("gt"in i){const o=n.index(t,r);for(const[a,c]of o.get())if(a>i.gt)for(const l of c)s[r].add(l)}return Ja(Object.values(s))}class tc{constructor(t,e){u(this,"indexCache",new Map);u(this,"historyCache",new Map);this.atoms=t,this.history=e}filterHistory(t){if(this.historyCache.has(t))return this.historyCache.get(t);const e=T("filterHistory:"+t,(s,r)=>{if(At(s))return this.history.get();const i=this.history.getDiffSince(r);if(i===Fe)return this.history.get();const o={added:{},removed:{},updated:{}};let a=0,c=0,l=0;for(const d of i){for(const h of oe(d.added))if(h.typeName===t)if(o.removed[h.id]){const p=o.removed[h.id];delete o.removed[h.id],c--,p!==h&&(o.updated[h.id]=[p,h],l++)}else o.added[h.id]=h,a++;for(const[h,p]of oe(d.updated))p.typeName===t&&(o.added[p.id]?o.added[p.id]=p:o.updated[p.id]?o.updated[p.id]=[o.updated[p.id][0],p]:(o.updated[p.id]=[h,p],l++));for(const h of oe(d.removed))h.typeName===t&&(o.added[h.id]?(delete o.added[h.id],a--):o.updated[h.id]?(o.removed[h.id]=o.updated[h.id][0],delete o.updated[h.id],l--,c++):(o.removed[h.id]=h,c++))}return a||c||l?yn(this.history.get(),o):s},{historyLength:100});return this.historyCache.set(t,e),e}index(t,e){const s=t+":"+e;if(this.indexCache.has(s))return this.indexCache.get(s);const r=this.__uncached_createIndex(t,e);return this.indexCache.set(s,r),r}__uncached_createIndex(t,e){const s=this.filterHistory(t),r=()=>{s.get();const i=new Map;for(const o of oe(this.atoms.get())){const a=o.get();if(a.typeName===t){const c=a[e];i.has(c)||i.set(c,new Set),i.get(c).add(a.id)}}return i};return T("index:"+t+":"+e,(i,o)=>{if(At(i))return r();const a=s.getDiffSince(o);if(a===Fe)return r();const c=new Map,l=(f,y)=>{let g=c.get(f);g||(g=new Kn(i.get(f)??new Set)),g.add(y),c.set(f,g)},d=(f,y)=>{let g=c.get(f);g||(g=new Kn(i.get(f)??new Set)),g.remove(y),c.set(f,g)};for(const f of a){for(const y of oe(f.added))if(y.typeName===t){const g=y[e];l(g,y.id)}for(const[y,g]of oe(f.updated))if(g.typeName===t){const x=y[e],w=g[e];x!==w&&(d(x,g.id),l(w,g.id))}for(const y of oe(f.removed))if(y.typeName===t){const g=y[e];d(g,y.id)}}let h,p;for(const[f,y]of c){const g=y.get();g&&(h||(h=new Map(i)),p||(p=new Map),g.value.size===0?h.delete(f):h.set(f,g.value),p.set(f,g.diff))}return h&&p?yn(h,p):i},{historyLength:100})}record(t,e=()=>({}),s="record:"+t+(e?":"+e.toString():"")){const r=this.ids(t,e,s);return T(s,()=>{var i;for(const o of r.get())return(i=this.atoms.get()[o])==null?void 0:i.get()})}records(t,e=()=>({}),s="records:"+t+(e?":"+e.toString():"")){const r=this.ids(t,e,"ids:"+s);return T(s,()=>[...r.get()].map(i=>{const o=this.atoms.get()[i];if(!o)throw new Error("no atom found for record id: "+i);return o.get()}))}ids(t,e=()=>({}),s="ids:"+t+(e?":"+e.toString():"")){const r=this.filterHistory(t),i=()=>{r.get();const c=e();return Object.keys(c).length===0?new Set(oe(this.atoms.get()).flatMap(l=>{const d=l.get();return d.typeName===t?d.id:[]})):Wr(this,t,c)},o=c=>{const l=i(),d=ec(c,l);return d?yn(l,d):c},a=T("ids_query:"+s,e,{isEqual:ua});return T("query:"+s,(c,l)=>{const d=a.get();if(At(c))return i();if(l<a.lastChangedEpoch)return o(c);const h=r.getDiffSince(l);if(h===Fe)return o(c);const p=new Kn(c);for(const y of h){for(const g of oe(y.added))g.typeName===t&&qr(d,g)&&p.add(g.id);for(const[g,x]of oe(y.updated))x.typeName===t&&(qr(d,x)?p.add(x.id):p.remove(x.id));for(const g of oe(y.removed))g.typeName===t&&p.remove(g.id)}const f=p.get();return f?yn(f.value,f.diff):c},{historyLength:50})}exec(t,e){const s=Wr(this,t,e);if(s.size===0)return ut;const r=this.atoms.get();return[...s].map(i=>r[i].get())}}class ao{constructor(t){u(this,"id",oo());u(this,"atoms",Te("store_atoms",{}));u(this,"history",Te("history",0,{historyLength:1e3}));u(this,"query",new tc(this.atoms,this.history));u(this,"listeners",new Set);u(this,"historyAccumulator",new sc);u(this,"historyReactor");u(this,"schema");u(this,"props");u(this,"scopedTypes");u(this,"onBeforeCreate");u(this,"onAfterCreate");u(this,"onBeforeChange");u(this,"onAfterChange");u(this,"onBeforeDelete");u(this,"onAfterDelete");u(this,"_runCallbacks",!0);u(this,"put",(t,e)=>{Xe(()=>{const s={},r={},i=this.atoms.__unsafe__getWithoutCapture();let o=null,a,c=!1;const l=this.onBeforeCreate&&this._runCallbacks?this.onBeforeCreate:null,d=this.onBeforeChange&&this._runCallbacks?this.onBeforeChange:null,h=this.isMergingRemoteChanges?"remote":"user";for(let p=0,f=t.length;p<f;p++){a=t[p];const y=(o??i)[a.id];if(y){const g=y.__unsafe__getWithoutCapture();if(d&&(a=d(g,a,h)),this.schema.validateRecord(this,a,e??"updateRecord",g)===g)continue;y.set(a),c=!0,s[a.id]=[g,y.__unsafe__getWithoutCapture()]}else l&&(a=l(a,h)),c=!0,a=this.schema.validateRecord(this,a,e??"createRecord",null),r[a.id]=a,o||(o={...i}),o[a.id]=Te("atom:"+a.id,a)}if(o&&this.atoms.set(o),!!c&&(this.updateHistory({added:r,updated:s,removed:{}}),this._runCallbacks)){const{onAfterCreate:p,onAfterChange:f}=this;p&&Object.values(r).forEach(y=>{p(y,h)}),f&&Object.values(s).forEach(([y,g])=>{f(y,g,h)})}})});u(this,"remove",t=>{Xe(()=>{const e=[],s=this.isMergingRemoteChanges?"remote":"user";if(this.onBeforeDelete&&this._runCallbacks)for(const i of t){const o=this.atoms.__unsafe__getWithoutCapture()[i];o&&this.onBeforeDelete(o.get(),s)===!1&&e.push(i)}let r;if(this.atoms.update(i=>{let o;for(const a of t)e.includes(a)||a in i&&(o||(o={...i}),r||(r={}),delete o[a],r[a]=i[a].get());return o??i}),!!r&&(this.updateHistory({added:{},updated:{},removed:r}),this.onAfterDelete&&this._runCallbacks)){let i;for(let o=0,a=t.length;o<a;o++)i=r[t[o]],i&&this.onAfterDelete(i,s)}})});u(this,"get",t=>{var e;return(e=this.atoms.get()[t])==null?void 0:e.get()});u(this,"unsafeGetWithoutCapture",t=>{var e;return(e=this.atoms.get()[t])==null?void 0:e.__unsafe__getWithoutCapture()});u(this,"serialize",(t="document")=>{const e={};for(const[s,r]of Ve(this.atoms.get())){const i=r.get();(t==="all"||this.scopedTypes[t].has(i.typeName))&&(e[s]=i)}return e});u(this,"allRecords",()=>oe(this.atoms.get()).map(t=>t.get()));u(this,"clear",()=>{this.remove(Hr(this.atoms.get()))});u(this,"update",(t,e)=>{const s=this.atoms.get()[t];if(!s){console.error(`Record ${t} not found. This is probably an error`);return}this.put([e(s.__unsafe__getWithoutCapture())])});u(this,"has",t=>!!this.atoms.get()[t]);u(this,"listen",(t,e)=>{this._flushHistory();const s={onHistory:t,filters:{source:(e==null?void 0:e.source)??"all",scope:(e==null?void 0:e.scope)??"all"}};return this.listeners.add(s),this.historyReactor.scheduler.isActivelyListening||this.historyReactor.start(),()=>{this.listeners.delete(s),this.listeners.size===0&&this.historyReactor.stop()}});u(this,"isMergingRemoteChanges",!1);u(this,"mergeRemoteChanges",t=>{if(this.isMergingRemoteChanges)return t();try{this.isMergingRemoteChanges=!0,Xe(t)}finally{this.isMergingRemoteChanges=!1}});u(this,"createComputedCache",(t,e,s)=>{const r=new Gr;return{get:i=>{const o=this.atoms.get()[i];if(o)return r.get(o,()=>{const a=s?T(o.name+":equals",()=>o.get(),{isEqual:s}):o;return T(t+":"+i,()=>e(a.get()))}).get()}}});u(this,"createSelectedComputedCache",(t,e,s)=>{const r=new Gr;return{get:i=>{const o=this.atoms.get()[i];if(!o)return;const a=T(t+":"+i+":selector",()=>e(o.get()));return r.get(o,()=>T(t+":"+i,()=>s(a.get()))).get()}}});u(this,"getRecordType",t=>{const e=this.schema.types[t.typeName];if(!e)throw new Error(`Record type ${t.typeName} not found`);return e});u(this,"_integrityChecker");u(this,"_isPossiblyCorrupted",!1);const{initialData:e,schema:s}=t;this.schema=s,this.props=t.props,e&&this.atoms.set(ur(Ve(e).map(([r,i])=>[r,Te("atom:"+r,this.schema.validateRecord(this,i,"initialize",null))]))),this.historyReactor=Ca("Store.historyReactor",()=>{this.history.get(),this._flushHistory()},{scheduleEffect:r=>ro(r)}),this.scopedTypes={document:new Set(oe(this.schema.types).filter(r=>r.scope==="document").map(r=>r.typeName)),session:new Set(oe(this.schema.types).filter(r=>r.scope==="session").map(r=>r.typeName)),presence:new Set(oe(this.schema.types).filter(r=>r.scope==="presence").map(r=>r.typeName))}}_flushHistory(){if(this.historyAccumulator.hasChanges()){const t=this.historyAccumulator.flush();for(const{changes:e,source:s}of t){let r=null,i=null,o=null;for(const{onHistory:a,filters:c}of this.listeners)if(!(c.source!=="all"&&c.source!==s))if(c.scope!=="all")if(c.scope==="document"){if(i??(i=this.filterChangesByScope(e,"document")),!i)continue;a({changes:i,source:s})}else if(c.scope==="session"){if(r??(r=this.filterChangesByScope(e,"session")),!r)continue;a({changes:r,source:s})}else{if(o??(o=this.filterChangesByScope(e,"presence")),!o)continue;a({changes:o,source:s})}else a({changes:e,source:s})}}}filterChangesByScope(t,e){const s={added:As(t.added,(r,i)=>this.scopedTypes[e].has(i.typeName)),updated:As(t.updated,(r,i)=>this.scopedTypes[e].has(i[1].typeName)),removed:As(t.removed,(r,i)=>this.scopedTypes[e].has(i.typeName))};return Object.keys(s.added).length===0&&Object.keys(s.updated).length===0&&Object.keys(s.removed).length===0?null:s}updateHistory(t){this.historyAccumulator.add({changes:t,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.get()+1,t)}validate(t){this.allRecords().forEach(e=>this.schema.validateRecord(this,e,t,null))}getSnapshot(t="document"){return{store:this.serialize(t),schema:this.schema.serialize()}}migrateSnapshot(t){const e=this.schema.migrateStoreSnapshot(t);if(e.type==="error")throw new Error(`Failed to migrate snapshot: ${e.reason}`);return{store:e.value,schema:this.schema.serialize()}}loadSnapshot(t){const e=this.schema.migrateStoreSnapshot(t);if(e.type==="error")throw new Error(`Failed to migrate snapshot: ${e.reason}`);const s=this._runCallbacks;try{this._runCallbacks=!1,Xe(()=>{this.clear(),this.put(Object.values(e.value)),this.ensureStoreIsUsable()})}finally{this._runCallbacks=s}}extractingChanges(t){const e=[],s=this.historyAccumulator.intercepting(r=>e.push(r.changes));try{return Xe(t),ps(e)}finally{s()}}applyDiff(t,e=!0){const s=this._runCallbacks;try{this._runCallbacks=e,Xe(()=>{const r=oe(t.added).concat(oe(t.updated).map(([o,a])=>a)),i=Hr(t.removed);r.length&&this.put(r),i.length&&this.remove(i)})}finally{this._runCallbacks=s}}ensureStoreIsUsable(){var t;this._integrityChecker??(this._integrityChecker=this.schema.createIntegrityChecker(this)),(t=this._integrityChecker)==null||t.call(this)}markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}}function ps(n){const t={added:{},removed:{},updated:{}};for(const e of n){for(const[s,r]of Ve(e.added))if(t.removed[s]){const i=t.removed[s];delete t.removed[s],i!==r&&(t.updated[s]=[i,r])}else t.added[s]=r;for(const[s,[r,i]]of Ve(e.updated)){if(t.added[s]){t.added[s]=i,delete t.updated[s],delete t.removed[s];continue}if(t.updated[s]){t.updated[s]=[t.updated[s][0],i],delete t.removed[s];continue}t.updated[s]=e.updated[s],delete t.removed[s]}for(const[s,r]of Ve(e.removed))t.added[s]?delete t.added[s]:t.updated[s]?(t.removed[s]=t.updated[s][0],delete t.updated[s]):t.removed[s]=r}return t}function nc(n){if(n.length===0)return[];const t=[];let e=[n[0]],s;for(let r=1,i=n.length;r<i;r++)s=n[r],e[0].source!==s.source&&(t.push(e),e=[]),e.push(s);return t.push(e),t.map(r=>({source:r[0].source,changes:ps(r.map(i=>i.changes))}))}class sc{constructor(){u(this,"_history",[]);u(this,"_interceptors",new Set)}intercepting(t){return this._interceptors.add(t),()=>{this._interceptors.delete(t)}}add(t){this._history.push(t);for(const e of this._interceptors)e(t)}flush(){const t=nc(this._history);return this._history=[],t}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function rc(n){const t=[];for(let e=n.length-1;e>=0;e--){const s=n[e];if("id"in s)t.unshift(s);else{const r=s.dependsOn,i=t[0];i&&(t[0]={...i,dependsOn:r.concat(i.dependsOn??[])})}}return t}function wn({sequence:n,sequenceId:t,retroactive:e=!0}){const s={sequenceId:t,retroactive:e,sequence:rc(n)};return co(s),s}function Le(n,t){return Object.fromEntries(Ve(t).map(([e,s])=>[e,`${n}/${s}`]))}function Ue(n){const t=n.sequenceId;return wn({sequenceId:t,retroactive:n.retroactive??!0,sequence:n.sequence.map(e=>"id"in e?{...e,scope:"record",filter:s=>{var r,i;return s.typeName===n.recordType&&(((r=e.filter)==null?void 0:r.call(e,s))??!0)&&(((i=n.filter)==null?void 0:i.call(n,s))??!0)}}:e)})}function ic(n){const t=new Map(n.map(i=>[i.id,i])),e=new Set,s=[];function r(i){ke(!e.has(i.id),`Circular dependency in migrations: ${i.id}`),e.add(i.id);const{version:o,sequenceId:a}=Jn(i.id),c=t.get(`${a}/${o-1}`);if(c&&r(c),i.dependsOn)for(const l of i.dependsOn){const d=t.get(l);d&&r(d)}t.delete(i.id),s.push(i)}for(const i of t.values())r(i);return s}function Jn(n){const[t,e]=n.split("/");return{sequenceId:t,version:parseInt(e)}}function Vr(n,t){t&&ke(n.startsWith(t+"/"),`Every migration in sequence '${t}' must have an id starting with '${t}/'. Got invalid id: '${n}'`),ke(n.match(/^(.*?)\/(0|[1-9]\d*)$/),`Invalid migration id: '${n}'`)}function co(n){if(ke(!n.sequenceId.includes("/"),`sequenceId cannot contain a '/', got ${n.sequenceId}`),ke(n.sequenceId.length,"sequenceId must be a non-empty string"),n.sequence.length===0)return;Vr(n.sequence[0].id,n.sequenceId);let t=Jn(n.sequence[0].id).version;ke(t===1,`Expected the first migrationId to be '${n.sequenceId}/1' but got '${n.sequence[0].id}'`);for(let e=1;e<n.sequence.length;e++){const s=n.sequence[e].id;Vr(s,n.sequenceId);const r=Jn(s).version;ke(r===t+1,`Migration id numbers must increase in increments of 1, expected ${n.sequenceId}/${t+1} but got '${n.sequence[e].id}'`),t=r}}var yt=(n=>(n.IncompatibleSubtype="incompatible-subtype",n.UnknownType="unknown-type",n.TargetVersionTooNew="target-version-too-new",n.TargetVersionTooOld="target-version-too-old",n.MigrationError="migration-error",n.UnrecognizedSubtype="unrecognized-subtype",n))(yt||{});function oc(n){if(n.schemaVersion>2||n.schemaVersion<1)return Qt.err("Bad schema version");if(n.schemaVersion===2)return Qt.ok(n);const t={schemaVersion:2,sequences:{}};for(const[e,s]of Object.entries(n.recordVersions))if(t.sequences[`com.tldraw.${e}`]=s.version,"subTypeKey"in s)for(const[r,i]of Object.entries(s.subTypeVersions))t.sequences[`com.tldraw.${e}.${r}`]=i;return Qt.ok(t)}class gr{constructor(t,e){u(this,"migrations",{});u(this,"sortedMigrations");var r;this.types=t,this.options=e;for(const i of e.migrations??[])ke(!this.migrations[i.sequenceId],`Duplicate migration sequenceId ${i.sequenceId}`),co(i),this.migrations[i.sequenceId]=i;const s=Object.values(this.migrations).flatMap(i=>i.sequence);this.sortedMigrations=ic(s);for(const i of this.sortedMigrations)if((r=i.dependsOn)!=null&&r.length)for(const o of i.dependsOn){const a=s.find(c=>c.id===o);ke(a,`Migration '${i.id}' depends on missing migration '${o}'`)}}static create(t,e){return new gr(t,e??{})}validateRecord(t,e,s,r){try{const i=We(this.types,e.typeName);if(!i)throw new Error(`Missing definition for record type ${e.typeName}`);return i.validate(e,r??void 0)}catch(i){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:t,record:e,phase:s,recordBefore:r,error:i});throw i}}getMigrationsSince(t){const e=oc(t);if(!e.ok)return e;const s=e.value,r=new Set(Object.keys(s.sequences).filter(o=>this.migrations[o]));for(const o in this.migrations)s.sequences[o]===void 0&&this.migrations[o].retroactive&&r.add(o);if(r.size===0)return Qt.ok([]);const i=new Set;for(const o of r){const a=s.sequences[o];if(typeof a!="number"&&this.migrations[o].retroactive||a===0){for(const d of this.migrations[o].sequence)i.add(d.id);continue}const c=`${o}/${a}`,l=this.migrations[o].sequence.findIndex(d=>d.id===c);if(l===-1)return Qt.err("Incompatible schema?");for(const d of this.migrations[o].sequence.slice(l+1))i.add(d.id)}return Qt.ok(this.sortedMigrations.filter(({id:o})=>i.has(o)))}migratePersistedRecord(t,e,s="up"){const r=this.getMigrationsSince(e);if(!r.ok)return console.error("Error migrating record",r.error),{type:"error",reason:yt.MigrationError};let i=r.value;if(i.length===0)return{type:"success",value:t};if(i.some(o=>o.scope==="store"))return{type:"error",reason:s==="down"?yt.TargetVersionTooOld:yt.TargetVersionTooNew};if(s==="down"){if(!i.every(o=>o.down))return{type:"error",reason:yt.TargetVersionTooOld};i=i.slice().reverse()}t=he(t);try{for(const o of i){if(o.scope==="store")throw new Error;if(!(o.filter?o.filter(t):!0))continue;const c=o[s](t);c&&(t=he(c))}}catch(o){return console.error("Error migrating record",o),{type:"error",reason:yt.MigrationError}}return{type:"success",value:t}}migrateStoreSnapshot(t){let{store:e}=t;const s=this.getMigrationsSince(t.schema);if(!s.ok)return console.error("Error migrating store",s.error),{type:"error",reason:yt.MigrationError};const r=s.value;if(r.length===0)return{type:"success",value:e};e=he(e);try{for(const i of r)if(i.scope==="record")for(const[o,a]of Object.entries(e)){if(!(i.filter?i.filter(a):!0))continue;const l=i.up(a);l&&(e[o]=he(l))}else if(i.scope==="store"){const o=i.up(e);o&&(e=he(o))}else us(i)}catch(i){return console.error("Error migrating store",i),{type:"error",reason:yt.MigrationError}}return{type:"success",value:e}}createIntegrityChecker(t){var e,s;return((s=(e=this.options).createIntegrityChecker)==null?void 0:s.call(e,t))??void 0}serialize(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:t,sequence:e})=>[t,e.length?Jn(e.at(-1).id).version:0]))}}serializeEarliestVersion(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:t})=>[t,0]))}}}function ac(n){if(!n.length)return null;let t="";for(const e of n)typeof e=="number"?t+=`.${e}`:e.startsWith("(")?t.endsWith(")")?t=`${t.slice(0,-1)}, ${e.slice(1)}`:t+=e:t+=`.${e}`;return t=t.replace(/id = [^,]+, /,"").replace(/id = [^)]+/,""),t.startsWith(".")?t.slice(1):t}class Y extends Error{constructor(e,s=[]){const r=ac(s),i=e.split(`
`).map((o,a)=>a===0?o:`  ${o}`).join(`
`);super(s?`At ${r}: ${i}`:i);u(this,"name","ValidationError");this.rawMessage=e,this.path=s}}function Me(n,t){try{return t()}catch(e){throw e instanceof Y?new Y(e.rawMessage,[n,...e.path]):new Y(e.toString(),[n])}}function wt(n){if(n===null)return"null";if(Array.isArray(n))return"an array";const t=typeof n;switch(t){case"bigint":case"boolean":case"function":case"number":case"string":case"symbol":return`a ${t}`;case"object":return`an ${t}`;case"undefined":return"undefined";default:us(t)}}class Ce{constructor(t,e){this.validationFn=t,this.validateUsingKnownGoodVersionFn=e}validate(t){return this.validationFn(t)}validateUsingKnownGoodVersion(t,e){return Object.is(t,e)?t:this.validateUsingKnownGoodVersionFn?this.validateUsingKnownGoodVersionFn(t,e):this.validate(e)}isValid(t){try{return this.validate(t),!0}catch{return!1}}nullable(){return uc(this)}optional(){return ho(this)}refine(t){return new Ce(e=>t(this.validate(e)),(e,s)=>{const r=this.validateUsingKnownGoodVersion(e,s);return Object.is(e,r)?e:t(r)})}check(t,e){return typeof t=="string"?this.refine(s=>(Me(`(check ${t})`,()=>e(s)),s)):this.refine(s=>(t(s),s))}}class cc extends Ce{constructor(t){super(e=>{const s=Zr.validate(e);for(let r=0;r<s.length;r++)Me(r,()=>t.validate(s[r]));return s},(e,s)=>{if(!t.validateUsingKnownGoodVersion)return this.validate(s);const r=Zr.validate(s);let i=e.length!==r.length;for(let o=0;o<r.length;o++){const a=r[o];if(o>=e.length){i=!0,Me(o,()=>t.validate(a));continue}if(Object.is(e[o],a))continue;const c=Me(o,()=>t.validateUsingKnownGoodVersion(e[o],a));Object.is(c,e[o])||(i=!0)}return i?s:e}),this.itemValidator=t}nonEmpty(){return this.check(t=>{if(t.length===0)throw new Y("Expected a non-empty array")})}lengthGreaterThan1(){return this.check(t=>{if(t.length<=1)throw new Y("Expected an array with length greater than 1")})}}class es extends Ce{constructor(t,e=!1){super(s=>{if(typeof s!="object"||s===null)throw new Y(`Expected object, got ${wt(s)}`);for(const[r,i]of Object.entries(t))Me(r,()=>{i.validate(We(s,r))});if(!e){for(const r of Object.keys(s))if(!Je(t,r))throw new Y("Unexpected property",[r])}return s},(s,r)=>{if(typeof r!="object"||r===null)throw new Y(`Expected object, got ${wt(r)}`);let i=!1;for(const[o,a]of Object.entries(t)){const c=We(s,o),l=We(r,o);if(Object.is(c,l))continue;const d=Me(o,()=>{const h=a;return h.validateUsingKnownGoodVersion?h.validateUsingKnownGoodVersion(c,l):h.validate(l)});Object.is(d,c)||(i=!0)}if(!e){for(const o of Object.keys(r))if(!Je(t,o))throw new Y("Unexpected property",[o])}for(const o of Object.keys(s))if(!Je(r,o)){i=!0;break}return i?r:s}),this.config=t,this.shouldAllowUnknownProperties=e}allowUnknownProperties(){return new es(this.config,!0)}extend(t){return new es({...this.config,...t})}}class fs extends Ce{constructor(t,e,s,r){super(i=>{this.expectObject(i);const{matchingSchema:o,variant:a}=this.getMatchingSchemaAndVariant(i);return o===void 0?this.unknownValueValidation(i,a):Me(`(${t} = ${a})`,()=>o.validate(i))},(i,o)=>{this.expectObject(o),this.expectObject(i);const{matchingSchema:a,variant:c}=this.getMatchingSchemaAndVariant(o);return a===void 0?this.unknownValueValidation(o,c):We(i,t)!==We(o,t)?Me(`(${t} = ${c})`,()=>a.validate(o)):Me(`(${t} = ${c})`,()=>a.validateUsingKnownGoodVersion?a.validateUsingKnownGoodVersion(i,o):a.validate(o))}),this.key=t,this.config=e,this.unknownValueValidation=s,this.useNumberKeys=r}expectObject(t){if(typeof t!="object"||t===null)throw new Y(`Expected an object, got ${wt(t)}`,[])}getMatchingSchemaAndVariant(t){const e=We(t,this.key);if(!this.useNumberKeys&&typeof e!="string")throw new Y(`Expected a string for key "${this.key}", got ${wt(e)}`);if(this.useNumberKeys&&!Number.isFinite(Number(e)))throw new Y(`Expected a number for key "${this.key}", got "${e}"`);return{matchingSchema:Je(this.config,e)?this.config[e]:void 0,variant:e}}validateUnknownVariants(t){return new fs(this.key,this.config,t,this.useNumberKeys)}}class lc extends Ce{constructor(t,e){super(s=>{if(typeof s!="object"||s===null)throw new Y(`Expected object, got ${wt(s)}`);for(const[r,i]of Object.entries(s))Me(r,()=>{t.validate(r),e.validate(i)});return s},(s,r)=>{if(typeof r!="object"||r===null)throw new Y(`Expected object, got ${wt(r)}`);let i=!1;for(const[o,a]of Object.entries(r)){if(!Je(s,o)){i=!0,Me(o,()=>{t.validate(o),e.validate(a)});continue}const c=We(s,o),l=a;if(Object.is(c,l))continue;const d=Me(o,()=>e.validateUsingKnownGoodVersion?e.validateUsingKnownGoodVersion(c,l):e.validate(l));Object.is(d,c)||(i=!0)}for(const o of Object.keys(s))if(!Je(r,o)){i=!0;break}return i?r:s}),this.keyValidator=t,this.valueValidator=e}}function mr(n){return new Ce(t=>{if(typeof t!==n)throw new Y(`Expected ${n}, got ${wt(t)}`);return t})}const dc=new Ce(n=>n),K=mr("string"),B=mr("number").check(n=>{if(Number.isNaN(n))throw new Y("Expected a number, got NaN");if(!Number.isFinite(n))throw new Y(`Expected a finite number, got ${n}`)}),ts=B.check(n=>{if(n<0)throw new Y(`Expected a positive number, got ${n}`)}),Ae=B.check(n=>{if(n<=0)throw new Y(`Expected a non-zero positive number, got ${n}`)}),lo=B.check(n=>{if(!Number.isInteger(n))throw new Y(`Expected an integer, got ${n}`)}),df=lo.check(n=>{if(n<0)throw new Y(`Expected a positive integer, got ${n}`)}),hf=lo.check(n=>{if(n<=0)throw new Y(`Expected a non-zero positive integer, got ${n}`)}),H=mr("boolean");function Re(n){return new Ce(t=>{if(t!==n)throw new Y(`Expected ${n}, got ${JSON.stringify(t)}`);return n})}const Zr=new Ce(n=>{if(!Array.isArray(n))throw new Y(`Expected an array, got ${wt(n)}`);return n});function ye(n){return new cc(n)}function q(n){return new es(n)}function tr(n){return typeof n=="object"&&n!==null&&(Object.getPrototypeOf(n)===Object.prototype||Object.getPrototypeOf(n)===null||Object.getPrototypeOf(n)===Qa)}function nr(n){return n===null||typeof n=="number"||typeof n=="string"||typeof n=="boolean"?!0:Array.isArray(n)?n.every(nr):tr(n)?Object.values(n).every(nr):!1}const Pe=new Ce(n=>{if(nr(n))return n;throw new Y(`Expected json serializable value, got ${typeof n}`)},(n,t)=>{if(Array.isArray(n)&&Array.isArray(t)){let e=n.length!==t.length;for(let s=0;s<t.length;s++){if(s>=n.length){e=!0,Pe.validate(t[s]);continue}const r=n[s],i=t[s];if(Object.is(r,i))continue;const o=Pe.validateUsingKnownGoodVersion(r,i);Object.is(o,r)||(e=!0)}return e?t:n}else if(tr(n)&&tr(t)){let e=!1;for(const s of Object.keys(t)){if(!Je(n,s)){e=!0,Pe.validate(t[s]);continue}const r=n[s],i=t[s];if(Object.is(r,i))continue;const o=Pe.validateUsingKnownGoodVersion(r,i);Object.is(o,r)||(e=!0)}for(const s of Object.keys(n))if(!Je(t,s)){e=!0;break}return e?t:n}else return Pe.validate(t)});function hc(n,t){return new lc(n,t)}function yr(n,t){return new fs(n,t,(e,s)=>{throw new Y(`Expected one of ${Object.keys(t).map(r=>JSON.stringify(r)).join(" or ")}, got ${JSON.stringify(s)}`,[n])},!1)}function uf(n,t){return new fs(n,t,(e,s)=>{throw new Y(`Expected one of ${Object.keys(t).map(r=>JSON.stringify(r)).join(" or ")}, got ${JSON.stringify(s)}`,[n])},!0)}function ft(n,t){return new Ce(e=>Me(n,()=>t.validate(e)),(e,s)=>Me(n,()=>t.validateUsingKnownGoodVersion?t.validateUsingKnownGoodVersion(e,s):t.validate(s)))}function gs(n){return new Ce(t=>{if(!n.has(t)){const e=Array.from(n,s=>JSON.stringify(s)).join(" or ");throw new Y(`Expected ${e}, got ${t}`)}return t})}function ho(n){return new Ce(t=>{if(t!==void 0)return n.validate(t)},(t,e)=>{if(!(t===void 0&&e===void 0)&&e!==void 0)return n.validateUsingKnownGoodVersion&&t!==void 0?n.validateUsingKnownGoodVersion(t,e):n.validate(e)})}function uc(n){return new Ce(t=>t===null?null:n.validate(t),(t,e)=>e===null?null:n.validateUsingKnownGoodVersion&&t!==null?n.validateUsingKnownGoodVersion(t,e):n.validate(e))}function uo(...n){return gs(new Set(n))}function po(n){try{return new URL(n)}catch{if(n.startsWith("/")||n.startsWith("./"))try{return new URL(n,"http://example.com")}catch{throw new Y(`Expected a valid url, got ${JSON.stringify(n)}`)}throw new Y(`Expected a valid url, got ${JSON.stringify(n)}`)}}const pc=new Set(["http:","https:","mailto:"]),tt=K.check(n=>{if(n==="")return;const t=po(n);if(!pc.has(t.protocol.toLowerCase()))throw new Y(`Expected a valid url, got ${JSON.stringify(n)} (invalid protocol)`)}),fc=new Set(["http:","https:","data:"]),sn=K.check(n=>{if(n==="")return;const t=po(n);if(!fc.has(t.protocol.toLowerCase()))throw new Y(`Expected a valid url, got ${JSON.stringify(n)} (invalid protocol)`)}),Sr=K.refine(n=>{try{return Ya(n),n}catch{throw new Y(`Expected an index key, got ${JSON.stringify(n)}`)}});function Ne(n){return K.refine(t=>{if(!t.startsWith(`${n}:`))throw new Error(`${n} ID must start with "${n}:"`);return t})}const ms=Ne("asset");function xr(n,t){return q({id:ms,typeName:Re("asset"),type:Re(n),props:t,meta:Pe})}const gc=ft("camera",q({typeName:Re("camera"),id:Ne("camera"),x:B,y:B,z:B,meta:Pe})),mc=Le("com.tldraw.camera",{AddMeta:1}),yc=Ue({sequenceId:"com.tldraw.camera",recordType:"camera",sequence:[{id:mc.AddMeta,up:n=>{n.meta={}}}]}),Ie=pt("camera",{validator:gc,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,z:1,meta:{}})),Cn=q({x:B,y:B,z:B.optional()}),bn=q({x:B,y:B,w:B,h:B}),Sc=new Set(["none","default","pointer","cross","grab","rotate","grabbing","resize-edge","resize-corner","text","move","ew-resize","ns-resize","nesw-resize","nwse-resize","nesw-rotate","nwse-rotate","swne-rotate","senw-rotate","zoom-in","zoom-out"]),fo=gs(Sc),xc=q({type:fo,rotation:B}),go=B.check(n=>{if(n<0||n>1)throw new Y("Opacity must be between 0 and 1")}),wc=new Set(["accent","white","black","selection-stroke","selection-fill","laser","muted-1"]),bc=gs(wc),Ic=new Set(["starting","paused","active","stopping"]),mo=q({id:K,points:ye(Cn),size:ts,color:bc,opacity:B,state:gs(Ic),delay:B,shrink:B,taper:H}),_n=Ne("page"),Pc=ft("page",q({typeName:Re("page"),id:_n,name:K,index:Sr,meta:Pe})),vc=Le("com.tldraw.page",{AddMeta:1}),Cc=Ue({sequenceId:"com.tldraw.page",recordType:"page",sequence:[{id:vc.AddMeta,up:n=>{n.meta={}}}]}),En=pt("page",{validator:Pc,scope:"document"}).withDefaultProperties(()=>({meta:{}}));function De(n){return En.isId(n)}Ne("instance");function _c(n){const t={};for(const[s,r]of n)t[s]=ho(r);const e=ft("instance",q({typeName:Re("instance"),id:Ne("instance"),currentPageId:_n,followingUserId:K.nullable(),brush:bn.nullable(),opacityForNextShape:go,stylesForNextShape:q(t),cursor:xc,scribbles:ye(mo),isFocusMode:H,isDebugMode:H,isToolLocked:H,exportBackground:H,screenBounds:bn,insets:ye(H),zoomBrush:bn.nullable(),isPenMode:H,isGridMode:H,chatMessage:K,isChatting:H,highlightedUserIds:ye(K),canMoveCamera:H,isFocused:H,devicePixelRatio:B,isCoarsePointer:H,isHoveringCanvas:H.nullable(),openMenus:ye(K),isChangingStyle:H,isReadonly:H,meta:Pe,duplicateProps:q({shapeIds:ye(Ne("shape")),offset:q({x:B,y:B})}).nullable()}));return pt("instance",{validator:e,scope:"session"}).withDefaultProperties(()=>({followingUserId:null,opacityForNextShape:1,stylesForNextShape:{},brush:null,scribbles:[],cursor:{type:"default",rotation:0},isFocusMode:!1,exportBackground:!1,isDebugMode:!1,isToolLocked:!1,screenBounds:{x:0,y:0,w:1080,h:720},insets:[!1,!1,!1,!1],zoomBrush:null,isGridMode:!1,isPenMode:!1,chatMessage:"",isChatting:!1,highlightedUserIds:[],canMoveCamera:!0,isFocused:!1,devicePixelRatio:typeof window>"u"?1:window.devicePixelRatio,isCoarsePointer:!1,isHoveringCanvas:null,openMenus:[],isChangingStyle:!1,isReadonly:!1,meta:{},duplicateProps:null}))}const J=Le("com.tldraw.instance",{AddTransparentExportBgs:1,RemoveDialog:2,AddToolLockMode:3,RemoveExtraPropsForNextShape:4,AddLabelColor:5,AddFollowingUserId:6,RemoveAlignJustify:7,AddZoom:8,AddVerticalAlign:9,AddScribbleDelay:10,RemoveUserId:11,AddIsPenModeAndIsGridMode:12,HoistOpacity:13,AddChat:14,AddHighlightedUserIds:15,ReplacePropsForNextShapeWithStylesForNextShape:16,AddMeta:17,RemoveCursorColor:18,AddLonelyProperties:19,ReadOnlyReadonly:20,AddHoveringCanvas:21,AddScribbles:22,AddInset:23,AddDuplicateProps:24}),Ec=Ue({sequenceId:"com.tldraw.instance",recordType:"instance",sequence:[{id:J.AddTransparentExportBgs,up:n=>({...n,exportBackground:!0})},{id:J.RemoveDialog,up:({dialog:n,...t})=>t},{id:J.AddToolLockMode,up:n=>({...n,isToolLocked:!1})},{id:J.RemoveExtraPropsForNextShape,up:({propsForNextShape:n,...t})=>({...t,propsForNextShape:Object.fromEntries(Object.entries(n).filter(([e])=>["color","labelColor","dash","fill","size","font","align","verticalAlign","icon","geo","arrowheadStart","arrowheadEnd","spline"].includes(e)))})},{id:J.AddLabelColor,up:({propsForNextShape:n,...t})=>({...t,propsForNextShape:{...n,labelColor:"black"}})},{id:J.AddFollowingUserId,up:n=>({...n,followingUserId:null})},{id:J.RemoveAlignJustify,up:n=>{let t=n.propsForNextShape.align;return t==="justify"&&(t="start"),{...n,propsForNextShape:{...n.propsForNextShape,align:t}}}},{id:J.AddZoom,up:n=>({...n,zoomBrush:null})},{id:J.AddVerticalAlign,up:n=>({...n,propsForNextShape:{...n.propsForNextShape,verticalAlign:"middle"}})},{id:J.AddScribbleDelay,up:n=>n.scribble!==null?{...n,scribble:{...n.scribble,delay:0}}:{...n}},{id:J.RemoveUserId,up:({userId:n,...t})=>t},{id:J.AddIsPenModeAndIsGridMode,up:n=>({...n,isPenMode:!1,isGridMode:!1})},{id:J.HoistOpacity,up:({propsForNextShape:{opacity:n,...t},...e})=>({...e,opacityForNextShape:Number(n??"1"),propsForNextShape:t})},{id:J.AddChat,up:n=>({...n,chatMessage:"",isChatting:!1})},{id:J.AddHighlightedUserIds,up:n=>({...n,highlightedUserIds:[]})},{id:J.ReplacePropsForNextShapeWithStylesForNextShape,up:({propsForNextShape:n,...t})=>({...t,stylesForNextShape:{}})},{id:J.AddMeta,up:n=>({...n,meta:{}})},{id:J.RemoveCursorColor,up:n=>{const{color:t,...e}=n.cursor;return{...n,cursor:e}}},{id:J.AddLonelyProperties,up:n=>({...n,canMoveCamera:!0,isFocused:!1,devicePixelRatio:1,isCoarsePointer:!1,openMenus:[],isChangingStyle:!1,isReadOnly:!1})},{id:J.ReadOnlyReadonly,up:({isReadOnly:n,...t})=>({...t,isReadonly:n})},{id:J.AddHoveringCanvas,up:n=>({...n,isHoveringCanvas:null})},{id:J.AddScribbles,up:({scribble:n,...t})=>({...t,scribbles:[]})},{id:J.AddInset,up:n=>({...n,insets:[!1,!1,!1,!1]}),down:({insets:n,...t})=>({...t})},{id:J.AddDuplicateProps,up:n=>({...n,duplicateProps:null}),down:({duplicateProps:n,...t})=>({...t})}]}),_e="instance:instance",Tc=K.refine(n=>{if(!n.startsWith("page:")&&!n.startsWith("shape:"))throw new Error('Parent ID must start with "page:" or "shape:"');return n}),Ke=Ne("shape");function kc(n,t,e){return q({id:Ke,typeName:Re("shape"),x:B,y:B,rotation:B,index:Sr,parentId:Tc,type:Re(n),isLocked:H,opacity:go,props:t?q(t):Pe,meta:e?q(e):Pe})}const Mc=ft("instance_page_state",q({typeName:Re("instance_page_state"),id:Ne("instance_page_state"),pageId:_n,selectedShapeIds:ye(Ke),hintingShapeIds:ye(Ke),erasingShapeIds:ye(Ke),hoveredShapeId:Ke.nullable(),editingShapeId:Ke.nullable(),croppingShapeId:Ke.nullable(),focusedGroupId:Ke.nullable(),meta:Pe})),dn=Le("com.tldraw.instance_page_state",{AddCroppingId:1,RemoveInstanceIdAndCameraId:2,AddMeta:3,RenameProperties:4,RenamePropertiesAgain:5}),Ac=Ue({sequenceId:"com.tldraw.instance_page_state",recordType:"instance_page_state",sequence:[{id:dn.AddCroppingId,up(n){n.croppingShapeId=null}},{id:dn.RemoveInstanceIdAndCameraId,up(n){delete n.instanceId,delete n.cameraId}},{id:dn.AddMeta,up:n=>{n.meta={}}},{id:dn.RenameProperties,up:n=>{},down:n=>{}},{id:dn.RenamePropertiesAgain,up:n=>{n.selectedShapeIds=n.selectedIds,delete n.selectedIds,n.hintingShapeIds=n.hintingIds,delete n.hintingIds,n.erasingShapeIds=n.erasingIds,delete n.erasingIds,n.hoveredShapeId=n.hoveredId,delete n.hoveredId,n.editingShapeId=n.editingId,delete n.editingId,n.croppingShapeId=n.croppingShapeId??n.croppingId??null,delete n.croppingId,n.focusedGroupId=n.focusLayerId,delete n.focusLayerId},down:n=>{n.selectedIds=n.selectedShapeIds,delete n.selectedShapeIds,n.hintingIds=n.hintingShapeIds,delete n.hintingShapeIds,n.erasingIds=n.erasingShapeIds,delete n.erasingShapeIds,n.hoveredId=n.hoveredShapeId,delete n.hoveredShapeId,n.editingId=n.editingShapeId,delete n.editingShapeId,n.croppingId=n.croppingShapeId,delete n.croppingShapeId,n.focusLayerId=n.focusedGroupId,delete n.focusedGroupId}}]}),ge=pt("instance_page_state",{validator:Mc,scope:"session"}).withDefaultProperties(()=>({editingShapeId:null,croppingShapeId:null,selectedShapeIds:[],hoveredShapeId:null,erasingShapeIds:[],hintingShapeIds:[],focusedGroupId:null,meta:{}})),Rc=ft("pointer",q({typeName:Re("pointer"),id:Ne("pointer"),x:B,y:B,lastActivityTimestamp:B,meta:Pe})),Dc=Le("com.tldraw.pointer",{AddMeta:1}),Oc=Ue({sequenceId:"com.tldraw.pointer",recordType:"pointer",sequence:[{id:Dc.AddMeta,up:n=>{n.meta={}}}]}),wr=pt("pointer",{validator:Rc,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,lastActivityTimestamp:0,meta:{}})),ns=wr.createId("pointer"),jc=ft("instance_presence",q({typeName:Re("instance_presence"),id:Ne("instance_presence"),userId:K,userName:K,lastActivityTimestamp:B,followingUserId:K.nullable(),cursor:q({x:B,y:B,type:fo,rotation:B}),color:K,camera:q({x:B,y:B,z:B}),screenBounds:bn,selectedShapeIds:ye(Ne("shape")),currentPageId:Ne("page"),brush:bn.nullable(),scribbles:ye(mo),chatMessage:K,meta:Pe})),hn=Le("com.tldraw.instance_presence",{AddScribbleDelay:1,RemoveInstanceId:2,AddChatMessage:3,AddMeta:4,RenameSelectedShapeIds:5}),Fc=Ue({sequenceId:"com.tldraw.instance_presence",recordType:"instance_presence",sequence:[{id:hn.AddScribbleDelay,up:n=>{n.scribble!==null&&(n.scribble.delay=0)}},{id:hn.RemoveInstanceId,up:n=>{delete n.instanceId}},{id:hn.AddChatMessage,up:n=>{n.chatMessage=""}},{id:hn.AddMeta,up:n=>{n.meta={}}},{id:hn.RenameSelectedShapeIds,up:n=>{}}]}),Lc=pt("instance_presence",{validator:jc,scope:"presence"}).withDefaultProperties(()=>({lastActivityTimestamp:0,followingUserId:null,color:"#FF0000",camera:{x:0,y:0,z:1},cursor:{x:0,y:0,type:"default",rotation:0},screenBounds:{x:0,y:0,w:1,h:1},selectedShapeIds:[],brush:null,scribbles:[],chatMessage:"",meta:{}})),Bc=ft("document",q({typeName:Re("document"),id:Re("document:document"),gridSize:B,name:K,meta:Pe})),Qr=Le("com.tldraw.document",{AddName:1,AddMeta:2}),zc=Ue({sequenceId:"com.tldraw.document",recordType:"document",sequence:[{id:Qr.AddName,up:n=>{n.name=""},down:n=>{delete n.name}},{id:Qr.AddMeta,up:n=>{n.meta={}}}]}),br=pt("document",{validator:Bc,scope:"document"}).withDefaultProperties(()=>({gridSize:10,name:"",meta:{}})),sr=br.createId("document");function Nc(n,t){return n.index<t.index?-1:n.index>t.index?1:0}function Jr(n){n.typeName==="asset"&&("src"in n&&(n.src="<redacted>"),"src"in n.props&&(n.props.src="<redacted>"))}const Uc=({error:n,phase:t,record:e,recordBefore:s})=>{throw hr(n,{tags:{origin:"store.validateRecord",storePhase:t,isExistingValidationIssue:t==="initialize"},extras:{recordBefore:s?Jr(he(s)):void 0,recordAfter:Jr(he(e))}}),n};function $c(){return[En.create({id:"page:page",name:"Page 1",index:"a1",meta:{}})]}function Hc(n){const t=n.query.ids("page"),e=()=>{if(!n.has(sr))return n.put([br.create({id:sr,name:n.props.defaultName})]),e();if(!n.has(ns))return n.put([wr.create({id:ns})]),e();const s=t.get();if(s.size===0)return n.put($c()),e();const r=()=>[...s].map(c=>n.get(c)).sort(Nc)[0].id,i=n.get(_e);if(i){if(!s.has(i.currentPageId))return n.put([{...i,currentPageId:r()}]),e()}else return n.put([n.schema.types.instance.create({id:_e,currentPageId:r(),exportBackground:!0})]),e();const o=new Set,a=new Set;for(const c of s){const l=ge.createId(c);n.has(l)||o.add(l);const d=Ie.createId(c);n.has(d)||a.add(d)}o.size>0&&n.put([...o].map(c=>ge.create({id:c,pageId:ge.parseId(c)}))),a.size>0&&n.put([...a].map(c=>Ie.create({id:c})))};return e}const Kc=xr("bookmark",q({title:K,description:K,image:K,src:sn.nullable()})),Yc=Le("com.tldraw.asset.bookmark",{MakeUrlsValid:1}),Xc=Ue({sequenceId:"com.tldraw.asset.bookmark",recordType:"asset",filter:n=>n.type==="bookmark",sequence:[{id:Yc.MakeUrlsValid,up:n=>{sn.isValid(n.props.src)||(n.props.src="")},down:n=>{}}]}),Gc=xr("image",q({w:B,h:B,name:K,isAnimated:H,mimeType:K.nullable(),src:sn.nullable()})),js=Le("com.tldraw.asset.image",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3}),qc=Ue({sequenceId:"com.tldraw.asset.image",recordType:"asset",filter:n=>n.type==="image",sequence:[{id:js.AddIsAnimated,up:n=>{n.props.isAnimated=!1},down:n=>{delete n.props.isAnimated}},{id:js.RenameWidthHeight,up:n=>{n.props.w=n.props.width,n.props.h=n.props.height,delete n.props.width,delete n.props.height},down:n=>{n.props.width=n.props.w,n.props.height=n.props.h,delete n.props.w,delete n.props.h}},{id:js.MakeUrlsValid,up:n=>{sn.isValid(n.props.src)||(n.props.src="")},down:n=>{}}]}),Wc=xr("video",q({w:B,h:B,name:K,isAnimated:H,mimeType:K.nullable(),src:sn.nullable()})),Fs=Le("com.tldraw.asset.video",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3}),Vc=Ue({sequenceId:"com.tldraw.asset.video",recordType:"asset",filter:n=>n.type==="video",sequence:[{id:Fs.AddIsAnimated,up:n=>{n.props.isAnimated=!1},down:n=>{delete n.props.isAnimated}},{id:Fs.RenameWidthHeight,up:n=>{n.props.w=n.props.width,n.props.h=n.props.height,delete n.props.width,delete n.props.height},down:n=>{n.props.width=n.props.w,n.props.height=n.props.h,delete n.props.w,delete n.props.h}},{id:Fs.MakeUrlsValid,up:n=>{sn.isValid(n.props.src)||(n.props.src="")},down:n=>{}}]}),Zc=ft("asset",yr("type",{image:Gc,video:Wc,bookmark:Kc})),Qc=Le("com.tldraw.asset",{AddMeta:1}),Jc=Ue({sequenceId:"com.tldraw.asset",recordType:"asset",sequence:[{id:Qc.AddMeta,up:n=>{n.meta={}}}]}),el=pt("asset",{validator:Zc,scope:"document"}).withDefaultProperties(()=>({meta:{}}));let tl=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((t,e)=>(e&=63,e<36?t+=e.toString(36):e<62?t+=(e-26).toString(36).toUpperCase():e>62?t+="-":t+="_",t),"");class Se{constructor(t,e,s){this.id=t,this.defaultValue=e,this.type=s}static define(t,e){const{defaultValue:s,type:r=dc}=e;return new Se(t,s,r)}static defineEnum(t,e){const{defaultValue:s,values:r}=e;return new nl(t,s,r)}validate(t){return this.type.validate(t)}validateUsingKnownGoodVersion(t,e){return this.type.validateUsingKnownGoodVersion?this.type.validateUsingKnownGoodVersion(t,e):this.validate(e)}}class nl extends Se{constructor(t,e,s){super(t,e,uo(...s)),this.values=s}}const Dn=Le("com.tldraw.shape",{AddIsLocked:1,HoistOpacity:2,AddMeta:3,AddWhite:4}),sl=Ue({sequenceId:"com.tldraw.shape",recordType:"shape",sequence:[{id:Dn.AddIsLocked,up:n=>{n.isLocked=!1},down:n=>{delete n.isLocked}},{id:Dn.HoistOpacity,up:n=>{n.opacity=Number(n.props.opacity??"1"),delete n.props.opacity},down:n=>{const t=n.opacity;delete n.opacity,n.props.opacity=t<.175?"0.1":t<.375?"0.25":t<.625?"0.5":t<.875?"0.75":"1"}},{id:Dn.AddMeta,up:n=>{n.meta={}}},{id:Dn.AddWhite,up:n=>{},down:n=>{n.props.color==="white"&&(n.props.color="black")}}]});function Vt(n){return n?n.typeName==="shape":!1}function He(n){return n?n.startsWith("shape:"):!1}function Zt(n){return`shape:${n??tl()}`}function yo(n){const t=new Map;for(const[e,s]of Object.entries(n))if(s instanceof Se){if(t.has(s))throw new Error(`Duplicate style prop ${s.id}. Each style prop can only be used once within a shape.`);t.set(s,e)}return t}const te="retired";function nt(n,t){return Gi(t,(e,s)=>`com.tldraw.shape.${n}/${s}`)}function rl(n){const t=[];for(const[e,{migrations:s}]of Object.entries(n)){const r=`com.tldraw.shape.${e}`;s?"sequenceId"in s?(ke(r===s.sequenceId,`sequenceId mismatch for ${e} shape migrations. Expected '${r}', got '${s.sequenceId}'`),t.push(s)):"sequence"in s?t.push(wn({sequenceId:r,retroactive:!1,sequence:s.sequence.map(i=>"id"in i?{id:i.id,scope:"record",filter:o=>o.typeName==="shape"&&o.type===e,dependsOn:i.dependsOn,up:o=>{const a=i.up(o.props);a&&(o.props=a)},down:typeof i.down=="function"?o=>{const a=i.down(o.props);a&&(o.props=a)}:void 0}:i)})):t.push(wn({sequenceId:r,retroactive:!1,sequence:Object.keys(s.migrators).map(i=>Number(i)).sort((i,o)=>i-o).map(i=>({id:`${r}/${i}`,scope:"record",filter:o=>o.typeName==="shape"&&o.type===e,up:o=>{const a=s.migrators[i].up(o);if(a)return a},down:o=>{const a=s.migrators[i].down(o);if(a)return a}}))})):t.push(wn({sequenceId:r,retroactive:!1,sequence:[]}))}return t}function il(n){return pt("shape",{scope:"document",validator:ft("shape",yr("type",Gi(n,(t,{props:e,meta:s})=>kc(t,e,s))))}).withDefaultProperties(()=>({x:0,y:0,rotation:0,isLocked:!1,opacity:1,meta:{}}))}const So=["black","grey","light-violet","violet","blue","light-blue","yellow","orange","green","light-green","light-red","red","white"],ei={lightMode:{id:"light",text:"#000000",background:"rgb(249, 250, 251)",solid:"#fcfffe",black:{solid:"#1d1d1d",note:{fill:"#FCE19C",text:"#000000"},semi:"#e8e8e8",pattern:"#494949",highlight:{srgb:"#fddd00",p3:"color(display-p3 0.972 0.8705 0.05)"}},blue:{solid:"#4465e9",note:{fill:"#8AA3FF",text:"#000000"},semi:"#dce1f8",pattern:"#6681ee",highlight:{srgb:"#10acff",p3:"color(display-p3 0.308 0.6632 0.9996)"}},green:{solid:"#099268",note:{fill:"#6FC896",text:"#000000"},semi:"#d3e9e3",pattern:"#39a785",highlight:{srgb:"#00ffc8",p3:"color(display-p3 0.2536 0.984 0.7981)"}},grey:{solid:"#9fa8b2",note:{fill:"#C0CAD3",text:"#000000"},semi:"#eceef0",pattern:"#bcc3c9",highlight:{srgb:"#cbe7f1",p3:"color(display-p3 0.8163 0.9023 0.9416)"}},"light-blue":{solid:"#4ba1f1",note:{fill:"#9BC4FD",text:"#000000"},semi:"#ddedfa",pattern:"#6fbbf8",highlight:{srgb:"#00f4ff",p3:"color(display-p3 0.1512 0.9414 0.9996)"}},"light-green":{solid:"#4cb05e",note:{fill:"#98D08A",text:"#000000"},semi:"#dbf0e0",pattern:"#65cb78",highlight:{srgb:"#65f641",p3:"color(display-p3 0.563 0.9495 0.3857)"}},"light-red":{solid:"#f87777",note:{fill:"#F7A5A1",text:"#000000"},semi:"#f4dadb",pattern:"#fe9e9e",highlight:{srgb:"#ff7fa3",p3:"color(display-p3 0.9988 0.5301 0.6397)"}},"light-violet":{solid:"#e085f4",note:{fill:"#DFB0F9",text:"#000000"},semi:"#f5eafa",pattern:"#e9acf8",highlight:{srgb:"#ff88ff",p3:"color(display-p3 0.9676 0.5652 0.9999)"}},orange:{solid:"#e16919",note:{fill:"#FAA475",text:"#000000"},semi:"#f8e2d4",pattern:"#f78438",highlight:{srgb:"#ffa500",p3:"color(display-p3 0.9988 0.6905 0.266)"}},red:{solid:"#e03131",note:{fill:"#FC8282",text:"#000000"},semi:"#f4dadb",pattern:"#e55959",highlight:{srgb:"#ff636e",p3:"color(display-p3 0.9992 0.4376 0.45)"}},violet:{solid:"#ae3ec9",note:{fill:"#DB91FD",text:"#000000"},semi:"#ecdcf2",pattern:"#bd63d3",highlight:{srgb:"#c77cff",p3:"color(display-p3 0.7469 0.5089 0.9995)"}},yellow:{solid:"#f1ac4b",note:{fill:"#FED49A",text:"#000000"},semi:"#f9f0e6",pattern:"#fecb92",highlight:{srgb:"#fddd00",p3:"color(display-p3 0.972 0.8705 0.05)"}},white:{solid:"#FFFFFF",semi:"#f5f5f5",pattern:"#f9f9f9",note:{fill:"#FFFFFF",text:"#000000"},highlight:{srgb:"#ffffff",p3:"color(display-p3 1 1 1)"}}},darkMode:{id:"dark",text:"hsl(210, 17%, 98%)",background:"hsl(240, 5%, 6.5%)",solid:"#010403",black:{solid:"#f2f2f2",note:{fill:"#2c2c2c",text:"#f2f2f2"},semi:"#2c3036",pattern:"#989898",highlight:{srgb:"#d2b700",p3:"color(display-p3 0.8078 0.7225 0.0312)"}},blue:{solid:"#4f72fc",note:{fill:"#2A3F98",text:"#f2f2f2"},semi:"#262d40",pattern:"#3a4b9e",highlight:{srgb:"#0079d2",p3:"color(display-p3 0.0032 0.4655 0.7991)"}},green:{solid:"#099268",note:{fill:"#014429",text:"#f2f2f2"},semi:"#253231",pattern:"#366a53",highlight:{srgb:"#009774",p3:"color(display-p3 0.0085 0.582 0.4604)"}},grey:{solid:"#9398b0",note:{fill:"#56595F",text:"#f2f2f2"},semi:"#33373c",pattern:"#7c8187",highlight:{srgb:"#9cb4cb",p3:"color(display-p3 0.6299 0.7012 0.7856)"}},"light-blue":{solid:"#4dabf7",note:{fill:"#1F5495",text:"#f2f2f2"},semi:"#2a3642",pattern:"#4d7aa9",highlight:{srgb:"#00bdc8",p3:"color(display-p3 0.0023 0.7259 0.7735)"}},"light-green":{solid:"#40c057",note:{fill:"#21581D",text:"#f2f2f2"},semi:"#2a3830",pattern:"#4e874e",highlight:{srgb:"#00a000",p3:"color(display-p3 0.2711 0.6172 0.0195)"}},"light-red":{solid:"#ff8787",note:{fill:"#923632",text:"#f2f2f2"},semi:"#3b3235",pattern:"#a56767",highlight:{srgb:"#db005b",p3:"color(display-p3 0.7849 0.0585 0.3589)"}},"light-violet":{solid:"#e599f7",note:{fill:"#762F8E",text:"#f2f2f2"},semi:"#383442",pattern:"#9770a9",highlight:{srgb:"#c400c7",p3:"color(display-p3 0.7024 0.0403 0.753)"}},orange:{solid:"#f76707",note:{fill:"#843906",text:"#f2f2f2"},semi:"#3a2e2a",pattern:"#9f552d",highlight:{srgb:"#d07a00",p3:"color(display-p3 0.7699 0.4937 0.0085)"}},red:{solid:"#e03131",note:{fill:"#89231A",text:"#f2f2f2"},semi:"#36292b",pattern:"#8f3734",highlight:{srgb:"#de002c",p3:"color(display-p3 0.7978 0.0509 0.2035)"}},violet:{solid:"#ae3ec9",note:{fill:"#681683",text:"#f2f2f2"},semi:"#31293c",pattern:"#763a8b",highlight:{srgb:"#9e00ee",p3:"color(display-p3 0.5651 0.0079 0.8986)"}},yellow:{solid:"#ffc034",note:{fill:"#98571B",text:"#f2f2f2"},semi:"#3c3934",pattern:"#fecb92",highlight:{srgb:"#d2b700",p3:"color(display-p3 0.8078 0.7225 0.0312)"}},white:{solid:"#f3f3f3",semi:"#f5f5f5",pattern:"#f9f9f9",note:{fill:"#eaeaea",text:"#1d1d1d"},highlight:{srgb:"#ffffff",p3:"color(display-p3 1 1 1)"}}}};function ol(n){return n.isDarkMode?ei.darkMode:ei.lightMode}const jt=Se.defineEnum("tldraw:color",{defaultValue:"black",values:So}),xo=Se.defineEnum("tldraw:labelColor",{defaultValue:"black",values:So}),ys=Se.defineEnum("tldraw:dash",{defaultValue:"draw",values:["draw","solid","dashed","dotted"]}),Ir=Se.defineEnum("tldraw:fill",{defaultValue:"none",values:["none","semi","solid","pattern"]}),Ss=Se.defineEnum("tldraw:font",{defaultValue:"draw",values:["draw","sans","serif","mono"]}),pf={draw:"'tldraw_draw', sans-serif",sans:"'tldraw_sans', sans-serif",serif:"'tldraw_serif', serif",mono:"'tldraw_mono', monospace"},Ft=Se.defineEnum("tldraw:size",{defaultValue:"m",values:["s","m","l","xl"]}),wo=["arrow","triangle","square","dot","pipe","diamond","inverted","bar","none"],al=Se.defineEnum("tldraw:arrowheadStart",{defaultValue:"none",values:wo}),cl=Se.defineEnum("tldraw:arrowheadEnd",{defaultValue:"arrow",values:wo}),ti=yr("type",{binding:q({type:Re("binding"),boundShapeId:Ke,normalizedAnchor:Cn,isExact:H,isPrecise:H}),point:q({type:Re("point"),x:B,y:B})}),ll={labelColor:xo,color:jt,fill:Ir,dash:ys,size:Ft,arrowheadStart:al,arrowheadEnd:cl,font:Ss,start:ti,end:ti,bend:B,text:K,labelPosition:B},Ls=nt("arrow",{AddLabelColor:1,AddIsPrecise:2,AddLabelPosition:3}),dl={sequence:[{id:Ls.AddLabelColor,up:n=>{n.labelColor="black"},down:te},{id:Ls.AddIsPrecise,up:({start:n,end:t})=>{n.type==="binding"&&(n.isPrecise=!(n.normalizedAnchor.x===.5&&n.normalizedAnchor.y===.5)),t.type==="binding"&&(t.isPrecise=!(t.normalizedAnchor.x===.5&&t.normalizedAnchor.y===.5))},down:({start:n,end:t})=>{n.type==="binding"&&(n.isPrecise||(n.normalizedAnchor={x:.5,y:.5}),delete n.isPrecise),t.type==="binding"&&(t.isPrecise||(t.normalizedAnchor={x:.5,y:.5}),delete t.isPrecise)}},{id:Ls.AddLabelPosition,up:n=>{n.labelPosition=.5},down:n=>{delete n.labelPosition}}]},hl={w:Ae,h:Ae,assetId:ms.nullable(),url:tt},ni=nt("bookmark",{NullAssetId:1,MakeUrlsValid:2}),ul={sequence:[{id:ni.NullAssetId,up:n=>{n.assetId===void 0&&(n.assetId=null)},down:te},{id:ni.MakeUrlsValid,up:n=>{tt.isValid(n.url)||(n.url="")},down:n=>{}}]},bo=q({type:uo("free","straight"),points:ye(Cn)}),pl={color:jt,fill:Ir,dash:ys,size:Ft,segments:ye(bo),isComplete:H,isClosed:H,isPen:H},fl=nt("draw",{AddInPen:1}),gl={sequence:[{id:fl.AddInPen,up:n=>{const{points:t}=n.segments[0];if(t.length===0){n.isPen=!1;return}let e=!(t[0].z===0||t[0].z===.5);t[1]&&(e=e&&!(t[1].z===0||t[1].z===.5)),n.isPen=e},down:te}]};var ml={};const si=/(^\/r\/[^/]+\/?$)/,Z=n=>{try{return new URL(n)}catch{return}},yl=[{type:"tldraw",title:"tldraw",hostnames:["beta.tldraw.com","tldraw.com","localhost:3000"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,overridePermissions:{"allow-top-navigation":!0},toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(si))return n},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(si))return n}},{type:"figma",title:"Figma",hostnames:["figma.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{if(n.match(/https:\/\/([\w\.-]+\.)?figma.com\/(file|proto)\/([0-9a-zA-Z]{22,128})(?:\/.*)?$/)&&!n.includes("figma.com/embed"))return`https://www.figma.com/embed?embed_host=share&url=${n}`},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/?$/)){const e=t.searchParams.get("url");if(e)return e}}},{type:"google_maps",title:"Google Maps",hostnames:["google.*"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{if(n.includes("/maps/")){const t=n.match(/@(.*),(.*),(.*)z/);let e;if(t){const[,s,r,i]=t;e=`https://${new URL(n).host.replace("www.","")}/maps/embed/v1/view?key=${ml.NEXT_PUBLIC_GC_API_KEY}&center=${s},${r}&zoom=${i}`}else e="";return e}},fromEmbedUrl:n=>{const t=Z(n);if(!t)return;if(t.pathname.match(/^\/maps\/embed\/v1\/view\/?$/)&&t.searchParams.has("center")&&t.searchParams.get("zoom")){const s=t.searchParams.get("zoom"),[r,i]=t.searchParams.get("center").split(",");return`https://www.google.com/maps/@${r},${i},${s}z`}}},{type:"val_town",title:"Val Town",hostnames:["val.town"],minWidth:260,minHeight:100,width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/v\/([^/]+)\/?/);if(e)return`https://www.val.town/embed/${e[1]}`},fromEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/embed\/([^/]+)\/?/);if(e)return`https://www.val.town/v/${e[1]}`}},{type:"codesandbox",title:"CodeSandbox",hostnames:["codesandbox.io"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/s\/([^/]+)\/?/);if(e)return`https://codesandbox.io/embed/${e[1]}`},fromEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/embed\/([^/]+)\/?/);if(e)return`https://codesandbox.io/s/${e[1]}`}},{type:"codepen",title:"Codepen",hostnames:["codepen.io"],minWidth:300,minHeight:300,width:520,height:400,doesResize:!0,toEmbedUrl:n=>{const t=/https:\/\/codepen.io\/([^/]+)\/pen\/([^/]+)/,e=n.match(t);if(e){const[s,r,i]=e;return`https://codepen.io/${r}/embed/${i}`}},fromEmbedUrl:n=>{const t=/https:\/\/codepen.io\/([^/]+)\/embed\/([^/]+)/,e=n.match(t);if(e){const[s,r,i]=e;return`https://codepen.io/${r}/pen/${i}`}}},{type:"scratch",title:"Scratch",hostnames:["scratch.mit.edu"],width:520,height:400,doesResize:!1,toEmbedUrl:n=>{const t=/https?:\/\/scratch.mit.edu\/projects\/([^/]+)/,e=n.match(t);if(e){const[s,r]=e;return`https://scratch.mit.edu/projects/embed/${r}`}},fromEmbedUrl:n=>{const t=/https:\/\/scratch.mit.edu\/projects\/embed\/([^/]+)/,e=n.match(t);if(e){const[s,r]=e;return`https://scratch.mit.edu/projects/${r}`}}},{type:"youtube",title:"YouTube",hostnames:["*.youtube.com","youtube.com","youtu.be"],width:800,height:450,doesResize:!0,overridePermissions:{"allow-presentation":!0},isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(!t)return;const e=t.hostname.replace(/^www./,"");if(e==="youtu.be")return`https://www.youtube.com/embed/${t.pathname.split("/").filter(Boolean)[0]}`;if((e==="youtube.com"||e==="m.youtube.com")&&t.pathname.match(/^\/watch/))return`https://www.youtube.com/embed/${t.searchParams.get("v")}`},fromEmbedUrl:n=>{const t=Z(n);if(!t)return;if(t.hostname.replace(/^www./,"")==="youtube.com"){const s=t.pathname.match(/^\/embed\/([^/]+)\/?/);if(s)return`https://www.youtube.com/watch?v=${s[1]}`}}},{type:"google_calendar",title:"Google Calendar",hostnames:["calendar.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,instructionLink:"https://support.google.com/calendar/answer/41207?hl=en",toEmbedUrl:n=>{const t=Z(n),e=t==null?void 0:t.searchParams.get("cid");if(t!=null&&t.pathname.match(/\/calendar\/u\/0/)&&e){t.pathname="/calendar/embed";const s=Array.from(t.searchParams.keys());for(const r of s)t.searchParams.delete(r);return t.searchParams.set("src",e),t.href}},fromEmbedUrl:n=>{const t=Z(n),e=t==null?void 0:t.searchParams.get("src");if(t!=null&&t.pathname.match(/\/calendar\/embed/)&&e){t.pathname="/calendar/u/0";const s=Array.from(t.searchParams.keys());for(const r of s)t.searchParams.delete(r);return t.searchParams.set("cid",e),t.href}}},{type:"google_slides",title:"Google Slides",hostnames:["docs.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t!=null&&t.pathname.match(/^\/presentation/)&&(t!=null&&t.pathname.match(/\/pub\/?$/))){t.pathname=t.pathname.replace(/\/pub$/,"/embed");const e=Array.from(t.searchParams.keys());for(const s of e)t.searchParams.delete(s);return t.href}},fromEmbedUrl:n=>{const t=Z(n);if(t!=null&&t.pathname.match(/^\/presentation/)&&(t!=null&&t.pathname.match(/\/embed\/?$/))){t.pathname=t.pathname.replace(/\/embed$/,"/pub");const e=Array.from(t.searchParams.keys());for(const s of e)t.searchParams.delete(s);return t.href}}},{type:"github_gist",title:"GitHub Gist",hostnames:["gist.github.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/([^/]+)\/([^/]+)/))return n.split("/").pop()?n:void 0},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/([^/]+)\/([^/]+)/))return n.split("/").pop()?n:void 0}},{type:"replit",title:"Replit",hostnames:["replit.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/@([^/]+)\/([^/]+)/))return`${n}?embed=true`},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/@([^/]+)\/([^/]+)/)&&t.searchParams.has("embed"))return t.searchParams.delete("embed"),t.href}},{type:"felt",title:"Felt",hostnames:["felt.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/map\//))return t.origin+"/embed"+t.pathname},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/map\//))return t.pathname=t.pathname.replace(/^\/embed/,""),t.href}},{type:"spotify",title:"Spotify",hostnames:["open.spotify.com"],width:720,height:500,minHeight:500,overrideOutlineRadius:12,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/(artist|album)\//))return t.origin+"/embed"+t.pathname},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/(artist|album)\//))return t.origin+t.pathname.replace(/^\/embed/,"")}},{type:"vimeo",title:"Vimeo",hostnames:["vimeo.com","player.vimeo.com"],width:640,height:360,doesResize:!0,isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="vimeo.com"&&t.pathname.match(/^\/[0-9]+/))return"https://player.vimeo.com/video/"+t.pathname.split("/")[1]+"?title=0&byline=0"},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="player.vimeo.com"){const e=t.pathname.match(/^\/video\/([^/]+)\/?$/);if(e)return"https://vimeo.com/"+e[1]}}},{type:"excalidraw",title:"Excalidraw",hostnames:["excalidraw.com"],width:720,height:500,doesResize:!0,isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.hash.match(/#room=/))return n},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.hash.match(/#room=/))return n}},{type:"observable",title:"Observable",hostnames:["observablehq.com"],width:720,height:500,doesResize:!0,isAspectRatioLocked:!1,backgroundColor:"#fff",toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/@([^/]+)\/([^/]+)\/?$/))return`${t.origin}/embed${t.pathname}?cell=*`;if(t&&t.pathname.match(/^\/d\/([^/]+)\/?$/)){const e=t.pathname.replace(/^\/d/,"");return`${t.origin}/embed${e}?cell=*`}},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/@([^/]+)\/([^/]+)\/?$/))return`${t.origin}${t.pathname.replace("/embed","")}#cell-*`;if(t&&t.pathname.match(/^\/embed\/([^/]+)\/?$/))return`${t.origin}${t.pathname.replace("/embed","/d")}#cell-*`}}],ff={"allow-downloads-without-user-activation":!1,"allow-downloads":!1,"allow-modals":!1,"allow-orientation-lock":!1,"allow-pointer-lock":!1,"allow-popups":!0,"allow-popups-to-escape-sandbox":!1,"allow-presentation":!1,"allow-storage-access-by-user-activation":!1,"allow-top-navigation":!1,"allow-top-navigation-by-user-activation":!1,"allow-scripts":!0,"allow-same-origin":!0,"allow-forms":!0},Sl={w:Ae,h:Ae,url:K},On=nt("embed",{GenOriginalUrlInEmbed:1,RemoveDoesResize:2,RemoveTmpOldUrl:3,RemovePermissionOverrides:4}),xl={sequence:[{id:On.GenOriginalUrlInEmbed,up:n=>{try{const t=n.url,e=new URL(t).host.replace("www.","");let s;for(const r of yl)if(r.hostnames.includes(e))try{s=r.fromEmbedUrl(t)}catch(i){console.warn(i)}n.tmpOldUrl=n.url,n.url=s??""}catch{n.url="",n.tmpOldUrl=n.url}},down:te},{id:On.RemoveDoesResize,up:n=>{delete n.doesResize},down:te},{id:On.RemoveTmpOldUrl,up:n=>{delete n.tmpOldUrl},down:te},{id:On.RemovePermissionOverrides,up:n=>{delete n.overridePermissions},down:te}]},wl={w:Ae,h:Ae,name:K},bl={sequence:[]},Pr=Se.defineEnum("tldraw:horizontalAlign",{defaultValue:"middle",values:["start","middle","end","start-legacy","end-legacy","middle-legacy"]}),Io=Se.defineEnum("tldraw:verticalAlign",{defaultValue:"middle",values:["start","middle","end"]}),Il=Se.defineEnum("tldraw:geo",{defaultValue:"rectangle",values:["cloud","rectangle","ellipse","triangle","diamond","pentagon","hexagon","octagon","star","rhombus","rhombus-2","oval","trapezoid","arrow-right","arrow-left","arrow-up","arrow-down","x-box","check-box"]}),Pl={geo:Il,labelColor:xo,color:jt,fill:Ir,dash:ys,size:Ft,font:Ss,align:Pr,verticalAlign:Io,url:tt,w:Ae,h:Ae,growY:ts,text:K},gt=nt("geo",{AddUrlProp:1,AddLabelColor:2,RemoveJustify:3,AddCheckBox:4,AddVerticalAlign:5,MigrateLegacyAlign:6,AddCloud:7,MakeUrlsValid:8}),vl={sequence:[{id:gt.AddUrlProp,up:n=>{n.url=""},down:te},{id:gt.AddLabelColor,up:n=>{n.labelColor="black"},down:te},{id:gt.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:te},{id:gt.AddCheckBox,up:n=>{},down:te},{id:gt.AddVerticalAlign,up:n=>{n.verticalAlign="middle"},down:te},{id:gt.MigrateLegacyAlign,up:n=>{let t;switch(n.align){case"start":t="start-legacy";break;case"end":t="end-legacy";break;default:t="middle-legacy";break}n.align=t},down:te},{id:gt.AddCloud,up:n=>{},down:te},{id:gt.MakeUrlsValid,up:n=>{tt.isValid(n.url)||(n.url="")},down:n=>{}}]},Po={},vo={sequence:[]},Cl={color:jt,size:Ft,segments:ye(bo),isComplete:H,isPen:H},_l={sequence:[]},El=q({topLeft:Cn,bottomRight:Cn}),Tl={w:Ae,h:Ae,playing:H,url:tt,assetId:ms.nullable(),crop:El.nullable()},Bs=nt("image",{AddUrlProp:1,AddCropProp:2,MakeUrlsValid:3}),kl={sequence:[{id:Bs.AddUrlProp,up:n=>{n.url=""},down:te},{id:Bs.AddCropProp,up:n=>{n.crop=null},down:n=>{delete n.crop}},{id:Bs.MakeUrlsValid,up:n=>{tt.isValid(n.url)||(n.url="")},down:n=>{}}]},Ml=Se.defineEnum("tldraw:spline",{defaultValue:"line",values:["cubic","line"]}),Al=q({id:K,index:Sr,x:B,y:B}),Rl={color:jt,dash:ys,size:Ft,spline:Ml,points:hc(K,Al)},jn=nt("line",{AddSnapHandles:1,RemoveExtraHandleProps:2,HandlesToPoints:3,PointIndexIds:4}),Dl={sequence:[{id:jn.AddSnapHandles,up:n=>{for(const t of Object.values(n.handles))t.canSnap=!0},down:te},{id:jn.RemoveExtraHandleProps,up:n=>{n.handles=ur(Object.values(n.handles).map(t=>[t.index,{x:t.x,y:t.y}]))},down:n=>{const t=Object.entries(n.handles).map(([e,s])=>({index:e,...s})).sort(ze);n.handles=Object.fromEntries(t.map((e,s)=>{const r=s===0?"start":s===t.length-1?"end":`handle:${e.index}`;return[r,{id:r,type:"vertex",canBind:!1,canSnap:!0,index:e.index,x:e.x,y:e.y}]}))}},{id:jn.HandlesToPoints,up:n=>{const t=Object.entries(n.handles).map(([e,{x:s,y:r}])=>({x:s,y:r,index:e})).sort(ze);n.points=t.map(({x:e,y:s})=>({x:e,y:s})),delete n.handles},down:n=>{const t=Js(n.points.length);n.handles=Object.fromEntries(n.points.map((e,s)=>[t[s],{x:e.x,y:e.y}])),delete n.points}},{id:jn.PointIndexIds,up:n=>{const t=Js(n.points.length);n.points=Object.fromEntries(n.points.map((e,s)=>{const r=t[s];return[r,{id:r,index:r,x:e.x,y:e.y}]}))},down:n=>{const t=Object.values(n.points).sort(ze);n.points=t.map(({x:e,y:s})=>({x:e,y:s}))}}]},Ol={color:jt,size:Ft,font:Ss,fontSizeAdjustment:ts,align:Pr,verticalAlign:Io,growY:ts,url:tt,text:K},Nt=nt("note",{AddUrlProp:1,RemoveJustify:2,MigrateLegacyAlign:3,AddVerticalAlign:4,MakeUrlsValid:5,AddFontSizeAdjustment:6}),jl={sequence:[{id:Nt.AddUrlProp,up:n=>{n.url=""},down:te},{id:Nt.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:te},{id:Nt.MigrateLegacyAlign,up:n=>{switch(n.align){case"start":n.align="start-legacy";return;case"end":n.align="end-legacy";return;default:n.align="middle-legacy";return}},down:te},{id:Nt.AddVerticalAlign,up:n=>{n.verticalAlign="middle"},down:te},{id:Nt.MakeUrlsValid,up:n=>{tt.isValid(n.url)||(n.url="")},down:n=>{}},{id:Nt.AddFontSizeAdjustment,up:n=>{n.fontSizeAdjustment=0},down:n=>{delete n.fontSizeAdjustment}}]},Fl={color:jt,size:Ft,font:Ss,align:Pr,w:Ae,text:K,scale:Ae,autoSize:H},Ll=nt("text",{RemoveJustify:1}),Bl={sequence:[{id:Ll.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:te}]},zl={w:Ae,h:Ae,time:B,playing:H,url:tt,assetId:ms.nullable()},ri=nt("video",{AddUrlProp:1,MakeUrlsValid:2}),Nl={sequence:[{id:ri.AddUrlProp,up:n=>{n.url=""},down:te},{id:ri.MakeUrlsValid,up:n=>{tt.isValid(n.url)||(n.url="")},down:n=>{}}]},Fn=Le("com.tldraw.store",{RemoveCodeAndIconShapeTypes:1,AddInstancePresenceType:2,RemoveTLUserAndPresenceAndAddPointer:3,RemoveUserDocument:4}),Ul=wn({sequenceId:"com.tldraw.store",retroactive:!1,sequence:[{id:Fn.RemoveCodeAndIconShapeTypes,scope:"store",up:n=>{for(const[t,e]of Ve(n))e.typeName==="shape"&&(e.type==="icon"||e.type==="code")&&delete n[t]}},{id:Fn.AddInstancePresenceType,scope:"store",up(n){}},{id:Fn.RemoveTLUserAndPresenceAndAddPointer,scope:"store",up:n=>{for(const[t,e]of Ve(n))e.typeName.match(/^(user|user_presence)$/)&&delete n[t]}},{id:Fn.RemoveUserDocument,scope:"store",up:n=>{for(const[t,e]of Ve(n))e.typeName.match("user_document")&&delete n[t]}}]}),$l={arrow:{migrations:dl,props:ll},bookmark:{migrations:ul,props:hl},draw:{migrations:gl,props:pl},embed:{migrations:xl,props:Sl},frame:{migrations:bl,props:wl},geo:{migrations:vl,props:Pl},group:{migrations:vo,props:Po},highlight:{migrations:_l,props:Cl},image:{migrations:kl,props:Tl},line:{migrations:Dl,props:Rl},note:{migrations:jl,props:Ol},text:{migrations:Bl,props:Fl},video:{migrations:Nl,props:zl}};function Hl({shapes:n=$l,migrations:t}={}){const e=new Map;for(const i of oe(n))for(const o of yo(i.props??{}).keys()){if(e.has(o.id)&&e.get(o.id)!==o)throw new Error(`Multiple StyleProp instances with the same id: ${o.id}`);e.set(o.id,o)}const s=il(n),r=_c(e);return gr.create({asset:el,camera:Ie,document:br,instance:r,instance_page_state:ge,page:En,instance_presence:Lc,pointer:wr,shape:s},{migrations:[Ul,Jc,yc,zc,Ec,Ac,Cc,Fc,Oc,sl,Xc,qc,Vc,...rl(n),...t??[]],onValidationFailure:Uc,createIntegrityChecker:Hc})}const ii=[{locale:"ca",label:"Catal"},{locale:"cs",label:"etina"},{locale:"da",label:"Danish"},{locale:"de",label:"Deutsch"},{locale:"en",label:"English"},{locale:"es",label:"Espaol"},{locale:"fr",label:"Franais"},{locale:"gl",label:"Galego"},{locale:"hr",label:"Hrvatski"},{locale:"it",label:"Italiano"},{locale:"hu",label:"Magyar"},{locale:"no",label:"Norwegian"},{locale:"pl",label:"Polski"},{locale:"pt-br",label:"Portugus - Brasil"},{locale:"pt-pt",label:"Portugus - Europeu"},{locale:"ro",label:"Romn"},{locale:"ru",label:"Russian"},{locale:"sl",label:"Slovenina"},{locale:"fi",label:"Suomi"},{locale:"sv",label:"Svenska"},{locale:"vi",label:"Ting Vit"},{locale:"tr",label:"Trke"},{locale:"uk",label:"Ukrainian"},{locale:"he",label:""},{locale:"ar",label:""},{locale:"fa",label:""},{locale:"ku",label:""},{locale:"ne",label:""},{locale:"hi-in",label:""},{locale:"te",label:""},{locale:"th",label:""},{locale:"my",label:""},{locale:"ko-kr",label:""},{locale:"ja",label:""},{locale:"zh-cn",label:""},{locale:"zh-tw",label:" ()"}];function Kl(){const n=typeof window<"u"?window.navigator.languages??["en"]:["en"];return Yl(n)}function Yl(n){for(const t of n){const e=Xl(t);if(e)return e}return"en"}const oi={zh:"zh-cn",pt:"pt-br",ko:"ko-kr",hi:"hi-in"};function Xl(n){const t=ii.find(r=>r.locale===n.toLowerCase());if(t)return t.locale;const[e,s]=n.split(/[-_]/).map(r=>r.toLowerCase());if(s){const r=ii.find(i=>i.locale===e);if(r)return r.locale}return e in oi?oi[e]:null}const Gl={error:null};class Co extends M.Component{constructor(){super(...arguments);u(this,"state",Gl)}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e){var s,r;(r=(s=this.props).onError)==null||r.call(s,e)}render(){const{error:e}=this.state;if(e!==null){const{fallback:s}=this.props;return S.jsx(s,{error:e})}return this.props.children}}function Tn({children:n,fallback:t,...e}){return t===null?S.jsx(S.Fragment,{children:n}):S.jsx(Co,{fallback:t,...e,children:n})}const xs=ht.createContext({});function N(){return ht.useContext(xs)}function ql(){return S.jsx("div",{className:"tl-background"})}function An(n,t,e,s,r,i){M.useLayoutEffect(()=>{const o=n.current;if(!o||t===void 0)return;let a=`translate(${t}px, ${e}px)`;s!==void 0&&(a+=` scale(${s})`),r!==void 0&&(a+=` rotate(${r}rad)`),i&&(a+=` translate(${i.x}px, ${i.y}px)`),o.style.transform=a})}const ss={linear:n=>n,easeInQuad:n=>n*n,easeOutQuad:n=>n*(2-n),easeInOutQuad:n=>n<.5?2*n*n:-1+(4-2*n)*n,easeInCubic:n=>n*n*n,easeOutCubic:n=>--n*n*n+1,easeInOutCubic:n=>n<.5?4*n*n*n:(n-1)*(2*n-2)*(2*n-2)+1,easeInQuart:n=>n*n*n*n,easeOutQuart:n=>1- --n*n*n*n,easeInOutQuart:n=>n<.5?8*n*n*n*n:1-8*--n*n*n*n,easeInQuint:n=>n*n*n*n*n,easeOutQuint:n=>1+--n*n*n*n*n,easeInOutQuint:n=>n<.5?16*n*n*n*n*n:1+16*--n*n*n*n*n,easeInSine:n=>1-Math.cos(n*Math.PI/2),easeOutSine:n=>Math.sin(n*Math.PI/2),easeInOutSine:n=>-(Math.cos(Math.PI*n)-1)/2,easeInExpo:n=>n<=0?0:Math.pow(2,10*n-10),easeOutExpo:n=>n>=1?1:1-Math.pow(2,-10*n),easeInOutExpo:n=>n<=0?0:n>=1?1:n<.5?Math.pow(2,20*n-10)/2:(2-Math.pow(2,-20*n+10))/2};class m{constructor(t=0,e=0,s=1){this.x=t,this.y=e,this.z=s}get pressure(){return this.z}set(t=this.x,e=this.y,s=this.z){return this.x=t,this.y=e,this.z=s,this}setTo({x:t=0,y:e=0,z:s=1}){return this.x=t,this.y=e,this.z=s,this}rot(t){if(t===0)return this;const{x:e,y:s}=this,r=Math.sin(t),i=Math.cos(t);return this.x=e*i-s*r,this.y=e*r+s*i,this}rotWith(t,e){if(e===0)return this;const s=this.x-t.x,r=this.y-t.y,i=Math.sin(e),o=Math.cos(e);return this.x=t.x+(s*o-r*i),this.y=t.y+(s*i+r*o),this}clone(){const{x:t,y:e,z:s}=this;return new m(t,e,s)}sub(t){return this.x-=t.x,this.y-=t.y,this}subXY(t,e){return this.x-=t,this.y-=e,this}subScalar(t){return this.x-=t,this.y-=t,this}add(t){return this.x+=t.x,this.y+=t.y,this}addXY(t,e){return this.x+=t,this.y+=e,this}addScalar(t){return this.x+=t,this.y+=t,this}clamp(t,e){return this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),e!==void 0&&(this.x=Math.min(this.x,e),this.y=Math.min(this.y,e)),this}div(t){return this.x/=t,this.y/=t,this}divV(t){return this.x/=t.x,this.y/=t.y,this}mul(t){return this.x*=t,this.y*=t,this}mulV(t){return this.x*=t.x,this.y*=t.y,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}nudge(t,e){const s=m.Tan(t,this);return this.add(s.mul(e))}neg(){return this.x*=-1,this.y*=-1,this}cross(t){return this.x=this.y*t.z-this.z*t.y,this.y=this.z*t.x-this.x*t.z,this}dpr(t){return m.Dpr(this,t)}cpr(t){return m.Cpr(this,t)}len2(){return m.Len2(this)}len(){return m.Len(this)}pry(t){return m.Pry(this,t)}per(){const{x:t,y:e}=this;return this.x=e,this.y=-t,this}uni(){return m.Uni(this)}tan(t){return m.Tan(this,t)}dist(t){return m.Dist(this,t)}distanceToLineSegment(t,e){return m.DistanceToLineSegment(t,e,this)}slope(t){return m.Slope(this,t)}snapToGrid(t){return this.x=Math.round(this.x/t)*t,this.y=Math.round(this.y/t)*t,this}angle(t){return m.Angle(this,t)}toAngle(){return m.ToAngle(this)}lrp(t,e){return this.x=this.x+(t.x-this.x)*e,this.y=this.y+(t.y-this.y)*e,this}equals(t){return m.Equals(this,t)}equalsXY(t,e){return m.EqualsXY(this,t,e)}norm(){const t=this.len();return this.x=t===0?0:this.x/t,this.y=t===0?0:this.y/t,this}toFixed(){return m.ToFixed(this)}toString(){return m.ToString(m.ToFixed(this))}toJson(){return m.ToJson(this)}toArray(){return m.ToArray(this)}static Add(t,e){return new m(t.x+e.x,t.y+e.y)}static AddXY(t,e,s){return new m(t.x+e,t.y+s)}static Sub(t,e){return new m(t.x-e.x,t.y-e.y)}static SubXY(t,e,s){return new m(t.x-e,t.y-s)}static AddScalar(t,e){return new m(t.x+e,t.y+e)}static SubScalar(t,e){return new m(t.x-e,t.y-e)}static Div(t,e){return new m(t.x/e,t.y/e)}static Mul(t,e){return new m(t.x*e,t.y*e)}static DivV(t,e){return new m(t.x/e.x,t.y/e.y)}static MulV(t,e){return new m(t.x*e.x,t.y*e.y)}static Neg(t){return new m(-t.x,-t.y)}static Per(t){return new m(t.y,-t.x)}static Abs(t){return new m(Math.abs(t.x),Math.abs(t.y))}static Dist(t,e){return((t.y-e.y)**2+(t.x-e.x)**2)**.5}static DistMin(t,e,s){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)<s**2}static Dist2(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}static Dpr(t,e){return t.x*e.x+t.y*e.y}static Cross(t,e){return new m(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z)}static Cpr(t,e){return t.x*e.y-e.x*t.y}static Len2(t){return t.x*t.x+t.y*t.y}static Len(t){return(t.x*t.x+t.y*t.y)**.5}static Pry(t,e){return m.Dpr(t,e)/m.Len(e)}static Uni(t){return m.Div(t,m.Len(t))}static Tan(t,e){return m.Uni(m.Sub(t,e))}static Min(t,e){return new m(Math.min(t.x,e.x),Math.min(t.y,e.y))}static Max(t,e){return new m(Math.max(t.x,e.x),Math.max(t.y,e.y))}static From({x:t,y:e,z:s=1}){return new m(t,e,s)}static FromArray(t){return new m(t[0],t[1])}static Rot(t,e=0){const s=Math.sin(e),r=Math.cos(e);return new m(t.x*r-t.y*s,t.x*s+t.y*r)}static RotWith(t,e,s){const r=t.x-e.x,i=t.y-e.y,o=Math.sin(s),a=Math.cos(s);return new m(e.x+(r*a-i*o),e.y+(r*o+i*a))}static NearestPointOnLineThroughPoint(t,e,s){return m.Mul(e,m.Sub(s,t).pry(e)).add(t)}static NearestPointOnLineSegment(t,e,s,r=!0){if(m.Equals(t,s)||m.Equals(e,s))return m.From(s);const i=m.Tan(e,t),o=m.Add(t,m.Mul(i,m.Sub(s,t).pry(i)));if(r){if(o.x<Math.min(t.x,e.x))return m.Cast(t.x<e.x?t:e);if(o.x>Math.max(t.x,e.x))return m.Cast(t.x>e.x?t:e);if(o.y<Math.min(t.y,e.y))return m.Cast(t.y<e.y?t:e);if(o.y>Math.max(t.y,e.y))return m.Cast(t.y>e.y?t:e)}return o}static DistanceToLineThroughPoint(t,e,s){return m.Dist(s,m.NearestPointOnLineThroughPoint(t,e,s))}static DistanceToLineSegment(t,e,s,r=!0){return m.Dist(s,m.NearestPointOnLineSegment(t,e,s,r))}static Snap(t,e=1){return new m(Math.round(t.x/e)*e,Math.round(t.y/e)*e)}static Cast(t){return t instanceof m?t:m.From(t)}static Slope(t,e){return t.x===e.y?NaN:(t.y-e.y)/(t.x-e.x)}static IsNaN(t){return isNaN(t.x)||isNaN(t.y)}static Angle(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}static Lrp(t,e,s){return m.Sub(e,t).mul(s).add(t)}static Med(t,e){return new m((t.x+e.x)/2,(t.y+e.y)/2)}static Equals(t,e){return Math.abs(t.x-e.x)<1e-4&&Math.abs(t.y-e.y)<1e-4}static EqualsXY(t,e,s){return t.x===e&&t.y===s}static Clockwise(t,e,s){return(s.x-t.x)*(e.y-t.y)-(e.x-t.x)*(s.y-t.y)<0}static Rescale(t,e){const s=m.Len(t);return new m(e*t.x/s,e*t.y/s)}static ScaleWithOrigin(t,e,s){return m.Sub(t,s).mul(e).add(s)}static ToFixed(t,e=2){return new m(+t.x.toFixed(e),+t.y.toFixed(e),+t.z.toFixed(e))}static Nudge(t,e,s){return m.Add(t,m.Tan(e,t).mul(s))}static ToString(t){return`${t.x}, ${t.y}`}static ToAngle(t){let e=Math.atan2(t.y,t.x);return e<0&&(e+=Math.PI*2),e}static FromAngle(t,e=1){return new m(Math.cos(t)*e,Math.sin(t)*e)}static ToArray(t){return[t.x,t.y,t.z]}static ToJson(t){const{x:e,y:s,z:r}=t;return{x:e,y:s,z:r}}static Average(t){const e=t.length,s=new m(0,0);if(e===0)return s;for(let r=0;r<e;r++)s.add(t[r]);return s.div(e)}static Clamp(t,e,s){return s===void 0?new m(Math.min(Math.max(t.x,e)),Math.min(Math.max(t.y,e))):new m(Math.min(Math.max(t.x,e),s),Math.min(Math.max(t.y,e),s))}static PointsBetween(t,e,s=6){const r=[];for(let i=0;i<s;i++){const o=ss.easeInQuad(i/(s-1)),a=m.Lrp(t,e,o);a.z=Math.min(1,.5+Math.abs(.5-Wl(o))*.65),r.push(a)}return r}static SnapToGrid(t,e=8){return new m(Math.round(t.x/e)*e,Math.round(t.y/e)*e)}}const Wl=n=>n<.5?2*n*n:-1+(4-2*n)*n;function Ut(n){return`${ce(n.x)},${ce(n.y)} `}function $t(n,t){return`${ce((n.x+t.x)/2)},${ce((n.y+t.y)/2)} `}const ue=Math.PI,kn=ue/2,ee=ue*2,gf=Math.sin;function rs(n,t,e){return Math.max(t,typeof e<"u"?Math.min(n,e):n)}function Ln(n,t=1e10){return n?Math.round(n*t)/t:0}function _o(n,t,e=1e-6){return Math.abs(n-t)<=e}function mf(n,t){const e=Math.pow(n-t,2)/Math.pow(n+t,2);return ue*(n+t)*(1+3*e/(10+Math.sqrt(4-3*e)))}function rr(n){return n=n%ee,n<0?n=n+ee:n===0&&(n=0),n}function ws(n,t){return n=rr(n),t=rr(t),n>t&&(t+=ee),t-n}function Eo(n,t){return ee-ws(n,t)}function zs(n,t){const e=(t-n)%ee;return 2*e%ee-e}function ir(n){return(ee+n)%ee}function yf(n,t){const e=ee/t;let s=Math.floor((ir(n)+e/2)/e)*e%ee;return s<ue&&(s+=ee),s>ue&&(s-=ee),s}function Vl(n,t){return n===t||_o(n%(Math.PI/2)-t%(Math.PI/2),0)}function Sf(n){return n*ue/180}function Zl(n){return n*180/ue}function To(n,t,e){return new m(n.x,n.y).add(m.FromAngle(e,t))}function xf(n,t,e){const s=n/2,r=t/2,i=[];let o=1/0,a=-1/0,c=1/0,l=-1/0;for(let y=0;y<e;y++){const g=ee/e,x=-kn+y*g,w=s+s*Math.cos(x),I=r+r*Math.sin(x);w<o&&(o=w),I<c&&(c=I),w>a&&(a=w),I>l&&(l=I),i.push(new m(w,I))}const d=a-o,h=l-c,p=n-d,f=t-h;if(p!==0||f!==0)for(let y=0;y<i.length;y++){const g=i[y];g.x=(g.x-o)/d*n,g.y=(g.y-c)/h*t}return i}function un(n,t,e,s){return n<s&&e<t}function Ye(n,t,e,s){const r=Math.max(n,e),i=Math.min(t,s);return r<=i?[r,i]:null}function ai(n,t,e){return(t.x-n.x)*(e.y-n.y)-(e.x-n.x)*(t.y-n.y)}function Dt(n,t){let e=0,s,r;for(let i=0;i<t.length;i++){if(s=t[i],s.x===n.x&&s.y===n.y||(r=t[(i+1)%t.length],m.Dist(n,s)+m.Dist(n,r)===m.Dist(s,r)))return!0;s.y<=n.y?r.y>n.y&&ai(s,r,n)>0&&(e+=1):r.y<=n.y&&ai(s,r,n)<0&&(e-=1)}return e!==0}function ce(n){return Math.round(n*1e4)/1e4}function wf(n){return Math.round(n*100)/100}const ci=n=>Math.abs(n)<Number.MAX_SAFE_INTEGER;function bf(n,t,e){return e<0?ws(n,t):Eo(n,t)}function li(n,t,e,s){let r;if(Math.abs(n)>ue){r=zs(t,s);const i=zs(s,e);return Math.abs(r)<Math.abs(i)?r/n:(n-i)/n}else{r=zs(t,s);const i=r/n;return Math.sign(r)!==Math.sign(n)?Math.abs(i)>.5?1:0:i}}function Ql(n,t,e,s){const r=2*((t-n)%ee)%ee-(t-n)%ee;return s?(ee-Math.abs(r))*(e?1:-1):r}const Bn=({brush:n,color:t,opacity:e,className:s})=>{const r=M.useRef(null);An(r,n.x,n.y);const i=ce(Math.max(1,n.w)),o=ce(Math.max(1,n.h));return S.jsx("svg",{className:"tl-overlays__item",ref:r,children:t?S.jsxs("g",{className:"tl-brush",opacity:e,children:[S.jsx("rect",{width:i,height:o,fill:t,opacity:.75}),S.jsx("rect",{width:i,height:o,fill:"none",stroke:t,opacity:.1})]}):S.jsx("rect",{className:`tl-brush tl-brush__default ${s}`,width:i,height:o})})},ct=2e3,di=40,Jl=320,Ht=[.1,.25,.5,1,2,4,8],pn=.1,Yt=8,ed=.5,td=.1,nd=.2,sd=.005,rd=.05,id=450,od=200,or=36,ar=16,ad=32,hi={};for(let n=1;n<=Math.ceil(Yt);n++)hi[n+"_dark"]=`hash_pattern_zoom_${n}_dark`,hi[n+"_light"]=`hash_pattern_zoom_${n}_light`;const cd={duration:0,easing:ss.easeInOutCubic},Ns=.09,ui=[{min:-1,mid:.15,step:64},{min:.05,mid:.375,step:16},{min:.15,mid:1,step:4},{min:.7,mid:2.5,step:1}],ld=6e4,ko=3e3,dd=1200,pi={CAMERA_MOVE:-10},hd=64,ud=8,pd=20,fd=8,gd=12,Mo=20,Ao=12,md=["top","right","bottom","left"],yd=500,fi=.35;var Us={};const If={},Ro=Oe("pointerCaptureTrackingObject",{defaults:{all:new Map},shouldStoreForSession:!1}),Ge={logPreventDefaults:Oe("logPreventDefaults",{defaults:{all:!1}}),logPointerCaptures:Oe("logPointerCaptures",{defaults:{all:!1}}),logElementRemoves:Oe("logElementRemoves",{defaults:{all:!1}}),debugSvg:Oe("debugSvg",{defaults:{all:!1}}),showFps:Oe("showFps",{defaults:{all:!1}}),throwToBlob:Oe("throwToBlob",{defaults:{all:!1}}),reconnectOnPing:Oe("reconnectOnPing",{defaults:{all:!1}}),debugCursors:Oe("debugCursors",{defaults:{all:!1}}),forceSrgb:Oe("forceSrgbColors",{defaults:{all:!1}}),debugGeometry:Oe("debugGeometry",{defaults:{all:!1}}),hideShapes:Oe("hideShapes",{defaults:{all:!1}}),editOnType:Oe("editOnType",{defaults:{all:!1}})};if(typeof Element<"u"){const n=Element.prototype.removeChild;ls("element removal logging",()=>{Ge.logElementRemoves.get()?Element.prototype.removeChild=function(t){return console.warn("[tldraw] removing child:",t),n.call(this,t)}:Element.prototype.removeChild=n})}function Oe(n,{defaults:t,shouldStoreForSession:e=!0}){return Sd({name:n,defaults:t,shouldStoreForSession:e})}function Sd(n){const t=wd(n),e=n.shouldStoreForSession?xd(n.name):null,s=Te(`debug:${n.name}`,e??t);return typeof window<"u"&&(n.shouldStoreForSession&&ls(`debug:${n.name}`,()=>{const r=s.get();r===t?no(`tldraw_debug:${n.name}`):pr(`tldraw_debug:${n.name}`,JSON.stringify(r))}),Object.defineProperty(window,`tldraw${n.name.replace(/^[a-z]/,r=>r.toUpperCase())}`,{get(){return s.get()},set(r){s.set(r)},configurable:!0})),Object.assign(s,n)}function xd(n){try{return JSON.parse(to(`tldraw_debug:${n}`)??"null")}catch{return null}}function $s(n){try{return n()}catch{return null}}function wd(n){switch($s(()=>Us.TLDRAW_ENV)??$s(()=>Us.VERCEL_PUBLIC_TLDRAW_ENV)??$s(()=>Us.NEXT_PUBLIC_TLDRAW_ENV)??"production"){case"production":return n.defaults.production??n.defaults.all;case"preview":case"staging":return n.defaults.staging??n.defaults.all;default:return n.defaults.development??n.defaults.all}}function is(n){if(n instanceof HTMLElement)return n;if(n.parentElement)return is(n.parentElement);throw Error("Could not find a parent element of an HTML type!")}function fe(n){n.preventDefault(),Ge.logPreventDefaults.get()&&console.warn("preventDefault called on event:",n)}function vr(n,t){if(n.setPointerCapture(t.pointerId),Ge.logPointerCaptures.get()){const e=Ro.get();e.set(n,(e.get(n)??0)+1),console.warn("setPointerCapture called on element:",n,t)}}function Cr(n,t){if(n.hasPointerCapture(t.pointerId)&&(n.releasePointerCapture(t.pointerId),Ge.logPointerCaptures.get())){const e=Ro.get();e.get(n)===1?e.delete(n):e.has(n)?e.set(n,e.get(n)-1):console.warn("Release without capture"),console.warn("releasePointerCapture called on element:",n,t)}}const bs=n=>n.stopPropagation(),pe=(n,t,e)=>{n&&n.style.setProperty(t,e)};function qe(n){return n.isKilled=!0,{point:{x:n.clientX,y:n.clientY,z:n.pressure},shiftKey:n.shiftKey,altKey:n.altKey,ctrlKey:n.metaKey||n.ctrlKey,pointerId:n.pointerId,button:n.button,isPen:n.pointerType==="pen"}}function bd(){const n=N();return M.useMemo(function(){let s,r;function i(g){if(!g.isKilled){if(g.button===2){n.dispatch({type:"pointer",target:"canvas",name:"right_click",...qe(g)});return}g.button!==0&&g.button!==1&&g.button!==5||(vr(g.currentTarget,g),n.dispatch({type:"pointer",target:"canvas",name:"pointer_down",...qe(g)}),n.getOpenMenus().length>0&&(n.updateInstanceState({openMenus:[]}),document.body.click(),n.getContainer().focus()))}}function o(g){g.isKilled||g.clientX===s&&g.clientY===r||(s=g.clientX,r=g.clientY,n.dispatch({type:"pointer",target:"canvas",name:"pointer_move",...qe(g)}))}function a(g){g.isKilled||g.button!==0&&g.button!==1&&g.button!==2&&g.button!==5||(s=g.clientX,r=g.clientY,Cr(g.currentTarget,g),n.dispatch({type:"pointer",target:"canvas",name:"pointer_up",...qe(g)}))}function c(g){if(g.isKilled||n.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const x=g.pointerType==="mouse"||g.pointerType==="pen";n.updateInstanceState({isHoveringCanvas:x?!0:null})}function l(g){if(g.isKilled||n.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const x=g.pointerType==="mouse"||g.pointerType==="pen";n.updateInstanceState({isHoveringCanvas:x?!1:null})}function d(g){g.isKilled=!0,document.body.click(),fe(g)}function h(g){g.isKilled=!0,g.target.tagName!=="A"&&g.target.tagName!=="TEXTAREA"&&!(n.getEditingShape()&&g.target.className.includes("tl-text-content"))&&fe(g)}function p(g){fe(g)}async function f(g){var w,I;if(fe(g),!((I=(w=g.dataTransfer)==null?void 0:w.files)!=null&&I.length))return;const x=Array.from(g.dataTransfer.files);await n.putExternalContent({type:"files",files:x,point:n.screenToPage({x:g.clientX,y:g.clientY}),ignoreParent:!1})}function y(g){bs(g)}return{onPointerDown:i,onPointerMove:o,onPointerUp:a,onPointerEnter:c,onPointerLeave:l,onDragOver:p,onDrop:f,onTouchStart:d,onTouchEnd:h,onClick:y}},[n])}function Id(){const n=N();M.useEffect(()=>{if(n.environment.isFirefox&&!n.environment.isAndroid&&!n.environment.isIos){n.updateInstanceState({isCoarsePointer:!1});return}if(window.matchMedia){const t=window.matchMedia("(pointer: coarse)"),e=()=>{n.updateInstanceState({isCoarsePointer:!!t.matches})};if(e(),t)return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}},[n])}const Do=M.createContext(null);function Pd({container:n,children:t}){return S.jsx(Do.Provider,{value:n,children:t})}function It(){return Gt(M.useContext(Do),"useContainer used outside of <Tldraw />")}function vd(){const n=N(),t=It(),e=z("isFocused",()=>n.getInstanceState().isFocused,[n]);M.useEffect(()=>{if(typeof matchMedia===void 0)return;let s=null;const r=()=>{s!=null&&s();const i=`(resolution: ${window.devicePixelRatio}dppx)`,o=matchMedia(i),a=c=>{c.type==="change"&&r()};o.addEventListener?o.addEventListener("change",r):o.addListener&&o.addListener(a),s=()=>{o.removeEventListener?o.removeEventListener("change",r):o.removeListener&&o.removeListener(a)},n.updateInstanceState({devicePixelRatio:window.devicePixelRatio})};return r(),()=>{s==null||s()}},[n]),M.useEffect(()=>{if(!e)return;const s=a=>{if(a.altKey&&(n.isIn("zoom")||!n.getPath().endsWith(".idle"))&&!zn()&&fe(a),a.isKilled)return;switch(a.isKilled=!0,a.key){case"=":case"-":case"0":{if(a.metaKey||a.ctrlKey){fe(a);return}break}case"Tab":{if(zn()||n.getIsMenuOpen())return;break}case",":return;case"Escape":{if((n.getEditingShape()||n.getSelectedShapeIds().length>0)&&a.preventDefault(),n.getOpenMenus().length>0)return;n.inputs.keys.has("Escape")||(n.inputs.keys.add("Escape"),n.cancel(),t.focus());return}default:if(zn()||n.getIsMenuOpen())return}const c={type:"keyboard",name:a.repeat?"key_repeat":"key_down",key:a.key,code:a.code,shiftKey:a.shiftKey,altKey:a.altKey,ctrlKey:a.metaKey||a.ctrlKey};n.dispatch(c)},r=a=>{if(a.isKilled||(a.isKilled=!0,zn()||n.getIsMenuOpen())||a.key===",")return;const c={type:"keyboard",name:"key_up",key:a.key,code:a.code,shiftKey:a.shiftKey,altKey:a.altKey,ctrlKey:a.metaKey||a.ctrlKey};n.dispatch(c)};function i(a){var c,l;if(t.contains(a.target)){const d=a.touches[0].pageX,h=a.touches[0].radiusX||0;(d-h<10||d+h>n.getViewportScreenBounds().width-10)&&(((c=a.target)==null?void 0:c.tagName)==="BUTTON"&&((l=a.target)==null||l.click()),fe(a))}}const o=a=>{t.contains(a.target)&&(a.ctrlKey||a.metaKey)&&fe(a)};return t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("wheel",o,{passive:!1}),document.addEventListener("gesturestart",fe),document.addEventListener("gesturechange",fe),document.addEventListener("gestureend",fe),t.addEventListener("keydown",s),t.addEventListener("keyup",r),()=>{t.removeEventListener("touchstart",i),t.removeEventListener("wheel",o),document.removeEventListener("gesturestart",fe),document.removeEventListener("gesturechange",fe),document.removeEventListener("gestureend",fe),t.removeEventListener("keydown",s),t.removeEventListener("keyup",r)}},[n,t,e])}const Cd=["input","select","button","textarea"];function zn(){const{activeElement:n}=document;return!!(n&&(n.getAttribute("contenteditable")||Cd.indexOf(n.tagName.toLowerCase())>-1))}const _d=["textarea","input"];function Ed(n){const t=N();M.useEffect(()=>{const e=n.current;if(!e)return;const s=r=>{var i;if(r instanceof PointerEvent&&r.pointerType==="pen"){r.isKilled=!0;const{target:o}=r;if(_d.includes((i=o.tagName)==null?void 0:i.toLocaleLowerCase())||t.isIn("select.editing_shape"))return;fe(r)}};return e.addEventListener("touchstart",s),e.addEventListener("touchend",s),()=>{e.removeEventListener("touchstart",s),e.removeEventListener("touchend",s)}},[t,n])}const gi=10,Td=/Mac|iPod|iPhone|iPad/.test(typeof window>"u"?"node":window.navigator.platform);function kd(n){let{deltaY:t,deltaX:e}=n,s=0;if(n.ctrlKey||n.altKey||n.metaKey){const r=Math.sign(n.deltaY),i=Math.abs(n.deltaY);let o=t;i>gi&&(o=gi*r),s=o/100}else n.shiftKey&&!Td&&(e=t,t=0);return{x:-e,y:-t,z:-s}}const Md=pa([fa,ga]);let Kt;const Ad=n=>Kt===void 0?(Kt=n,!1):n-Kt>120&&n-Kt<160?(Kt=n,!0):(Kt=n,!1);function Rd(n){const t=N(),e=M.useMemo(()=>{let s="not sure";const r=({event:g})=>{if(!t.getInstanceState().isFocused||(s="not sure",Ad(Date.now())))return;const x=t.getEditingShapeId();if(x){const b=t.getShape(x);if(b&&t.getShapeUtil(b).canScroll(b)){const v=t.getShapePageBounds(x);if(v!=null&&v.containsPoint(t.inputs.currentPagePoint))return}}fe(g),bs(g);const w=kd(g);if(w.x===0&&w.y===0)return;const I={type:"wheel",name:"wheel",delta:w,point:new m(g.clientX,g.clientY),shiftKey:g.shiftKey,altKey:g.altKey,ctrlKey:g.metaKey||g.ctrlKey};t.dispatch(I)};let i=1,o=1,a=1,c=0;const l=new m,d=new m,h=g=>{const x=n.current;s="not sure";const{event:w,origin:I,da:b}=g;w instanceof WheelEvent||(w.target===x||x!=null&&x.contains(w.target))&&(d.x=I[0],d.y=I[1],l.x=I[0],l.y=I[1],i=b[0],o=t.getZoomLevel(),t.dispatch({type:"pinch",name:"pinch_start",point:{x:I[0],y:I[1],z:t.getZoomLevel()},delta:{x:0,y:0},shiftKey:w.shiftKey,altKey:w.altKey,ctrlKey:w.metaKey||w.ctrlKey}))},p=g=>{if(g&&(s="zooming"),s==="zooming")return;const x=Math.abs(c-i),w=m.Dist(l,d);switch(s){case"not sure":{x>24?s="zooming":w>16&&(s="panning");break}case"panning":{x>64&&(s="zooming");break}}};return{onWheel:r,onPinchStart:h,onPinchEnd:g=>{const x=n.current,{event:w,origin:I,offset:b}=g;if(w instanceof WheelEvent||!(w.target===x||x!=null&&x.contains(w.target)))return;const P=b[0];s="not sure",requestAnimationFrame(()=>{t.dispatch({type:"pinch",name:"pinch_end",point:{x:I[0],y:I[1],z:P},delta:{x:I[0],y:I[1]},shiftKey:w.shiftKey,altKey:w.altKey,ctrlKey:w.metaKey||w.ctrlKey})})},onPinch:g=>{const x=n.current,{event:w,origin:I,offset:b,da:P}=g;if(w instanceof WheelEvent||!(w.target===x||x!=null&&x.contains(w.target)))return;const v=g.type==="gesturechange"||g.type==="gestureend";c=P[0];const C=I[0]-d.x,E=I[1]-d.y;switch(d.x=I[0],d.y=I[1],p(v),s){case"zooming":{a=b[0],t.dispatch({type:"pinch",name:"pinch",point:{x:I[0],y:I[1],z:a},delta:{x:C,y:E},shiftKey:w.shiftKey,altKey:w.altKey,ctrlKey:w.metaKey||w.ctrlKey});break}case"panning":{t.dispatch({type:"pinch",name:"pinch",point:{x:I[0],y:I[1],z:o},delta:{x:C,y:E},shiftKey:w.shiftKey,altKey:w.altKey,ctrlKey:w.metaKey||w.ctrlKey});break}}}}},[t,n]);Md(e,{target:n,eventOptions:{passive:!1},pinch:{from:()=>[t.getZoomLevel(),0],scaleBounds:()=>({from:t.getZoomLevel(),max:8,min:.05})}})}function Hs(n,t,e){const s=n.getShape(t),r=n.getShapeHandles(s);return{shape:s,handle:r.find(i=>i.id===e)}}function Dd(n,t){const e=N();return M.useMemo(()=>{const s=c=>{if(c.isKilled)return;const l=is(c.currentTarget);vr(l,c);const{shape:d,handle:h}=Hs(e,n,t);h&&e.dispatch({type:"pointer",target:"handle",handle:h,shape:d,name:"pointer_down",...qe(c)})};let r,i;return{onPointerDown:s,onPointerMove:c=>{if(c.isKilled||c.clientX===r&&c.clientY===i)return;r=c.clientX,i=c.clientY;const{shape:l,handle:d}=Hs(e,n,t);d&&e.dispatch({type:"pointer",target:"handle",handle:d,shape:l,name:"pointer_move",...qe(c)})},onPointerUp:c=>{if(c.isKilled)return;const l=is(c.currentTarget);Cr(l,c);const{shape:d,handle:h}=Hs(e,n,t);h&&e.dispatch({type:"pointer",target:"handle",handle:h,shape:d,name:"pointer_up",...qe(c)})}}},[e,n,t])}const Q=class Q{constructor(t=0,e=0,s=0,r=0){u(this,"x",0);u(this,"y",0);u(this,"w",0);u(this,"h",0);this.x=t,this.y=e,this.w=s,this.h=r}get point(){return new m(this.x,this.y)}set point(t){this.x=t.x,this.y=t.y}get minX(){return this.x}set minX(t){this.x=t}get midX(){return this.x+this.w/2}get maxX(){return this.x+this.w}get minY(){return this.y}set minY(t){this.y=t}get midY(){return this.y+this.h/2}get maxY(){return this.y+this.h}get width(){return this.w}set width(t){this.w=t}get height(){return this.h}set height(t){this.h=t}get aspectRatio(){return this.width/this.height}get center(){return new m(this.midX,this.midY)}set center(t){this.minX=t.x-this.width/2,this.minY=t.y-this.height/2}get corners(){return[new m(this.minX,this.minY),new m(this.maxX,this.minY),new m(this.maxX,this.maxY),new m(this.minX,this.maxY)]}get cornersAndCenter(){return[new m(this.minX,this.minY),new m(this.maxX,this.minY),new m(this.maxX,this.maxY),new m(this.minX,this.maxY),this.center]}get sides(){const{corners:t}=this;return[[t[0],t[1]],[t[1],t[2]],[t[2],t[3]],[t[3],t[0]]]}get size(){return new m(this.w,this.h)}toFixed(){return this.x=Ln(this.x),this.y=Ln(this.y),this.w=Ln(this.w),this.h=Ln(this.h),this}setTo(t){return this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h,this}set(t=0,e=0,s=0,r=0){return this.x=t,this.y=e,this.w=s,this.h=r,this}expand(t){const e=Math.min(this.minX,t.minX),s=Math.min(this.minY,t.minY),r=Math.max(this.maxX,t.maxX),i=Math.max(this.maxY,t.maxY);return this.x=e,this.y=s,this.w=r-e,this.h=i-s,this}expandBy(t){return this.x-=t,this.y-=t,this.w+=t*2,this.h+=t*2,this}scale(t){return this.x/=t,this.y/=t,this.w/=t,this.h/=t,this}clone(){const{x:t,y:e,w:s,h:r}=this;return new Q(t,e,s,r)}translate(t){return this.x+=t.x,this.y+=t.y,this}snapToGrid(t){const e=Math.round(this.minX/t)*t,s=Math.round(this.minY/t)*t,r=Math.round(this.maxX/t)*t,i=Math.round(this.maxY/t)*t;this.minX=e,this.minY=s,this.width=Math.max(1,r-e),this.height=Math.max(1,i-s)}collides(t){return Q.Collides(this,t)}contains(t){return Q.Contains(this,t)}includes(t){return Q.Includes(this,t)}containsPoint(t,e=0){return Q.ContainsPoint(this,t,e)}getHandlePoint(t){switch(t){case"top_left":return new m(this.minX,this.minY);case"top_right":return new m(this.maxX,this.minY);case"bottom_left":return new m(this.minX,this.maxY);case"bottom_right":return new m(this.maxX,this.maxY);case"top":return new m(this.midX,this.minY);case"right":return new m(this.maxX,this.midY);case"bottom":return new m(this.midX,this.maxY);case"left":return new m(this.minX,this.midY)}}toJson(){return{x:this.minX,y:this.minY,w:this.w,h:this.h}}resize(t,e,s){const{minX:r,minY:i,maxX:o,maxY:a}=this;let{minX:c,minY:l,maxX:d,maxY:h}=this;switch(t){case"left":case"top_left":case"bottom_left":{c+=e;break}case"right":case"top_right":case"bottom_right":{d+=e;break}}switch(t){case"top":case"top_left":case"top_right":{l+=s;break}case"bottom":case"bottom_left":case"bottom_right":{h+=s;break}}const p=(d-c)/(o-r),f=(h-l)/(a-i),y=p<0,g=f<0;if(y){const x=d;d=c,c=x}if(g){const x=h;h=l,l=x}this.minX=c,this.minY=l,this.width=Math.abs(d-c),this.height=Math.abs(h-l)}union(t){const e=Math.min(this.minX,t.x),s=Math.min(this.minY,t.y),r=Math.max(this.maxX,t.w+t.x),i=Math.max(this.maxY,t.h+t.y);return this.x=e,this.y=s,this.width=r-e,this.height=i-s,this}static From(t){return new Q(t.x,t.y,t.w,t.h)}static FromCenter(t,e){return new Q(t.x-e.x/2,t.y-e.y/2,e.x,e.y)}static FromPoints(t){if(t.length===0)return new Q;let e=1/0,s=1/0,r=-1/0,i=-1/0,o;for(let a=0,c=t.length;a<c;a++)o=t[a],e=Math.min(o.x,e),s=Math.min(o.y,s),r=Math.max(o.x,r),i=Math.max(o.y,i);return new Q(e,s,r-e,i-s)}static Expand(t,e){const s=Math.min(e.minX,t.minX),r=Math.min(e.minY,t.minY),i=Math.max(e.maxX,t.maxX),o=Math.max(e.maxY,t.maxY);return new Q(s,r,i-s,o-r)}static ExpandBy(t,e){return new Q(t.minX-e,t.minY-e,t.width+e*2,t.height+e*2)}static Resize(t,e,s,r,i=!1){const{minX:o,minY:a,maxX:c,maxY:l}=t;let{minX:d,minY:h,maxX:p,maxY:f}=t;switch(e){case"left":case"top_left":case"bottom_left":{d+=s;break}case"right":case"top_right":case"bottom_right":{p+=s;break}}switch(e){case"top":case"top_left":case"top_right":{h+=r;break}case"bottom":case"bottom_left":case"bottom_right":{f+=r;break}}const y=(p-d)/(c-o),g=(f-h)/(l-a),x=y<0,w=g<0;if(i){const b=(c-o)/(l-a),P=Math.abs(p-d),v=Math.abs(f-h),C=P*(g<0?1:-1)*(1/b),E=v*(y<0?1:-1)*b,A=b<P/v;switch(e){case"top_left":{A?h=f+C:d=p+E;break}case"top_right":{A?h=f+C:p=d-E;break}case"bottom_right":{A?f=h-C:p=d-E;break}case"bottom_left":{A?f=h-C:d=p+E;break}case"bottom":case"top":{const _=(d+p)/2,k=v*b;d=_-k/2,p=_+k/2;break}case"left":case"right":{const _=(h+f)/2,k=P/b;h=_-k/2,f=_+k/2;break}}}if(x){const b=p;p=d,d=b}if(w){const b=f;f=h,h=b}const I=new Q(d,h,Math.abs(p-d),Math.abs(f-h));return{box:I,scaleX:+(I.width/t.width*(y>0?1:-1)).toFixed(5),scaleY:+(I.height/t.height*(g>0?1:-1)).toFixed(5)}}equals(t){return Q.Equals(this,t)}static Equals(t,e){return e.x===t.x&&e.y===t.y&&e.w===t.w&&e.h===t.h}zeroFix(){return this.w=Math.max(1,this.w),this.h=Math.max(1,this.h),this}static ZeroFix(t){return new Q(t.x,t.y,Math.max(1,t.w),Math.max(1,t.h))}};u(Q,"Collides",(t,e)=>!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)),u(Q,"Contains",(t,e)=>t.minX<e.minX&&t.minY<e.minY&&t.maxY>e.maxY&&t.maxX>e.maxX),u(Q,"Includes",(t,e)=>Q.Collides(t,e)||Q.Contains(t,e)),u(Q,"ContainsPoint",(t,e,s=0)=>!(e.x<t.minX-s||e.y<t.minY-s||e.x>t.maxX+s||e.y>t.maxY+s)),u(Q,"Common",t=>{let e=1/0,s=1/0,r=-1/0,i=-1/0;for(let o=0;o<t.length;o++){const a=t[o];e=Math.min(e,a.minX),s=Math.min(s,a.minY),r=Math.max(r,a.maxX),i=Math.max(i,a.maxY)}return new Q(e,s,r-e,i-s)}),u(Q,"Sides",(t,e=0)=>{const{corners:s}=t;return[[s[0],s[1]],[s[1],s[2]],[s[2],s[3]],[s[3],s[0]]]});let $=Q;function Od(n){switch(n){case"top":return"bottom";case"bottom":return"top";case"top_left":return"bottom_left";case"top_right":return"bottom_right";case"bottom_left":return"top_left";case"bottom_right":return"top_right";default:return n}}function jd(n){switch(n){case"left":return"right";case"right":return"left";case"top_left":return"top_right";case"top_right":return"top_left";case"bottom_left":return"bottom_right";case"bottom_right":return"bottom_left";default:return n}}function Fd(n){return n==="top_left"||n==="top_right"||n==="bottom_right"||n==="bottom_left"}function Ld(n){const t=N();M.useLayoutEffect(()=>{let e=new $;function s(){const l=n.current;if(!l)return null;const d=l.getBoundingClientRect(),h=new $(d.left||d.x,d.top||d.y,Math.max(d.width,1),Math.max(d.height,1));e.equals(h)||(t.updateViewportScreenBounds(h),e=h)}s();const r=ma(s,200,{trailing:!0}),i=setInterval(r,1e3);window.addEventListener("resize",r);const o=new ResizeObserver(l=>{l[0].contentRect&&r()}),a=n.current;let c=null;return a&&(o.observe(a),c=Bd(a),c.addEventListener("scroll",r)),()=>{clearInterval(i),window.removeEventListener("resize",r),o.disconnect(),c==null||c.removeEventListener("scroll",r)}},[t,n])}/*!
 * Author: excalidraw
 * MIT License: https://github.com/excalidraw/excalidraw/blob/master/LICENSE
 * https://github.com/excalidraw/excalidraw/blob/48c3465b19f10ec755b3eb84e21a01a468e96e43/packages/excalidraw/utils.ts#L600
 */const Bd=n=>{let t=n.parentElement;for(;t;){if(t===document.body)return document;const{overflowY:e}=window.getComputedStyle(t);if(t.scrollHeight>t.clientHeight&&(e==="auto"||e==="scroll"||e==="overlay"))return t;t=t.parentElement}return document},W=class W{constructor(t,e,s,r,i,o){u(this,"a",1);u(this,"b",0);u(this,"c",0);u(this,"d",1);u(this,"e",0);u(this,"f",0);this.a=t,this.b=e,this.c=s,this.d=r,this.e=i,this.f=o}equals(t){return this===t||this.a===t.a&&this.b===t.b&&this.c===t.c&&this.d===t.d&&this.e===t.e&&this.f===t.f}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0,this}multiply(t){const e=t,{a:s,b:r,c:i,d:o,e:a,f:c}=this;return this.a=s*e.a+i*e.b,this.c=s*e.c+i*e.d,this.e=s*e.e+i*e.f+a,this.b=r*e.a+o*e.b,this.d=r*e.c+o*e.d,this.f=r*e.e+o*e.f+c,this}rotate(t,e,s){return t===0?this:e===void 0?this.multiply(W.Rotate(t)):this.translate(e,s).multiply(W.Rotate(t)).translate(-e,-s)}translate(t,e){return this.multiply(W.Translate(t,e))}scale(t,e){return this.multiply(W.Scale(t,e))}invert(){const{a:t,b:e,c:s,d:r,e:i,f:o}=this,a=t*r-e*s;return this.a=r/a,this.b=e/-a,this.c=s/-a,this.d=t/a,this.e=(r*i-s*o)/-a,this.f=(e*i-t*o)/a,this}applyToPoint(t){return W.applyToPoint(this,t)}applyToPoints(t){return W.applyToPoints(this,t)}rotation(){return W.Rotation(this)}point(){return W.Point(this)}decomposed(){return W.Decompose(this)}toCssString(){return W.toCssString(this)}setTo(t){return Object.assign(this,t),this}decompose(){return W.Decompose(this)}clone(){return new W(this.a,this.b,this.c,this.d,this.e,this.f)}static Identity(){return new W(1,0,0,1,0,0)}static Translate(t,e){return new W(1,0,0,1,t,e)}static Rotate(t,e,s){if(t===0)return W.Identity();const r=Math.cos(t),i=Math.sin(t),o=new W(r,i,-i,r,0,0);return e===void 0?o:W.Compose(W.Translate(e,s),o,W.Translate(-e,-s))}static Multiply(t,e){return{a:t.a*e.a+t.c*e.b,c:t.a*e.c+t.c*e.d,e:t.a*e.e+t.c*e.f+t.e,b:t.b*e.a+t.d*e.b,d:t.b*e.c+t.d*e.d,f:t.b*e.e+t.d*e.f+t.f}}static Inverse(t){const e=t.a*t.d-t.b*t.c;return{a:t.d/e,b:t.b/-e,c:t.c/-e,d:t.a/e,e:(t.d*t.e-t.c*t.f)/-e,f:(t.b*t.e-t.a*t.f)/e}}static Absolute(t){const e=t.a*t.d-t.b*t.c;return{a:t.d/e,b:t.b/-e,c:t.c/-e,d:t.a/e,e:(t.d*t.e-t.c*t.f)/e,f:(t.b*t.e-t.a*t.f)/-e}}static Compose(...t){const e=W.Identity();for(let s=0,r=t.length;s<r;s++)e.multiply(t[s]);return e}static Point(t){return new m(t.e,t.f)}static Rotation(t){let e;if(t.a!==0||t.c!==0){const s=(t.a*t.a+t.c*t.c)**.5;e=Math.acos(t.a/s)*(t.c>0?-1:1)}else if(t.b!==0||t.d!==0){const s=(t.b*t.b+t.d*t.d)**.5;e=kn+Math.acos(t.b/s)*(t.d>0?-1:1)}else e=0;return ir(e)}static Decompose(t){let e,s,r;if(t.a!==0||t.c!==0){const i=(t.a*t.a+t.c*t.c)**.5;e=i,s=(t.a*t.d-t.b*t.c)/i,r=Math.acos(t.a/i)*(t.c>0?-1:1)}else if(t.b!==0||t.d!==0){const i=(t.b*t.b+t.d*t.d)**.5;e=(t.a*t.d-t.b*t.c)/i,s=i,r=kn+Math.acos(t.b/i)*(t.d>0?-1:1)}else e=0,s=0,r=0;return{x:t.e,y:t.f,scaleX:e,scaleY:s,rotation:ir(r)}}static Smooth(t,e=1e10){return t.a=Math.round(t.a*e)/e,t.b=Math.round(t.b*e)/e,t.c=Math.round(t.c*e)/e,t.d=Math.round(t.d*e)/e,t.e=Math.round(t.e*e)/e,t.f=Math.round(t.f*e)/e,t}static toCssString(t){return`matrix(${ce(t.a)}, ${ce(t.b)}, ${ce(t.c)}, ${ce(t.d)}, ${ce(t.e)}, ${ce(t.f)})`}static applyToPoint(t,e){return new m(t.a*e.x+t.c*e.y+t.e,t.b*e.x+t.d*e.y+t.f,e.z)}static applyToXY(t,e,s){return[t.a*e+t.c*s+t.e,t.b*e+t.d*s+t.f]}static applyToPoints(t,e){return e.map(s=>new m(t.a*s.x+t.c*s.y+t.e,t.b*s.x+t.d*s.y+t.f,s.z))}static applyToBounds(t,e){return new $(t.e+e.minX,t.f+e.minY,e.width,e.height)}static From(t){return new W(t.a,t.b,t.c,t.d,t.e,t.f)}static Cast(t){return t instanceof W?t:W.From(t)}};u(W,"Scale",(t,e,s,r)=>{const i=new W(t,0,0,e,0,0);return s===void 0?i:W.Compose(W.Translate(s,r),i,W.Translate(-s,-r))});let F=W;function Oo(n,t){return t===0?n:Oo(t,n%t)}function jo(n){const t=n.toString().split(".")[1];if(!t)return 1;const e=Math.pow(10,t.length),s=parseInt(t,10);return e/Oo(s,e)}class Lt{constructor(t){u(this,"isFilled",!1);u(this,"isClosed",!0);u(this,"isLabel",!1);u(this,"debugColor");u(this,"ignore");u(this,"_vertices");u(this,"_bounds");u(this,"_area");this.isFilled=t.isFilled,this.isClosed=t.isClosed,this.isLabel=t.isLabel??!1,this.debugColor=t.debugColor,this.ignore=t.ignore}hitTestPoint(t,e=0,s=!1){return this.isClosed&&(this.isFilled||s)&&Dt(t,this.vertices)?!0:m.Dist2(t,this.nearestPoint(t))<=e*e}distanceToPoint(t,e=!1){return t.dist(this.nearestPoint(t))*(this.isClosed&&(this.isFilled||e)&&Dt(t,this.vertices)?-1:1)}distanceToLineSegment(t,e){if(t.equals(e))return this.distanceToPoint(t);const{vertices:s}=this;let r,i=1/0,o,a,c;for(let l=0;l<s.length;l++)a=s[l],c=m.NearestPointOnLineSegment(t,e,a,!0),o=m.Dist2(a,c),o<i&&(i=o,r=c);if(!r)throw Error("nearest point not found");return this.isClosed&&this.isFilled&&Dt(r,this.vertices)?-i:i}hitTestLineSegment(t,e,s=0){return this.distanceToLineSegment(t,e)<=s}nearestPointOnLineSegment(t,e){const{vertices:s}=this;let r,i=1/0,o,a,c;for(let l=0;l<s.length;l++)a=s[l],c=m.NearestPointOnLineSegment(t,e,a,!0),o=m.Dist2(a,c),o<i&&(i=o,r=c);if(!r)throw Error("nearest point not found");return r}isPointInBounds(t,e=0){const{bounds:s}=this;return!(t.x<s.minX-e||t.y<s.minY-e||t.x>s.maxX+e||t.y>s.maxY+e)}get vertices(){return this._vertices||(this._vertices=this.getVertices()),this._vertices}getBounds(){return $.FromPoints(this.vertices)}get bounds(){return this._bounds||(this._bounds=this.getBounds()),this._bounds}get center(){return this.bounds.center}get area(){return this._area||(this._area=this.getArea()),this._area}getArea(){if(!this.isClosed)return 0;const{vertices:t}=this;let e=0;for(let s=0,r=t.length;s<r;s++){const i=t[s],o=t[(s+1)%r];e+=i.x*o.y-o.x*i.y}return e/2}toSimpleSvgPath(){let t="";const{vertices:e}=this,s=e.length;if(s===0)return t;t+=`M${e[0].x},${e[0].y}`;for(let r=1;r<s;r++)t+=`L${e[r].x},${e[r].y}`;return this.isClosed&&(t+="Z"),t}}class Is extends Lt{constructor(e){super({...e,isClosed:!0,isFilled:!1});u(this,"children",[]);u(this,"ignoredChildren",[]);for(const s of e.children)s.ignore?this.ignoredChildren.push(s):this.children.push(s);if(this.children.length===0)throw Error("Group2d must have at least one child")}getVertices(){return this.children.filter(e=>!e.isLabel).flatMap(e=>e.vertices)}nearestPoint(e){let s=1/0,r;const{children:i}=this;if(i.length===0)throw Error("no children");let o,a;for(const c of i)o=c.nearestPoint(e),a=m.Dist2(o,e),a<s&&(s=a,r=o);if(!r)throw Error("nearest point not found");return r}distanceToPoint(e,s=!1){return Math.min(...this.children.map((r,i)=>r.distanceToPoint(e,s||i>0)))}hitTestPoint(e,s,r){return!!this.children.filter(i=>!i.isLabel).find(i=>i.hitTestPoint(e,s,r))}hitTestLineSegment(e,s,r){return!!this.children.filter(i=>!i.isLabel).find(i=>i.hitTestLineSegment(e,s,r))}getArea(){return this.children[0].area}toSimpleSvgPath(){let e="";for(const r of this.children)e+=r.toSimpleSvgPath();const s=$.FromPoints(this.vertices).corners;for(let r=0,i=s.length;r<i;r++){const o=s[r],a=s[(r-1+i)%i],c=o.dist(a),l=s[(r+1)%i],d=o.dist(l),h=o.clone().lrp(a,4/c),p=o,f=o.clone().lrp(l,4/d);e+=`M${h.x},${h.y} L${p.x},${p.y} L${f.x},${f.y} `}return e}}function zd(n=!0){const[t,e]=M.useState(0),s=N();M.useEffect(()=>{if(!n)return;const r=()=>e(i=>i+1);return s.on("tick",r),()=>{s.off("tick",r)}},[s,n])}const Nd=hs(function({showStroke:t=!0,showVertices:e=!0,showClosestPointOnOutline:s=!0}){const r=N();zd(s);const i=r.getZoomLevel(),o=r.getRenderingShapes(),{inputs:{currentPagePoint:a}}=r;return S.jsx("svg",{style:{position:"absolute",pointerEvents:"none",zIndex:999999999,top:0,left:0,overflow:"visible"},children:o.map(c=>{const l=r.getShape(c.id);if(l.type==="group")return null;const d=r.getShapeGeometry(l),h=r.getShapePageTransform(l),p=r.getPointInShapeSpace(l,a),f=d.nearestPoint(p),y=d.distanceToPoint(p,!0),g=Math.abs(y)*i,x=y<0,{vertices:w}=d;return S.jsxs("g",{transform:h.toCssString(),strokeLinecap:"round",strokeLinejoin:"round",children:[t&&S.jsx(Fo,{geometry:d}),e&&w.map((I,b)=>S.jsx("circle",{cx:I.x,cy:I.y,r:"2",fill:`hsl(${Qn(b,[0,w.length-1],[120,200])}, 100%, 50%)`,stroke:"black",strokeWidth:"1"},`v${b}`)),s&&g<150&&S.jsx("line",{x1:f.x,y1:f.y,x2:p.x,y2:p.y,opacity:1-g/150,stroke:x?"goldenrod":"dodgerblue",strokeWidth:"2"})]},c.id+"_outline")})})});function Fo({geometry:n}){return n instanceof Is?S.jsx(S.Fragment,{children:[...n.children,...n.ignoredChildren].map((t,e)=>S.jsx(Fo,{geometry:t},e))}):S.jsx("path",{stroke:n.debugColor??"red",strokeWidth:"2",fill:"none",opacity:"1",d:n.toSimpleSvgPath()})}function Ud(n){return ya(n)}function $d(){const n=N(),t=Na("userIds",()=>Ud(n.getCollaborators().map(e=>e.userId)).sort(),{isEqual:(e,s)=>{var r;return e.join(",")===((r=s.join)==null?void 0:r.call(s,","))}},[n]);return z(t)}function Hd(n){const t=N();return z(`latestPresence:${n}`,()=>t.getCollaborators().find(s=>s.userId===n),[t])??null}const Kd=hs(function(){const t=$d();return S.jsx(S.Fragment,{children:t.map(e=>S.jsx(Yd,{collaboratorId:e},e))})}),Yd=hs(function({collaboratorId:t}){const e=N(),s=Hd(t),r=Gd(s);if(!(s&&s.currentPageId===e.getCurrentPageId()))return null;switch(r){case"inactive":{const{followingUserId:i,highlightedUserIds:o}=e.getInstanceState();if(!(i===s.userId||o.includes(s.userId)))return null;break}case"idle":{const{highlightedUserIds:i}=e.getInstanceState();if(s.followingUserId===e.user.getId()&&!(s.chatMessage||i.includes(s.userId)))return null;break}}return S.jsx(Xd,{latestPresence:s})}),Xd=hs(function({latestPresence:t}){const e=N(),{CollaboratorBrush:s,CollaboratorScribble:r,CollaboratorCursor:i,CollaboratorHint:o,CollaboratorShapeIndicator:a}=re(),c=e.getZoomLevel(),l=e.getViewportPageBounds(),{userId:d,chatMessage:h,brush:p,scribbles:f,selectedShapeIds:y,userName:g,cursor:x,color:w}=t,I=!(x.x<l.minX-12/c||x.y<l.minY-16/c||x.x>l.maxX-12/c||x.y>l.maxY-16/c);return S.jsxs(S.Fragment,{children:[p&&s?S.jsx(s,{className:"tl-collaborator__brush",brush:p,color:w,opacity:.1},d+"_brush"):null,I&&i?S.jsx(i,{className:"tl-collaborator__cursor",point:x,color:w,zoom:c,name:g!=="New User"?g:null,chatMessage:h},d+"_cursor"):o?S.jsx(o,{className:"tl-collaborator__cursor-hint",point:x,color:w,zoom:c,viewport:l},d+"_cursor_hint"):null,r&&f.length?S.jsx(S.Fragment,{children:f.map(b=>S.jsx(r,{className:"tl-collaborator__scribble",scribble:b,color:w,zoom:c,opacity:b.color==="laser"?.5:.1},d+"_scribble_"+b.id))}):null,a&&y.map(b=>S.jsx(a,{className:"tl-collaborator__shape-indicator",shapeId:b,color:w,opacity:.5},d+"_"+b))]})});function mi(n){return n>ld?"inactive":n>ko?"idle":"active"}function Gd(n){const t=M.useRef((n==null?void 0:n.lastActivityTimestamp)??-1),[e,s]=M.useState(()=>mi(Date.now()-t.current));return M.useEffect(()=>{const r=setInterval(()=>{s(mi(Date.now()-t.current))},dd);return()=>clearInterval(r)},[]),n&&(t.current=n.lastActivityTimestamp),e}const Lo=M.memo(function({id:t,shape:e,util:s,index:r,backgroundIndex:i,opacity:o,dprMultiple:a}){const c=N(),{ShapeErrorFallback:l}=re(),d=M.useRef(null),h=M.useRef(null),p=M.useRef({transform:"",clipPath:"none",width:0,height:0,x:0,y:0,isCulled:!1});Rt("set shape stuff",()=>{const g=c.getShape(t);if(!g)return;const x=p.current,w=c.getShapeClipPath(t)??"none";w!==x.clipPath&&(pe(d.current,"clip-path",w),pe(h.current,"clip-path",w),x.clipPath=w);const I=c.getShapePageTransform(t),b=F.toCssString(I),P=c.getShapeGeometry(g).bounds;b!==x.transform&&(pe(d.current,"transform",b),pe(h.current,"transform",b),x.transform=b);const v=P.w%a,C=P.h%a,E=v===0?P.w:P.w+(a-v),A=C===0?P.h:P.h+(a-C);(E!==x.width||A!==x.height)&&(pe(d.current,"width",Math.max(E,a)+"px"),pe(d.current,"height",Math.max(A,a)+"px"),pe(h.current,"width",Math.max(E,a)+"px"),pe(h.current,"height",Math.max(A,a)+"px"),x.width=E,x.height=A)},[c]),Rt("set opacity and z-index",()=>{const g=d.current,x=h.current;pe(g,"opacity",o),pe(x,"opacity",o),pe(g,"z-index",r),pe(x,"z-index",i)},[o,r,i]),Rt("set display",()=>{if(!c.getShape(t))return;const w=c.getCulledShapes().has(t);w!==p.current.isCulled&&(pe(d.current,"display",w?"none":"block"),pe(h.current,"display",w?"none":"block"),p.current.isCulled=w)},[c]);const f=M.useCallback(g=>c.annotateError(g,{origin:"shape",willCrashApp:!1}),[c]);if(!e)return null;const y="fill"in e.props&&e.props.fill!=="none";return S.jsxs(S.Fragment,{children:[s.backgroundComponent&&S.jsx("div",{ref:h,className:"tl-shape tl-shape-background","data-shape-type":e.type,draggable:!1,children:S.jsx(Tn,{fallback:l,onError:f,children:S.jsx(Wd,{shape:e,util:s})})}),S.jsx("div",{ref:d,className:"tl-shape","data-shape-type":e.type,"data-shape-is-filled":y,draggable:!1,children:S.jsx(Tn,{fallback:l,onError:f,children:S.jsx(qd,{shape:e,util:s})})})]})}),qd=M.memo(function({shape:t,util:e}){return ds("InnerShape:"+t.type,()=>e.component(t))},(n,t)=>n.shape.props===t.shape.props&&n.shape.meta===t.shape.meta),Wd=M.memo(function({shape:t,util:e}){return ds("InnerShape:"+t.type,()=>{var s;return(s=e.backgroundComponent)==null?void 0:s.call(e,t)})},(n,t)=>n.shape.props===t.shape.props&&n.shape.meta===t.shape.meta);function Vd({className:n}){const t=N(),{Background:e,SvgDefs:s}=re(),r=M.useRef(null),i=M.useRef(null),o=M.useRef(null),a=It();Ld(r),vd(),Id(),Rd(r),Ed(r);const c=M.useRef({lodDisableTextOutline:!1,allowTextOutline:!0});Rt("position layers",function(){const{x:w,y:I,z:b}=t.getCamera();if(c.current.allowTextOutline&&t.environment.isSafari&&(a.style.setProperty("--tl-text-outline","none"),c.current.allowTextOutline=!1),c.current.allowTextOutline&&b<fi!==c.current.lodDisableTextOutline){const C=b<fi;a.style.setProperty("--tl-text-outline",C?"none":`0 var(--b) 0 var(--color-background), 0 var(--a) 0 var(--color-background),
				var(--b) var(--b) 0 var(--color-background), var(--a) var(--b) 0 var(--color-background),
				var(--a) var(--a) 0 var(--color-background), var(--b) var(--a) 0 var(--color-background)`),c.current.lodDisableTextOutline=C}const P=b>=1?Qn(b,[1,8],[.125,.5],!0):Qn(b,[.1,1],[-2,.125],!0),v=`scale(${ce(b)}) translate(${ce(w+P)}px,${ce(I+P)}px)`;pe(i.current,"transform",v),pe(o.current,"transform",v)},[t,a]);const l=bd(),d=z("shapeSvgDefs",()=>{const x=new Map;for(const w of oe(t.shapeUtils)){if(!w)return;const I=w.getCanvasSvgDefs();for(const{key:b,component:P}of I)x.has(b)||x.set(b,S.jsx(P,{},b))}return[...x.values()]},[t]),h=z("debug_shapes",()=>Ge.hideShapes.get(),[Ge]),p=z("debug_svg",()=>Ge.debugSvg.get(),[Ge]),f=z("debug_geometry",()=>Ge.debugGeometry.get(),[Ge]),y=z("isEditingAnything",()=>t.getEditingShapeId()!==null,[t]),g=z("isSelectingAnything",()=>!!t.getSelectedShapeIds().length,[t]);return S.jsxs("div",{ref:r,draggable:!1,"data-iseditinganything":y,"data-isselectinganything":g,className:ve("tl-canvas",n),"data-testid":"canvas",...l,children:[S.jsx("svg",{className:"tl-svg-context",children:S.jsxs("defs",{children:[d,S.jsx(dh,{}),S.jsx(hh,{}),s&&S.jsx(s,{})]})}),e&&S.jsx("div",{className:"tl-background__wrapper",children:S.jsx(e,{})}),S.jsx(Zd,{}),S.jsxs("div",{ref:i,className:"tl-html-layer tl-shapes",draggable:!1,children:[S.jsx(gh,{}),S.jsx(fh,{}),h?null:p?S.jsx(ih,{}):S.jsx(ah,{})]}),S.jsxs("div",{className:"tl-overlays",children:[S.jsxs("div",{ref:o,className:"tl-html-layer",children:[f?S.jsx(Nd,{}):null,S.jsx(nh,{}),S.jsx(Jd,{}),S.jsx(Qd,{}),S.jsx(eh,{}),S.jsx(ch,{}),S.jsx(lh,{}),S.jsx(th,{}),S.jsx(ph,{}),S.jsx(Kd,{})]}),S.jsx(mh,{})]}),S.jsx(yh,{})]})}function Zd(){const n=N(),t=z("gridSize",()=>n.getDocumentSettings().gridSize,[n]),{x:e,y:s,z:r}=z("camera",()=>n.getCamera(),[n]),i=z("isGridMode",()=>n.getInstanceState().isGridMode,[n]),{Grid:o}=re();return o&&i?S.jsx(o,{x:e,y:s,z:r,size:t}):null}function Qd(){const n=N(),t=z("scribbles",()=>n.getInstanceState().scribbles,[n]),e=z("zoomLevel",()=>n.getZoomLevel(),[n]),{Scribble:s}=re();return s&&t.length?S.jsx(S.Fragment,{children:t.map(r=>S.jsx(s,{className:"tl-user-scribble",scribble:r,zoom:e},r.id))}):null}function Jd(){const n=N(),t=z("brush",()=>n.getInstanceState().brush,[n]),{Brush:e}=re();return e&&t?S.jsx(e,{className:"tl-user-brush",brush:t}):null}function eh(){const n=N(),t=z("zoomBrush",()=>n.getInstanceState().zoomBrush,[n]),{ZoomBrush:e}=re();return e&&t?S.jsx(e,{className:"tl-user-brush tl-zoom-brush",brush:t}):null}function th(){const n=N(),t=z("snapLines",()=>n.snaps.getIndicators(),[n]),e=z("zoomLevel",()=>n.getZoomLevel(),[n]),{SnapIndicator:s}=re();return s&&t.length>0?S.jsx(S.Fragment,{children:t.map(r=>S.jsx(s,{className:"tl-user-snapline",line:r,zoom:e},r.id))}):null}function nh(){const n=N(),t=z("handles shapeIdWithHandles",()=>{const{isReadonly:e,isChangingStyle:s}=n.getInstanceState();if(e||s)return!1;const r=n.getOnlySelectedShape();return!r||!n.getShapeHandles(r)?!1:r.id},[n]);return t?S.jsx(sh,{shapeId:t}):null}function sh({shapeId:n}){const t=N(),{Handles:e}=re(),s=z("zoomLevel",()=>t.getZoomLevel(),[t]),r=z("coarse pointer",()=>t.getInstanceState().isCoarsePointer,[t]),i=z("handles transform",()=>t.getShapePageTransform(n),[t,n]),o=z("handles",()=>{const a=t.getShapeHandles(n);if(!a)return null;const c=(r?Mo:Ao)/s*2;return a.filter(l=>l.type!=="virtual"||!a.some(d=>d!==l&&d.type==="vertex"&&m.Dist(l,d)<c)).sort(l=>l.type==="vertex"?1:-1)},[t,s,r,n]);return!e||!o||!i?null:S.jsx(e,{children:S.jsx("g",{transform:F.toCssString(i),children:o.map(a=>S.jsx(rh,{shapeId:n,handle:a,zoom:s,isCoarse:r},a.id))})})}function rh({shapeId:n,handle:t,zoom:e,isCoarse:s}){const r=Dd(n,t.id),{Handle:i}=re();return i?S.jsx("g",{"aria-label":"handle",transform:`translate(${t.x}, ${t.y})`,...r,children:S.jsx(i,{shapeId:n,handle:t,zoom:e,isCoarse:s})}):null}function ih(){const n=N(),t=z("rendering shapes",()=>n.getRenderingShapes(),[n]),e=z("dpr multiple",()=>jo(Math.floor(n.getInstanceState().devicePixelRatio*100)/100),[n]);return S.jsx(S.Fragment,{children:t.map(s=>S.jsxs(M.Fragment,{children:[S.jsx(Lo,{...s,dprMultiple:e}),S.jsx(uh,{id:s.id})]},s.id+"_fragment"))})}function oh(){const n=N(),t=M.useRef(new Set);return Rt("reflow for culled shapes",()=>{const e=n.getCulledShapes();if(t.current.size===e.size&&[...e].every(r=>t.current.has(r)))return;t.current=e;const s=document.getElementsByClassName("tl-canvas");s.length!==0&&s[0].offsetHeight},[n]),null}function ah(){const n=N(),t=z("rendering shapes",()=>n.getRenderingShapes(),[n]),e=z("dpr multiple",()=>jo(Math.floor(n.getInstanceState().devicePixelRatio*100)/100),[n]);return S.jsxs(S.Fragment,{children:[t.map(s=>S.jsx(Lo,{...s,dprMultiple:e},s.id+"_shape")),n.environment.isSafari&&S.jsx(oh,{})]})}function ch(){const n=N(),t=z("rendering shapes",()=>n.getRenderingShapes(),[n]),e=M.useRef(new Set),s=z("should display selected ids",()=>{const i=e.current,o=new Set;if(n.isInAny("select.idle","select.brushing","select.scribble_brushing","select.editing_shape","select.pointing_shape","select.pointing_selection","select.pointing_handle")&&!n.getInstanceState().isChangingStyle){const a=n.getSelectedShapeIds();for(const c of a)o.add(c);if(n.isInAny("select.idle","select.editing_shape")){const c=n.getInstanceState();if(c.isHoveringCanvas&&!c.isCoarsePointer){const l=n.getHoveredShapeId();l&&o.add(l)}}}if(i.size!==o.size)return e.current=o,o;for(const a of o)if(!i.has(a))return e.current=o,o;return i},[n]),{ShapeIndicator:r}=re();return r?S.jsx(S.Fragment,{children:t.map(({id:i})=>S.jsx(r,{shapeId:i,hidden:!s.has(i)},i+"_indicator"))}):null}function lh(){const n=N(),{ShapeIndicator:t}=re(),e=z("hinting shape ids",()=>Zn(n.getHintingShapeIds()),[n]);return!e.length||!t?null:S.jsx(S.Fragment,{children:e.map(s=>S.jsx(t,{className:"tl-user-indicator__hint",shapeId:s},s+"_hinting"))})}function dh(){return S.jsxs("g",{id:"cursor",children:[S.jsxs("g",{fill:"rgba(0,0,0,.2)",transform:"translate(-11,-11)",children:[S.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),S.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),S.jsxs("g",{fill:"white",transform:"translate(-12,-12)",children:[S.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),S.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),S.jsxs("g",{fill:"currentColor",transform:"translate(-12,-12)",children:[S.jsx("path",{d:"m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z"}),S.jsx("path",{d:"m13 10.814v11.188l2.969-2.866.428-.139h4.768z"})]})]})}function hh(){return S.jsx("path",{id:"cursor_hint",fill:"currentColor",d:"M -2,-5 2,0 -2,5 Z"})}function uh({id:n}){const t=N(),[e,s]=M.useState(null),r=z("is in root",()=>{const i=t.getShape(n);return(i==null?void 0:i.parentId)===t.getCurrentPageId()},[t,n]);return M.useEffect(()=>{if(!r)return;let i=null;const o=ls("shape to svg",async()=>{const a=Math.random();i=a;const l=t.isShapeOfType(n,"frame")?0:10;let d=t.getShapePageBounds(n);if(!d)return;d=d.clone().expandBy(l);const h=await t.getSvgString([n],{padding:l,background:t.getInstanceState().exportBackground});if(i!==a||!h)return;const p=`data:image/svg+xml;utf8,${encodeURIComponent(h.svg)}`;s({src:p,bounds:d})});return()=>{i=null,o()}},[t,n,r]),!r||!e?null:S.jsx("img",{src:e.src,width:e.bounds.width,height:e.bounds.height,style:{position:"absolute",top:0,left:0,transform:`translate(${e.bounds.x}px, ${e.bounds.maxY+12}px)`,outline:"1px solid black",maxWidth:"none"}})}function ph(){const n=N(),t=z("selection rotation",()=>n.getSelectionRotation(),[n]),e=z("selection bounds",()=>n.getSelectionRotatedPageBounds(),[n]),{SelectionForeground:s}=re();return!e||!s?null:S.jsx(s,{bounds:e,rotation:t})}function fh(){const n=N(),t=z("selection rotation",()=>n.getSelectionRotation(),[n]),e=z("selection bounds",()=>n.getSelectionRotatedPageBounds(),[n]),{SelectionBackground:s}=re();return!e||!s?null:S.jsx(s,{bounds:e,rotation:t})}function gh(){const{OnTheCanvas:n}=re();return n?S.jsx(n,{}):null}function mh(){const{InFrontOfTheCanvas:n}=re();return n?S.jsx(n,{}):null}function yh(){const n=N(),t=z("camera state",()=>n.getCameraState(),[n]);return S.jsx("div",{className:ve("tl-hit-test-blocker",{"tl-hit-test-blocker__hidden":t==="idle"})})}function Sh({className:n,zoom:t,point:e,color:s,viewport:r,opacity:i=1}){const o=M.useRef(null);return An(o,rs(e.x,r.minX+5/t,r.maxX-5/t),rs(e.y,r.minY+5/t,r.maxY-5/t),1/t,m.Angle(r.center,e)),S.jsxs("svg",{ref:o,className:ve("tl-overlays__item",n),children:[S.jsx("use",{href:"#cursor_hint",color:s,strokeWidth:3,stroke:"var(--color-background)"}),S.jsx("use",{href:"#cursor_hint",color:s,opacity:i})]})}const yi=M.memo(function({className:t,zoom:e,point:s,color:r,name:i,chatMessage:o}){const a=M.useRef(null);return An(a,s==null?void 0:s.x,s==null?void 0:s.y,1/e),s?S.jsxs("div",{ref:a,className:ve("tl-overlays__item",t),children:[S.jsx("svg",{className:"tl-cursor",children:S.jsx("use",{href:"#cursor",color:r})}),o?S.jsxs(S.Fragment,{children:[i&&S.jsx("div",{className:"tl-nametag-title",style:{color:r},children:i}),S.jsx("div",{className:"tl-nametag-chat",style:{backgroundColor:r},children:o})]}):i&&S.jsx("div",{className:"tl-nametag",style:{backgroundColor:r},children:i})]}):null});function xh({x:n,y:t,z:e,size:s}){return S.jsxs("svg",{className:"tl-grid",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[S.jsx("defs",{children:ui.map(({min:r,mid:i,step:o},a)=>{const c=o*s*e,l=.5+n*e,d=.5+t*e,h=l>0?l%c:c+l%c,p=d>0?d%c:c+d%c,f=e<i?Qn(e,[r,i],[0,1]):1;return S.jsx("pattern",{id:`grid-${o}`,width:c,height:c,patternUnits:"userSpaceOnUse",children:S.jsx("circle",{className:"tl-grid-dot",cx:h,cy:p,r:1,opacity:f})},`grid-pattern-${a}`)})}),ui.map(({step:r},i)=>S.jsx("rect",{width:"100%",height:"100%",fill:`url(#grid-${r})`},`grid-rect-${i}`))]})}function wh({handle:n,isCoarse:t,className:e,zoom:s}){const r=(t?Mo:Ao)/s;if(n.type==="clone"){const o=3/Math.max(s,.35),a=`M0,${-o} A${o},${o} 0 0,1 0,${o}`,c=md.indexOf(n.id);return S.jsxs("g",{className:ve(`tl-handle tl-handle__${n.type}`,e),children:[S.jsx("circle",{className:"tl-handle__bg",r}),S.jsx("path",{className:"tl-handle__fg",d:a,transform:`rotate(${-90+90*c})`})]})}const i=(n.type==="create"&&t?3:4)/Math.max(s,.35);return S.jsxs("g",{className:ve(`tl-handle tl-handle__${n.type}`,e),children:[S.jsx("circle",{className:"tl-handle__bg",r}),S.jsx("circle",{className:"tl-handle__fg",r:i})]})}const bh=({children:n})=>S.jsx("svg",{className:"tl-user-handles tl-overlays__item",children:n});function Ih(n,t=!0){const e=n.length;if(e<2)return"";let s=n[0],r=n[1];if(e===2)return`M${Ut(s)}L${Ut(r)}`;let i="";for(let o=2,a=e-1;o<a;o++)s=n[o],r=n[o+1],i+=$t(s,r);return t?`M${$t(n[0],n[1])}Q${Ut(n[1])}${$t(n[1],n[2])}T${i}${$t(n[e-1],n[0])}${$t(n[0],n[1])}Z`:`M${Ut(n[0])}Q${Ut(n[1])}${$t(n[1],n[2])}${n.length>3?"T":""}${i}L${Ut(n[e-1])}`}function Si({scribble:n,zoom:t,color:e,opacity:s,className:r}){return n.points.length?S.jsx("svg",{className:r&&ve("tl-overlays__item",r),children:S.jsx("path",{className:"tl-scribble",d:Ih(n.points,!1),stroke:e??`var(--color-${n.color})`,fill:"none",strokeWidth:8/t,opacity:s??n.opacity})}):null}function Ph({bounds:n,rotation:t}){const e=M.useRef(null);return An(e,n.x,n.y,1,t),M.useLayoutEffect(()=>{const s=e.current;s&&(s.style.width=ce(Math.max(1,n.width))+"px",s.style.height=ce(Math.max(1,n.height))+"px")},[n.width,n.height]),S.jsx("div",{ref:e,className:"tl-selection__bg",draggable:!1})}function vh({bounds:n,rotation:t}){const e=N(),s=M.useRef(null),r=z("only selected shape",()=>e.getOnlySelectedShape(),[e]),i=r?e.getShapeUtil(r).expandSelectionOutlinePx(r):0;return An(s,n==null?void 0:n.x,n==null?void 0:n.y,1,t,{x:-i,y:-i}),n=n.clone().expandBy(i).zeroFix(),S.jsx("svg",{ref:s,className:"tl-overlays__item tl-selection__fg","data-testid":"selection-foreground",children:S.jsx("rect",{className:ve("tl-selection__fg__outline"),width:ce(n.width),height:ce(n.height)})})}const Ch=()=>S.jsx("div",{className:"tl-shape-error-boundary"}),_h=({shape:n,util:t})=>ds("Indicator: "+n.type,()=>t.indicator(n)),Eh=({editor:n,id:t})=>{const e=z("shape for indicator",()=>n.store.get(t),[n,t]),{ShapeIndicatorErrorFallback:s}=re();return!e||e.isLocked?null:S.jsx(Tn,{fallback:s,onError:r=>n.annotateError(r,{origin:"react.shapeIndicator",willCrashApp:!1}),children:S.jsx(_h,{shape:e,util:n.getShapeUtil(e)},e.id)})},xi=M.memo(function({shapeId:t,className:e,color:s,hidden:r,opacity:i}){const o=N(),a=M.useRef(null);return Rt("indicator transform",()=>{const c=a.current;if(!c)return;const l=o.getShapePageTransform(t);l&&c.style.setProperty("transform",l.toCssString())},[o,t]),M.useLayoutEffect(()=>{const c=a.current;c&&c.style.setProperty("display",r?"none":"block")},[r]),S.jsx("svg",{ref:a,className:ve("tl-overlays__item",e),children:S.jsx("g",{className:"tl-shape-indicator",stroke:s??"var(--color-selected)",opacity:i,children:S.jsx(Eh,{editor:o,id:t})})})}),Th=()=>S.jsx("circle",{cx:4,cy:4,r:8,strokeWidth:"1",stroke:"red"});function kh({points:n,zoom:t}){const e=2.5/t,s=n.reduce((p,f)=>Math.min(p,f.x),1/0),r=n.reduce((p,f)=>Math.max(p,f.x),-1/0),i=n.reduce((p,f)=>Math.min(p,f.y),1/0),o=n.reduce((p,f)=>Math.max(p,f.y),-1/0),a=n.some(p=>p.x===s&&p.y===i);let c,l,d,h;return a?(c=s,l=i,d=r,h=o):(c=s,l=o,d=r,h=i),S.jsxs("g",{className:"tl-snap-indicator",stroke:"lime",children:[S.jsx("line",{x1:c,y1:l,x2:d,y2:h}),n.map((p,f)=>S.jsx("g",{transform:`translate(${p.x},${p.y})`,children:S.jsx("path",{className:"tl-snap-point",d:`M ${-e},${-e} L ${e},${e} M ${-e},${e} L ${e},${-e}`})},f))]})}function Mh({gaps:n,direction:t,zoom:e}){const s=3.5/e;let r=[-1/0,1/0],i=null;const o=t==="horizontal";for(const c of n){if(i=Ye(r[0],r[1],o?c.startEdge[0].y:c.startEdge[0].x,o?c.startEdge[1].y:c.startEdge[1].x),i)r=i;else continue;if(i=Ye(r[0],r[1],o?c.endEdge[0].y:c.endEdge[0].x,o?c.endEdge[1].y:c.endEdge[1].x),i)r=i;else continue}if(r===null)return null;const a=(r[0]+r[1])/2;return S.jsx("g",{className:"tl-snap-indicator",stroke:"cyan",children:n.map(({startEdge:c,endEdge:l},d)=>S.jsx(M.Fragment,{children:o?S.jsxs(S.Fragment,{children:[S.jsx("line",{x1:c[0].x,y1:a-2*s,x2:c[1].x,y2:a+2*s}),S.jsx("line",{x1:l[0].x,y1:a-2*s,x2:l[1].x,y2:a+2*s}),S.jsx("line",{x1:c[0].x,y1:a,x2:l[0].x,y2:a}),S.jsx("line",{x1:(c[0].x+l[0].x)/2,y1:a-s,x2:(c[0].x+l[0].x)/2,y2:a+s})]}):S.jsxs(S.Fragment,{children:[S.jsx("line",{x1:a-2*s,y1:c[0].y,x2:a+2*s,y2:c[1].y}),S.jsx("line",{x1:a-2*s,y1:l[0].y,x2:a+2*s,y2:l[1].y}),S.jsx("line",{x1:a,y1:c[0].y,x2:a,y2:l[0].y}),S.jsx("line",{x1:a-s,y1:(c[0].y+l[0].y)/2,x2:a+s,y2:(c[0].y+l[0].y)/2})]})},d))})}function Ah({className:n,line:t,zoom:e}){return S.jsx("svg",{className:ve("tl-overlays__item",n),children:t.type==="points"?S.jsx(kh,{...t,zoom:e}):t.type==="gaps"?S.jsx(Mh,{...t,zoom:e}):null})}function Rh(){return S.jsx("svg",{width:16,height:16,viewBox:"0 0 16 16",children:S.jsxs("g",{strokeWidth:2,fill:"none",fillRule:"evenodd",children:[S.jsx("circle",{strokeOpacity:.25,cx:8,cy:8,r:7,stroke:"var(--color-text-1)"}),S.jsx("path",{strokeLinecap:"round",d:"M15 8c0-4.5-4.5-7-7-7",stroke:"var(--color-text-1)",children:S.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 8 8",to:"360 8 8",dur:"1s",repeatCount:"indefinite"})})]})})}const Dh=()=>null;function Bo(n,t){const e=M.useRef(n);return t(n,e.current)?e.current:(e.current=n,n)}function Pf(n){return Bo(n,Ua)}function Oh(n){return Bo(n,qi)}const zo=M.createContext({});function jh({overrides:n={},children:t}){const e=Oh(n);return S.jsx(zo.Provider,{value:M.useMemo(()=>({Background:ql,SvgDefs:Dh,Brush:Bn,ZoomBrush:Bn,ScreenshotBrush:Bn,CollaboratorBrush:Bn,Cursor:yi,CollaboratorCursor:yi,CollaboratorHint:Sh,CollaboratorShapeIndicator:xi,Grid:xh,Scribble:Si,SnapIndicator:Ah,Handles:bh,Handle:wh,CollaboratorScribble:Si,ErrorFallback:No,ShapeErrorFallback:Ch,ShapeIndicatorErrorFallback:Th,Spinner:Rh,SelectionBackground:Ph,SelectionForeground:vh,ShapeIndicator:xi,OnTheCanvas:null,InFrontOfTheCanvas:null,Canvas:Vd,...e}),[e]),children:t})}function re(){return M.useContext(zo)}const _r={openWindow:(n,t)=>window.open(n,t,"noopener noreferrer"),refreshPage:()=>window.location.reload(),hardReset:async()=>{var n;return await((n=window.__tldraw__hardReset)==null?void 0:n.call(window))}};function Fh(){_r.hardReset()}function Lh(){_r.refreshPage()}const Bh="https://github.com/tldraw/tldraw/issues/new";function zh(){}const No=({error:n,editor:t})=>{const e=M.useRef(null),[s,r]=M.useState(!1),[i,o]=M.useState(!1),[a,c]=M.useState(!1),{Canvas:l}=re(),d=n instanceof Error?n.message:String(n),h=n instanceof Error?n.stack:null,p=z("isDarkMode",()=>{try{if(t)return t.user.getIsDarkMode()}catch{}return null},[t]),[f,y]=M.useState(null);M.useLayoutEffect(()=>{var v;p!==null&&y(p);let b=(v=e.current)==null?void 0:v.parentElement,P=!1;for(;b;){if(b.classList.contains("tl-theme__dark")||b.classList.contains("tl-theme__light")){P=!0;break}b=b.parentElement}if(P){y(null);return}y(window.matchMedia("(prefers-color-scheme: dark)").matches)},[p]),M.useEffect(()=>{if(i){const b=setTimeout(()=>{o(!1)},2e3);return()=>clearTimeout(b)}},[i]);const g=()=>{const b=document.createElement("textarea");b.value=h??d,document.body.appendChild(b),b.select(),document.execCommand("copy"),b.remove(),o(!0)},x=()=>{Lh()},w=async()=>{Fh()},I=new URL(Bh);return I.searchParams.set("title",d),I.searchParams.set("labels","bug"),I.searchParams.set("body",`Hey, I ran into an error while using tldraw:

\`\`\`js
${h??d}
\`\`\`

My browser: ${navigator.userAgent}`),S.jsxs("div",{ref:e,className:ve("tl-container tl-error-boundary",f===null?"":f?"tl-theme__dark":"tl-theme__light"),children:[S.jsx("div",{className:"tl-error-boundary__overlay"}),t&&S.jsx(Co,{onError:zh,fallback:()=>null,children:S.jsx(xs.Provider,{value:t,children:S.jsx("div",{className:"tl-overlay tl-error-boundary__canvas",children:l?S.jsx(l,{}):null})})}),S.jsx("div",{className:ve("tl-modal","tl-error-boundary__content",{"tl-error-boundary__content__expanded":s&&!a}),children:a?S.jsxs(S.Fragment,{children:[S.jsx("h2",{children:"Are you sure?"}),S.jsx("p",{children:"Resetting your data will delete your drawing and cannot be undone."}),S.jsxs("div",{className:"tl-error-boundary__content__actions",children:[S.jsx("button",{onClick:()=>c(!1),children:"Cancel"}),S.jsx("button",{className:"tl-error-boundary__reset",onClick:w,children:"Reset data"})]})]}):S.jsxs(S.Fragment,{children:[S.jsx("h2",{children:"Something's gone wrong."}),S.jsxs("p",{children:["Sorry, we encountered an error. Please refresh the page to continue. If you keep seeing this error, you can ",S.jsx("a",{href:I.toString(),children:"create a GitHub issue"})," or"," ",S.jsx("a",{href:"https://discord.gg/Cq6cPsTfNy",children:"ask for help on Discord"}),"."]}),s&&S.jsxs(S.Fragment,{children:["Message:",S.jsx("h4",{children:S.jsx("code",{children:d})}),"Stack trace:",S.jsxs("div",{className:"tl-error-boundary__content__error",children:[S.jsx("pre",{children:S.jsx("code",{children:h??d})}),S.jsx("button",{onClick:g,children:i?"Copied!":"Copy"})]})]}),S.jsxs("div",{className:"tl-error-boundary__content__actions",children:[S.jsx("button",{onClick:()=>r(!s),children:s?"Hide details":"Show details"}),S.jsxs("div",{className:"tl-error-boundary__content__actions__group",children:[S.jsx("button",{className:"tl-error-boundary__reset",onClick:()=>c(!0),children:"Reset data"}),S.jsx("button",{className:"tl-error-boundary__refresh",onClick:x,children:"Refresh Page"})]})]})]})})]})};let Nh=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((t,e)=>(e&=63,e<36?t+=e.toString(36):e<62?t+=(e-26).toString(36).toUpperCase():e>62?t+="-":t+="_",t),"");function Ee(){return Nh()}const Uo="TLDRAW_USER_DATA_v3",$o=q({id:K,name:K.nullable().optional(),locale:K.nullable().optional(),color:K.nullable().optional(),isDarkMode:H.nullable().optional(),animationSpeed:B.nullable().optional(),edgeScrollSpeed:B.nullable().optional(),isSnapMode:H.nullable().optional(),isWrapMode:H.nullable().optional()}),Xt={AddAnimationSpeed:1,AddIsSnapMode:2,MakeFieldsNullable:3,AddEdgeScrollSpeed:4,AddExcalidrawSelectMode:5},Er=Math.max(...Object.values(Xt));function Uh(n){n.version<Xt.AddAnimationSpeed&&(n.user.animationSpeed=1),n.version<Xt.AddIsSnapMode&&(n.user.isSnapMode=!1),n.version<Xt.MakeFieldsNullable,n.version<Xt.AddEdgeScrollSpeed&&(n.user.edgeScrollSpeed=1),n.version<Xt.AddExcalidrawSelectMode&&(n.user.isWrapMode=!1),n.version=Er}const wi=["#FF802B","#EC5E41","#F2555A","#F04F88","#E34BA9","#BD54C6","#9D5BD2","#7B66DC","#02B1CC","#11B3A3","#39B178","#55B467"];function $h(){return wi[Math.floor(Math.random()*wi.length)]}function Hh(){var n,t;return typeof window>"u"?!1:((t=(n=window.matchMedia)==null?void 0:n.call(window,"(prefers-color-scheme: dark)"))==null?void 0:t.matches)??!1}function Kh(){var n,t;return typeof window>"u"?!1:((t=(n=window.matchMedia)==null?void 0:n.call(window,"(prefers-reduced-motion: reduce)"))==null?void 0:t.matches)??!1}const _t=Object.freeze({name:"New User",locale:Kl(),color:$h(),isDarkMode:!1,edgeScrollSpeed:1,animationSpeed:Kh()?0:1,isSnapMode:!1,isWrapMode:!1});function Ks(){return{id:Ee()}}function Ho(n){if(n===null||typeof n!="object"||!("version"in n)||!("user"in n)||typeof n.version!="number")return Ks();const t=he(n);Uh(t);try{return $o.validate(t.user)}catch{return Ks()}}function Yh(){const n=JSON.parse(Ji(Uo)||"null")??null;return Ho(n)}const Mn=Te("globalUserData",null);function Xh(){eo(Uo,JSON.stringify({version:Er,user:Mn.get()}))}function Gh(n){$o.validate(n),Mn.set(n),Xh(),qh()}const Jt=typeof BroadcastChannel<"u"?new BroadcastChannel("tldraw-user-sync"):null;Jt==null||Jt.addEventListener("message",n=>{const t=n.data;(t==null?void 0:t.type)===Yo&&(t==null?void 0:t.origin)!==Ko()&&Mn.set(Ho(t.data))});let Ys=null;function Ko(){return Ys===null&&(Ys=Ee()),Ys}const Yo="tldraw-user-preferences-change";function qh(){Jt==null||Jt.postMessage({type:Yo,origin:Ko(),data:{user:Xo(),version:Er}})}function Xo(){let n=Mn.get();return n||(n=Yh(),Mn.set(n)),n}function Go(n={}){return{derivePresenceState:n.derivePresenceState??(()=>T("presence",()=>null)),userPreferences:n.userPreferences??T("userPreferences",()=>Xo()),setUserPreferences:n.setUserPreferences??Gh}}function Wh({children:n,className:t="",...e}){return S.jsx("svg",{...e,className:ve("tl-svg-container",t),children:n})}function Tr(n,t,e,s){const r=n.x-e.x,i=n.y-e.y,o=s.x-e.x,a=s.y-e.y,c=t.x-n.x,l=t.y-n.y,d=o*i-a*r,h=c*i-l*r,p=a*c-o*l;if(d===0||h===0||p===0)return null;if(p!==0){const f=d/p,y=h/p;if(0<=f&&f<=1&&0<=y&&y<=1)return m.AddXY(n,f*c,f*l)}return null}function Ps(n,t,e,s){const r=(t.x-n.x)*(t.x-n.x)+(t.y-n.y)*(t.y-n.y),i=2*((t.x-n.x)*(n.x-e.x)+(t.y-n.y)*(n.y-e.y)),o=e.x*e.x+e.y*e.y+n.x*n.x+n.y*n.y-2*(e.x*n.x+e.y*n.y)-s*s,a=i*i-4*r*o;if(a<0||a===0)return null;const c=Math.sqrt(a),l=(-i+c)/(2*r),d=(-i-c)/(2*r);if((l<0||l>1)&&(d<0||d>1))return null;const h=[];return 0<=l&&l<=1&&h.push(m.Lrp(n,t,l)),0<=d&&d<=1&&h.push(m.Lrp(n,t,d)),h.length===0?null:h}function Vh(n,t,e){const s=[];let r;for(let i=0,o=e.length-1;i<o;i++)r=Tr(n,t,e[i],e[i+1]),r&&s.push(r);return s.length===0?null:s}function Zh(n,t,e){const s=[];let r;for(let i=1,o=e.length;i<o+1;i++)r=Tr(n,t,e[i-1],e[i%e.length]),r&&s.push(r);return s.length===0?null:s}function vf(n,t,e,s){let r=e.x-n.x,i=e.y-n.y;const o=Math.sqrt(r*r+i*i),a=(o*o-s*s+t*t)/(2*o),c=Math.sqrt(t*t-a*a);return r/=o,i/=o,[new m(n.x+r*a-i*c,n.y+i*a+r*c),new m(n.x+r*a+i*c,n.y+i*a-r*c)]}function bi(n,t,e){const s=[];let r,i,o;for(let a=0,c=e.length;a<c;a++)r=e[a],i=e[(a+1)%e.length],o=Ps(r,i,n,t),o&&s.push(...o);return s.length===0?null:s}function Ii(n,t,e){const s=[];let r,i,o;for(let a=1,c=e.length;a<c;a++)r=e[a-1],i=e[a],o=Ps(r,i,n,t),o&&s.push(...o);return s.length===0?null:s}function Nn(n,t,e){return(e.y-n.y)*(t.x-n.x)>(t.y-n.y)*(e.x-n.x)}function kr(n,t,e,s){return Nn(n,e,s)!==Nn(t,e,s)&&Nn(n,t,e)!==Nn(n,t,s)}function Pi(n,t){const e=new Map;let s,r,i,o;for(let a=0,c=n.length;a<c;a++)if(s=n[a],Dt(s,t)){const l=Xs(s);e.has(l)||e.set(l,s)}for(let a=0,c=t.length;a<c;a++)if(s=t[a],Dt(s,n)){const l=Xs(s);e.has(l)||e.set(l,s)}for(let a=0,c=n.length;a<c;a++){s=n[a],r=n[(a+1)%n.length];for(let l=0,d=t.length;l<d;l++){i=t[l],o=t[(l+1)%t.length];const h=Tr(s,r,i,o);if(h!==null){const p=Xs(h);e.has(p)||e.set(p,h)}}}return e.size===0?null:Qh([...e.values()])}function Xs(n){return`${n.x},${n.y}`}function Qh(n){const t=m.Average(n);return n.sort((e,s)=>m.Angle(t,e)-m.Angle(t,s))}function Cf(n,t){let e,s,r,i;for(let o=0,a=n.length;o<a;o++){e=n[o],s=n[(o+1)%a];for(let c=0,l=t.length;c<l;c++)if(r=t[c],i=t[(c+1)%l],kr(e,s,r,i))return!0}return!1}function _f(n,t){let e,s,r,i;for(let o=0,a=n.length;o<a;o++){e=n[o],s=n[(o+1)%a];for(let c=1,l=t.length;c<l;c++)if(r=t[c-1],i=t[c],kr(e,s,r,i))return!0}return!1}class cr extends Lt{constructor(e){super({...e,isClosed:!1,isFilled:!1});u(this,"start");u(this,"end");u(this,"d");u(this,"u");u(this,"ul");u(this,"_length");const{start:s,end:r}=e;this.start=s,this.end=r,this.d=s.clone().sub(r),this.u=this.d.clone().uni(),this.ul=this.u.len()}get length(){return this._length?this._length:this.d.len()}midPoint(){return this.start.lrp(this.end,.5)}getVertices(){return[this.start,this.end]}nearestPoint(e){const{start:s,end:r,u:i,ul:o}=this;if(o===0)return s;const a=m.Sub(e,s).dpr(i)/o,c=s.x+i.x*a;if(c<Math.min(s.x,r.x))return s.x<r.x?s:r;if(c>Math.max(s.x,r.x))return s.x>r.x?s:r;const l=s.y+i.y*a;return l<Math.min(s.y,r.y)?s.y<r.y?s:r:l>Math.max(s.y,r.y)?s.y>r.y?s:r:new m(c,l)}hitTestLineSegment(e,s,r=0){return kr(e,s,this.start,this.end)||this.distanceToLineSegment(e,s)<=r}}class Mr extends Lt{constructor(e){super({isClosed:!1,isFilled:!1,...e});u(this,"points");u(this,"_segments");u(this,"_length");const{points:s}=e;this.points=s}get segments(){if(!this._segments){this._segments=[];const{vertices:e}=this;for(let s=0,r=e.length-1;s<r;s++){const i=e[s],o=e[s+1];this._segments.push(new cr({start:i,end:o}))}this.isClosed&&this._segments.push(new cr({start:e[e.length-1],end:e[0]}))}return this._segments}get length(){return this._length||(this._length=this.segments.reduce((e,s)=>e+s.length,0)),this._length}getVertices(){return this.points}nearestPoint(e){const{segments:s}=this;let r=this.points[0],i=1/0,o,a;for(let c=0;c<s.length;c++)o=s[c].nearestPoint(e),a=m.Dist2(o,e),a<i&&(r=o,i=a);if(!r)throw Error("nearest point not found");return r}hitTestLineSegment(e,s,r=0){const{segments:i}=this;for(let o=0,a=i.length;o<a;o++)if(i[o].hitTestLineSegment(e,s,r))return!0;return!1}}class qo extends Mr{constructor(t){super({...t}),this.isClosed=!0}}class Wo extends qo{constructor(e){const{x:s=0,y:r=0,width:i,height:o}=e;super({...e,points:[new m(s,r),new m(s+i,r),new m(s+i,r+o),new m(s,r+o)]});u(this,"x");u(this,"y");u(this,"w");u(this,"h");this.x=s,this.y=r,this.w=i,this.h=o}getBounds(){return new $(this.x,this.y,this.w,this.h)}}class In{constructor(t){u(this,"canSnap",()=>!0);u(this,"canScroll",()=>!1);u(this,"canBind",(t,e)=>!0);u(this,"canEdit",()=>!1);u(this,"canResize",()=>!0);u(this,"canEditInReadOnly",()=>!1);u(this,"canCrop",()=>!1);u(this,"hideResizeHandles",()=>!1);u(this,"hideRotateHandle",()=>!1);u(this,"hideSelectionBoundsBg",()=>!1);u(this,"hideSelectionBoundsFg",()=>!1);u(this,"isAspectRatioLocked",()=>!1);u(this,"onBeforeCreate");u(this,"onBeforeUpdate");u(this,"onDragShapesOver");u(this,"onDragShapesOut");u(this,"onDropShapesOver");u(this,"onResizeStart");u(this,"onResize");u(this,"onResizeEnd");u(this,"onTranslateStart");u(this,"onTranslate");u(this,"onTranslateEnd");u(this,"onHandleDrag");u(this,"onRotateStart");u(this,"onRotate");u(this,"onRotateEnd");u(this,"onBindingChange");u(this,"onChildrenChange");u(this,"onDoubleClickHandle");u(this,"onDoubleClickEdge");u(this,"onDoubleClick");u(this,"onClick");u(this,"onEditEnd");this.editor=t}providesBackgroundForChildren(t){return!1}canReceiveNewChildrenOfType(t,e){return!1}canDropShapes(t,e){return!1}expandSelectionOutlinePx(t){return 0}getCanvasSvgDefs(){return[]}getBoundsSnapGeometry(t){return{}}getHandleSnapGeometry(t){return{}}}u(In,"props"),u(In,"migrations"),u(In,"type");function Jh(n,t,e={}){const{closed:s=!1,snap:r=1,start:i="outset",end:o="outset",lengthRatio:a=2,style:c="dashed"}=e;let l=0,d=0,h=1,p=0,f=0;switch(c){case"dashed":{h=1,l=Math.min(t*a,n/4);break}case"dotted":{h=100,l=t/h;break}default:return{strokeDasharray:"none",strokeDashoffset:"none"}}return s||(i==="outset"?(n+=l/2,f+=l/2):i==="skip"&&(n-=l,f-=l),o==="outset"?n+=l/2:o==="skip"&&(n-=l)),d=Math.floor(n/l/(2*h)),d-=d%r,d<3&&c==="dashed"?n/t<5?(l=n,d=1,p=0):(l=n*.333,p=n*.333):(d=Math.max(d,3),l=n/d/(2*h),s?(f=l/2,p=(n-d*l)/d):p=(n-d*l)/Math.max(1,d-1)),{strokeDasharray:[l,p].join(" "),strokeDashoffset:f.toString()}}function vi({bounds:n,className:t}){const e=N(),s=z("zoom level",()=>e.getZoomLevel(),[e]);return S.jsx("g",{className:t,pointerEvents:"none",strokeLinecap:"round",strokeLinejoin:"round",children:n.sides.map((r,i)=>{const{strokeDasharray:o,strokeDashoffset:a}=Jh(r[0].dist(r[1]),1/s,{style:"dashed",lengthRatio:4});return S.jsx("line",{x1:r[0].x,y1:r[0].y,x2:r[1].x,y2:r[1].y,strokeDasharray:o,strokeDashoffset:a},i)})})}class Xn extends In{constructor(){super(...arguments);u(this,"hideSelectionBoundsFg",()=>!0);u(this,"canBind",()=>!1);u(this,"onChildrenChange",e=>{const s=this.editor.getSortedChildIdsForParent(e.id);if(s.length===0){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.deleteShapes([e.id]);return}else if(s.length===1){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.reparentShapes(s,e.parentId),this.editor.deleteShapes([e.id]);return}})}getDefaultProps(){return{}}getGeometry(e){const s=this.editor.getSortedChildIdsForParent(e.id);return s.length===0?new Wo({width:1,height:1,isFilled:!1}):new Is({children:s.map(r=>{const i=this.editor.getShape(r),o=this.editor.getShapeGeometry(r),a=this.editor.getShapeLocalTransform(i).applyToPoints(o.vertices);return o.isClosed?new qo({points:a,isFilled:!0}):new Mr({points:a})})})}component(e){const s=this.editor.getErasingShapeIds().includes(e.id),{hintingShapeIds:r}=this.editor.getCurrentPageState(),i=r.length>0&&r.some(c=>c!==e.id&&this.editor.isShapeOfType(this.editor.getShape(c),"group")),o=this.editor.getCurrentPageState().focusedGroupId!==e.id;if(!s&&(o||i))return null;const a=this.editor.getShapeGeometry(e).bounds;return S.jsx(Wh,{id:e.id,children:S.jsx(vi,{className:"tl-group",bounds:a})})}indicator(e){const s=this.editor.getShapeGeometry(e).bounds;return S.jsx(vi,{className:"",bounds:s})}}u(Xn,"type","group"),u(Xn,"props",Po),u(Xn,"migrations",vo);const Vo=[Xn],eu=new Set(Vo.map(n=>n.type));function Zo(n){const t=[...Vo],e=new Set;for(const s of n){if(eu.has(s.type))throw new Error(`Shape type "${s.type}" is a core shapes type and cannot be overridden`);if(e.has(s.type))throw new Error(`Shape type "${s.type}" is defined more than once`);t.push(s),e.add(s.type)}return t}function Ci(n,t){if(!t)return!1;switch(n.type){case"mixed":return t.type==="mixed";case"shared":return t.type==="shared"&&n.value===t.value;default:throw us(n)}}class tu{constructor(t){u(this,"map");this.map=new Map(t)}get(t){return this.map.get(t)}getAsKnownValue(t){const e=this.get(t);if(e&&e.type!=="mixed")return e.value}get size(){return this.map.size}equals(t){if(this.size!==t.size)return!1;const e=new Set;for(const[s,r]of this){if(!Ci(r,t.get(s)))return!1;e.add(s)}for(const[s,r]of t)if(!e.has(s)&&!Ci(r,this.get(s)))return!1;return!0}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}[Symbol.iterator](){return this.map[Symbol.iterator]()}}class _i extends tu{set(t,e){this.map.set(t,e)}applyValue(t,e){const s=this.get(t);if(!s){this.set(t,{type:"shared",value:e});return}switch(s.type){case"mixed":return;case"shared":s.value!==e&&this.set(t,{type:"mixed"});return;default:us(s,"type")}}}class nu{constructor(){u(this,"items",new WeakMap)}get(t,e){return this.items.has(t)||this.items.set(t,e(t)),this.items.get(t)}access(t){return this.items.get(t)}set(t,e){this.items.set(t,e)}has(t){return this.items.has(t)}invalidate(t){this.items.delete(t)}bust(){this.items=new WeakMap}}function su(n,t,e){return fetch(n).then(function(s){return s.arrayBuffer()}).then(function(s){return new File([s],t,{type:e})})}function ru(n,t){var r;let e=n;const s=new Set(t);for(;s.has(e);)e=(r=/^.*(\d+)$/.exec(e))!=null&&r[1]?e.replace(/(\d+)(?=\D?)$/,i=>(+i+1).toString()):`${e} 1`;return e}function Un(n,t,e){if(e.length===0)return[];const s=new Map;for(const i of G(e.map(o=>n.getShape(o)))){const{parentId:o}=i;s.has(o)||s.set(o,{children:G(n.getSortedChildIdsForParent(o).map(a=>n.getShape(a))),moving:new Set}),s.get(o).moving.add(i)}const r=[];switch(t){case"toBack":{s.forEach(({moving:i,children:o})=>iu(i,o,r));break}case"toFront":{s.forEach(({moving:i,children:o})=>ou(i,o,r));break}case"forward":{s.forEach(({moving:i,children:o})=>au(i,o,r));break}case"backward":{s.forEach(({moving:i,children:o})=>cu(i,o,r));break}}return r}function iu(n,t,e){const s=t.length;if(n.size===s)return;let r,i;for(let o=0;o<s;o++){const a=t[o];if(n.has(a))r=a.index,n.delete(a);else{i=a.index;break}}if(n.size!==0){const o=tn(r,i,n.size);e.push(...Array.from(n.values()).sort(ze).map((a,c)=>({...a,index:o[c]})))}}function ou(n,t,e){const s=t.length;if(n.size===s)return;let r,i;for(let o=s-1;o>-1;o--){const a=t[o];if(n.has(a))i=a.index,n.delete(a);else{r=a.index;break}}if(n.size!==0){const o=tn(r,i,n.size);e.push(...Array.from(n.values()).sort(ze).map((a,c)=>({...a,index:o[c]})))}}function au(n,t,e){var i;const s=t.length;if(n.size===s)return;let r={name:"skipping"};for(let o=0;o<s;o++){const a=n.has(t[o]);switch(r.name){case"skipping":{if(!a)continue;r={name:"selecting",selectIndex:o};break}case"selecting":{if(a)continue;const{selectIndex:c}=r;tn(t[o].index,(i=t[o+1])==null?void 0:i.index,o-c).forEach((l,d)=>e.push({...t[c+d],index:l})),r={name:"skipping"};break}}}}function cu(n,t,e){var i;const s=t.length;if(n.size===s)return;let r={name:"skipping"};for(let o=s-1;o>-1;o--){const a=n.has(t[o]);switch(r.name){case"skipping":{if(!a)continue;r={name:"selecting",selectIndex:o};break}case"selecting":{if(a)continue;tn((i=t[o-1])==null?void 0:i.index,t[o].index,r.selectIndex-o).forEach((c,l)=>{e.push({...t[o+l+1],index:c})}),r={name:"skipping"};break}}}}function lu({editor:n}){const t=n.getSelectedShapes(),e=n.getSelectionRotation(),s=n.getSelectionRotatedPageBounds(),{inputs:{originPagePoint:r}}=n;if(!s)return null;const i=s.center.clone().rotWith(s.point,e);return{selectionPageCenter:i,initialCursorAngle:i.angle(r),initialSelectionRotation:e,shapeSnapshots:t.map(o=>({shape:he(o),initialPagePoint:n.getShapePageTransform(o.id).point()}))}}function du({delta:n,editor:t,snapshot:e,stage:s}){const{selectionPageCenter:r,shapeSnapshots:i}=e;t.updateShapes(i.map(({shape:a,initialPagePoint:c})=>{const l=He(a.parentId)?t.getShapePageTransform(a.parentId):F.Identity(),d=m.RotWith(c,r,n),h=F.applyToPoint(F.Inverse(l),d),p=rr(a.rotation+n);return{id:a.id,type:a.type,x:h.x,y:h.y,rotation:p}}));const o=[];i.forEach(({shape:a})=>{var h,p,f;const c=t.getShape(a.id);if(!c)return;const l=t.getShapeUtil(a);if(s==="start"||s==="one-off"){const y=(h=l.onRotateStart)==null?void 0:h.call(l,a);y&&o.push(y)}const d=(p=l.onRotate)==null?void 0:p.call(l,a,c);if(d&&o.push(d),s==="end"||s==="one-off"){const y=(f=l.onRotateEnd)==null?void 0:f.call(l,a,c);y&&o.push(y)}}),o.length>0&&t.updateShapes(o)}const hu=n=>{const{store:t}=n,e=t.query.filterHistory("shape"),s=t.query.records("shape",()=>({type:{eq:"arrow"}}));function r(){const i=s.get(),o={};for(const a of i){const{start:c,end:l}=a.props;if(c.type==="binding"){const d=o[c.boundShapeId];d?d.push({arrowId:a.id,handleId:"start"}):o[c.boundShapeId]=[{arrowId:a.id,handleId:"start"}]}if(l.type==="binding"){const d=o[l.boundShapeId];d?d.push({arrowId:a.id,handleId:"end"}):o[l.boundShapeId]=[{arrowId:a.id,handleId:"end"}]}}return o}return T("arrowBindingsIndex",(i,o)=>{if(At(i))return r();const a=i,c=e.getDiffSince(o);if(c===Fe)return r();let l;function d(f){l||(l={...a}),l[f]?l[f]===a[f]&&(l[f]=[...l[f]]):l[f]=[]}function h(f,y,g){d(f),l[f]=l[f].filter(x=>x.arrowId!==y||x.handleId!==g),l[f].length===0&&delete l[f]}function p(f,y,g){d(f),l[f].push({arrowId:y,handleId:g})}for(const f of c){for(const y of Object.values(f.added))if(n.isShapeOfType(y,"arrow")){const{start:g,end:x}=y.props;g.type==="binding"&&p(g.boundShapeId,y.id,"start"),x.type==="binding"&&p(x.boundShapeId,y.id,"end")}for(const[y,g]of Object.values(f.updated))if(!(!n.isShapeOfType(y,"arrow")||!n.isShapeOfType(g,"arrow")))for(const x of["start","end"]){const w=y.props[x],I=g.props[x];w.type==="binding"&&I.type==="point"?h(w.boundShapeId,y.id,x):w.type==="point"&&I.type==="binding"?p(I.boundShapeId,g.id,x):w.type==="binding"&&I.type==="binding"&&w.boundShapeId!==I.boundShapeId&&(h(w.boundShapeId,y.id,x),p(I.boundShapeId,g.id,x))}for(const y of Object.values(f.removed))if(n.isShapeOfType(y,"arrow")){const{start:g,end:x}=y.props;g.type==="binding"&&h(g.boundShapeId,y.id,"start"),x.type==="binding"&&h(x.boundShapeId,y.id,"end")}}return l??a})};function uu(n,t,e){const s=n.getShapeMaskedPageBounds(t);return s===void 0?!0:!e.includes(s)}const pu=n=>{const t=Number.isFinite(n.renderingBoundsMargin);function e(s){const r=s.getCurrentPageShapeIds(),i=s.getViewportPageBounds(),o=new Set;return r.forEach(a=>{uu(s,a,i)&&o.add(a)}),o}return T("getCulledShapes",s=>{if(!t)return new Set;if(At(s))return e(n);const r=e(n);if(s.size!==r.size)return r;for(const i of s)if(!r.has(i))return r;return s})},fu=n=>{const t=n.query.ids("shape"),e=n.query.filterHistory("shape");function s(){const r={},i=t.get(),o=Array(i.size);return i.forEach(a=>o.push(n.get(a))),o.sort(ze),o.forEach(a=>{r[a.parentId]||(r[a.parentId]=[]),r[a.parentId].push(a.id)}),r}return T("parentsToChildrenWithIndexes",(r,i)=>{if(At(r))return s();const o=e.getDiffSince(i);if(o===Fe)return s();if(o.length===0)return r;let a=null;const c=h=>{a||(a={...r}),a[h]?a[h]===r[h]&&(a[h]=[...a[h]]):a[h]=[]},l=new Set;let d;for(let h=0,p=o.length;h<p;h++){d=o[h];for(const f of Object.values(d.added))Vt(f)&&(c(f.parentId),a[f.parentId].push(f.id),l.add(a[f.parentId]));for(const[f,y]of Object.values(d.updated))if(Vt(y)&&Vt(f)){if(f.parentId!==y.parentId)c(f.parentId),c(y.parentId),a[f.parentId].splice(a[f.parentId].indexOf(y.id),1),a[y.parentId].push(y.id),l.add(a[y.parentId]);else if(f.index!==y.index){c(y.parentId);const g=a[y.parentId].indexOf(y.id);a[y.parentId][g]=y.id,l.add(a[y.parentId])}}for(const f of Object.values(d.removed))Vt(f)&&(c(f.parentId),a[f.parentId].splice(a[f.parentId].indexOf(f.id),1))}for(const h of l){const p=G(h.map(f=>n.get(f)));p.sort(ze),h.splice(0,h.length,...p.map(f=>f.id))}return a??r})},Gs=(n,t,e)=>{for(;!De(e.parentId);){const s=n.get(e.parentId);if(!s)return!1;e=s}return e.parentId===t},gu=(n,t)=>{const e=n.query.ids("shape");let s=null;function r(){const i=t();return s=i,new Set([...e.get()].filter(o=>Gs(n,i,n.get(o))))}return T("_shapeIdsInCurrentPage",(i,o)=>{if(At(i))return r();const a=t();if(a!==s)return r();const c=n.history.getDiffSince(o);if(c===Fe)return r();const l=new Kn(i);for(const h of c){for(const p of Object.values(h.added))Vt(p)&&Gs(n,a,p)&&l.add(p.id);for(const[p,f]of Object.values(h.updated))Vt(f)&&(Gs(n,a,f)?l.add(f.id):l.remove(f.id));for(const p of Object.keys(h.removed))He(p)&&l.remove(p)}const d=l.get();return d?yn(d.value,d.diff):i})},Qo=M.createContext(null);function mu({context:n,editor:t,children:e}){return S.jsx(xs.Provider,{value:t,children:S.jsx(Qo.Provider,{value:n,children:e})})}function yu(){const n=M.useContext(Qo);return n?{isDarkMode:n.isDarkMode}:null}async function Su(n,t,e={}){var v,C;const s=typeof t[0]=="string"?t:t.map(E=>E.id);if(s.length===0)return;if(!window.document)throw Error("No document");const{scale:r=1,background:i=!1,padding:o=ad,preserveAspectRatio:a=!1}=e,c=e.darkMode??n.user.getIsDarkMode(),l=ol({isDarkMode:c}),d=n.getShapeAndDescendantIds(s),h=n.getUnorderedRenderingShapes(!1).filter(({id:E})=>d.has(E));let p=null;if(e.bounds)p=e.bounds;else for(const{id:E}of h){const A=n.getShapeMaskedPageBounds(E);A&&(p?p.union(A):p=A.clone())}if(!p)return;const f=s.length===1&&n.isShapeOfType(n.getShape(s[0]),"frame")?s[0]:null;f||p.expandBy(o);const y=p.width*r,g=p.height*r;try{(C=(v=document.body).focus)==null||C.call(v)}catch{}const x=[],w=new Map,I={isDarkMode:c,addExportDef:E=>{if(w.has(E.key))return;const A=(async()=>{const _=await E.getElement();_&&x.push(S.jsx(M.Fragment,{children:_},x.length))})();w.set(E.key,A)}},b=(await Promise.all(h.map(async({id:E,opacity:A,index:_,backgroundIndex:k})=>{var xe,it;if(E===f)return[];const R=n.getShape(E);if(n.isShapeOfType(R,"group"))return[];const X=n.getShapeUtil(R);let j=await((xe=X.toSvg)==null?void 0:xe.call(X,R,I)),U=await((it=X.toBackgroundSvg)==null?void 0:it.call(X,R,I));if(!j&&!U){const ne=n.getShapePageBounds(R);j=S.jsx("rect",{width:ne.w,height:ne.h,fill:l.solid,stroke:l.grey.pattern,strokeWidth:1})}let ie=n.getShapePageTransform(R).toCssString();"scale"in R.props&&R.props.scale!==1&&(ie=`${ie} scale(${R.props.scale}, ${R.props.scale})`),j&&(j=S.jsx("g",{transform:ie,opacity:A,children:j},R.id)),U&&(U=S.jsx("g",{transform:ie,opacity:A,children:U},`bg_${R.id}`));const le=n.getShapeMask(R.id);if(le){const ne=`mask_${R.id.replace(":","_")}`;x.push(S.jsx("clipPath",{id:ne,children:S.jsx("path",{d:`M${le.map(({x:we,y:Pt})=>`${we},${Pt}`).join("L")}Z`})},x.length)),j&&(j=S.jsx("g",{clipPath:`url(#${ne})`,children:j},R.id)),U&&(U=S.jsx("g",{clipPath:`url(#${ne})`,children:U},`bg_${R.id}`))}const rt=[];return j&&rt.push({zIndex:_,element:j}),U&&rt.push({zIndex:k,element:U}),rt}))).flat();return await Promise.all(w.values()),{jsx:S.jsx(mu,{editor:n,context:I,children:S.jsxs("svg",{preserveAspectRatio:a||void 0,direction:"ltr",width:y,height:g,viewBox:`${p.minX} ${p.minY} ${p.width} ${p.height}`,strokeLinecap:"round",strokeLinejoin:"round",style:{backgroundColor:i?f?l.solid:l.background:"transparent"},children:[S.jsx("defs",{children:x}),b.sort((E,A)=>E.zIndex-A.zIndex).map(({element:E})=>E)]})}),width:y,height:g}}const xu=40;class wu{constructor(t){u(this,"_clickId","");u(this,"_clickTimeout");u(this,"_clickScreenPoint");u(this,"_previousScreenPoint");u(this,"_getClickTimeout",(t,e=Ee())=>{this._clickId=e,clearTimeout(this._clickTimeout),this._clickTimeout=setTimeout(()=>{if(this._clickState===t&&this._clickId===e){switch(this._clickState){case"pendingTriple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"double_click",phase:"settle"});break}case"pendingQuadruple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"triple_click",phase:"settle"});break}case"pendingOverflow":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"settle"});break}}this._clickState="idle"}},t==="idle"||t==="pendingDouble"?id:od)});u(this,"_clickState","idle");u(this,"lastPointerInfo",{});u(this,"transformPointerDownEvent",t=>{if(!this._clickState)return t;switch(this._clickScreenPoint=m.From(t.point),this._previousScreenPoint&&this._previousScreenPoint.dist(this._clickScreenPoint)>xu&&(this._clickState="idle"),this._previousScreenPoint=this._clickScreenPoint,this.lastPointerInfo=t,this._clickState){case"idle":return this._clickState="pendingDouble",this._clickTimeout=this._getClickTimeout(this._clickState),t;case"pendingDouble":return this._clickState="pendingTriple",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"double_click",phase:"down"};case"pendingTriple":return this._clickState="pendingQuadruple",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"triple_click",phase:"down"};case"pendingQuadruple":return this._clickState="pendingOverflow",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"quadruple_click",phase:"down"};case"pendingOverflow":return this._clickState="overflow",this._clickTimeout=this._getClickTimeout(this._clickState),t;default:return this._clickTimeout=this._getClickTimeout(this._clickState),t}});u(this,"transformPointerUpEvent",t=>{if(!this._clickState)return t;switch(this._clickScreenPoint=m.From(t.point),this._clickState){case"pendingTriple":return{...this.lastPointerInfo,type:"click",name:"double_click",phase:"up"};case"pendingQuadruple":return{...this.lastPointerInfo,type:"click",name:"triple_click",phase:"up"};case"pendingOverflow":return{...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"up"};default:return t}});u(this,"cancelDoubleClickTimeout",()=>{this._clickTimeout=clearTimeout(this._clickTimeout),this._clickState="idle"});u(this,"handleMove",()=>{this._clickState!=="idle"&&this._clickScreenPoint&&m.Dist2(this._clickScreenPoint,this.editor.inputs.currentScreenPoint)>(this.editor.getInstanceState().isCoarsePointer?or:ar)&&this.cancelDoubleClickTimeout()});this.editor=t}get clickState(){return this._clickState}}class bu{constructor(t){u(this,"isSafari");u(this,"isIos");u(this,"isChromeForIos");u(this,"isFirefox");u(this,"isAndroid");this.editor=t,typeof window<"u"&&"navigator"in window?(this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIos=!!navigator.userAgent.match(/iPad/i)||!!navigator.userAgent.match(/iPhone/i),this.isChromeForIos=/crios.*safari/i.test(navigator.userAgent),this.isFirefox=/firefox/i.test(navigator.userAgent),this.isAndroid=/android/i.test(navigator.userAgent)):(this.isSafari=!1,this.isIos=!1,this.isChromeForIos=!1,this.isFirefox=!1,this.isAndroid=!1)}}function Et(n){return Pu}class Iu{constructor(){u(this,"length",0);u(this,"head",null);u(this,"tail",this)}push(t){return new Ar(t,this)}toArray(){return ut}[Symbol.iterator](){return{next(){return{value:void 0,done:!0}}}}}const Pu=new Iu;class Ar{constructor(t,e){u(this,"length");this.head=t,this.tail=e,this.length=e.length+1}push(t){return new Ar(t,this)}toArray(){return Array.from(this)}[Symbol.iterator](){let t=this;return{next(){if(t.length){const e=t.head;return t=t.tail,{value:e,done:!1}}else return{value:void 0,done:!0}}}}}class vu{constructor(t,e){u(this,"_undos",Te("HistoryManager.undos",Et()));u(this,"_redos",Te("HistoryManager.redos",Et()));u(this,"_batchDepth",0);u(this,"onBatchComplete",()=>{});u(this,"_commands",{});u(this,"createCommand",(t,e,s)=>{if(this._commands[t])throw new Error(`Duplicate command: ${t}`);this._commands[t]=s;const r=(...i)=>{if(!this._batchDepth)return this.batch(()=>r(...i)),this.ctx;const o=e(...i);if(!o)return this.ctx;const{data:a,ephemeral:c,squashing:l,preservesRedoStack:d}=o;if(this.ignoringUpdates((h,p)=>(s.do(a),{undos:h,redos:p})),!c){const h=this._undos.get().head;l&&h&&h.type==="command"&&h.name===t&&h.preservesRedoStack===d?this._undos.update(p=>p.tail.push({...h,data:s.squash(h.data,a)})):this._undos.update(p=>p.push({type:"command",name:t,data:a,preservesRedoStack:d})),o.preservesRedoStack||this._redos.set(Et()),this.ctx.emit("change-history",{reason:"push"})}return this.ctx};return r});u(this,"batch",t=>{try{this._batchDepth++,this._batchDepth===1?Xe(()=>{const e=this._undos.get().head;t(),e!==this._undos.get().head&&this.onBatchComplete()}):t()}catch(e){throw this.annotateError(e),e}finally{this._batchDepth--}return this});u(this,"ignoringUpdates",t=>{let e=this._undos.get(),s=this._redos.get();this._undos.set(Et()),this._redos.set(Et());try{({undos:e,redos:s}=Xe(()=>t(e,s)))}finally{this._undos.set(e),this._redos.set(s)}});u(this,"_undo",({pushToRedoStack:t,toMark:e=void 0})=>(this.ignoringUpdates((s,r)=>{var i;if(s.length===0)return{undos:s,redos:r};for(;((i=s.head)==null?void 0:i.type)==="STOP";){const o=s.head;if(s=s.tail,t&&(r=r.push(o)),o.id===e)return this.ctx.emit("change-history",t?{reason:"undo"}:{reason:"bail",markId:e}),{undos:s,redos:r}}if(s.length===0)return this.ctx.emit("change-history",t?{reason:"undo"}:{reason:"bail",markId:e}),{undos:s,redos:r};for(;s.head;){const o=s.head;if(s=s.tail,t&&(r=r.push(o)),o.type==="STOP"){if(o.onUndo&&(!e||o.id===e))return this.ctx.emit("change-history",t?{reason:"undo"}:{reason:"bail",markId:e}),{undos:s,redos:r}}else this._commands[o.name].undo(o.data)}return this.ctx.emit("change-history",t?{reason:"undo"}:{reason:"bail",markId:e}),{undos:s,redos:r}}),this));u(this,"undo",()=>(this._undo({pushToRedoStack:!0}),this));u(this,"redo",()=>(this.ignoringUpdates((t,e)=>{var s;if(e.length===0)return{undos:t,redos:e};for(;((s=e.head)==null?void 0:s.type)==="STOP";)t=t.push(e.head),e=e.tail;if(e.length===0)return this.ctx.emit("change-history",{reason:"redo"}),{undos:t,redos:e};for(;e.head;){const r=e.head;if(t=t.push(e.head),e=e.tail,r.type==="STOP"){if(r.onRedo)break}else{const i=this._commands[r.name];i.redo?i.redo(r.data):i.do(r.data)}}return this.ctx.emit("change-history",{reason:"redo"}),{undos:t,redos:e}}),this));u(this,"bail",()=>(this._undo({pushToRedoStack:!1}),this));u(this,"bailToMark",t=>(this._undo({pushToRedoStack:!1,toMark:t}),this));u(this,"mark",(t=Ee(),e=!0,s=!0)=>{const r=this._undos.get().head;return r&&r.type==="STOP"&&r.id===t&&r.onUndo===e&&r.onRedo===s?r.id:(this._undos.update(i=>i.push({type:"STOP",id:t,onUndo:e,onRedo:s})),this.ctx.emit("mark-history",{id:t}),t)});this.ctx=t,this.annotateError=e}getNumUndos(){return this._undos.get().length}getNumRedos(){return this._redos.get().length}clear(){this._undos.set(Et()),this._redos.set(Et())}}class Cu{constructor(t){u(this,"scribbleItems",new Map);u(this,"state","paused");u(this,"addScribble",(t,e=Ee())=>{const s={id:e,scribble:{id:e,size:20,color:"accent",opacity:.8,delay:0,points:[],shrink:.1,taper:!0,...t,state:"starting"},timeoutMs:0,delayRemaining:t.delay??0,prev:null,next:null};return this.scribbleItems.set(e,s),s});u(this,"stop",t=>{const e=this.scribbleItems.get(t);if(!e)throw Error(`Scribble with id ${t} not found`);return e.delayRemaining=Math.min(e.delayRemaining,200),e.scribble.state="stopping",e});u(this,"addPoint",(t,e,s)=>{const r=this.scribbleItems.get(t);if(!r)throw Error(`Scribble with id ${t} not found`);const{prev:i}=r,o={x:e,y:s,z:.5};return(!i||m.Dist(i,o)>=1)&&(r.next=o),r});u(this,"tick",t=>{this.scribbleItems.size!==0&&this.editor.batch(()=>{this.scribbleItems.forEach(e=>{if(e.scribble.state==="starting"){const{next:c,prev:l}=e;c&&c!==l&&(e.prev=c,e.scribble.points.push(c)),e.scribble.points.length>8&&(e.scribble.state="active");return}e.delayRemaining>0&&(e.delayRemaining=Math.max(0,e.delayRemaining-t)),e.timeoutMs+=t,e.timeoutMs>=16&&(e.timeoutMs=0);const{delayRemaining:s,timeoutMs:r,prev:i,next:o,scribble:a}=e;switch(a.state){case"active":{o&&o!==i?(e.prev=o,a.points.push(o),s===0&&a.points.length>8&&a.points.shift()):r===0&&(a.points.length>1?a.points.shift():e.delayRemaining=a.delay);break}case"stopping":{if(e.delayRemaining===0&&r===0){if(a.points.length===1){this.scribbleItems.delete(e.id);return}a.shrink&&(a.size=Math.max(1,a.size*(1-a.shrink))),a.points.shift()}break}}}),this.editor.updateInstanceState({scribbles:Array.from(this.scribbleItems.values()).map(({scribble:e})=>({...e,points:[...e.points]})).slice(-5)})})});this.editor=t}reset(){this.editor.updateInstanceState({scribbles:[]}),this.scribbleItems.clear()}}class _u{constructor(t){u(this,"_beforeCreateHandlers",{});u(this,"_afterCreateHandlers",{});u(this,"_beforeChangeHandlers",{});u(this,"_afterChangeHandlers",{});u(this,"_beforeDeleteHandlers",{});u(this,"_afterDeleteHandlers",{});u(this,"_batchCompleteHandlers",[]);this.editor=t,t.store.onBeforeCreate=(s,r)=>{const i=this._beforeCreateHandlers[s.typeName];if(i){let o=s;for(const a of i)o=a(o,r);return o}return s},t.store.onAfterCreate=(s,r)=>{const i=this._afterCreateHandlers[s.typeName];if(i)for(const o of i)o(s,r)},t.store.onBeforeChange=(s,r,i)=>{const o=this._beforeChangeHandlers[r.typeName];if(o){let a=r;for(const c of o)a=c(s,a,i);return a}return r};let e=0;t.store.onAfterChange=(s,r,i)=>{if(e++,e>1e3)console.error("[CleanupManager.onAfterChange] Maximum update depth exceeded, bailing out.");else{const o=this._afterChangeHandlers[r.typeName];if(o)for(const a of o)a(s,r,i)}e--},t.store.onBeforeDelete=(s,r)=>{const i=this._beforeDeleteHandlers[s.typeName];if(i){for(const o of i)if(o(s,r)===!1)return!1}},t.store.onAfterDelete=(s,r)=>{const i=this._afterDeleteHandlers[s.typeName];if(i)for(const o of i)o(s,r)},t.history.onBatchComplete=()=>{this._batchCompleteHandlers.forEach(s=>s())}}registerBeforeCreateHandler(t,e){return this._beforeCreateHandlers[t]||(this._beforeCreateHandlers[t]=[]),this._beforeCreateHandlers[t].push(e),()=>Tt(this._beforeCreateHandlers[t],e)}registerAfterCreateHandler(t,e){return this._afterCreateHandlers[t]||(this._afterCreateHandlers[t]=[]),this._afterCreateHandlers[t].push(e),()=>Tt(this._afterCreateHandlers[t],e)}registerBeforeChangeHandler(t,e){return this._beforeChangeHandlers[t]||(this._beforeChangeHandlers[t]=[]),this._beforeChangeHandlers[t].push(e),()=>Tt(this._beforeChangeHandlers[t],e)}registerAfterChangeHandler(t,e){return this._afterChangeHandlers[t]||(this._afterChangeHandlers[t]=[]),this._afterChangeHandlers[t].push(e),()=>Tt(this._afterChangeHandlers[t],e)}registerBeforeDeleteHandler(t,e){return this._beforeDeleteHandlers[t]||(this._beforeDeleteHandlers[t]=[]),this._beforeDeleteHandlers[t].push(e),()=>Tt(this._beforeDeleteHandlers[t],e)}registerAfterDeleteHandler(t,e){return this._afterDeleteHandlers[t]||(this._afterDeleteHandlers[t]=[]),this._afterDeleteHandlers[t].push(e),()=>Tt(this._afterDeleteHandlers[t],e)}registerBatchCompleteHandler(t){return this._batchCompleteHandlers.push(t),()=>Tt(this._batchCompleteHandlers,t)}}function Tt(n,t){const e=n.indexOf(t);e>=0&&n.splice(e,1)}var Eu=Object.defineProperty,Tu=Object.getOwnPropertyDescriptor,vs=(n,t,e,s)=>{for(var r=Tu(t,e),i=n.length-1,o;i>=0;i--)(o=n[i])&&(r=o(t,e,r)||r);return r&&Eu(t,e,r),r};const L=n=>Math.round(n*10**8)/10**8;function lt(n,t,e,s,r){const i=n.filter(a=>(s==="forward"?a.startNode.id===t:a.endNode.id===t)&&L(a.length)===L(e)&&Ye(a.breadthIntersection[0],a.breadthIntersection[1],r[0],r[1]));if(i.length===0)return[];const o=new Set;return i.forEach(a=>{const c=s==="forward"?a.endNode.id:a.startNode.id;if(!o.has(c)){o.add(c);const l=lt(n,c,e,s,Ye(a.breadthIntersection[0],a.breadthIntersection[1],r[0],r[1]));i.push(...l)}}),i}function ku(n){n.sort((t,e)=>e.gaps.length-t.gaps.length);for(let t=n.length-1;t>0;t--){const e=n[t];for(let s=t-1;s>=0;s--){const r=n[s];if(r.direction===e.direction&&e.gaps.every(i=>r.gaps.some(o=>L(i.startEdge[0].x)===L(o.startEdge[0].x)&&L(i.startEdge[0].y)===L(o.startEdge[0].y)&&L(i.startEdge[1].x)===L(o.startEdge[1].x)&&L(i.startEdge[1].y)===L(o.startEdge[1].y))&&r.gaps.some(o=>L(i.endEdge[0].x)===L(o.endEdge[0].x)&&L(i.endEdge[0].y)===L(o.endEdge[0].y)&&L(i.endEdge[1].x)===L(o.endEdge[1].x)&&L(i.endEdge[1].y)===L(o.endEdge[1].y)))){n.splice(t,1);break}}}}class Rn{constructor(t){u(this,"editor");this.manager=t,this.editor=t.editor}getSnapPointsCache(){const{editor:t}=this;return t.store.createComputedCache("snapPoints",e=>{const s=t.getShapePageTransform(e.id);if(!s)return;const i=t.getShapeUtil(e).getBoundsSnapGeometry(e).points??t.getShapeGeometry(e).bounds.cornersAndCenter;if(!(!s||!i))return i.map((o,a)=>{const{x:c,y:l}=F.applyToPoint(s,o);return{x:c,y:l,id:`${e.id}:${a}`}})})}getSnapPoints(t){return this.getSnapPointsCache().get(t)??[]}getSnappablePoints(){const t=this.getSnapPointsCache(),e=this.manager.getSnappableShapes(),s=[];for(const r of e){const i=t.get(r);i&&s.push(...i)}return s}getSnappableGapNodes(){return Array.from(this.manager.getSnappableShapes(),t=>({id:t,pageBounds:Gt(this.editor.getShapePageBounds(t))}))}getVisibleGaps(){const t=[],e=[];let s,r;const i=this.getSnappableGapNodes().sort((a,c)=>a.pageBounds.minX-c.pageBounds.minX);for(let a=0;a<i.length;a++){s=i[a];for(let c=a+1;c<i.length;c++)r=i[c],s.pageBounds.maxX<r.pageBounds.minX&&un(s.pageBounds.minY,s.pageBounds.maxY,r.pageBounds.minY,r.pageBounds.maxY)&&t.push({startNode:s,endNode:r,startEdge:[new m(s.pageBounds.maxX,s.pageBounds.minY),new m(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new m(r.pageBounds.minX,r.pageBounds.minY),new m(r.pageBounds.minX,r.pageBounds.maxY)],length:r.pageBounds.minX-s.pageBounds.maxX,breadthIntersection:Ye(s.pageBounds.minY,s.pageBounds.maxY,r.pageBounds.minY,r.pageBounds.maxY)})}const o=i.sort((a,c)=>a.pageBounds.minY-c.pageBounds.minY);for(let a=0;a<o.length;a++){s=o[a];for(let c=a+1;c<o.length;c++)r=o[c],s.pageBounds.maxY<r.pageBounds.minY&&un(s.pageBounds.minX,s.pageBounds.maxX,r.pageBounds.minX,r.pageBounds.maxX)&&e.push({startNode:s,endNode:r,startEdge:[new m(s.pageBounds.minX,s.pageBounds.maxY),new m(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new m(r.pageBounds.minX,r.pageBounds.minY),new m(r.pageBounds.maxX,r.pageBounds.minY)],length:r.pageBounds.minY-s.pageBounds.maxY,breadthIntersection:Ye(s.pageBounds.minX,s.pageBounds.maxX,r.pageBounds.minX,r.pageBounds.maxX)})}return{horizontal:t,vertical:e}}snapTranslateShapes({lockedAxis:t,initialSelectionPageBounds:e,initialSelectionSnapPoints:s,dragDelta:r}){var x,w;const i=this.manager.getSnapThreshold(),o=this.getSnappablePoints(),a=e.clone().translate(r),c=s.map(({x:I,y:b},P)=>({id:"selection:"+P,x:I+r.x,y:b+r.y})),l=o,d=[],h=[],p=new m(i,i);this.collectPointSnaps({minOffset:p,nearestSnapsX:d,nearestSnapsY:h,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h,minOffset:p});const f=new m(t==="x"?0:((x=d[0])==null?void 0:x.nudge)??0,t==="y"?0:((w=h[0])==null?void 0:w.nudge)??0);p.x=0,p.y=0,d.length=0,h.length=0,c.forEach(I=>{I.x+=f.x,I.y+=f.y}),a.translate(f),this.collectPointSnaps({minOffset:p,nearestSnapsX:d,nearestSnapsY:h,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h,minOffset:p});const y=this.getPointSnapLines({nearestSnapsX:d,nearestSnapsY:h}),g=this.getGapSnapLines({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h});return this.manager.setIndicators([...g,...y]),{nudge:f}}snapResizeShapes({initialSelectionPageBounds:t,dragDelta:e,handle:s,isAspectRatioLocked:r,isResizingFromCenter:i}){var E,A;const o=this.manager.getSnapThreshold(),{box:a,scaleX:c,scaleY:l}=$.Resize(t,s,i?e.x*2:e.x,i?e.y*2:e.y,r);let d=s;c<0&&(d=jd(d)),l<0&&(d=Od(d)),i&&(a.center=t.center);const h=d==="top"||d==="bottom",p=d==="left"||d==="right",f=Ei(d,a),y=this.getSnappablePoints(),g=[],x=[],w=new m(o,o);this.collectPointSnaps({minOffset:w,nearestSnapsX:g,nearestSnapsY:x,otherNodeSnapPoints:y,selectionSnapPoints:f});const I=new m(h?0:((E=g[0])==null?void 0:E.nudge)??0,p?0:((A=x[0])==null?void 0:A.nudge)??0);if(r&&Fd(d)&&I.len()!==0){const _=g.length&&x.length?Math.abs(I.x)<Math.abs(I.y)?"x":"y":g.length?"x":"y",k=t.aspectRatio;_==="x"?(x.length=0,I.y=I.x/k,(d==="bottom_left"||d==="top_right")&&(I.y=-I.y)):(g.length=0,I.x=I.y*k,(d==="bottom_left"||d==="top_right")&&(I.x=-I.x))}const b=m.Add(e,I),{box:P}=$.Resize(t,s,i?b.x*2:b.x,i?b.y*2:b.y,r);i&&(P.center=t.center);const v=Ei("any",P);g.length=0,x.length=0,w.x=0,w.y=0,this.collectPointSnaps({minOffset:w,nearestSnapsX:g,nearestSnapsY:x,otherNodeSnapPoints:y,selectionSnapPoints:v});const C=this.getPointSnapLines({nearestSnapsX:g,nearestSnapsY:x});return this.manager.setIndicators([...C]),{nudge:I}}collectPointSnaps({selectionSnapPoints:t,otherNodeSnapPoints:e,minOffset:s,nearestSnapsX:r,nearestSnapsY:i}){for(const o of t)for(const a of e){const c=m.Sub(o,a),l=Math.abs(c.x),d=Math.abs(c.y);L(l)<=L(s.x)&&(L(l)<L(s.x)&&(r.length=0),r.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.x-o.x}),s.x=l),L(d)<=L(s.y)&&(L(d)<L(s.y)&&(i.length=0),i.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.y-o.y}),s.y=d)}}collectGapSnaps({selectionPageBounds:t,minOffset:e,nearestSnapsX:s,nearestSnapsY:r}){const{horizontal:i,vertical:o}=this.getVisibleGaps();for(const a of i){if(!un(a.breadthIntersection[0],a.breadthIntersection[1],t.minY,t.maxY))continue;const l=a.startEdge[0].x+a.length/2-t.center.x;if(a.length>t.width&&L(Math.abs(l))<=L(e.x)){L(Math.abs(l))<L(e.x)&&(s.length=0),e.x=Math.abs(l);const w={type:"gap_center",gap:a,nudge:l},I=s.find(({type:P})=>P==="gap_center"),b=I&&Ye(a.breadthIntersection[0],a.breadthIntersection[1],I.gap.breadthIntersection[0],I.gap.breadthIntersection[1]);I&&I.gap.length>a.length&&b?s[s.indexOf(I)]=w:(!I||!b)&&s.push(w)}const h=a.startNode.pageBounds.minX-a.length,p=t.maxX,f=h-p;L(Math.abs(f))<=L(e.x)&&(L(Math.abs(f))<L(e.x)&&(s.length=0),e.x=Math.abs(f),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"left",nudge:f}));const y=a.endNode.pageBounds.maxX+a.length,g=t.minX,x=y-g;L(Math.abs(x))<=L(e.x)&&(L(Math.abs(x))<L(e.x)&&(s.length=0),e.x=Math.abs(x),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"right",nudge:x}))}for(const a of o){if(!un(a.breadthIntersection[0],a.breadthIntersection[1],t.minX,t.maxX))continue;const l=a.startEdge[0].y+a.length/2-t.center.y;if(a.length>t.height&&L(Math.abs(l))<=L(e.y)){L(Math.abs(l))<L(e.y)&&(r.length=0),e.y=Math.abs(l);const w={type:"gap_center",gap:a,nudge:l},I=r.find(({type:P})=>P==="gap_center"),b=I&&un(I.gap.breadthIntersection[0],I.gap.breadthIntersection[1],a.breadthIntersection[0],a.breadthIntersection[1]);I&&I.gap.length>a.length&&b?r[r.indexOf(I)]=w:(!I||!b)&&r.push(w);continue}const h=a.startNode.pageBounds.minY-a.length,p=t.maxY,f=h-p;L(Math.abs(f))<=L(e.y)&&(L(Math.abs(f))<L(e.y)&&(r.length=0),e.y=Math.abs(f),r.push({type:"gap_duplicate",gap:a,protrusionDirection:"top",nudge:f}));const y=a.endNode.pageBounds.maxY+a.length,g=t.minY,x=y-g;L(Math.abs(x))<=L(e.y)&&(L(Math.abs(x))<L(e.y)&&(r.length=0),e.y=Math.abs(x),r.push({type:"gap_duplicate",gap:a,protrusionDirection:"bottom",nudge:x}))}}getPointSnapLines({nearestSnapsX:t,nearestSnapsY:e}){const s={},r={};if(t.length>0){for(const i of t)if(i.type==="points"){const o=L(i.points.otherPoint.x);s[o]||(s[o]=[]),s[o].push(i.points)}}if(e.length>0){for(const i of e)if(i.type==="points"){const o=L(i.points.otherPoint.y);r[o]||(r[o]=[]),r[o].push(i.points)}}return Object.values(s).concat(Object.values(r)).map(i=>({id:Ee(),type:"points",points:Zn(i.map(o=>m.From(o.otherPoint)).concat(i.map(o=>m.From(o.thisPoint))),(o,a)=>o.equals(a))}))}getGapSnapLines({selectionPageBounds:t,nearestSnapsX:e,nearestSnapsY:s}){const{vertical:r,horizontal:i}=this.getVisibleGaps(),o={top:t.sides[0],right:t.sides[1],bottom:[t.corners[3],t.corners[2]],left:[t.corners[0],t.corners[3]]},a=[];if(e.length>0)for(const c of e){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:d,startNode:h,endNode:p,length:f,endEdge:y}}=c;switch(c.type){case"gap_center":{const g=(f-t.width)/2,x=Ye(l[0],l[1],t.minY,t.maxY);a.push({type:"gaps",direction:"horizontal",id:Ee(),gaps:[...lt(i,h.id,g,"backward",x),{startEdge:d,endEdge:o.left},{startEdge:o.right,endEdge:y},...lt(i,p.id,g,"forward",x)]});break}case"gap_duplicate":{const g=Ye(l[0],l[1],t.minY,t.maxY);a.push({type:"gaps",direction:"horizontal",id:Ee(),gaps:c.protrusionDirection==="left"?[{startEdge:o.right,endEdge:d.map(x=>x.clone().addXY(-h.pageBounds.width,0))},{startEdge:d,endEdge:y},...lt(i,p.id,f,"forward",g)]:[...lt(i,h.id,f,"backward",g),{startEdge:d,endEdge:y},{startEdge:y.map(x=>x.clone().addXY(c.gap.endNode.pageBounds.width,0)),endEdge:o.left}]});break}}}if(s.length>0)for(const c of s){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:d,startNode:h,endNode:p,length:f,endEdge:y}}=c;switch(c.type){case"gap_center":{const g=(f-t.height)/2,x=Ye(l[0],l[1],t.minX,t.maxX);a.push({type:"gaps",direction:"vertical",id:Ee(),gaps:[...lt(r,h.id,g,"backward",x),{startEdge:d,endEdge:o.top},{startEdge:o.bottom,endEdge:y},...lt(r,c.gap.endNode.id,g,"forward",x)]});break}case"gap_duplicate":{const g=Ye(l[0],l[1],t.minX,t.maxX);a.push({type:"gaps",direction:"vertical",id:Ee(),gaps:c.protrusionDirection==="top"?[{startEdge:o.bottom,endEdge:d.map(x=>x.clone().addXY(0,-h.pageBounds.height))},{startEdge:d,endEdge:y},...lt(r,p.id,f,"forward",g)]:[...lt(r,h.id,f,"backward",g),{startEdge:d,endEdge:y},{startEdge:y.map(x=>x.clone().addXY(0,p.pageBounds.height)),endEdge:o.top}]})}break}}return ku(a),a}}vs([T],Rn.prototype,"getSnapPointsCache");vs([T],Rn.prototype,"getSnappablePoints");vs([T],Rn.prototype,"getSnappableGapNodes");vs([T],Rn.prototype,"getVisibleGaps");function Ei(n,t){const{minX:e,maxX:s,minY:r,maxY:i}=t,o=[];switch(n){case"top":case"left":case"top_left":case"any":o.push({id:"top_left",handle:"top_left",x:e,y:r})}switch(n){case"top":case"right":case"top_right":case"any":o.push({id:"top_right",handle:"top_right",x:s,y:r})}switch(n){case"bottom":case"right":case"bottom_right":case"any":o.push({id:"bottom_right",handle:"bottom_right",x:s,y:i})}switch(n){case"bottom":case"left":case"bottom_left":case"any":o.push({id:"bottom_left",handle:"bottom_left",x:e,y:i})}return o}var Mu=Object.defineProperty,Au=Object.getOwnPropertyDescriptor,Ru=(n,t,e,s)=>{for(var r=Au(t,e),i=n.length-1,o;i>=0;i--)(o=n[i])&&(r=o(t,e,r)||r);return r&&Mu(t,e,r),r};const Du=()=>null,Ou=()=>[];class Jo{constructor(t){u(this,"editor");this.manager=t,this.editor=t.editor}getSnapGeometryCache(){const{editor:t}=this;return t.store.createComputedCache("handle snap geometry",e=>{const s=t.getShapeUtil(e).getHandleSnapGeometry(e);return{outline:s.outline===void 0?t.getShapeGeometry(e):s.outline,points:s.points??[],getSelfSnapOutline:s.getSelfSnapOutline??Du,getSelfSnapPoints:s.getSelfSnapPoints??Ou}})}*iterateSnapPointsInPageSpace(t,e){var r,i;const s=(r=this.getSnapGeometryCache().get(t))==null?void 0:r.getSelfSnapPoints(e);if(s&&s.length){const o=Gt(this.editor.getShapePageTransform(t));for(const a of s)yield o.applyToPoint(a)}for(const o of this.manager.getSnappableShapes()){if(o===t)continue;const a=(i=this.getSnapGeometryCache().get(o))==null?void 0:i.points;if(!a||!a.length)continue;const c=Gt(this.editor.getShapePageTransform(o));for(const l of a)yield c.applyToPoint(l)}}*iterateSnapOutlines(t,e){var r,i;const s=(r=this.getSnapGeometryCache().get(t))==null?void 0:r.getSelfSnapOutline(e);s&&(yield{shapeId:t,outline:s});for(const o of this.manager.getSnappableShapes()){if(o===t)continue;const a=(i=this.getSnapGeometryCache().get(o))==null?void 0:i.outline;a&&(yield{shapeId:o,outline:a})}}getHandleSnapPosition({currentShapeId:t,handle:e,handleInPageSpace:s}){const r=this.manager.getSnapThreshold();let i=r,o=null;for(const l of this.iterateSnapPointsInPageSpace(t,e))m.DistMin(s,l,i)&&(i=m.Dist(s,l),o=l);if(o)return o;let a=r,c=null;for(const{shapeId:l,outline:d}of this.iterateSnapOutlines(t,e)){const h=Gt(this.editor.getShapePageTransform(l)),p=this.editor.getPointInShapeSpace(l,s),f=d.nearestPoint(p),y=h.applyToPoint(f);m.DistMin(s,y,a)&&(a=m.Dist(s,y),c=y)}return c||null}snapHandle({currentShapeId:t,handle:e}){const r=Gt(this.editor.getShapePageTransform(t)).applyToPoint(e),i=this.getHandleSnapPosition({currentShapeId:t,handle:e,handleInPageSpace:r});return i?(this.manager.setIndicators([{id:Ee(),type:"points",points:[i]}]),{nudge:m.Sub(i,r)}):null}}Ru([T],Jo.prototype,"getSnapGeometryCache");var ju=Object.defineProperty,Fu=Object.getOwnPropertyDescriptor,Rr=(n,t,e,s)=>{for(var r=Fu(t,e),i=n.length-1,o;i>=0;i--)(o=n[i])&&(r=o(t,e,r)||r);return r&&ju(t,e,r),r};class Cs{constructor(t){u(this,"shapeBounds");u(this,"handles");u(this,"_snapIndicators",Te("snapLines",void 0));this.editor=t,this.shapeBounds=new Rn(this),this.handles=new Jo(this)}getIndicators(){return this._snapIndicators.get()??ut}clearIndicators(){this.getIndicators().length&&this._snapIndicators.set(void 0)}setIndicators(t){this._snapIndicators.set(t)}getSnapThreshold(){return 8/this.editor.getZoomLevel()}getSnappableShapes(){const{editor:t}=this,e=t.getRenderingBounds(),s=t.getSelectedShapeIds(),r=new Set,i=o=>{if(He(o)){const c=t.getShape(o);c&&t.isShapeOfType(c,"frame")&&r.add(o)}const a=t.getSortedChildIdsForParent(o);for(const c of a){if(s.includes(c))continue;const l=t.getShape(c);if(!l||!t.getShapeUtil(l).canSnap(l))continue;const h=t.getShapePageBounds(c);if(h&&e.includes(h)){if(t.isShapeOfType(l,"group")){i(c);continue}r.add(c)}}};return i(this.getCurrentCommonAncestor()??t.getCurrentPageId()),r}getCurrentCommonAncestor(){return this.editor.findCommonAncestor(this.editor.getSelectedShapes())}}Rr([T],Cs.prototype,"getSnapThreshold");Rr([T],Cs.prototype,"getSnappableShapes");Rr([T],Cs.prototype,"getCurrentCommonAncestor");const Lu=/\r?\n|\r/g;function Ti(n){return n.replace(Lu,`
`).split(`
`).map(t=>t||" ").join(`
`)}const Bu={start:"left","start-legacy":"left",middle:"center","middle-legacy":"center",end:"right","end-legacy":"right"},zu=/\s/;class Nu{constructor(t){u(this,"baseElm");u(this,"measureText",(t,e)=>{var o;const s=(o=this.baseElm)==null?void 0:o.cloneNode();this.baseElm.insertAdjacentElement("afterend",s),s.setAttribute("dir","ltr"),s.style.setProperty("font-family",e.fontFamily),s.style.setProperty("font-style",e.fontStyle),s.style.setProperty("font-weight",e.fontWeight),s.style.setProperty("font-size",e.fontSize+"px"),s.style.setProperty("line-height",e.lineHeight*e.fontSize+"px"),s.style.setProperty("max-width",e.maxWidth===null?null:e.maxWidth+"px"),s.style.setProperty("min-width",e.minWidth===null?null:e.minWidth+"px"),s.style.setProperty("padding",e.padding),s.style.setProperty("overflow-wrap",e.disableOverflowWrapBreaking?"normal":"break-word"),s.textContent=Ti(t);const r=s.scrollWidth,i=s.getBoundingClientRect();return s.remove(),{x:0,y:0,w:i.width,h:i.height,scrollWidth:r}});var r;this.editor=t;const e=this.editor.getContainer();(r=e.querySelector("#tldraw_text_measure"))==null||r.remove();const s=document.createElement("div");s.id="tldraw_text_measure",s.classList.add("tl-text"),s.classList.add("tl-text-measure"),s.tabIndex=-1,e.appendChild(s),this.baseElm=s}measureElementTextNodeSpans(t,{shouldTruncateToFirstLine:e=!1}={}){const s=[],r=t.getBoundingClientRect(),i=-r.left,o=-r.top,a=new Range,c=t.childNodes[0];let l=0,d=null,h=null,p=0,f=!1;for(const y of t.childNodes)if(y.nodeType===Node.TEXT_NODE)for(const g of y.textContent??""){a.setStart(c,l),a.setEnd(c,l+g.length);const x=a.getClientRects(),w=x[x.length-1],I=w.top+o,b=w.left+i,P=w.right+i,v=zu.test(g);if(v!==h||I!==p||!d){if(d){if(e&&I!==p){f=!0;break}s.push(d)}d={box:{x:b,y:I,w:w.width,h:w.height},text:g}}else d.box.w=P-d.box.x,d.text+=g;h=v,p=I,l+=g.length}return d&&s.push(d),{spans:s,didTruncate:f}}measureTextSpans(t,e){var l;if(t==="")return[];const s=(l=this.baseElm)==null?void 0:l.cloneNode();this.baseElm.insertAdjacentElement("afterend",s);const r=Math.ceil(e.width-e.padding*2);s.style.setProperty("width",`${r}px`),s.style.setProperty("height","min-content"),s.style.setProperty("dir","ltr"),s.style.setProperty("font-size",`${e.fontSize}px`),s.style.setProperty("font-family",e.fontFamily),s.style.setProperty("font-weight",e.fontWeight),s.style.setProperty("line-height",`${e.lineHeight*e.fontSize}px`),s.style.setProperty("text-align",Bu[e.textAlign]);const i=e.overflow==="truncate-ellipsis"||e.overflow==="truncate-clip";i&&(s.style.setProperty("overflow-wrap","anywhere"),s.style.setProperty("word-break","break-all"));const o=Ti(t);s.textContent=o;const{spans:a,didTruncate:c}=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:i});if(e.overflow==="truncate-ellipsis"&&c){s.textContent="";const d=Math.ceil(this.measureElementTextNodeSpans(s).spans[0].box.w);s.style.setProperty("width",`${r-d}px`),s.textContent=o;const h=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:!0}).spans,p=h[h.length-1];return h.push({text:"",box:{x:Math.min(p.box.x+p.box.w,e.width-e.padding-d),y:p.box.y,w:d,h:p.box.h}}),h}return s.remove(),a}}const ki=ro;class Uu{constructor(t){u(this,"cancelRaf");u(this,"isPaused",!0);u(this,"now",0);u(this,"start",()=>{var t;this.isPaused=!1,(t=this.cancelRaf)==null||t.call(this),this.cancelRaf=ki(this.tick),this.now=Date.now()});u(this,"tick",()=>{if(this.isPaused)return;const t=Date.now(),e=t-this.now;this.now=t,this.updatePointerVelocity(e),this.editor.emit("frame",e),this.editor.emit("tick",e),this.cancelRaf=ki(this.tick)});u(this,"dispose",()=>{var t;this.isPaused=!0,(t=this.cancelRaf)==null||t.call(this)});u(this,"prevPoint",new m);u(this,"updatePointerVelocity",t=>{const{prevPoint:e,editor:{inputs:{currentScreenPoint:s,pointerVelocity:r}}}=this;if(t===0)return;const i=m.Sub(s,e);this.prevPoint=s.clone();const o=i.len(),a=o?i.div(o):new m(0,0),c=r.clone().lrp(a.mul(o/t),.5);Math.abs(c.x)<.01&&(c.x=0),Math.abs(c.y)<.01&&(c.y=0),r.equals(c)||(this.editor.inputs.pointerVelocity=c)});this.editor=t,this.editor.disposables.add(this.dispose),this.start()}}var $u=Object.defineProperty,Hu=Object.getOwnPropertyDescriptor,st=(n,t,e,s)=>{for(var r=Hu(t,e),i=n.length-1,o;i>=0;i--)(o=n[i])&&(r=o(t,e,r)||r);return r&&$u(t,e,r),r};class Ze{constructor(t,e){u(this,"updateUserPreferences",t=>{this.user.setUserPreferences({...this.user.userPreferences.get(),...t})});this.user=t,this.inferDarkMode=e}getUserPreferences(){return{id:this.getId(),name:this.getName(),locale:this.getLocale(),color:this.getColor(),animationSpeed:this.getAnimationSpeed(),isSnapMode:this.getIsSnapMode(),isDarkMode:this.getIsDarkMode(),isWrapMode:this.getIsWrapMode()}}getIsDarkMode(){return this.user.userPreferences.get().isDarkMode??(this.inferDarkMode?Hh():!1)}getEdgeScrollSpeed(){return this.user.userPreferences.get().edgeScrollSpeed??_t.edgeScrollSpeed}getAnimationSpeed(){return this.user.userPreferences.get().animationSpeed??_t.animationSpeed}getId(){return this.user.userPreferences.get().id}getName(){return this.user.userPreferences.get().name??_t.name}getLocale(){return this.user.userPreferences.get().locale??_t.locale}getColor(){return this.user.userPreferences.get().color??_t.color}getIsSnapMode(){return this.user.userPreferences.get().isSnapMode??_t.isSnapMode}getIsWrapMode(){return this.user.userPreferences.get().isWrapMode??_t.isWrapMode}}st([T],Ze.prototype,"getUserPreferences");st([T],Ze.prototype,"getIsDarkMode");st([T],Ze.prototype,"getEdgeScrollSpeed");st([T],Ze.prototype,"getAnimationSpeed");st([T],Ze.prototype,"getId");st([T],Ze.prototype,"getName");st([T],Ze.prototype,"getLocale");st([T],Ze.prototype,"getColor");st([T],Ze.prototype,"getIsSnapMode");st([T],Ze.prototype,"getIsWrapMode");function fn(n){return Math.abs(n.props.bend)<8}function os(n,t){if(t.type==="point")return;const e=n.getShape(t.boundShapeId),s=n.getShapePageTransform(e),r=n.getShapeGeometry(e),i=r instanceof Is?r.children[0].vertices:r.vertices;return{shape:e,transform:s,isClosed:r.isClosed,isExact:t.isExact,didIntersect:!1,outline:i}}function Mi(n,t,e,s){if(e.type==="point")return m.From(e);const r=n.getShape(e.boundShapeId);if(r){const{point:i,size:o}=n.getShapeGeometry(r).bounds,a=m.Add(i,m.MulV(e.isPrecise||s?e.normalizedAnchor:{x:.5,y:.5},o)),c=F.applyToPoint(n.getShapePageTransform(r),a);return F.applyToPoint(F.Inverse(t),c)}else return new m(0,0)}function kt(n,t){const e=n.getShapePageTransform(t);let s,r;t.props.start.type==="binding"&&t.props.end.type==="binding"&&(s=t.props.start.boundShapeId,r=t.props.end.boundShapeId);const i=Dr(n,s,r),o=Mi(n,e,t.props.start,i==="double-bound"||i==="start-contains-end"),a=Mi(n,e,t.props.end,i==="double-bound"||i==="end-contains-start");return{start:o,end:a}}const Pn=10,as=10,Ku=10,St={s:2,m:3.5,l:5,xl:10};function Dr(n,t,e){if(!t||!e)return"safe";if(t===e)return"double-bound";const s=n.getShapePageBounds(t),r=n.getShapePageBounds(e);if(s&&r){if(s.contains(r))return"start-contains-end";if(r.contains(s))return"end-contains-start"}return"safe"}function vn(n,t){const{start:e,end:s,arrowheadStart:r,arrowheadEnd:i}=t.props,o=kt(n,t),a=o.start.clone(),c=o.end.clone(),l=m.Med(a,c);if(m.Equals(a,c))return{isStraight:!0,start:{handle:a,point:a,arrowhead:t.props.arrowheadStart},end:{handle:c,point:c,arrowhead:t.props.arrowheadEnd},middle:l,isValid:!1,length:0};const d=m.Sub(c,a).uni(),h=os(n,e),p=os(n,s),f=n.getShapePageTransform(t);Ai(c,o.start,f,p),Ai(a,o.end,f,h);let y=0,g=0,x=0,w=0,I=Pn;const b=h&&p&&h.shape===p.shape,P=h&&p?Dr(n,h.shape.id,p.shape.id):"safe";P==="safe"&&h&&p&&!b&&!h.isExact&&!p.isExact&&(p.didIntersect&&!h.didIntersect?h.isClosed&&a.setTo(c.clone().add(d.clone().mul(Pn))):p.didIntersect||p.isClosed&&c.setTo(a.clone().sub(d.clone().mul(Pn))));const v=m.Sub(c,a),C=m.Len(v)?v.uni():m.From(v),E=!m.Equals(C,d);b||(P!=="start-contains-end"&&h&&r!=="none"&&!h.isExact&&(x=St[t.props.size]/2+("size"in h.shape.props?St[h.shape.props.size]/2:0),y=as+x,I+=x),P!=="end-contains-start"&&p&&i!=="none"&&!p.isExact&&(w=St[t.props.size]/2+("size"in p.shape.props?St[p.shape.props.size]/2:0),g=as+w,I+=w));const A=a.clone().add(C.clone().mul(y*(E?-1:1))),_=c.clone().sub(C.clone().mul(g*(E?-1:1)));m.DistMin(A,_,I)&&(y!==0&&g!==0?(y*=-1.5,g*=-1.5):y!==0?y*=-1:g!==0&&(g*=-1)),a.add(C.clone().mul(y*(E?-1:1))),c.sub(C.clone().mul(g*(E?-1:1))),E?(h&&p&&c.setTo(m.Add(a,C.clone().mul(-10))),l.setTo(m.Med(o.start,o.end))):l.setTo(m.Med(a,c));const k=m.Dist(a,c);return{isStraight:!0,start:{handle:o.start,point:a,arrowhead:t.props.arrowheadStart},end:{handle:o.end,point:c,arrowhead:t.props.arrowheadEnd},middle:l,isValid:k>0,length:k}}function Ai(n,t,e,s){if(s===void 0||s.isExact)return;const r=F.applyToPoint(e,t),i=F.applyToPoint(e,n),o=F.applyToPoint(F.Inverse(s.transform),r),a=F.applyToPoint(F.Inverse(s.transform),i),c=s.isClosed,d=(c?Zh:Vh)(o,a,s.outline);let h;if(d!==null&&(h=d.sort((y,g)=>m.Dist2(y,o)-m.Dist2(g,o))[0]??(c?void 0:a)),h===void 0)return;const p=F.applyToPoint(s.transform,h),f=F.applyToPoint(F.Inverse(e),p);n.setTo(f),s.didIntersect=!0}function qs(n,t,e=0){const{arrowheadEnd:s,arrowheadStart:r}=t.props,i=t.props.bend+e;if(Math.abs(i)>Math.abs(t.props.bend*Ku))return vn(n,t);const o=kt(n,t),a=m.Med(o.start,o.end),c=m.Sub(o.end,o.start),l=m.Len(c)?c.uni():m.From(c),d=m.Add(a,l.per().mul(-i)),h=os(n,t.props.start),p=os(n,t.props.end),f=o.start.clone(),y=o.end.clone(),g=d.clone();if(m.Equals(f,y))return{isStraight:!0,start:{handle:f,point:f,arrowhead:t.props.arrowheadStart},end:{handle:y,point:y,arrowhead:t.props.arrowheadEnd},middle:g,isValid:!1,length:0};const x=t.props.bend<0,w=x?ws:Eo,I=Ri(f,y,g),b=m.Angle(I.center,f),P=m.Angle(I.center,y),v=w(b,P);if(I.length===0||I.size===0||!ci(I.length)||!ci(I.size))return vn(n,t);const C=f.clone(),E=y.clone(),A=g.clone(),_=n.getShapePageTransform(t);let k=0,R=0,X=Pn;if(h&&!h.isExact){const ne=F.applyToPoint(_,C),we=F.applyToPoint(_,I.center),Pt=F.applyToPoint(_,E),vt=F.Inverse(h.transform),rn=F.applyToPoint(vt,ne),de=F.applyToPoint(vt,we),on=F.applyToPoint(vt,Pt),{isClosed:ot}=h,ks=ot?bi:Ii;let Qe,Be=ks(de,I.radius,h.outline);if(Be){const ae=de.angle(rn),Ms=de.angle(on),an=w(ae,Ms);Be=Be.filter($e=>w(ae,de.angle($e))<=an);const cn=an*.25;Be.sort(ot?($e,Ct)=>Math.abs(w(ae,de.angle($e))-cn)<Math.abs(w(ae,de.angle(Ct))-cn)?-1:1:($e,Ct)=>w(ae,de.angle($e))<w(ae,de.angle(Ct))?-1:1),Qe=Be[0]??(ot?void 0:rn)}else Qe=ot?void 0:rn;if(Qe&&(C.setTo(n.getPointInShapeSpace(t,F.applyToPoint(h.transform,Qe))),h.didIntersect=!0,r!=="none")){const ae=St[t.props.size]/2+("size"in h.shape.props?St[h.shape.props.size]/2:0);k=as+ae,X+=ae}}if(p&&!p.isExact){const ne=F.applyToPoint(_,C),we=F.applyToPoint(_,E),Pt=F.applyToPoint(_,I.center),vt=F.Inverse(p.transform),rn=F.applyToPoint(vt,ne),de=F.applyToPoint(vt,Pt),on=F.applyToPoint(vt,we),ot=p.isClosed,ks=ot?bi:Ii;let Qe,Be=ks(de,I.radius,p.outline);if(Be){const ae=de.angle(rn),Ms=de.angle(on),an=w(ae,Ms),cn=an*.75;Be=Be.filter($e=>w(ae,de.angle($e))<=an),Be.sort(ot?($e,Ct)=>Math.abs(w(ae,de.angle($e))-cn)<Math.abs(w(ae,de.angle(Ct))-cn)?-1:1:($e,Ct)=>w(ae,de.angle($e))<w(ae,de.angle(Ct))?-1:1),Be[0]?Qe=Be[0]:Qe=ot?void 0:on}else Qe=ot?void 0:on;if(Qe&&(E.setTo(n.getPointInShapeSpace(t,F.applyToPoint(p.transform,Qe))),p.didIntersect=!0,s!=="none")){const ae=St[t.props.size]/2+("size"in p.shape.props?St[p.shape.props.size]/2:0);R=as+ae,X+=ae}}let j=m.Angle(I.center,C),U=m.Angle(I.center,E),ie=w(j,U),le=ie*I.radius;const rt=C.clone(),xe=E.clone();if(k!==0){const ne=k/le*(x?1:-1),we=m.FromAngle(j+ie*ne);rt.setTo(I.center).add(we.mul(I.radius))}if(R!==0){const ne=R/le*(x?-1:1),we=m.FromAngle(U+ie*ne);xe.setTo(I.center).add(we.mul(I.radius))}if(m.DistMin(rt,xe,X)&&(k!==0&&R!==0?(k*=-1.5,R*=-1.5):k!==0?k*=-2:R!==0&&(R*=-2)),k!==0){const ne=k/le*(x?1:-1),we=m.FromAngle(j+ie*ne);C.setTo(I.center).add(we.mul(I.radius))}if(R!==0){const ne=R/le*(x?-1:1),we=m.FromAngle(U+ie*ne);E.setTo(I.center).add(we.mul(I.radius))}if(h&&p&&!h.isExact&&!p.isExact){j=m.Angle(I.center,C),U=m.Angle(I.center,E),ie=w(j,U),le=ie*I.radius;const ne=Dr(n,h.shape.id,p.shape.id);if(ne==="double-bound"&&le<30)C.setTo(f),E.setTo(y),A.setTo(g);else if(ne==="safe"&&(h&&!h.didIntersect&&C.setTo(f),p&&!p.didIntersect||w(b,j)>w(b,U))){const we=Math.min(.9,Pn/le)*(x?1:-1),Pt=m.FromAngle(j+ie*we);E.setTo(I.center).add(Pt.mul(I.radius))}}Yu(I.center,I.radius,C,E,A,v,x),C.equals(E)&&(C.setTo(A.clone().addXY(1,1)),E.setTo(A.clone().subXY(1,1))),f.setTo(C),y.setTo(E),g.setTo(A);const it=Ri(f,y,g);return{isStraight:!1,start:{point:f,handle:o.start,arrowhead:t.props.arrowheadStart},end:{point:y,handle:o.end,arrowhead:t.props.arrowheadEnd},middle:g,handleArc:I,bodyArc:it,isValid:it.length!==0&&isFinite(it.center.x)&&isFinite(it.center.y)}}function Ri(n,t,e){const s=-2*(n.x*(t.y-e.y)-n.y*(t.x-e.x)+t.x*e.y-e.x*t.y),r={x:((n.x*n.x+n.y*n.y)*(e.y-t.y)+(t.x*t.x+t.y*t.y)*(n.y-e.y)+(e.x*e.x+e.y*e.y)*(t.y-n.y))/s,y:((n.x*n.x+n.y*n.y)*(t.x-e.x)+(t.x*t.x+t.y*t.y)*(e.x-n.x)+(e.x*e.x+e.y*e.y)*(n.x-t.x))/s},i=m.Dist(r,n),o=+m.Clockwise(n,e,t),a=((n.y-t.y)**2+(n.x-t.x)**2)**.5,c=((t.y-e.y)**2+(t.x-e.x)**2)**.5,l=((e.y-n.y)**2+(e.x-n.x)**2)**.5,d=Math.acos((c*c+l*l-a*a)/(2*c*l))*2,h=+(ue>d),p=(ee-d)*(o?1:-1),f=p*i;return{center:r,radius:i,size:p,length:f,largeArcFlag:h,sweepFlag:o}}function Yu(n,t,e,s,r,i,o){const a=m.Angle(n,e),c=m.Angle(n,s);let l=ws(a,c);o||(l=ee-l);const d=.5*(o?1:-1),h=m.FromAngle(a+l*d);if(r.setTo(n).add(h.mul(t)),l>i){r.rotWith(n,ue);const p=s.clone();s.setTo(e),e.setTo(p)}}const Xu={wheel:"onWheel",pointer_down:"onPointerDown",pointer_move:"onPointerMove",long_press:"onLongPress",pointer_up:"onPointerUp",right_click:"onRightClick",middle_click:"onMiddleClick",key_down:"onKeyDown",key_up:"onKeyUp",key_repeat:"onKeyRepeat",cancel:"onCancel",complete:"onComplete",interrupt:"onInterrupt",double_click:"onDoubleClick",triple_click:"onTripleClick",quadruple_click:"onQuadrupleClick",tick:"onTick"};class Ot{constructor(t,e){u(this,"id");u(this,"type");u(this,"shapeType");u(this,"initial");u(this,"children");u(this,"parent");u(this,"_path");u(this,"_current");u(this,"_isActive");u(this,"transition",(t,e={})=>{var i;const s=t.split(".");let r=this;for(let o=0;o<s.length;o++){const a=s[o],c=r.getCurrent(),l=(i=r.children)==null?void 0:i[a];if(!l)throw Error(`${r.id} - no child state exists with the id ${a}.`);if((c==null?void 0:c.id)!==l.id&&(c==null||c.exit(e,a),r._current.set(l),l.enter(e,(c==null?void 0:c.id)||"initial"),!l.getIsActive()))break;r=l}return this});u(this,"handleEvent",t=>{var r;const e=Xu[t.name],s=this._current.__unsafe__getWithoutCapture();(r=this[e])==null||r.call(this,t),this._isActive.__unsafe__getWithoutCapture()&&s&&s===this._current.__unsafe__getWithoutCapture()&&s.handleEvent(t)});u(this,"enter",(t,e)=>{var s;if(this._isActive.set(!0),(s=this.onEnter)==null||s.call(this,t,e),this.children&&this.initial&&this.getIsActive()){const r=this.children[this.initial];this._current.set(r),r.enter(t,e)}});u(this,"exit",(t,e)=>{var s,r;this._isActive.set(!1),(s=this.onExit)==null||s.call(this,t,e),this.getIsActive()||(r=this.getCurrent())==null||r.exit(t,e)});u(this,"_currentToolIdMask",Te("curent tool id mask",void 0));u(this,"onWheel");u(this,"onPointerDown");u(this,"onPointerMove");u(this,"onLongPress");u(this,"onPointerUp");u(this,"onDoubleClick");u(this,"onTripleClick");u(this,"onQuadrupleClick");u(this,"onRightClick");u(this,"onMiddleClick");u(this,"onKeyDown");u(this,"onKeyUp");u(this,"onKeyRepeat");u(this,"onCancel");u(this,"onComplete");u(this,"onInterrupt");u(this,"onTick");u(this,"onEnter");u(this,"onExit");this.editor=t;const{id:s,children:r,initial:i}=this.constructor;this.id=s,this._isActive=Te("toolIsActive"+this.id,!1),this._current=Te("toolState"+this.id,void 0),this._path=T("toolPath"+this.id,()=>{const o=this.getCurrent();return this.id+(o?`.${o.getPath()}`:"")}),this.parent=e??{},this.parent?r&&i?(this.type="branch",this.initial=i,this.children=Object.fromEntries(r().map(o=>[o.id,new o(this.editor,this)])),this._current.set(this.children[this.initial])):this.type="leaf":(this.type="root",r&&i&&(this.initial=i,this.children=Object.fromEntries(r().map(o=>[o.id,new o(this.editor,this)])),this._current.set(this.children[this.initial])))}getPath(){return this._path.get()}getCurrent(){return this._current.get()}getIsActive(){return this._isActive.get()}getCurrentToolIdMask(){return this._currentToolIdMask.get()}setCurrentToolIdMask(t){this._currentToolIdMask.set(t)}}u(Ot,"id"),u(Ot,"initial"),u(Ot,"children");class Gn extends Ot{constructor(){super(...arguments);u(this,"onKeyDown",e=>{var s;switch(e.code){case"KeyZ":{if(!(e.shiftKey||e.ctrlKey)){const r=this.getCurrent();r&&((s=r.getCurrent())==null?void 0:s.id)==="idle"&&this.children.zoom&&this.editor.setCurrentTool("zoom",{...e,onInteractionEnd:r.id})}break}}})}}u(Gn,"id","root"),u(Gn,"initial",""),u(Gn,"children",()=>[]);var Gu=Object.defineProperty,qu=Object.getOwnPropertyDescriptor,O=(n,t,e,s)=>{for(var r=qu(t,e),i=n.length-1,o;i>=0;i--)(o=n[i])&&(r=o(t,e,r)||r);return r&&Gu(t,e,r),r};class D extends Sa.EventEmitter{constructor({store:e,user:s,shapeUtils:r,tools:i,getContainer:o,initialState:a,inferDarkMode:c}){super();u(this,"store");u(this,"root");u(this,"disposables",new Set);u(this,"_tickManager");u(this,"snaps");u(this,"user");u(this,"textMeasure");u(this,"environment");u(this,"scribbles");u(this,"getContainer");u(this,"sideEffects");u(this,"shapeUtils");u(this,"styleProps");u(this,"history",new vu(this,e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)}));u(this,"_crashingError",null);u(this,"_updateInstanceState",this.history.createCommand("updateInstanceState",(e,s)=>{const r=this.store.get(this.getInstanceState().id),i={...r,...e};return{data:{prev:r,next:i},ephemeral:!1,squashing:!1,...s}},{do:({next:e})=>{this.store.put([e])},undo:({prev:e})=>{this.store.put([e])},squash({prev:e},{next:s}){return{prev:e,next:s}}}));u(this,"_isChangingStyleTimeout",-1);u(this,"setCursor",e=>(this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}},{ephemeral:!0}),this));u(this,"_setInstancePageState",this.history.createCommand("setInstancePageState",(e,s)=>({data:{prev:this.store.get(e.id??this.getCurrentPageState().id),partial:e},...s}),{do:({prev:e,partial:s})=>{this.store.update(e.id,r=>({...r,...s}))},undo:({prev:e})=>{this.store.update(e.id,()=>e)}}));u(this,"_setSelectedShapes",this.history.createCommand("setSelectedShapes",(e,s)=>{const{selectedShapeIds:r}=this.getCurrentPageState(),i=new Set(r);return e.length===i.size&&e.every(o=>i.has(o))?null:{data:{selectedShapeIds:e,prevSelectedShapeIds:r},preservesRedoStack:!0,...s}},{do:({selectedShapeIds:e})=>{this.store.put([{...this.getCurrentPageState(),selectedShapeIds:e}])},undo:({prevSelectedShapeIds:e})=>{this.store.put([{...this.getCurrentPageState(),selectedShapeIds:e}])},squash({prevSelectedShapeIds:e},{selectedShapeIds:s}){return{selectedShapeIds:s,prevSelectedShapeIds:e}}}));u(this,"_setFocusedGroupId",this.history.createCommand("setFocusedGroupId",e=>{const s=this.getCurrentPageState().focusedGroupId;if(s!==e)return{data:{prev:s,next:e},preservesRedoStack:!0,squashing:!0}},{do:({next:e})=>{this.store.update(this.getCurrentPageState().id,s=>({...s,focusedGroupId:e}))},undo:({prev:e})=>{this.store.update(this.getCurrentPageState().id,s=>({...s,focusedGroupId:e}))},squash({prev:e},{next:s}){return{prev:e,next:s}}}));u(this,"_viewportAnimation",null);u(this,"_willSetInitialBounds",!0);u(this,"_wasInset",!1);u(this,"_cameraState",Te("camera state","idle"));u(this,"_cameraStateTimeoutRemaining",0);u(this,"_lastUpdateRenderingBoundsTimestamp",Date.now());u(this,"_decayCameraStateTimeout",e=>{this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining<=0&&(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"),this.updateRenderingBounds())});u(this,"_tickCameraState",()=>{this._cameraStateTimeoutRemaining=hd;const e=Date.now();this._cameraState.__unsafe__getWithoutCapture()==="idle"&&(this._lastUpdateRenderingBoundsTimestamp=e,this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))});u(this,"_renderingBounds",Te("rendering viewport",new $));u(this,"renderingBoundsMargin",100);u(this,"_currentPageShapeIds");u(this,"_setCurrentPageId",this.history.createCommand("setCurrentPage",(e,s)=>{if(!this.store.has(e)){console.error("Tried to set the current page id to a page that doesn't exist.");return}return this.stopFollowingUser(),{data:{toId:e,fromId:this.getCurrentPageId()},squashing:!0,preservesRedoStack:!0,...s}},{do:({toId:e})=>{if(this.store.has(e)){if(!this.getPageStates().find(s=>s.pageId===e)){const s=Ie.create({id:Ie.createId(e)});this.store.put([s,ge.create({id:ge.createId(e),pageId:e})])}this.store.put([{...this.getInstanceState(),currentPageId:e}]),this.updateRenderingBounds()}},undo:({fromId:e})=>{this.store.has(e)&&(this.store.put([{...this.getInstanceState(),currentPageId:e}]),this.updateRenderingBounds())},squash:({fromId:e},{toId:s})=>({toId:s,fromId:e})}));u(this,"_updatePage",this.history.createCommand("updatePage",(e,s)=>{if(this.getInstanceState().isReadonly)return null;const r=this.getPage(e.id);return r?{data:{prev:r,partial:e},...s}:null},{do:({partial:e})=>{this.store.update(e.id,s=>({...s,...e}))},undo:({prev:e,partial:s})=>{this.store.update(s.id,()=>e)},squash(e,s){return{prev:{...e.prev,...s.prev},partial:s.partial}}}));u(this,"_createPage",this.history.createCommand("createPage",e=>{if(this.getInstanceState().isReadonly||this.getPages().length>=di)return null;const s=this.getPages(),r=ru(e.name??"Page 1",s.map(l=>l.name));let i=e.index;(!i||s.some(l=>l.index===i))&&(i=zt(s[s.length-1].index));const o=En.create({meta:{},...e,name:r,index:i}),a=Ie.create({id:Ie.createId(o.id)}),c=ge.create({id:ge.createId(o.id),pageId:o.id});return{data:{newPage:o,newTabPageState:c,newCamera:a}}},{do:({newPage:e,newTabPageState:s,newCamera:r})=>{this.store.put([e,r,s])},undo:({newPage:e,newTabPageState:s,newCamera:r})=>{this.getPages().length!==1&&this.store.remove([s.id,e.id,r.id])}}));u(this,"_deletePage",this.history.createCommand("delete_page",e=>{if(this.getInstanceState().isReadonly)return null;const s=this.getPages();if(s.length===1)return null;const r=this.getPage(e),i=this.getPageStates().filter(o=>o.pageId===e);if(!r)return null;if(e===this.getCurrentPageId()){const o=s.findIndex(c=>c.id===e),a=s[o-1]??s[o+1];this.setCurrentPage(a.id)}return{data:{id:e,deletedPage:r,deletedPageStates:i}}},{do:({deletedPage:e,deletedPageStates:s})=>{const r=this.getPages();if(r.length!==1){if(e.id===this.getCurrentPageId()){const i=r.findIndex(a=>a.id===e.id),o=r[i-1]??r[i+1];this.setCurrentPage(o.id)}this.store.remove(s.map(i=>i.id)),this.store.remove([e.id]),this.updateRenderingBounds()}},undo:({deletedPage:e,deletedPageStates:s})=>{this.store.put([e]),this.store.put(s),this.updateRenderingBounds()}}));u(this,"_createAssets",this.history.createCommand("createAssets",e=>this.getInstanceState().isReadonly||e.length<=0?null:{data:{assets:e}},{do:({assets:e})=>{this.store.put(e)},undo:({assets:e})=>{this.store.remove(e.map(s=>s.id))}}));u(this,"_updateAssets",this.history.createCommand("updateAssets",e=>this.getInstanceState().isReadonly||e.length<=0?void 0:{data:{snapshots:{},assets:e}},{do:({assets:e,snapshots:s})=>{this.store.put(e.map(r=>{const i=this.store.get(r.id);return s[r.id]=i,{...i,...r}}))},undo:({snapshots:e})=>{this.store.put(Object.values(e))}}));u(this,"_deleteAssets",this.history.createCommand("deleteAssets",e=>{if(this.getInstanceState().isReadonly||e.length<=0)return;const s=G(e.map(r=>this.store.get(r)));return{data:{ids:e,prev:s}}},{do:({ids:e})=>{this.store.remove(e)},undo:({prev:e})=>{this.store.put(e)}}));u(this,"_parentIdsToChildIds");u(this,"_childIdsCache",new nu);u(this,"_createShapes",this.history.createCommand("createShapes",e=>{if(this.getInstanceState().isReadonly||e.length<=0)return null;const s=this.getCurrentPageShapeIds();if(e.length+s.size>ct){$n(this);return}return e.length===0?null:{data:{currentPageId:this.getCurrentPageId(),partials:e.map(i=>i.id?i:{...i,id:Zt()})}}},{do:({partials:e})=>{var a,c;const s=this.getFocusedGroupId(),r=this.getCurrentPageShapesSorted();e=e.map(l=>{if(!l.parentId||!(this.store.has(l.parentId)||e.some(d=>d.id===l.parentId))){let d=this.getFocusedGroupId();for(let p=r.length-1;p>=0;p--){const f=r[p];if(this.getShapeUtil(f).canReceiveNewChildrenOfType(f,l.type)&&this.isPointInShape(f,{x:l.x??0,y:l.y??0},{margin:0,hitInside:!0})){d=f.id;break}}const h=l.parentId;if(d===l.id&&(d=s),d!==h&&(l={...l},l.parentId=d,He(d))){const p=this.getPointInShapeSpace(this.getShape(d),{x:l.x??0,y:l.y??0});l.x=p.x,l.y=p.y,l.rotation=-this.getShapePageTransform(d).rotation()+(l.rotation??0)}}return l});const i=new Map,o=[];for(const l of e){const d=this.getShapeUtil(l);let h=l.index;if(!h){const g=l.parentId??s;i.has(g)||i.set(g,this.getHighestIndexForParent(g)),h=i.get(g),i.set(g,zt(h))}const p=d.getDefaultProps();for(const[g,x]of this.styleProps[l.type])p[x]=this.getStyleForNextShape(g);let f=this.store.schema.types.shape.create({...l,index:h,opacity:l.opacity??this.getInstanceState().opacityForNextShape,parentId:l.parentId??s,props:"props"in l?{...p,...l.props}:p});if(f.index===void 0)throw Error("no index!");const y=(c=(a=this.getShapeUtil(f)).onBeforeCreate)==null?void 0:c.call(a,f);y&&(f=y),o.push(f)}o.forEach(l=>{l.meta={...this.getInitialMetaForShape(l),...l.meta}}),this.store.put(o)},undo:({partials:e})=>{this.store.remove(e.map(s=>s.id))}}));u(this,"animatingShapes",new Map);u(this,"_updateShapes",this.history.createCommand("updateShapes",(e,s)=>{if(this.getInstanceState().isReadonly)return null;const r={},i={};let o,a;for(let c=0,l=e.length;c<l;c++){const d=e[c];d&&(o=this.getShape(d.id),o&&(a=gn(o,d),a!==o&&(r[o.id]=o,i[o.id]=a)))}return{data:{snapshots:r,updates:i},...s}},{do:({updates:e})=>{this.store.put(oe(e).map(s=>{var i,o;const r=this.store.get(s.id);if(r){const a=(o=(i=this.getShapeUtil(s)).onBeforeUpdate)==null?void 0:o.call(i,r,s);if(a)return a}return s}))},undo:({snapshots:e})=>{this.store.put(Object.values(e))},squash(e,s){return{snapshots:{...s.snapshots,...e.snapshots},updates:{...e.updates,...s.updates}}}}));u(this,"_deleteShapes",this.history.createCommand("delete_shapes",e=>{if(this.getInstanceState().isReadonly||e.length===0)return null;const s=[...this.getCurrentPageState().selectedShapeIds],r=new Set(e);for(const l of e)this.visitDescendants(l,d=>{r.add(d)});const i=[...r],o=this._getArrowBindingsIndex().get(),a=G(i.flatMap(l=>{const d=this.getShape(l),h=o[l];return h&&h.length>0?h.map(({arrowId:p})=>this.getShape(p)).concat(d):d})),c=s.filter(l=>!r.has(l));return{data:{deletedIds:i,snapshots:a,prevSelectedShapeIds:s,postSelectedShapeIds:c}}},{do:({deletedIds:e,postSelectedShapeIds:s})=>{this.store.remove(e),this.store.update(this.getCurrentPageState().id,r=>({...r,selectedShapeIds:s}))},undo:({snapshots:e,prevSelectedShapeIds:s})=>{this.store.put(e),this.store.update(this.getCurrentPageState().id,r=>({...r,selectedShapeIds:s}))}}));u(this,"externalAssetContentHandlers",{file:null,url:null});u(this,"externalContentHandlers",{text:null,files:null,embed:null,"svg-text":null,url:null});u(this,"inputs",{originPagePoint:new m,originScreenPoint:new m,previousPagePoint:new m,previousScreenPoint:new m,currentPagePoint:new m,currentScreenPoint:new m,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,pointerVelocity:new m});u(this,"_clickManager",new wu(this));u(this,"_prevCursor","default");u(this,"_shiftKeyTimeout",-1);u(this,"_setShiftKeyTimeout",()=>{this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ShiftLeft"})});u(this,"_altKeyTimeout",-1);u(this,"_setAltKeyTimeout",()=>{this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"AltLeft"})});u(this,"_ctrlKeyTimeout",-1);u(this,"_setCtrlKeyTimeout",()=>{this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ControlLeft"})});u(this,"_restoreToolId","select");u(this,"_pinchStart",1);u(this,"_didPinch",!1);u(this,"_selectedShapeIdsAtPointerDown",[]);u(this,"_longPressTimeout",-1);u(this,"capturedPointerId",null);u(this,"dispatch",e=>(this._pendingEventsForNextTick.push(e),e.type==="pointer"&&e.name==="pointer_move"||e.type==="wheel"||e.type==="pinch"||this._flushEventsForTick(0),this));u(this,"_pendingEventsForNextTick",[]);u(this,"_flushEventForTick",e=>{if(this.getCrashingError())return this;const{inputs:s}=this,{type:r}=e;if(e.type==="misc"){(e.name==="cancel"||e.name==="complete")&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.updateInstanceState({cursor:{type:this._prevCursor,rotation:0}}))),this.root.handleEvent(e);return}e.shiftKey?(clearInterval(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,s.shiftKey=!0):!e.shiftKey&&s.shiftKey&&this._shiftKeyTimeout===-1&&(this._shiftKeyTimeout=setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearInterval(this._altKeyTimeout),this._altKeyTimeout=-1,s.altKey=!0):!e.altKey&&s.altKey&&this._altKeyTimeout===-1&&(this._altKeyTimeout=setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearInterval(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,s.ctrlKey=!0):!e.ctrlKey&&s.ctrlKey&&this._ctrlKeyTimeout===-1&&(this._ctrlKeyTimeout=setTimeout(this._setCtrlKeyTimeout,150));const{originPagePoint:i,originScreenPoint:o,currentPagePoint:a,currentScreenPoint:c}=s;switch(s.isPointing||(s.isDragging=!1),r){case"pinch":{if(!this.getInstanceState().canMoveCamera)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":{if(s.isPinching)return;s.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds()),this._didPinch=!0,s.isPinching=!0,this.interrupt());return}case"pinch":{if(!s.isPinching)return;const{point:{z:l=1},delta:{x:d,y:h}}=e,{screenBounds:p}=this.store.unsafeGetWithoutCapture(_e),{x:f,y}=m.SubXY(e.point,p.x,p.y),{x:g,y:x,z:w}=this.getCamera(),I=Math.min(Yt,Math.max(pn,l));this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this._setCamera({x:g+d/w-f/w+f/I,y:x+h/w-y/w+y/I,z:I},!0);return}case"pinch_end":{if(!s.isPinching)return this;s.isPinching=!1;const{_selectedShapeIdsAtPointerDown:l}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown,{squashing:!0}),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,this.once("tick",()=>{this._didPinch||this.setSelectedShapes(l,{squashing:!0})}));return}}}case"wheel":{if(!this.getInstanceState().canMoveCamera)return;if(this._updateInputsFromEvent(e),!this.getIsMenuOpen()){if(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),s.ctrlKey){const{x:p,y:f}=this.inputs.currentScreenPoint,{x:y,y:g,z:x}=this.getCamera(),w=Math.min(Yt,Math.max(pn,x+(e.delta.z??0)*x));this._setCamera({x:y+(p/w-p)-(p/x-p),y:g+(f/w-f)-(f/x-f),z:w},!0);return}const{x:l,y:d,z:h}=this.getCamera();this._setCamera({x:l+e.delta.x/h,y:d+e.delta.y/h,z:h},!0),!s.isDragging&&s.isPointing&&m.Dist2(i,a)>(this.getInstanceState().isCoarsePointer?or:ar)/this.getZoomLevel()&&(clearTimeout(this._longPressTimeout),s.isDragging=!0)}break}case"pointer":{if(s.isPinching)return;this._updateInputsFromEvent(e);const{isPen:l}=e;switch(e.name){case"pointer_down":{if(this.clearOpenMenus(),this._longPressTimeout=setTimeout(()=>{this.dispatch({...e,name:"long_press"})},yd),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===0&&(this.capturedPointerId=e.pointerId),s.buttons.add(e.button),s.isPointing=!0,s.isDragging=!1,this.getInstanceState().isPenMode){if(!l)return}else l&&this.updateInstanceState({isPenMode:!0});if(e.button===5?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===1&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;o.setTo(c),i.setTo(a);break}case"pointer_move":{if(!l&&this.getInstanceState().isPenMode)return;if(this.inputs.isPanning&&this.inputs.isPointing){clearTimeout(this._longPressTimeout);const{currentScreenPoint:d,previousScreenPoint:h}=this.inputs;this.pan(m.Sub(d,h));return}!s.isDragging&&s.isPointing&&m.Dist2(i,a)>(this.getInstanceState().isCoarsePointer?or:ar)/this.getZoomLevel()&&(clearTimeout(this._longPressTimeout),s.isDragging=!0);break}case"pointer_up":{if(s.buttons.delete(e.button),s.isPointing=!1,s.isDragging=!1,this.getIsMenuOpen()||!l&&this.getInstanceState().isPenMode)return;this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),s.isPanning?e.button===1?this.inputs.keys.has(" ")?(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:Ns}),this.setCursor({type:"grab",rotation:0})):(s.isPanning=!1,this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:Ns}),this.setCursor({type:this._prevCursor,rotation:0})):e.button===0&&(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:Ns}),this.setCursor({type:"grab",rotation:0})):e.button===5&&(this.complete(),this.setCurrentTool(this._restoreToolId));break}}break}case"keyboard":{switch(e.key==="ShiftRight"&&(e.key="ShiftLeft"),e.key==="AltRight"&&(e.key="AltLeft"),e.code==="ControlRight"&&(e.code="ControlLeft"),e.name){case"key_down":{s.keys.add(e.code),!e.ctrlKey&&e.code==="Space"&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0}));break}case"key_up":{s.keys.delete(e.code),e.code==="Space"&&!this.inputs.buttons.has(1)&&(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}));break}}break}}if(e.type==="pointer"&&(e.button===1?e.name="middle_click":e.button===2&&(e.name="right_click"),e.isPen===this.getInstanceState().isPenMode))switch(e.name){case"pointer_down":{const l=this._clickManager.transformPointerDownEvent(e);if(e.name!==l.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(l),this.emit("event",l);return}break}case"pointer_up":{clearTimeout(this._longPressTimeout);const l=this._clickManager.transformPointerUpEvent(e);if(e.name!==l.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(l),this.emit("event",l);return}break}case"pointer_move":{this._clickManager.handleMove();break}}return this.root.handleEvent(e),this.emit("event",e),this});this.store=e,this.snaps=new Cs(this),this.user=new Ze(s??Go(),c??!1),this.getContainer=o??(()=>document.body),this.textMeasure=new Nu(this),this._tickManager=new Uu(this);class l extends Gn{}u(l,"initial",a??""),this.root=new l(this),this.root.children={};const d=Zo(r),h={},p={},f=new Map;for(const b of d){const P=new b(this);h[b.type]=P;const v=yo(b.props??{});p[b.type]=v;for(const C of v.keys())if(!f.has(C.id))f.set(C.id,C);else if(f.get(C.id)!==C)throw Error(`Multiple style props with id "${C.id}" in use. Style prop IDs must be unique.`)}this.shapeUtils=h,this.styleProps=p;for(const b of[...i]){if(Je(this.root.children,b.id))throw Error(`Can't override tool with id "${b.id}"`);this.root.children[b.id]=new b(this,this.root)}this.environment=new bu(this),this.scribbles=new Cu(this);const y=new Set,g=b=>{var rt;const P=this.getShape(b);if(!P)return;const{start:v,end:C}=P.props,E=v.type==="binding"?this.getShape(v.boundShapeId):void 0,A=C.type==="binding"?this.getShape(C.boundShapeId):void 0,_=this.getAncestorPageId(P);if(!_)return;let k;if(E&&A)k=this.findCommonAncestor([E,A])??_;else if(E||A){const xe=(rt=E||A)==null?void 0:rt.parentId;xe&&xe===P.parentId?k=P.parentId:k=_}else return;k&&k!==P.parentId&&this.reparentShapes([b],k);const R=this.getShape(b);if(!R)throw Error("no reparented arrow");const X=this.getShapeNearestSibling(R,E),j=this.getShapeNearestSibling(R,A);let U;if(X&&j)U=X.index>j.index?X:j;else if(X&&!j)U=X;else if(j&&!X)U=j;else return;let ie;const le=this.getSortedChildIdsForParent(U.parentId).map(xe=>this.getShape(xe)).filter(xe=>xe.index>U.index);if(le.length){const xe=le.find(it=>it.type!=="arrow");if(R.index>U.index&&(!xe||R.index<xe.index))return;ie=Ds(U.index,le[0].index)}else ie=zt(U.index);ie!==R.index&&this.updateShapes([{id:b,type:"arrow",index:ie}])},x=(b,P)=>{const{x:v,y:C}=kt(this,b)[P];this.store.put([{...b,props:{...b.props,[P]:{type:"point",x:v,y:C}}}])},w=b=>{for(const P of["start","end"]){const v=b.props[P];if(v.type!=="binding")continue;const C=this.getShape(v.boundShapeId),E=this.getAncestorPageId(b)===this.getAncestorPageId(C);(!C||!E)&&x(b,P)}g(b.id)},I=(b,P)=>{let v=null;const C=b.selectedShapeIds.filter(_=>!P.has(_));C.length!==b.selectedShapeIds.length&&(v||(v={...b}),v.selectedShapeIds=C);const E=b.erasingShapeIds.filter(_=>!P.has(_));E.length!==b.erasingShapeIds.length&&(v||(v={...b}),v.erasingShapeIds=E),b.hoveredShapeId&&P.has(b.hoveredShapeId)&&(v||(v={...b}),v.hoveredShapeId=null),b.editingShapeId&&P.has(b.editingShapeId)&&(v||(v={...b}),v.editingShapeId=null);const A=b.hintingShapeIds.filter(_=>!P.has(_));return A.length!==b.hintingShapeIds.length&&(v||(v={...b}),v.hintingShapeIds=A),b.focusedGroupId&&P.has(b.focusedGroupId)&&(v||(v={...b}),v.focusedGroupId=null),v};if(this.sideEffects=new _u(this),this.sideEffects.registerBatchCompleteHandler(()=>{var b;for(const P of y){y.delete(P);const v=this.getShape(P);if(!v)continue;const C=this.getShapeUtil(v),E=(b=C.onChildrenChange)==null?void 0:b.call(C,v);E!=null&&E.length&&this.updateShapes(E,{squashing:!0})}this.emit("update")}),this.sideEffects.registerBeforeDeleteHandler("shape",b=>{b.parentId&&He(b.parentId)&&y.add(b.parentId);const P=this._getArrowBindingsIndex().get()[b.id];if(P!=null&&P.length)for(const{arrowId:E,handleId:A}of P){const _=this.getShape(E);_&&x(_,A)}const v=new Set([b.id]),C=G(this.getPageStates().map(E=>I(E,v)));C.length&&this.store.put(C)}),this.sideEffects.registerBeforeDeleteHandler("page",b=>{var E;if(this.getInstanceState().currentPageId!==b.id)return;const P=(E=this.getPages().find(A=>A.id!==b.id))==null?void 0:E.id;if(!P)return;this.store.put([{...this.getInstanceState(),currentPageId:P}]);const v=Ie.createId(b.id),C=ge.createId(b.id);this.store.remove([v,C])}),this.sideEffects.registerAfterChangeHandler("shape",(b,P)=>{if(this.isShapeOfType(P,"arrow")&&w(P),b.parentId!==P.parentId){const v=C=>{const E=this._getArrowBindingsIndex().get()[C];if(E!=null&&E.length)for(const A of E)g(A.arrowId)};v(P.id),this.visitDescendants(P.id,v)}if(b.parentId!==P.parentId&&De(P.parentId)){const v=new Set([b.id]);this.visitDescendants(b.id,C=>{v.add(C)});for(const C of this.getPageStates()){if(C.pageId===P.parentId)continue;const E=I(C,v);E&&this.store.put([E])}}b.parentId&&He(b.parentId)&&y.add(b.parentId),P.parentId!==b.parentId&&He(P.parentId)&&y.add(P.parentId)}),this.sideEffects.registerAfterChangeHandler("instance_page_state",(b,P)=>{if((b==null?void 0:b.selectedShapeIds)!==(P==null?void 0:P.selectedShapeIds)){const v=P.selectedShapeIds.filter(E=>{var _,k;let A=(_=this.getShape(E))==null?void 0:_.parentId;for(;He(A);){if(P.selectedShapeIds.includes(A))return!1;A=(k=this.getShape(A))==null?void 0:k.parentId}return!0});let C=null;if(v.length>0){const E=this.findCommonAncestor(G(v.map(A=>this.getShape(A))),A=>this.isShapeOfType(A,"group"));E&&(C=E)}else P!=null&&P.focusedGroupId&&(C=P.focusedGroupId);(v.length!==P.selectedShapeIds.length||C!==P.focusedGroupId)&&this.store.put([{...P,selectedShapeIds:v,focusedGroupId:C??null}])}}),this.sideEffects.registerAfterCreateHandler("shape",b=>{this.isShapeOfType(b,"arrow")&&w(b)}),this.sideEffects.registerAfterCreateHandler("page",b=>{const P=Ie.createId(b.id),v=ge.createId(b.id);this.store.has(P)||this.store.put([Ie.create({id:P})]),this.store.has(v)||this.store.put([ge.create({id:v,pageId:b.id})])}),this._currentPageShapeIds=gu(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=fu(this.store),this.disposables.add(this.store.listen(b=>{this.emit("change",b)})),this.store.ensureStoreIsUsable(),this._setInstancePageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]},{ephemeral:!0}),a&&this.root.children[a]===void 0)throw Error(`No state found for initialState "${a}".`);this.root.enter(void 0,"initial"),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.updateRenderingBounds(),this.on("tick",this._flushEventsForTick),requestAnimationFrame(()=>{this._tickManager.start()})}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear()}getShapeUtil(e){const s=typeof e=="string"?e:e.type,r=We(this.shapeUtils,s);return ke(r,`No shape util found for type "${s}"`),r}undo(){return this._flushEventsForTick(0),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.history.redo(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e,s,r){return this.history.mark(e,s,r),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}batch(e){return this.history.batch(e),this}_getArrowBindingsIndex(){return hu(this)}getArrowsBoundTo(e){return this._getArrowBindingsIndex().get()[e]||ut}getArrowInfoCache(){return this.store.createComputedCache("arrow infoCache",e=>fn(e)?vn(this,e):qs(this,e))}getArrowInfo(e){const s=typeof e=="string"?e:e.id;return this.getArrowInfoCache().get(s)}annotateError(e,{origin:s,willCrashApp:r,tags:i,extras:o}){const a=this.createErrorAnnotations(s,r);return hr(e,{tags:{...a.tags,...i},extras:{...a.extras,...o}}),r&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,s){try{const r=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:s},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes(),editingShape:r?this.getShape(r):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:s},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){const s=e.split(".").reverse();let r=this.root;for(;s.length>0;){const i=s.pop();if(!i)return!0;const o=r.getCurrent();if((o==null?void 0:o.id)===i){if(s.length===0)return!0;r=o;continue}else return!1}return!1}isInAny(...e){return e.some(s=>this.isIn(s))}setCurrentTool(e,s={}){return this.root.transition(e,s),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){const e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){var i;const s=e.split(".").reverse();let r=this.root;for(;s.length>0;){const o=s.pop();if(!o)return r;const a=(i=r.children)==null?void 0:i[o];if(!a)return;r=a}return r}getDocumentSettings(){return this.store.get(sr)}updateDocumentSettings(e){return this.store.put([{...this.getDocumentSettings(),...e}]),this}getInstanceState(){return this.store.get(_e)}updateInstanceState(e,s){return this._updateInstanceState(e,{ephemeral:!0,squashing:!0,...s}),e.isChangingStyle!==void 0&&(clearTimeout(this._isChangingStyleTimeout),e.isChangingStyle===!0&&(this._isChangingStyleTimeout=setTimeout(()=>{this.updateInstanceState({isChangingStyle:!1},{ephemeral:!0})},2e3))),this}getOpenMenus(){return this.getInstanceState().openMenus}addOpenMenu(e){const s=new Set(this.getOpenMenus());return s.has(e)||(s.add(e),this.updateInstanceState({openMenus:[...s]})),this}deleteOpenMenu(e){const s=new Set(this.getOpenMenus());return s.has(e)&&(s.delete(e),this.updateInstanceState({openMenus:[...s]})),this}clearOpenMenus(){return this.getOpenMenus().length&&this.updateInstanceState({openMenus:[]}),this}getIsMenuOpen(){return this.getOpenMenus().length>0}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return ge.createId(this.getCurrentPageId())}updateCurrentPageState(e,s){return this._setInstancePageState(e,s),this}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){const{selectedShapeIds:e}=this.getCurrentPageState();return G(e.map(s=>this.store.get(s)))}setSelectedShapes(e,s){const r=e.map(i=>typeof i=="string"?i:i.id);return this._setSelectedShapes(r,s),this}select(...e){const s=typeof e[0]=="string"?e:e.map(r=>r.id);return this.setSelectedShapes(s),this}deselect(...e){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=this.getSelectedShapeIds();return r.length>0&&s.length>0&&this.setSelectedShapes(r.filter(i=>!s.includes(i))),this}selectAll(){const e=this.getSortedChildIdsForParent(this.getCurrentPageId());return e.length<=0?this:(this.setSelectedShapes(this._getUnlockedShapeIds(e)),this)}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){var e;return((e=this.getOnlySelectedShape())==null?void 0:e.id)??null}getOnlySelectedShape(){const e=this.getSelectedShapes();return e.length===1?e[0]:null}getSelectionPageBounds(){const e=this.getCurrentPageState().selectedShapeIds;return e.length===0?null:$.Common(G(e.map(s=>this.getShapePageBounds(s))))}getSelectionRotation(){const e=this.getSelectedShapeIds();let s=!1,r=0;for(let i=0,o=e.length;i<o;i++){const a=this.getShapePageTransform(e[i]);if(a)if(s){if(a.rotation()!==r)return 0}else s=!0,r=a.rotation()}return r}getSelectionRotatedPageBounds(){const e=this.getSelectedShapeIds();if(e.length===0)return;const s=this.getSelectionRotation();if(s===0)return this.getSelectionPageBounds();if(e.length===1){const i=this.getShapeGeometry(e[0]).bounds.clone(),o=this.getShapePageTransform(e[0]);return i.point=o.applyToPoint(i.point),i}const r=$.FromPoints(this.getSelectedShapeIds().flatMap(i=>{const o=this.getShapePageTransform(i);return o?o.applyToPoints(this.getShapeGeometry(i).bounds.corners):[]}).map(i=>i.rot(-s)));return r.point=r.point.rot(s),r}getSelectionRotatedScreenBounds(){const e=this.getSelectionRotatedPageBounds();if(!e)return;const{x:s,y:r}=this.pageToScreen(e.point),i=this.getZoomLevel();return new $(s,r,e.width*i,e.height*i)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){const e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;if(s!==null){const r=this.getShape(s);if(!r)throw Error(`Editor.setFocusedGroup: Shape with id ${s} does not exist`);if(!this.isShapeOfType(r,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${r.type}`)}return s===this.getFocusedGroupId()?this:(this._setFocusedGroupId(s),this)}popFocusedGroupId(){const e=this.getFocusedGroup();if(e){const s=this.findShapeAncestor(e,r=>this.isShapeOfType(r,"group"));this.setFocusedGroup((s==null?void 0:s.id)??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){const e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;if(s!==this.getEditingShapeId()){if(s){const r=this.getShape(s);if(r&&this.getShapeUtil(r).canEdit(r))return this._setInstancePageState({editingShapeId:s}),this}this._setInstancePageState({editingShapeId:null})}return this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){const e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;return s===this.getHoveredShapeId()?this:(this.updateCurrentPageState({hoveredShapeId:s},{ephemeral:!0}),this)}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){const e=this.getHintingShapeIds();return G(e.map(s=>this.getShape(s)))}setHintingShapes(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id);return this.updateCurrentPageState({hintingShapeIds:Zn(s)},{ephemeral:!0}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){const e=this.getErasingShapeIds();return G(e.map(s=>this.getShape(s)))}setErasingShapes(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id);s.sort();const r=this.getErasingShapeIds();if(s.length===r.length){for(let i=0;i<s.length;i++)if(s[i]!==r[i]){this._setInstancePageState({erasingShapeIds:s},{ephemeral:!0});break}}else this._setInstancePageState({erasingShapeIds:s},{ephemeral:!0});return this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;if(s!==this.getCroppingShapeId())if(!s)this.updateCurrentPageState({croppingShapeId:null});else{const r=this.getShape(s),i=this.getShapeUtil(r);r&&i.canCrop(r)&&this.updateCurrentPageState({croppingShapeId:s})}return this}getCameraId(){return Ie.createId(this.getCurrentPageId())}getCamera(){return this.store.get(this.getCameraId())}getZoomLevel(){return this.getCamera().z}_setCamera(e,s=!1){const r=this.getCamera();return r.x===e.x&&r.y===e.y&&r.z===e.z?this:(this.batch(()=>{const i={...r,...e};this.store.put([i]);const{currentScreenPoint:o,currentPagePoint:a}=this.inputs,{screenBounds:c}=this.store.unsafeGetWithoutCapture(_e);if(o.x/i.z-i.x!==a.x||o.y/i.z-i.y!==a.y){const l={type:"pointer",target:"canvas",name:"pointer_move",point:m.AddXY(o,c.x,c.y),pointerId:pi.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,button:0,isPen:this.getInstanceState().isPenMode??!1};s?this._flushEventForTick(l):this.dispatch(l)}this._tickCameraState()}),this)}setCamera(e,s){const r=Number.isFinite(e.x)?e.x:0,i=Number.isFinite(e.y)?e.y:0,o=Number.isFinite(e.z)?e.z:this.getZoomLevel();if(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),s){const{width:a,height:c}=this.getViewportScreenBounds();return this._animateToViewport(new $(-r,-i,a/o,c/o),s)}else this._setCamera({x:r,y:i,z:o});return this}centerOnPoint(e,s){if(!this.getInstanceState().canMoveCamera)return this;const{width:r,height:i}=this.getViewportPageBounds();return this.setCamera({x:-(e.x-r/2),y:-(e.y-i/2),z:this.getCamera().z},s),this}zoomToContent(e={duration:220}){const s=this.getSelectionPageBounds()??this.getCurrentPageBounds();return s&&this.zoomToBounds(s,{targetZoom:Math.min(1,this.getZoomLevel()),...e}),this}zoomToFit(e){if(!this.getInstanceState().canMoveCamera)return this;const s=[...this.getCurrentPageShapeIds()];if(s.length<=0)return this;const r=$.Common(G(s.map(i=>this.getShapePageBounds(i))));return this.zoomToBounds(r,e),this}resetZoom(e=this.getViewportScreenCenter(),s){if(!this.getInstanceState().canMoveCamera)return this;const{x:r,y:i,z:o}=this.getCamera(),{x:a,y:c}=e;return this.setCamera({x:r+(a/1-a)-(a/o-a),y:i+(c/1-c)-(c/o-c),z:1},s),this}zoomIn(e=this.getViewportScreenCenter(),s){if(!this.getInstanceState().canMoveCamera)return this;const{x:r,y:i,z:o}=this.getCamera();let a=Yt;for(let d=1;d<Ht.length;d++){const h=Ht[d-1],p=Ht[d];if(!(p-o<=(p-h)/2)){a=p;break}}const{x:c,y:l}=e;return this.setCamera({x:r+(c/a-c)-(c/o-c),y:i+(l/a-l)-(l/o-l),z:a},s),this}zoomOut(e=this.getViewportScreenCenter(),s){if(!this.getInstanceState().canMoveCamera)return this;const{x:r,y:i,z:o}=this.getCamera();let a=pn;for(let d=Ht.length-1;d>0;d--){const h=Ht[d-1],p=Ht[d];if(!(p-o>=(p-h)/2)){a=h;break}}const{x:c,y:l}=e;return this.setCamera({x:r+(c/a-c)-(c/o-c),y:i+(l/a-l)-(l/o-l),z:a},s),this}zoomToSelection(e){if(!this.getInstanceState().canMoveCamera)return this;const s=this.getSelectionPageBounds();return s?(this.zoomToBounds(s,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this):this}panZoomIntoView(e,s){if(!this.getInstanceState().canMoveCamera)return this;if(e.length<=0)return this;const r=$.Common(G(e.map(o=>this.getShapePageBounds(o)))),i=this.getViewportPageBounds();if(i.h<r.h||i.w<r.w)return this.zoomToBounds(r,{targetZoom:this.getCamera().z,...s}),this;{const o=this.getViewportPageBounds().clone().expandBy(-32/this.getZoomLevel());let a=0,c=0;o.maxY<r.maxY?c=o.maxY-r.maxY:o.minY>r.minY&&(c=o.minY-r.minY),o.maxX<r.maxX?a=o.maxX-r.maxX:o.minX>r.minX&&(a=o.minX-r.minX);const l=this.getCamera();this.setCamera({x:l.x+a,y:l.y+c,z:l.z},s)}return this}zoomToBounds(e,s){if(!this.getInstanceState().canMoveCamera)return this;const r=this.getViewportScreenBounds(),i=(s==null?void 0:s.inset)??Math.min(256,r.width*.28);let o=rs(Math.min((r.width-i)/e.width,(r.height-i)/e.height),pn,Yt);return(s==null?void 0:s.targetZoom)!==void 0&&(o=Math.min(s.targetZoom,o)),this.setCamera({x:-e.minX+(r.width-e.width*o)/2/o,y:-e.minY+(r.height-e.height*o)/2/o,z:o},s),this}pan(e,s){if(!this.getInstanceState().canMoveCamera)return this;const{x:r,y:i,z:o}=this.getCamera();return this.setCamera({x:r+e.x/o,y:i+e.y/o,z:o},s),this._flushEventsForTick(0),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;const s=()=>{this.removeListener("tick",this._animateViewport),this.removeListener("stop-camera-animation",s),this._viewportAnimation=null};this.once("stop-camera-animation",s),this._viewportAnimation.elapsed+=e;const{elapsed:r,easing:i,duration:o,start:a,end:c}=this._viewportAnimation;if(r>o){this._setCamera({x:-c.x,y:-c.y,z:this.getViewportScreenBounds().width/c.width}),s();return}const l=o-r,d=i(1-l/o),h=a.minX+(c.minX-a.minX)*d,p=a.minY+(c.minY-a.minY)*d,f=a.maxX+(c.maxX-a.maxX)*d;this._setCamera({x:-h,y:-p,z:this.getViewportScreenBounds().width/(f-h)})}_animateToViewport(e,s={}){const{duration:r=0,easing:i=ss.easeInOutCubic}=s,o=this.user.getAnimationSpeed(),a=this.getViewportPageBounds();return this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),r===0||o===0?this._setCamera({x:-e.x,y:-e.y,z:this.getViewportScreenBounds().width/e.width}):(this._viewportAnimation={elapsed:0,duration:r/o,easing:i,start:a.clone(),end:e.clone()},this.addListener("tick",this._animateViewport),this)}slideCamera(e={}){if(!this.getInstanceState().canMoveCamera)return this;if(this.stopCameraAnimation(),this.user.getAnimationSpeed()===0)return this;const{speed:r,friction:i,direction:o,speedThreshold:a=.01}=e;let c=Math.min(r,1);const l=()=>{this.removeListener("tick",d),this.removeListener("stop-camera-animation",l)};this.once("stop-camera-animation",l);const d=h=>{const{x:p,y:f,z:y}=this.getCamera(),g=m.Mul(o,c*h/y);c*=1-i,c<a?l():this._setCamera({x:p+g.x,y:f+g.y,z:y})};return this.addListener("tick",d),this}animateToUser(e){const s=this.getCollaborators().find(r=>r.userId===e);return s?(this.batch(()=>{this.getInstanceState().followingUserId!==null&&this.stopFollowingUser();const r=s.currentPageId===this.getCurrentPageId();r||this.setCurrentPage(s.currentPageId);const i=r?{duration:500}:void 0;this.centerOnPoint(s.cursor,i);const{highlightedUserIds:o}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...o,e]}),setTimeout(()=>{const a=[...this.getInstanceState().highlightedUserIds],c=a.indexOf(e);c<0||(a.splice(c,1),this.updateInstanceState({highlightedUserIds:a}))},ko)}),this):this}animateToShape(e,s=cd){if(!this.getInstanceState().canMoveCamera)return this;const r=this.getViewportScreenBounds().clone().expandBy(-32),i=r.width/r.height,o=this.getShapePageBounds(e);if(!o)return this;const a=o.width/o.height,c=o.clone(),l=o.width/r.width;return c.width+=(r.minX+r.maxX)*l,c.height+=(r.minY+r.maxY)*l,c.x-=r.minX*l,c.y-=r.minY*l,a>i?(c.height=o.width/i,c.y-=(c.height-o.height)/2):(c.width=o.height*i,c.x-=(c.width-o.width)/2),this._animateToViewport(c,s)}updateViewportScreenBounds(e,s=!1){e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);const r=[e.minY!==0,document.body.scrollWidth!==e.maxX,document.body.scrollHeight!==e.maxY,e.minX!==0],i=e.equals(this.getViewportScreenBounds()),{_willSetInitialBounds:o}=this;if(i)this._willSetInitialBounds=!1;else if(o)this._willSetInitialBounds=!1,this.updateInstanceState({screenBounds:e.toJson(),insets:r},{squashing:!0,ephemeral:!0});else if(s&&!this.getInstanceState().followingUserId){const a=this.getViewportPageCenter();this.updateInstanceState({screenBounds:e.toJson(),insets:r},{squashing:!0,ephemeral:!0}),this.centerOnPoint(a)}else this.updateInstanceState({screenBounds:e.toJson(),insets:r},{squashing:!0,ephemeral:!0});return this._tickCameraState(),this.updateRenderingBounds(),this}getViewportScreenBounds(){const{x:e,y:s,w:r,h:i}=this.getInstanceState().screenBounds;return new $(e,s,r,i)}getViewportScreenCenter(){const e=this.getViewportScreenBounds();return new m(e.midX-e.minX,e.midY-e.minY)}getViewportPageBounds(){const{w:e,h:s}=this.getViewportScreenBounds(),{x:r,y:i,z:o}=this.getCamera();return new $(-r,-i,e/o,s/o)}getViewportPageCenter(){return this.getViewportPageBounds().center}screenToPage(e){const{screenBounds:s}=this.store.unsafeGetWithoutCapture(_e),{x:r,y:i,z:o=1}=this.getCamera();return{x:(e.x-s.x)/o-r,y:(e.y-s.y)/o-i,z:e.z??.5}}pageToScreen(e){const s=this.getViewportScreenBounds(),{x:r,y:i,z:o=1}=this.getCamera();return{x:(e.x+r)*o+s.x,y:(e.y+i)*o+s.y,z:e.z??.5}}pageToViewport(e){const{x:s,y:r,z:i=1}=this.getCamera();return{x:(e.x+s)*i,y:(e.y+r)*i,z:e.z??.5}}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){const e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(r=>r.userId))].sort().map(r=>e.filter(o=>o.userId===r).sort((o,a)=>a.lastActivityTimestamp-o.lastActivityTimestamp)[0]):ut}getCollaboratorsOnCurrentPage(){const e=this.getCurrentPageId();return this.getCollaborators().filter(s=>s.currentPageId===e)}startFollowingUser(e){const s=this._getCollaboratorsQuery().get().filter(c=>c.userId===e),r=this.user.getId();if(r||console.warn("You should set the userId for the current instance before following a user"),s.some(c=>c.followingUserId===r))return this;Xe(()=>{this.stopFollowingUser(),this.updateInstanceState({followingUserId:e},{ephemeral:!0})});const i=()=>{this.removeListener("frame",a),this.removeListener("stop-following",i)};let o=!1;const a=()=>{const c=[...s].sort((j,U)=>j.lastActivityTimestamp-U.lastActivityTimestamp).pop();if(!c){this.stopFollowingUser();return}const l=c.currentPageId===this.getCurrentPageId(),d=l?ed:1;if(!l){this.stopFollowingUser(),this.setCurrentPage(c.currentPageId),this.startFollowingUser(e);return}const{center:h,width:p,height:f}=this.getViewportPageBounds(),y=$.From(c.screenBounds),g=y.width/c.camera.z,x=y.height/c.camera.z,w=new m(g/2-c.camera.x,x/2-c.camera.y),I=c.followingUserId===r,b=p+(g-p)*d,P=f+(x-f)*d,v=I?f/P:Math.min(p/b,f/P),C=rs(this.getCamera().z*v,pn,Yt),E=this.getViewportScreenBounds().w/C,A=this.getViewportScreenBounds().h/C,_=w.sub(h),k=m.Add(h,m.Mul(_,d)),R=m.Sub(k,h).len(),X=Math.abs(C-this.getCamera().z);if(R<td&&X<sd){o=!0;return}o&&R<nd&&X<rd||(o=!1,this.stopCameraAnimation(),this._setCamera({x:-(k.x-E/2),y:-(k.y-A/2),z:C}))};return this.once("stop-following",i),this.addListener("frame",a),this}stopFollowingUser(){return this.updateInstanceState({followingUserId:null},{ephemeral:!0}),this.emit("stop-following"),this}getCameraState(){return this._cameraState.get()}getUnorderedRenderingShapes(e){const s=[];let r=ct*2,i=ct;const o=this.getErasingShapeIds(),a=(l,d,h)=>{const p=this.getShape(l);if(!p)return;d*=p.opacity;let f=!1;const y=this.getShapeUtil(p);e&&(f=!h&&o.includes(l),f&&(d*=.32)),s.push({id:l,shape:p,util:y,index:r,backgroundIndex:i,opacity:d}),r+=1,i+=1;const g=this.getSortedChildIdsForParent(l);if(!g.length)return;let x=null;y.providesBackgroundForChildren(p)&&(x=i,i=r,r+=ct);for(const w of g)a(w,d,h||f);x!==null&&(i=x)},c=e?[this.getCurrentPage()]:this.getPages();for(const l of c)for(const d of this.getSortedChildIdsForParent(l.id))a(d,1,!1);return s}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(Xa)}getRenderingBounds(){return this._renderingBounds.get()}updateRenderingBounds(){const e=this.getViewportPageBounds();return e.equals(this._renderingBounds.__unsafe__getWithoutCapture())?this:(this._renderingBounds.set(e.clone()),this)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return this._getAllPagesQuery().get().sort(ze)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get(typeof e=="string"?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){const s=typeof e=="string"?e:e.id,r=this.store.query.exec("shape",{parentId:{eq:s}});return this.getShapeAndDescendantIds(r.map(i=>i.id))}setCurrentPage(e,s){const r=typeof e=="string"?e:e.id;return this._setCurrentPageId(r,s),this}updatePage(e,s){return this._updatePage(e,s),this}createPage(e){return this._createPage(e),this}deletePage(e){const s=typeof e=="string"?e:e.id;return this._deletePage(s),this}duplicatePage(e,s=En.createId()){if(this.getPages().length>=di)return this;const r=typeof e=="string"?e:e.id,i=this.getPage(r);if(!i)return this;const o={...this.getCamera()},a=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(i.id));return this.batch(()=>{var d;const c=this.getPages(),l=Ds(i.index,(d=c[c.indexOf(i)+1])==null?void 0:d.index);if(this.createPage({name:i.name+" Copy",id:s,index:l}),this.setCurrentPage(s),this.setCamera(o),a)return this.putContentOntoCurrentPage(a)}),this}renamePage(e,s,r){const i=typeof e=="string"?e:e.id;return this.getInstanceState().isReadonly?this:(this.updatePage({id:i,name:s},r),this)}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this._createAssets(e),this}updateAssets(e){return this._updateAssets(e),this}deleteAssets(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id);return this._deleteAssets(s),this}getAsset(e){return this.store.get(typeof e=="string"?e:e.id)}_getShapeGeometryCache(){return this.store.createComputedCache("bounds",e=>this.getShapeUtil(e).getGeometry(e),(e,s)=>e.props===s.props)}getShapeGeometry(e){return this._getShapeGeometryCache().get(typeof e=="string"?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>{var s,r;return(r=(s=this.getShapeUtil(e)).getHandles)==null?void 0:r.call(s,e)})}getShapeHandles(e){return this._getShapeHandlesCache().get(typeof e=="string"?e:e.id)}getShapeLocalTransform(e){const s=typeof e=="string"?e:e.id,r=this.getShape(s);if(!r)throw Error("Editor.getTransform: shape not found");return F.Identity().translate(r.x,r.y).rotate(r.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if(De(e.parentId))return this.getShapeLocalTransform(e);const s=this._getShapePageTransformCache().get(e.parentId)??F.Identity();return F.Compose(s,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){const s=typeof e=="string"?e:e.id,r=this.getShape(s);return!r||De(r.parentId)?F.Identity():this._getShapePageTransformCache().get(r.parentId)??F.Identity()}getShapePageTransform(e){const s=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(s)??F.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{const s=this._getShapePageTransformCache().get(e.id);return s?$.FromPoints(F.applyToPoints(s,this.getShapeGeometry(e).vertices)):new $})}getShapePageBounds(e){return this._getShapePageBoundsCache().get(typeof e=="string"?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{const s=this._getShapeMaskCache().get(e.id);if(!s)return;if(s.length===0)return"polygon(0px 0px, 0px 0px, 0px 0px)";const r=this._getShapePageTransformCache().get(e.id);return r?`polygon(${F.applyToPoints(F.Inverse(r),s).map(o=>`${o.x}px ${o.y}px`).join(",")})`:void 0})}getShapeClipPath(e){return this._getShapeClipPathCache().get(typeof e=="string"?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if(De(e.parentId))return;const s=this.getShapeAncestors(e.id).filter(i=>this.isShapeOfType(i,"frame"));return s.length===0?void 0:s.map(i=>this._getShapePageTransformCache().get(i.id).applyToPoints(this.getShapeGeometry(i).vertices)).reduce((i,o)=>{if(!(o&&i))return;const a=Pi(i,o);return a?a.map(m.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get(typeof e=="string"?e:e.id)}getShapeMaskedPageBounds(e){return typeof e!="string"&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{const s=this._getShapePageBoundsCache().get(e.id);if(!s)return;const r=this._getShapeMaskCache().get(e.id);if(r){if(r.length===0)return;const{corners:i}=s;if(i.every((a,c)=>a&&m.Equals(a,r[c])))return s.clone();const o=Pi(r,i);return o?$.FromPoints(o):void 0}return s})}getShapeAncestors(e,s=[]){const r=typeof e=="string"?e:e.id,i=this.getShape(r);if(!i)return s;const o=i.parentId;if(De(o))return s.reverse(),s;const a=this.store.get(o);return a?(s.push(a),this.getShapeAncestors(a,s)):s}findShapeAncestor(e,s){const r=typeof e=="string"?e:e.id,i=this.getShape(r);if(!i)return;const o=i.parentId;if(De(o))return;const a=this.getShape(o);if(a)return s(a)?a:this.findShapeAncestor(a,s)}hasAncestor(e,s){const r=typeof e=="string"?e:e==null?void 0:e.id,i=r&&this.getShape(r);return i?i.parentId===s?!0:this.hasAncestor(this.getShapeParent(i),s):!1}findCommonAncestor(e,s){var l;if(e.length===0)return;const r=typeof e[0]=="string"?e:e.map(d=>d.id),i=G(r.map(d=>this.getShape(d)));if(i.length===1){const d=i[0].parentId;return De(d)?void 0:s?(l=this.findShapeAncestor(i[0],s))==null?void 0:l.id:d}const[o,...a]=i;let c=this.getShapeParent(o);for(;c;){if(s&&!s(c)){c=this.getShapeParent(c);continue}if(a.every(d=>this.hasAncestor(d,c.id)))return c.id;c=this.getShapeParent(c)}}isShapeOrAncestorLocked(e){const s=typeof e=="string"?this.getShape(e):e;return s===void 0?!1:s.isLocked?!0:this.isShapeOrAncestorLocked(this.getShapeParent(s))}_notVisibleShapes(){return pu(this)}getCulledShapes(){const e=this._notVisibleShapes().get(),s=this.getSelectedShapeIds(),r=this.getEditingShapeId(),i=new Set(e);return r&&i.delete(r),s.forEach(o=>{i.delete(o)}),i}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(s=>{const r=this.getShapeMaskedPageBounds(s);r&&(e?e=e.expand(r):e=r.clone())}),e}getSelectedShapeAtPoint(e){const s=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(r=>r.type!=="group"&&s.includes(r.id)).reverse().find(r=>this.isPointInShape(r,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,s={}){const r=this.getZoomLevel(),i=this.getViewportPageBounds(),{filter:o,margin:a=0,hitLabels:c=!1,hitInside:l=!1,hitFrameInside:d=!1}=s;let h=1/0,p=null,f=1/0,y=null;const g=(s.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(x=>{if(this.isShapeOfType(x,"group"))return!1;const w=this.getShapeMask(x);return w&&!Dt(e,w)?!1:o?o(x):!0});for(let x=g.length-1;x>=0;x--){const w=g[x],I=this.getShapeGeometry(w),b=I instanceof Is,P=this.getPointInShapeSpace(w,e);if((this.isShapeOfType(w,"arrow")||this.isShapeOfType(w,"geo")&&w.props.fill==="none")&&w.props.text.trim()){for(const C of I.children)if(C.isLabel&&C.isPointInBounds(P))return w}if(this.isShapeOfType(w,"frame")){const C=I.distanceToPoint(P,l);if(Math.abs(C)<=a)return y||w;if(I.hitTestPoint(P,0,!0))return y||p||(d?w:void 0);continue}let v;if(b){let C=1/0;for(const E of I.children){if(E.isLabel&&!c)continue;const A=E.distanceToPoint(P,l);A<C&&(C=A)}v=C}else a===0&&(I.bounds.w<1||I.bounds.h<1)||I.bounds.containsPoint(P,a)?v=I.distanceToPoint(P,l):v=1/0;if(I.isClosed){if(v<=a){if(I.isFilled||b&&I.children[0].isFilled)return y||w;if(this.getShapePageBounds(w).contains(i))continue;if(Math.abs(v)<a)Math.abs(v)<f&&(f=Math.abs(v),y=w);else if(!y){const{area:C}=I;C<h&&(h=C,p=w)}}}else if(v<ud/r)return w}return y||p||void 0}getShapesAtPoint(e,s={}){return this.getCurrentPageShapes().filter(r=>this.isPointInShape(r,e,s))}isPointInShape(e,s,r={}){const{hitInside:i=!1,margin:o=0}=r,a=typeof e=="string"?e:e.id,c=this.getShapeMask(a);return c&&!Dt(s,c)?!1:this.getShapeGeometry(a).hitTestPoint(this.getPointInShapeSpace(e,s),o,i)}getPointInShapeSpace(e,s){const r=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(r).clone().invert().applyToPoint(s)}getPointInParentSpace(e,s){const r=typeof e=="string"?e:e.id,i=this.getShape(r);if(!i)return new m(0,0);if(De(i.parentId))return m.From(s);const o=this.getShapePageTransform(i.parentId);return o?o.clone().invert().applyToPoint(s):m.From(s)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){const e=[],s=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let r=0,i=s.length;r<i;r++)ea(this,s[r],e);return e}getCurrentPageRenderingShapesSorted(){const e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:s})=>!e.has(s))}isShapeOfType(e,s){const r=typeof e=="string"?this.getShape(e):e;return r?r.type===s:!1}getShape(e){const s=typeof e=="string"?e:e.id;if(He(s))return this.store.get(s)}getShapeParent(e){const s=typeof e=="string"?e:e==null?void 0:e.id;if(!s)return;const r=this.getShape(s);if(!(r===void 0||!He(r.parentId)))return this.store.get(r.parentId)}getShapeNearestSibling(e,s){return s?s.parentId===e.parentId?s:this.findShapeAncestor(s,i=>i.parentId===e.parentId):void 0}isShapeInPage(e,s=this.getCurrentPageId()){const r=typeof e=="string"?e:e.id,i=this.getShape(r);if(!i)return!1;let o=!1;if(i.parentId===s)o=!0;else{let a=this.getShape(i.parentId);e:for(;a;){if(a.parentId===s){o=!0;break e}a=this.getShape(a.parentId)}}return o}getAncestorPageId(e){const s=typeof e=="string"?e:e==null?void 0:e.id,r=s&&this.getShape(s);if(r)return De(r.parentId)?r.parentId:this.getAncestorPageId(this.getShape(r.parentId))}reparentShapes(e,s,r){const i=typeof e[0]=="string"?e:e.map(y=>y.id);if(i.length===0)return this;const o=[],a=De(s)?F.Identity():this.getShapePageTransform(s),c=a.rotation();let l=[];const d=G(this.getSortedChildIdsForParent(s).map(y=>this.getShape(y)));if(r){const y=d.find(g=>g.index===r);if(y){const g=d[d.indexOf(y)+1];g?l=tn(r,g.index,i.length):l=Rs(r,i.length)}else{const g=d.sort(ze).find(x=>x.index>r);g?l=tn(r,g.index,i.length):l=Rs(r,i.length)}}else{const y=d.length&&d[d.length-1];l=y?Rs(y.index,i.length):Js(i.length)}const h=a.clone().invert(),p=G(i.map(y=>this.getShape(y))),f=p.filter(y=>y.isLocked);f.length&&this.updateShapes(f.map(({id:y,type:g})=>({id:y,type:g,isLocked:!1})));for(let y=0;y<p.length;y++){const g=p[y],x=this.getShapePageTransform(g);if(!x)continue;const w=x.point();if(!w)continue;const I=h.applyToPoint(w),b=x.rotation()-c;o.push({id:g.id,type:g.type,parentId:s,x:I.x,y:I.y,rotation:b,index:l[y],isLocked:g.isLocked})}return this.updateShapes(o),this}getHighestIndexForParent(e){const s=typeof e=="string"?e:e.id,r=this._parentIdsToChildIds.get()[s];if(!r||r.length===0)return"a1";const i=this.getShape(r[r.length-1]);return zt(i.index)}getSortedChildIdsForParent(e){const s=typeof e=="string"?e:e.id,r=this._parentIdsToChildIds.get()[s];return r?this._childIdsCache.get(r,()=>r):ut}visitDescendants(e,s){const r=typeof e=="string"?e:e.id,i=this.getSortedChildIdsForParent(r);for(const o of i)s(o)!==!1&&this.visitDescendants(o,s);return this}getShapeAndDescendantIds(e){const s=new Set,r=[...e];for(;r.length>0;){const i=r.pop();if(!i)break;if(!s.has(i)){s.add(i);for(const o of this.getSortedChildIdsForParent(i))r.push(o)}}return s}getDroppingOverShape(e,s=[]){const r=this.getCurrentPageShapesSorted();for(let i=r.length-1;i>=0;i--){const o=r[i];if(this.getSelectedShapeIds().includes(o.id)||!this.getShapeUtil(o).canDropShapes(o,s)||s.find(c=>c.id===o.id||this.hasAncestor(o,c.id)))continue;const a=this.getShapeMaskedPageBounds(o.id);if(a&&a.containsPoint(e)&&this.getShapeGeometry(o).hitTestPoint(this.getPointInShapeSpace(o,e),0,!0))return o}}getOutermostSelectableShape(e,s){const r=typeof e=="string"?e:e.id,i=this.getShape(r);let o=i,a=i;const c=this.getFocusedGroup();for(;a;){if(this.isShapeOfType(a,"group")&&(c==null?void 0:c.id)!==a.id&&!this.hasAncestor(c,a.id)&&((s==null?void 0:s(a))??!0))o=a;else if((c==null?void 0:c.id)===a.id)break;a=this.getShapeParent(a)}return o}rotateShapesBy(e,s){if((typeof e[0]=="string"?e:e.map(o=>o.id)).length<=0)return this;const i=lu({editor:this});return i?(du({delta:s,snapshot:i,editor:this,stage:"one-off"}),this):this}getChangesToTranslateShape(e,s){var o,a,c;let r=e;const i=this.getShapeUtil(e);return r=gn(r,((o=i.onTranslateStart)==null?void 0:o.call(i,r))??void 0),r=gn(r,{id:e.id,type:e.type,x:s.x,y:s.y}),r=gn(r,((a=i.onTranslate)==null?void 0:a.call(i,e,r))??void 0),r=gn(r,((c=i.onTranslateEnd)==null?void 0:c.call(i,e,r))??void 0),r}nudgeShapes(e,s,r){const i=typeof e[0]=="string"?e:e.map(a=>a.id);if(i.length<=0)return this;const o=[];for(const a of i){const c=this.getShape(a),l=m.From(s),d=this.getShapeParentTransform(c);d&&l.rot(-d.rotation()),o.push(this.getChangesToTranslateShape(c,l.add(c)))}return this.updateShapes(o,{squashing:!0,...r}),this}duplicateShapes(e,s){const r=typeof e[0]=="string"?e:e.map(d=>d.id);if(r.length<=0)return this;const i=new Set(r),o=[],a=[...r];for(;a.length>0;){const d=a.pop();if(!d)break;o.push(d),this.getSortedChildIdsForParent(d).forEach(h=>a.push(h))}o.reverse();const c=new Map(o.map(d=>[d,Zt()])),l=G(o.map(d=>{const h=this.getShape(d);if(!h)return null;const p=c.get(d);let f=0,y=0;if(s&&i.has(d)){const C=this.getShapeParentTransform(h),E=new m(s.x,s.y).rot(-C.rotation());f=E.x,y=E.y}const g=h.parentId??this.getCurrentPageId(),x=this.getSortedChildIdsForParent(g),w=x.indexOf(h.id),I=x[w+1],b=I?this.getShape(I):null,P=b?Ds(h.index,b.index):zt(h.index);let v=he(h);if(this.isShapeOfType(h,"arrow")&&this.isShapeOfType(v,"arrow")){const C=this.getArrowInfo(h);let E,A;if(h.props.start.type==="binding"&&(E=c.get(h.props.start.boundShapeId),!E))if(C!=null&&C.isValid){const{x:k,y:R}=C.start.point;v.props.start={type:"point",x:k,y:R}}else{const{start:k}=kt(this,h);v.props.start={type:"point",x:k.x,y:k.y}}if(h.props.end.type==="binding"&&(A=c.get(h.props.end.boundShapeId),!A))if(C!=null&&C.isValid){const{x:k,y:R}=C.end.point;v.props.end={type:"point",x:k,y:R}}else{const{end:k}=kt(this,h);v.props.start={type:"point",x:k.x,y:k.y}}const _=fn(v)?vn(this,v):qs(this,v);if(C!=null&&C.isValid&&(_!=null&&_.isValid)&&!fn(h)){const k=m.Med(C.start.handle,C.end.handle),R=m.Dist(C.middle,k),X=m.Dist(_.middle,k);v.props.bend<0?v.props.bend+=X-R:v.props.bend-=X-R}v.props.start.type==="binding"&&E&&(v.props.start.boundShapeId=E),v.props.end.type==="binding"&&A&&(v.props.end.boundShapeId=A)}return v={...v,id:p,x:h.x+f,y:h.y+y,index:P},v}));return l.forEach(d=>{He(d.parentId)&&c.has(d.parentId)&&(d.parentId=c.get(d.parentId))}),this.history.batch(()=>{const d=l.length+this.getCurrentPageShapeIds().size>ct;d&&$n(this);const h=d?l.slice(0,ct-this.getCurrentPageShapeIds().size):l,p=h.map(f=>f.id);if(this.createShapes(h),this.setSelectedShapes(p),s!==void 0){const f=this.getSelectionPageBounds(),y=this.getViewportPageBounds();f&&!y.contains(f)&&this.centerOnPoint(f.center,{duration:Jl})}}),this}moveShapesToPage(e,s){const r=typeof e[0]=="string"?e:e.map(c=>c.id);if(r.length===0)return this;if(this.getInstanceState().isReadonly)return this;const i=this.getCurrentPageId();if(s===i)return this;if(!this.store.has(s))return this;const o=this.getContentFromCurrentPage(r);if(!o)return this;if(this.getPageShapeIds(s).size+o.shapes.length>ct)return $n(this,s),this;const a=this.getCamera().z;return this.history.batch(()=>{this.deleteShapes(r),this.setCurrentPage(s),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(o,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:a}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){const s=typeof e[0]=="string"?e:e.map(a=>a.id);if(this.getInstanceState().isReadonly||s.length===0)return this;let r=!0,i=!0;const o=[];for(const a of s){const c=this.getShape(a);c&&(o.push(c),c.isLocked?i=!1:r=!1)}return this.batch(()=>{i?(this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!0}))),this.setSelectedShapes([])):r?this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!1}))):this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!0})))}),this}sendToBack(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Un(this,"toBack",s);return r&&this.updateShapes(r),this}sendBackward(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Un(this,"backward",s);return r&&this.updateShapes(r),this}bringForward(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Un(this,"forward",s);return r&&this.updateShapes(r),this}bringToFront(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Un(this,"toFront",s);return r&&this.updateShapes(r),this}flipShapes(e,s){const r=typeof e[0]=="string"?e:e.map(a=>a.id);if(this.getInstanceState().isReadonly)return this;let i=G(r.map(a=>this.getShape(a)));if(!i.length)return this;i=G(i.map(a=>this.isShapeOfType(a,"group")?this.getSortedChildIdsForParent(a.id).map(c=>this.getShape(c)):a).flat());const o=$.Common(G(i.map(a=>this.getShapePageBounds(a)))).center;return this.batch(()=>{for(const a of i){const c=this.getShapeGeometry(a).bounds,l=this.getShapePageTransform(a.id);l&&this.resizeShape(a.id,{x:s==="horizontal"?-1:1,y:s==="vertical"?-1:1},{initialBounds:c,initialPageTransform:l,initialShape:a,mode:"scale_shape",scaleOrigin:o,scaleAxisRotation:0})}}),this}stackShapes(e,s,r){const i=typeof e[0]=="string"?e:e.map(x=>x.id);if(this.getInstanceState().isReadonly)return this;const o=G(i.map(x=>this.getShape(x)).filter(x=>!(!x||this.isShapeOfType(x,"arrow")&&(x.props.start.type==="binding"||x.props.end.type==="binding")))),a=o.length;if(r===0&&a<3||a<2)return this;const c=Object.fromEntries(o.map(x=>[x.id,this.getShapePageBounds(x)]));let l,d,h,p;s==="horizontal"?(l="x",d="minX",h="maxX",p="width"):(l="y",d="minY",h="maxY",p="height");let f;if(r===0){const x=[];o.sort((I,b)=>c[I.id][d]-c[b.id][d]);for(let I=0;I<a-1;I++){const b=o[I],P=o[I+1],v=c[b.id],E=c[P.id][d]-v[h],A=x.find(_=>_.gap===E);A?A.count++:x.push({gap:E,count:1})}let w=0;x.forEach(I=>{I.count>w&&(w=I.count,f=I.gap)}),w===1&&(f=Math.max(0,x.reduce((I,b)=>I+b.gap*b.count,0)/(a-1)))}else f=r;const y=[];let g=c[o[0].id][h];return o.forEach((x,w)=>{var C,E;if(w===0)return;const I={x:0,y:0};I[l]=g+f-c[x.id][l];const b=this.getShapeParent(x),P=b?m.Rot(I,-this.getShapePageTransform(b).decompose().rotation):I,v=(E=(C=this.getShapeUtil(x)).onTranslateStart)==null?void 0:E.call(C,x);y.push(v?{...v,[l]:x[l]+P[l]}:{id:x.id,type:x.type,[l]:x[l]+P[l]}),g+=c[x.id][p]+f}),this.updateShapes(y),this}packShapes(e,s){var E,A;const r=typeof e[0]=="string"?e:e.map(_=>_.id);if(this.getInstanceState().isReadonly)return this;if(r.length<2)return this;const i=G(r.map(_=>this.getShape(_)).filter(_=>!(!_||this.isShapeOfType(_,"arrow")&&(_.props.start.type==="binding"||_.props.end.type==="binding")))),o={},a={};let c,l,d=0;for(let _=0;_<i.length;_++)c=i[_],l=this.getShapePageBounds(c),o[c.id]=l,a[c.id]=l.clone(),d+=l.width*l.height;const h=$.Common(G(Object.values(o))),p=h.width;i.sort((_,k)=>o[k.id].height-o[_.id].height);const f=Math.max(Math.ceil(Math.sqrt(d/.95)),p),y=[new $(h.x,h.y,f,1/0)];let g=0,x=0,w,I;for(let _=0;_<i.length;_++){c=i[_],l=a[c.id];for(let k=y.length-1;k>=0;k--)if(w=y[k],!(l.width>w.width||l.height>w.height)){l.x=w.x,l.y=w.y,x=Math.max(x,l.maxY),g=Math.max(g,l.maxX),l.width===w.width&&l.height===w.height?(I=y.pop(),k<y.length&&(y[k]=I)):l.height===w.height?(w.x+=l.width+s,w.width-=l.width+s):l.width===w.width?(w.y+=l.height+s,w.height-=l.height+s):(y.push(new $(w.x+(l.width+s),w.y,w.width-(l.width+s),l.height)),w.y+=l.height+s,w.height-=l.height+s);break}}const b=$.Common(Object.values(a)),P=m.Sub(h.center,b.center);let v;const C=[];for(let _=0;_<i.length;_++){c=i[_],l=o[c.id],v=a[c.id];const k=m.Sub(v.point,l.point).add(P),R=this.getShapeParentTransform(c);R&&k.rot(-R.rotation());const X={id:c.id,type:c.type,x:c.x+k.x,y:c.y+k.y},j=(A=(E=this.getShapeUtil(c)).onTranslateStart)==null?void 0:A.call(E,{...c,...X});j?C.push({...X,...j}):C.push(X)}return C.length&&this.updateShapes(C),this}alignShapes(e,s){const r=typeof e[0]=="string"?e:e.map(l=>l.id);if(this.getInstanceState().isReadonly)return this;if(r.length<2)return this;const i=G(r.map(l=>this.getShape(l))),o=Object.fromEntries(i.map(l=>[l.id,this.getShapePageBounds(l)])),a=$.Common(G(Object.values(o))),c=[];return i.forEach(l=>{const d=o[l.id];if(!d)return;const h={x:0,y:0};switch(s){case"top":{h.y=a.minY-d.minY;break}case"center-vertical":{h.y=a.midY-d.minY-d.height/2;break}case"bottom":{h.y=a.maxY-d.minY-d.height;break}case"left":{h.x=a.minX-d.minX;break}case"center-horizontal":{h.x=a.midX-d.minX-d.width/2;break}case"right":{h.x=a.maxX-d.minX-d.width;break}}const p=this.getShapeParent(l),f=p?m.Rot(h,-this.getShapePageTransform(p).decompose().rotation):h;c.push(this.getChangesToTranslateShape(l,m.Add(l,f)))}),this.updateShapes(c),this}distributeShapes(e,s){const r=typeof e[0]=="string"?e:e.map(b=>b.id);if(this.getInstanceState().isReadonly)return this;if(r.length<3)return this;const i=r.length,o=G(r.map(b=>this.getShape(b))),a=Object.fromEntries(o.map(b=>[b.id,this.getShapePageBounds(b)]));let c,l,d,h,p;s==="horizontal"?(c="x",l="minX",d="maxX",h="midX",p="width"):(c="y",l="minY",d="maxY",h="midY",p="height");const f=[],y=o.sort((b,P)=>a[b.id][l]-a[P.id][l])[0],g=o.sort((b,P)=>a[P.id][d]-a[b.id][d])[0],x=a[y.id][h],w=(a[g.id][h]-x)/(i-1),I=x+w;return o.filter(b=>b!==y&&b!==g).sort((b,P)=>a[b.id][h]-a[P.id][h]).forEach((b,P)=>{const v={x:0,y:0};v[c]=I+w*P-a[b.id][p]/2-a[b.id][c];const C=this.getShapeParent(b),E=C?m.Rot(v,-this.getShapePageTransform(C).rotation()):v;f.push(this.getChangesToTranslateShape(b,m.Add(b,E)))}),this.updateShapes(f),this}stretchShapes(e,s){const r=typeof e[0]=="string"?e:e.map(l=>l.id);if(this.getInstanceState().isReadonly)return this;if(r.length<2)return this;const i=G(r.map(l=>this.getShape(l))),o=Object.fromEntries(r.map(l=>[l,this.getShapeGeometry(l).bounds])),a=Object.fromEntries(r.map(l=>[l,this.getShapePageBounds(l)])),c=$.Common(G(Object.values(a)));switch(s){case"vertical":{this.batch(()=>{for(const l of i){if(this.getShapePageTransform(l).rotation()%ee)continue;const h=o[l.id],p=a[l.id],f=new m(0,c.minY-p.minY),y=this.getShapeParentTransform(l);y&&f.rot(-y.rotation());const{x:g,y:x}=m.Add(f,l);this.updateShapes([{id:l.id,type:l.type,x:g,y:x}],{squashing:!0});const w=new m(1,c.height/p.height);this.resizeShape(l.id,w,{initialBounds:h,scaleOrigin:new m(p.center.x,c.minY),scaleAxisRotation:0})}});break}case"horizontal":{this.batch(()=>{for(const l of i){const d=o[l.id],h=a[l.id];if(this.getShapePageTransform(l).rotation()%ee)continue;const f=new m(c.minX-h.minX,0),y=this.getShapeParentTransform(l);y&&f.rot(-y.rotation());const{x:g,y:x}=m.Add(f,l);this.updateShapes([{id:l.id,type:l.type,x:g,y:x}],{squashing:!0});const w=new m(c.width/h.width,1);this.resizeShape(l.id,w,{initialBounds:d,scaleOrigin:new m(c.minX,h.center.y),scaleAxisRotation:0})}});break}}return this}resizeShape(e,s,r={}){var f;const i=typeof e=="string"?e:e.id;if(this.getInstanceState().isReadonly)return this;Number.isFinite(s.x)||(s=new m(1,s.y)),Number.isFinite(s.y)||(s=new m(s.x,1));const o=r.initialShape??this.getShape(i);if(!o)return this;const a=r.scaleOrigin??((f=this.getShapePageBounds(i))==null?void 0:f.center);if(!a)return this;const c=r.initialPageTransform?F.Cast(r.initialPageTransform):this.getShapePageTransform(i);if(!c)return this;const l=c.rotation();if(l==null)return this;const d=r.scaleAxisRotation??l,h=r.initialBounds??this.getShapeGeometry(i).bounds;if(!h)return this;if(!Vl(l,d))return this._resizeUnalignedShape(i,s,{...r,initialBounds:h,scaleOrigin:a,scaleAxisRotation:d,initialPageTransform:c,initialShape:o});const p=this.getShapeUtil(o);if(p.isAspectRatioLocked(o)&&(Math.abs(s.x)>Math.abs(s.y)?s=new m(s.x,Math.sign(s.y)*Math.abs(s.x)):s=new m(Math.sign(s.x)*Math.abs(s.y),s.y)),p.onResize&&p.canResize(o)){const y=this._scalePagePoint(F.applyToPoint(c,new m(0,0)),a,s,d),g=this.getPointInParentSpace(o.id,y),x=new m(s.x,s.y),w=_o((l-d)%Math.PI,0);x.x=w?s.x:s.y,x.y=w?s.y:s.x;const I=F.applyToPoint(c,new m),{x:b,y:P}=this.getPointInParentSpace(o.id,I);this.updateShapes([{id:i,type:o.type,x:g.x,y:g.y,...p.onResize({...o,x:b,y:P},{newPoint:g,handle:r.dragHandle??"bottom_right",mode:r.mode??"scale_shape",scaleX:x.x,scaleY:x.y,initialBounds:h,initialShape:o})}],{squashing:!0})}else{const y=F.applyToPoint(c,h.center),g=this._scalePagePoint(y,a,s,d),x=this.getPointInParentSpace(o.id,y),w=this.getPointInParentSpace(o.id,g),I=m.Sub(w,x);this.updateShapes([{id:i,type:o.type,x:o.x+I.x,y:o.y+I.y}],{squashing:!0})}return this}_scalePagePoint(e,s,r,i){const o=m.RotWith(e,s,-i).sub(s),a=m.MulV(o,r);return m.Add(a,s).rotWith(s,i)}_resizeUnalignedShape(e,s,r){const{type:i}=r.initialShape,o=new m(s.x,s.y);if(Math.abs(s.x)>Math.abs(s.y)?o.x=Math.sign(s.x)*Math.abs(s.y):o.y=Math.sign(s.y)*Math.abs(s.x),this.resizeShape(e,o,{initialShape:r.initialShape,initialBounds:r.initialBounds}),Math.sign(s.x)*Math.sign(s.y)<0){let{rotation:w}=F.Decompose(r.initialPageTransform);w-=2*w,this.updateShapes([{id:e,type:i,rotation:w}],{squashing:!0})}const a=F.applyToPoint(r.initialPageTransform,r.initialBounds.center),c=this._scalePagePoint(a,r.scaleOrigin,s,r.scaleAxisRotation),l=this.getShapePageBounds(e),d=this.getShapePageTransform(e),h=l.center,p=d.point();if(!h||!p)return this;const f=m.Sub(c,h),y=m.Add(p,f),{x:g,y:x}=this.getPointInParentSpace(e,y);return this.updateShapes([{id:e,type:i,x:g,y:x}],{squashing:!0}),this}getInitialMetaForShape(e){return{}}createShape(e){return this._createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");return this._createShapes(e),this}animateShape(e,s){return this.animateShapes([e],s)}animateShapes(e,s={}){const{duration:r=500,easing:i=ss.linear}=s,o=Ee();let a=r,c;const l=[];let d,h;for(let y=0,g=e.length;y<g;y++){if(d=e[y],!d)continue;h={partial:d,values:[]};const x=this.getShape(d.id);if(x){for(const w of["x","y","rotation"])d[w]!==void 0&&x[w]!==d[w]&&h.values.push({prop:w,from:x[w],to:d[w]});l.push(h),this.animatingShapes.set(x.id,o)}}let p;const f=y=>{if(a-=y,a<0){const{animatingShapes:I}=this,b=e.filter(P=>P&&I.get(P.id)===o);b.length&&this.updateShapes(b,{squashing:!1}),this.removeListener("tick",f);return}c=i(1-a/r);const{animatingShapes:g}=this,x=[];let w;for(let I=0,b=l.length;I<b;I++)p=l[I],w=g.get(p.partial.id),w===o&&x.push({id:p.partial.id,type:p.partial.type,...p.values.reduce((P,{prop:v,from:C,to:E})=>(P[v]=C+(E-C)*c,P),{})});this._updateShapes(x,{squashing:!0})};return this.addListener("tick",f),this}groupShapes(e,s=Zt()){var f;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getInstanceState().isReadonly)return this;const r=typeof e[0]=="string"?e:e.map(y=>y.id);if(r.length<=1)return this;const i=G(this._getUnlockedShapeIds(r).map(y=>this.getShape(y))),o=i.sort(ze).map(y=>y.id),a=$.Common(G(i.map(y=>this.getShapePageBounds(y)))),{x:c,y:l}=a.point,d=this.findCommonAncestor(i)??this.getCurrentPageId();if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const h=i.filter(y=>y.parentId===d).sort(ze),p=(f=h[h.length-1])==null?void 0:f.index;return this.batch(()=>{this.createShapes([{id:s,type:"group",parentId:d,index:p,x:c,y:l,opacity:1,props:{}}]),this.reparentShapes(o,s),this.select(s)}),this}ungroupShapes(e){const s=typeof e[0]=="string"?e:e.map(a=>a.id);if(this.getInstanceState().isReadonly)return this;if(s.length===0)return this;if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const r=new Set,i=G(s.map(a=>this.getShape(a))),o=[];return i.forEach(a=>{this.isShapeOfType(a,"group")?o.push(a):r.add(a.id)}),o.length===0?this:(this.batch(()=>{let a;for(let c=0,l=o.length;c<l;c++){a=o[c];const d=this.getSortedChildIdsForParent(a.id);for(let h=0,p=d.length;h<p;h++)r.add(d[h]);this.reparentShapes(d,a.parentId,a.index)}this.deleteShapes(o.map(c=>c.id)),this.select(...r)}),this)}updateShape(e,s){return this.updateShapes([e],s),this}updateShapes(e,s){const r=Array(e.length);for(let i=0,o=e.length;i<o;i++){const a=e[i];if(!a)continue;const c=this.getShape(a.id);c&&(this.isShapeOrAncestorLocked(c)&&!Object.hasOwn(a,"isLocked")||(this.animatingShapes.delete(a.id),r.push(a)))}return this._updateShapes(r,s),this}_getUnlockedShapeIds(e){return e.filter(s=>{var r;return!((r=this.getShape(s))!=null&&r.isLocked)})}deleteShapes(e){if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");return this._deleteShapes(this._getUnlockedShapeIds(typeof e[0]=="string"?e:e.map(s=>s.id))),this}deleteShape(e){return this.deleteShapes([typeof e=="string"?e:e.id]),this}_extractSharedStyles(e,s){if(this.isShapeOfType(e,"group")){const r=this._parentIdsToChildIds.get()[e.id];if(!r)return;for(let i=0,o=r.length;i<o;i++)this._extractSharedStyles(this.getShape(r[i]),s)}else for(const[r,i]of this.styleProps[e.type])s.applyValue(r,We(e.props,i))}_getSelectionSharedStyles(){const e=this.getSelectedShapes(),s=new _i;for(const r of e)this._extractSharedStyles(r,s);return s}getStyleForNextShape(e){const s=this.getInstanceState().stylesForNextShape[e.id];return s===void 0?e.defaultValue:s}getShapeStyleIfExists(e,s){const r=this.styleProps[e.type].get(s);if(r!==void 0)return We(e.props,r)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();const e=this.root.getCurrent(),s=new _i;if(!e)return s;if(e.shapeType)for(const r of this.styleProps[e.shapeType].keys())s.applyValue(r,this.getStyleForNextShape(r));return s}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){const e=[],s=i=>{const o=this.getShape(i);if(o)if(this.isShapeOfType(o,"group"))for(const a of this.getSortedChildIdsForParent(o.id))s(a);else e.push(o)};for(const i of this.getSelectedShapeIds())s(i);let r=null;for(const i of e)if(r===null)r=i.opacity;else if(r!==i.opacity)return{type:"mixed"};if(r!==null)return{type:"shared",value:r}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,s){return this.updateInstanceState({opacityForNextShape:e},s),this}setOpacityForSelectedShapes(e,s){const r=this.getSelectedShapes();if(r.length>0){const i=[],o=a=>{if(this.isShapeOfType(a,"group")){const c=this.getSortedChildIdsForParent(a);for(const l of c)o(this.getShape(l))}else i.push(a)};for(const a of r)o(a);this.updateShapes(i.map(a=>({id:a.id,type:a.type,opacity:e})),s)}return this}setStyleForNextShapes(e,s,r){const i=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...i,[e.id]:s}},r),this}setStyleForSelectedShapes(e,s,r){const i=this.getSelectedShapes();if(i.length>0){const o=[],a=c=>{if(this.isShapeOfType(c,"group")){const l=this.getSortedChildIdsForParent(c.id);for(const d of l)a(this.getShape(d))}else{const l=this.getShapeUtil(c),d=this.styleProps[c.type].get(e);if(d){const h={id:c.id,type:c.type,props:{[d]:s}};o.push({util:l,originalShape:c,updatePartial:h})}}};for(const c of i)a(c);this.updateShapes(o.map(({updatePartial:c})=>c),r)}return this}registerExternalAssetHandler(e,s){return this.externalAssetContentHandlers[e]=s,this}async getAssetForExternalContent(e){var s,r;return await((r=(s=this.externalAssetContentHandlers)[e.type])==null?void 0:r.call(s,e))}registerExternalContentHandler(e,s){return this.externalContentHandlers[e]=s,this}async putExternalContent(e){var s,r;return(r=(s=this.externalContentHandlers)[e.type])==null?void 0:r.call(s,e)}getContentFromCurrentPage(e){const s=typeof e[0]=="string"?e:e.map(c=>c.id);if(!s||s.length===0)return;const r={};let i=Zn(s.map(c=>this.getShape(c)).sort(ze).flatMap(c=>{const l=[c];return this.visitDescendants(c.id,d=>{l.push(this.getShape(d))}),l}));i=i.map(c=>{if(r[c.id]=this.getShapePageTransform(c.id),c=he(c),this.isShapeOfType(c,"arrow")){const l=c.props.start.type==="binding"?c.props.start.boundShapeId:void 0,d=c.props.end.type==="binding"?c.props.end.boundShapeId:void 0,h=this.getArrowInfo(c);if(c.props.start.type==="binding"&&!i.some(f=>f.id===l))if(h!=null&&h.isValid){const{x:f,y}=h.start.point;c.props.start={type:"point",x:f,y}}else{const{start:f}=kt(this,c);c.props.start={type:"point",x:f.x,y:f.y}}if(c.props.end.type==="binding"&&!i.some(f=>f.id===d))if(h!=null&&h.isValid){const{x:f,y}=h.end.point;c.props.end={type:"point",x:f,y}}else{const{end:f}=kt(this,c);c.props.end={type:"point",x:f.x,y:f.y}}const p=fn(c)?vn(this,c):qs(this,c);if(h!=null&&h.isValid&&(p!=null&&p.isValid)&&!fn(c)){const f=m.Med(h.start.handle,h.end.handle),y=m.Dist(h.middle,f),g=m.Dist(p.middle,f);c.props.bend<0?c.props.bend+=g-y:c.props.bend-=g-y}return c}return c});const o=[];i.forEach(c=>{if(i.find(l=>l.id===c.parentId)===void 0){const l=this.getShapePageTransform(c.id),d=l.point(),h=l.rotation();c.x=d.x,c.y=d.y,c.rotation=h,c.parentId=this.getCurrentPageId(),o.push(c.id)}});const a=new Set;return i.forEach(c=>{"assetId"in c.props&&c.props.assetId!==null&&a.add(c.props.assetId)}),{shapes:i,rootShapeIds:o,schema:this.store.schema.serialize(),assets:G(Array.from(a).map(c=>this.getAsset(c)))}}putContentOntoCurrentPage(e,s={}){var A;if(this.getInstanceState().isReadonly)return this;if(!e.schema)throw Error(`Could not put content:
content is missing a schema.`);const{select:r=!1,preserveIds:i=!1,preservePosition:o=!1}=s;let{point:a=void 0}=s;const c=this.getCurrentPageId(),{rootShapeIds:l}=e,d=[],h=[],p={store:{...Object.fromEntries(e.assets.map(_=>[_.id,_])),...Object.fromEntries(e.shapes.map(_=>[_.id,_]))},schema:e.schema},f=this.store.schema.migrateStoreSnapshot(p);if(f.type==="error")throw Error("Could not put content: could not migrate content");for(const _ of Object.values(f.value))switch(_.typeName){case"asset":{d.push(_);break}case"shape":{h.push(_);break}}const y=new Map(h.map(_=>[_.id,Zt()]));let g=this.getCurrentPageId(),x=1/0,w=[];for(const _ of this.getSelectedShapes()){if(x===0)break;const k=this.isShapeOfType(_,"frame"),R=this.getShapeAncestors(_);k&&R.push(_);const X=k?R.length+1:R.length;if(X<x)x=X,w=R,g=k?_.id:_.parentId;else if(X===x){if(w.length!==R.length)throw Error(`Ancestors: ${w.length} !== ${R.length}`);if(w.length===0){g=c;break}else{g=c;for(let j=0;j<w.length&&R[j]===w[j];j++)g=R[j].id}}}let I=!1;if(!De(g)){const _=this.getShape(g);if(_){if(!this.getViewportPageBounds().includes(this.getShapePageBounds(_)))g=c;else if(l.length===1){const k=h.find(R=>R.id===l[0]);this.isShapeOfType(_,"frame")&&this.isShapeOfType(k,"frame")&&k.props.w===(_==null?void 0:_.props.w)&&k.props.h===(_==null?void 0:_.props.h)&&(I=!0)}}else g=c}I||(I=y.has(g)),I&&(g=this.getShape(g).parentId);let b=this.getHighestIndexForParent(g);const P=[],v=h.map(_=>{let k;if(i)k=he(_),y.set(_.id,_.id);else{const R=y.get(_.id);k=he({..._,id:R})}if(l.includes(_.id)&&(k.parentId=c,P.push(k)),y.has(k.parentId)?k.parentId=y.get(_.parentId):(l.push(k.id),k.index=b,b=zt(b)),this.isShapeOfType(k,"arrow")){if(k.props.start.type==="binding"){const R=y.get(k.props.start.boundShapeId);k.props.start=R?{...k.props.start,boundShapeId:R}:{type:"point",x:0,y:0}}if(k.props.end.type==="binding"){const R=y.get(k.props.end.boundShapeId);k.props.end=R?{...k.props.end,boundShapeId:R}:{type:"point",x:0,y:0}}}return k});if(v.length+this.getCurrentPageShapeIds().size>ct)return $n(this),this;const C=[],E=[];for(const _ of d)this.store.has(_.id)||((_.type==="image"||_.type==="video")&&((A=_.props.src)!=null&&A.startsWith("data:image"))&&(E.push(he(_)),_.props.src=null),C.push(_));return Promise.allSettled(E.map(async _=>{const k=await su(_.props.src,_.props.name,_.props.mimeType??"image/png"),R=await this.getAssetForExternalContent({type:"file",file:k});if(!R){this.deleteAssets([_.id]);return}this.updateAssets([{...R,id:_.id}])})),this.batch(()=>{C.length>0&&this.createAssets(C),this.createShapes(v),r&&this.select(...P.map(j=>j.id)),g!==c&&this.reparentShapes(P.map(j=>j.id),g);const _=v.map(j=>this.getShape(j.id)),k=$.Common(_.map(j=>this.getShapePageBounds(j)));if(a===void 0)if(De(g)){const j=this.getViewportPageBounds();o||j.includes($.From(k))?a=k.center:a=j.center}else{const j=this.getShape(g);a=F.applyToPoint(this.getShapePageTransform(j),this.getShapeGeometry(j).bounds.center)}if(P.length===1){const j=P[0];if(this.isShapeOfType(j,"frame"))for(;this.getShapesAtPoint(a).some(U=>this.isShapeOfType(U,"frame")&&U.props.w===j.props.w&&U.props.h===j.props.h);)a.x+=k.w+16}const R=$.Common(G(P.map(({id:j})=>this.getShapePageBounds(j)))).center,X=m.Sub(a,R);this.updateShapes(P.map(({id:j})=>{const U=this.getShape(j),ie=this.getShapeParentTransform(j).decompose().rotation,le=m.Rot(X,-ie);return{id:U.id,type:U.type,x:U.x+le.x,y:U.y+le.y}}))}),this}async getSvgElement(e,s={}){const r=await Su(this,e,s);if(!r)return;const i=document.createDocumentFragment(),o=xa.createRoot(i);wa.flushSync(()=>{o.render(r.jsx)});const a=i.firstElementChild;return ke(a instanceof SVGSVGElement,"Expected an SVG element"),o.unmount(),{svg:a,width:r.width,height:r.height}}async getSvgString(e,s={}){const r=await this.getSvgElement(e,s);return r?{svg:new XMLSerializer().serializeToString(r.svg),width:r.width,height:r.height}:void 0}async getSvg(e,s={}){const r=await this.getSvgElement(e,s);if(r)return r.svg}_updateInputsFromEvent(e){var w;const{pointerVelocity:s,previousScreenPoint:r,previousPagePoint:i,currentScreenPoint:o,currentPagePoint:a}=this.inputs,{screenBounds:c}=this.store.unsafeGetWithoutCapture(_e),{x:l,y:d,z:h}=this.store.unsafeGetWithoutCapture(this.getCameraId()),p=e.point.x-c.x,f=e.point.y-c.y,y=e.point.z??.5;r.setTo(o),i.setTo(a),o.set(p,f);const g=p/h-l,x=f/h-d;isFinite(g)&&isFinite(x)&&a.set(g,x,y),this.inputs.isPen=e.type==="pointer"&&e.isPen,(e.name==="pointer_down"||this.inputs.isPinching)&&s.set(0,0),this.store.put([{id:ns,typeName:"pointer",x:a.x,y:a.y,lastActivityTimestamp:e.type==="pointer"&&e.pointerId===pi.CAMERA_MOVE?((w=this.store.unsafeGetWithoutCapture(ns))==null?void 0:w.lastActivityTimestamp)??this._tickManager.now:this._tickManager.now,meta:{}}])}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_flushEventsForTick(e){this.batch(()=>{if(this._pendingEventsForNextTick.length>0){const s=[...this._pendingEventsForNextTick];this._pendingEventsForNextTick.length=0;for(const r of s)this._flushEventForTick(r)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}}O([T],D.prototype,"getCanUndo");O([T],D.prototype,"getCanRedo");O([T],D.prototype,"_getArrowBindingsIndex");O([T],D.prototype,"getArrowInfoCache");O([T],D.prototype,"getPath");O([T],D.prototype,"getCurrentTool");O([T],D.prototype,"getCurrentToolId");O([T],D.prototype,"getDocumentSettings");O([T],D.prototype,"getInstanceState");O([T],D.prototype,"getOpenMenus");O([T],D.prototype,"getIsMenuOpen");O([T],D.prototype,"getPageStates");O([T],D.prototype,"_getPageStatesQuery");O([T],D.prototype,"getCurrentPageState");O([T],D.prototype,"_getCurrentPageStateId");O([T],D.prototype,"getSelectedShapeIds");O([T],D.prototype,"getSelectedShapes");O([T],D.prototype,"getOnlySelectedShapeId");O([T],D.prototype,"getOnlySelectedShape");O([T],D.prototype,"getSelectionPageBounds");O([T],D.prototype,"getSelectionRotation");O([T],D.prototype,"getSelectionRotatedPageBounds");O([T],D.prototype,"getSelectionRotatedScreenBounds");O([T],D.prototype,"getFocusedGroupId");O([T],D.prototype,"getFocusedGroup");O([T],D.prototype,"getEditingShapeId");O([T],D.prototype,"getEditingShape");O([T],D.prototype,"getHoveredShapeId");O([T],D.prototype,"getHoveredShape");O([T],D.prototype,"getHintingShapeIds");O([T],D.prototype,"getHintingShape");O([T],D.prototype,"getErasingShapeIds");O([T],D.prototype,"getErasingShapes");O([T],D.prototype,"getCameraId");O([T],D.prototype,"getCamera");O([T],D.prototype,"getZoomLevel");O([T],D.prototype,"getViewportScreenBounds");O([T],D.prototype,"getViewportScreenCenter");O([T],D.prototype,"getViewportPageBounds");O([T],D.prototype,"getViewportPageCenter");O([T],D.prototype,"_getCollaboratorsQuery");O([T],D.prototype,"getCollaborators");O([T],D.prototype,"getCollaboratorsOnCurrentPage");O([T],D.prototype,"getRenderingShapes");O([T],D.prototype,"_getAllPagesQuery");O([T],D.prototype,"getPages");O([T],D.prototype,"getCurrentPageId");O([T],D.prototype,"getCurrentPageShapeIdsSorted");O([T],D.prototype,"_getAllAssetsQuery");O([T],D.prototype,"_getShapeGeometryCache");O([T],D.prototype,"_getShapeHandlesCache");O([T],D.prototype,"_getShapePageTransformCache");O([T],D.prototype,"_getShapePageBoundsCache");O([T],D.prototype,"_getShapeClipPathCache");O([T],D.prototype,"_getShapeMaskCache");O([T],D.prototype,"_getShapeMaskedPageBoundsCache");O([T],D.prototype,"_notVisibleShapes");O([T],D.prototype,"getCulledShapes");O([T],D.prototype,"getCurrentPageBounds");O([T],D.prototype,"getCurrentPageShapes");O([T],D.prototype,"getCurrentPageShapesSorted");O([T],D.prototype,"getCurrentPageRenderingShapesSorted");O([T],D.prototype,"_getSelectionSharedStyles");O([T({isEqual:(n,t)=>n.equals(t)})],D.prototype,"getSharedStyles");O([T],D.prototype,"getSharedOpacity");function $n(n,t=n.getCurrentPageId()){const e=n.getPage(t).name;n.emit("max-shapes",{name:e,pageId:t,count:ct})}function gn(n,t){if(!t)return n;let e=null;const s=Object.entries(t);for(let r=0,i=s.length;r<i;r++){const[o,a]=s[r];if(a!==void 0&&!(o==="id"||o==="type"||o==="typeName")&&a!==n[o]){if(e||(e={...n}),o==="props"||o==="meta"){e[o]={...n[o]};for(const[c,l]of Object.entries(a))l!==void 0&&(e[o][c]=l);continue}e[o]=a}}return e||n}function ea(n,t,e){const s=n.getShape(t);if(!s)return;e.push(s);const r=n.getSortedChildIdsForParent(t);for(let i=0,o=r.length;i<o;i++)ea(n,r[i],e)}function ta(){const n=N(),t=yu();return z("isDarkMode",()=>(t==null?void 0:t.isDarkMode)??n.user.getIsDarkMode(),[t,n])}const Di="<path d='m19.7432 17.0869-4.072 4.068 2.829 2.828-8.473-.013-.013-8.47 2.841 2.842 4.075-4.068 1.414-1.415-2.844-2.842h8.486v8.484l-2.83-2.827z' fill='%23fff'/><path d='m18.6826 16.7334-4.427 4.424 1.828 1.828-5.056-.016-.014-5.054 1.842 1.841 4.428-4.422 2.474-2.475-1.844-1.843h5.073v5.071l-1.83-1.828z' fill='%23000'/>",Oi="<path d='m9 17.9907v.005l5.997 5.996.001-3.999h1.999 2.02v4l5.98-6.001-5.98-5.999.001 4.019-2.021.002h-2l.001-4.022zm1.411.003 3.587-3.588-.001 2.587h3.5 2.521v-2.585l3.565 3.586-3.564 3.585-.001-2.585h-2.521l-3.499-.001-.001 2.586z' fill='%23fff'/><path d='m17.4971 18.9932h2.521v2.586l3.565-3.586-3.565-3.585v2.605h-2.521-3.5v-2.607l-3.586 3.587 3.586 3.586v-2.587z' fill='%23000'/>",Hn='<path d="M22.4789 9.45728L25.9935 12.9942L22.4789 16.5283V14.1032C18.126 14.1502 14.6071 17.6737 14.5675 22.0283H17.05L13.513 25.543L9.97889 22.0283H12.5674C12.6071 16.5691 17.0214 12.1503 22.4789 12.1031L22.4789 9.45728Z" fill="black"/><path fill-rule="evenodd" clip-rule="evenodd" d="M21.4789 7.03223L27.4035 12.9945L21.4789 18.9521V15.1868C18.4798 15.6549 16.1113 18.0273 15.649 21.0284H19.475L13.5128 26.953L7.55519 21.0284H11.6189C12.1243 15.8155 16.2679 11.6677 21.4789 11.1559L21.4789 7.03223ZM22.4789 12.1031C17.0214 12.1503 12.6071 16.5691 12.5674 22.0284H9.97889L13.513 25.543L17.05 22.0284H14.5675C14.5705 21.6896 14.5947 21.3558 14.6386 21.0284C15.1157 17.4741 17.9266 14.6592 21.4789 14.1761C21.8063 14.1316 22.1401 14.1069 22.4789 14.1032V16.5284L25.9935 12.9942L22.4789 9.45729L22.4789 12.1031Z" fill="white"/>';function mt(n,t,e,s,r,i=16,o=16){const a=(-e-t)*(ue/180),c=Math.sin(a),l=Math.cos(a),d=1*l-1*c,h=1*c+1*l;return`url("data:image/svg+xml,<svg height='32' width='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' style='color: ${r};'><defs><filter id='shadow' y='-40%' x='-40%' width='180px' height='180%' color-interpolation-filters='sRGB'><feDropShadow dx='${d}' dy='${h}' stdDeviation='1.2' flood-opacity='.5'/></filter></defs><g fill='none' transform='rotate(${t+e} 16 16)${s?" scale(-1,-1) translate(0, -32)":""}' filter='url(%23shadow)'>`+n.replaceAll('"',"'")+`</g></svg>") ${i} ${o}, pointer`}const Wu=["default","pointer","cross","move","grab","grabbing","text","zoom-in","zoom-out"],Vu={none:()=>"none","ew-resize":(n,t,e)=>mt(Oi,n,0,t,e),"ns-resize":(n,t,e)=>mt(Oi,n,90,t,e),"nesw-resize":(n,t,e)=>mt(Di,n,0,t,e),"nwse-resize":(n,t,e)=>mt(Di,n,90,t,e),"nwse-rotate":(n,t,e)=>mt(Hn,n,0,t,e),"nesw-rotate":(n,t,e)=>mt(Hn,n,90,t,e),"senw-rotate":(n,t,e)=>mt(Hn,n,180,t,e),"swne-rotate":(n,t,e)=>mt(Hn,n,270,t,e)};function Zu(n,t=0,e="black"){return Vu[n](Zl(t),!1,e)}function Qu(){const n=N(),t=It(),e=ta();Rt("useCursor",()=>{const{type:s,rotation:r}=n.getInstanceState().cursor;if(Wu.includes(s)){t.style.setProperty("--tl-cursor",`var(--tl-cursor-${s})`);return}t.style.setProperty("--tl-cursor",Zu(s,r,e?"white":"black"))},[n,t,e])}function Ju(){const n=N(),t=It(),e=ta(),s=z(Ge.forceSrgb);ht.useEffect(()=>{e?(t.setAttribute("data-color-mode","dark"),t.classList.remove("tl-theme__light"),t.classList.add("tl-theme__dark")):(t.setAttribute("data-color-mode","light"),t.classList.remove("tl-theme__dark"),t.classList.add("tl-theme__light")),s?t.classList.add("tl-theme__force-sRGB"):t.classList.remove("tl-theme__force-sRGB")},[n,t,s,e])}function ep(n){const t=M.useRef();return M.useLayoutEffect(()=>{t.current=n}),M.useDebugValue(n),M.useCallback((...e)=>{const s=t.current;return ke(s,"fn does not exist"),s(...e)},[])}function tp(n){const t=N(),e=It();M.useLayoutEffect(()=>{n?(t.getInstanceState().isFocused||t.updateInstanceState({isFocused:!0}),t.getContainer().focus()):t.getInstanceState().isFocused&&t.updateInstanceState({isFocused:!1})},[t,e,n])}function np(){const[n,t]=M.useState(0);M.useEffect(()=>t(e=>e+1),[])}const en="TLDRAW_TAB_ID_v2",et=globalThis.window;function sp(){return et?["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(et.navigator.platform)||et.navigator.userAgent.includes("Mac")&&"ontouchend"in document:!1}const cs=et?et[en]??to(en)??"TLDRAW_INSTANCE_STATE_V1_"+Ee():"<error>";et&&(et[en]=cs,sp()?pr(en,cs):no(en));et==null||et.addEventListener("beforeunload",()=>{pr(en,cs)});const na={Initial:0},_s=Math.max(...Object.values(na));function rp(n){n.version<na.Initial,n.version=_s}const sa=q({version:B,currentPageId:_n,isFocusMode:H,exportBackground:H,isDebugMode:H,isToolLocked:H,isGridMode:H,pageStates:ye(q({pageId:_n,camera:q({x:B,y:B,z:B}),selectedShapeIds:ye(Ke),focusedGroupId:Ke.nullable()}))});function ip(n){if(!n||typeof n!="object")return console.warn("Invalid instance state"),null;if(!("version"in n)||typeof n.version!="number")return console.warn("No version in instance state"),null;n.version!==_s&&(n=he(n),rp(n));try{return sa.validate(n)}catch(t){return console.warn(t),null}}function op(n){const t=n.query.ids("page");return T("sessionStateSnapshot",()=>{const e=n.get(_e);if(!e)return null;const s=[...t.get()];return{version:_s,currentPageId:e.currentPageId,exportBackground:e.exportBackground,isFocusMode:e.isFocusMode,isDebugMode:e.isDebugMode,isToolLocked:e.isToolLocked,isGridMode:e.isGridMode,pageStates:s.map(r=>{const i=n.get(ge.createId(r)),o=n.get(Ie.createId(r));return{pageId:r,camera:{x:(o==null?void 0:o.x)??0,y:(o==null?void 0:o.y)??0,z:(o==null?void 0:o.z)??1},selectedShapeIds:(i==null?void 0:i.selectedShapeIds)??[],focusedGroupId:(i==null?void 0:i.focusedGroupId)??null}})}})}function ap(n,t){const e=ip(t);if(!e)return;const s=n.allRecords().filter(o=>o.typeName==="instance_page_state"||o.typeName==="camera"),r={added:{},updated:{},removed:{...ur(s.map(o=>[o.id,o]))}};n.has(_e)&&(r.removed[_e]=n.get(_e));const i={removed:{},updated:{},added:{[_e]:n.schema.types.instance.create({id:_e,currentPageId:e.currentPageId,isDebugMode:e.isDebugMode,isFocusMode:e.isFocusMode,isToolLocked:e.isToolLocked,isGridMode:e.isGridMode,exportBackground:e.exportBackground})}};for(const o of e.pageStates){const a=Ie.createId(o.pageId),c=ge.createId(o.pageId);i.added[a]=Ie.create({id:Ie.createId(o.pageId),x:o.camera.x,y:o.camera.y,z:o.camera.z}),i.added[c]=ge.create({id:ge.createId(o.pageId),pageId:o.pageId,selectedShapeIds:o.selectedShapeIds,focusedGroupId:o.focusedGroupId})}Xe(()=>{n.applyDiff(ps([r,i])),n.ensureStoreIsUsable()})}function cp(n){var r;const t=[];for(const i of Object.values(n))(r=i.typeName)!=null&&r.match(/^(instance.*|pointer|camera)$/)&&t.push(i);const e=t.filter(i=>i.typeName==="instance"&&i.id!==_e)[0];if(!e)return null;const s={version:_s,currentPageId:e.currentPageId,exportBackground:!!e.exportBackground,isFocusMode:!!e.isFocusMode,isDebugMode:!!e.isDebugMode,isToolLocked:!!e.isToolLocked,isGridMode:!1,pageStates:t.filter(i=>i.typeName==="instance_page_state"&&i.instanceId===e.id).map(i=>{const o=n[i.cameraId]??{x:0,y:0,z:1};return{pageId:i.pageId,camera:{x:o.x,y:o.y,z:o.z},selectedShapeIds:i.selectedShapeIds,focusedGroupId:i.focusedGroupId}})};try{return sa.validate(s),s}catch{return null}}function lp(){window.alert(`Oops! We could not save changes to your browser's storage. We now need to reload the page and try again.

Keep seeing this message?
 If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.
 If your hard disk is full, try clearing up some space and then reload the page.`)}function dp(){window.alert(`Oops! We could not access your browser's storageand the app won't work correctly without that. We now need to reload the page and try again.

Keep seeing this message?
 If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.`)}const Es="TLDRAW_DOCUMENT_v2",ra="TLDRAW_DB_NAME_INDEX_v2",V={Records:"records",Schema:"schema",SessionState:"session_state"};async function Ts(n,t){gp(n);const e=await ba(n,3,{upgrade(s){s.objectStoreNames.contains(V.Records)||s.createObjectStore(V.Records),s.objectStoreNames.contains(V.Schema)||s.createObjectStore(V.Schema),s.objectStoreNames.contains(V.SessionState)||s.createObjectStore(V.SessionState)}});try{return await t(e)}finally{e.close()}}async function hp({persistenceKey:n,sessionId:t,didCancel:e}){const s=Es+n;if(Or().includes(s))return await fp({persistenceKey:n,didCancel:e}),await Ts(s,async r=>{var h,p;if(e!=null&&e())return;const i=r.transaction([V.Records,V.Schema,V.SessionState],"readonly"),o=i.objectStore(V.Records),a=i.objectStore(V.Schema),c=i.objectStore(V.SessionState);let l=t?(h=await c.get(t))==null?void 0:h.snapshot:null;l||(l=(p=(await c.getAll()).sort((y,g)=>y.updatedAt-g.updatedAt).pop())==null?void 0:p.snapshot);const d={records:await o.getAll(),schema:await a.get(V.Schema),sessionStateSnapshot:l};if(e!=null&&e()){i.abort();return}return await i.done,d})}async function up({persistenceKey:n,schema:t,changes:e,sessionId:s,sessionStateSnapshot:r,didCancel:i}){const o=Es+n;await Ts(o,async a=>{const c=a.transaction([V.Records,V.Schema,V.SessionState],"readwrite"),l=c.objectStore(V.Records),d=c.objectStore(V.Schema),h=c.objectStore(V.SessionState);for(const[p,f]of Object.entries(e.added))await l.put(f,p);for(const[p,f]of Object.values(e.updated))await l.put(f,f.id);for(const p of Object.keys(e.removed))await l.delete(p);if(d.put(t.serialize(),V.Schema),r&&s?h.put({snapshot:r,updatedAt:Date.now(),id:s},s):(r||s)&&console.error("sessionStateSnapshot and instanceId must be provided together"),i!=null&&i())return c.abort();await c.done})}async function pp({persistenceKey:n,schema:t,snapshot:e,sessionId:s,sessionStateSnapshot:r,didCancel:i}){const o=Es+n;await Ts(o,async a=>{const c=a.transaction([V.Records,V.Schema,V.SessionState],"readwrite"),l=c.objectStore(V.Records),d=c.objectStore(V.Schema),h=c.objectStore(V.SessionState);await l.clear();for(const[p,f]of Object.entries(e))await l.put(f,p);if(d.put(t.serialize(),V.Schema),r&&s?h.put({snapshot:r,updatedAt:Date.now(),id:s},s):(r||s)&&console.error("sessionStateSnapshot and instanceId must be provided together"),i!=null&&i())return c.abort();await c.done})}async function fp({persistenceKey:n,didCancel:t}){await Ts(Es+n,async e=>{const s=e.transaction([V.SessionState],"readwrite"),r=s.objectStore(V.SessionState),i=(await r.getAll()).sort((a,c)=>a.updatedAt-c.updatedAt);if(i.length<10){await s.done;return}const o=i.slice(0,i.length-10);for(const{id:a}of o)await r.delete(a);if(t!=null&&t())return s.abort();await s.done})}function Or(){const n=JSON.parse(Ji(ra)||"[]")??[];return Array.isArray(n)?n:[]}function gp(n){const t=new Set(Or());t.add(n),eo(ra,JSON.stringify([...t]))}const mp=350,yp=1e4,ji=Symbol("UPDATE_INSTANCE_STATE"),Sp=n=>n;class xp{constructor(t){u(this,"onmessage")}postMessage(t){}close(){}}const wp=typeof BroadcastChannel>"u"?xp:BroadcastChannel;class bp{constructor(t,{persistenceKey:e,sessionId:s=cs,onLoad:r,onLoadError:i},o=new wp(`tldraw-tab-sync-${e}`)){u(this,"disposables",new Set);u(this,"diffQueue",[]);u(this,"didDispose",!1);u(this,"shouldDoFullDBWrite",!0);u(this,"isReloading",!1);u(this,"persistenceKey");u(this,"sessionId");u(this,"serializedSchema");u(this,"isDebugging",!1);u(this,"documentTypes");u(this,"$sessionStateSnapshot");u(this,"initTime",Date.now());u(this,"isPersisting",!1);u(this,"didLastWriteError",!1);u(this,"scheduledPersistTimeout",null);this.store=t,this.channel=o,typeof window<"u"&&(window.tlsync=this),this.persistenceKey=e,this.sessionId=s,this.serializedSchema=this.store.schema.serialize(),this.$sessionStateSnapshot=op(this.store),this.disposables.add(t.listen(({changes:a})=>{this.diffQueue.push(a),this.channel.postMessage(Sp({type:"diff",storeId:this.store.id,changes:a,schema:this.serializedSchema})),this.schedulePersist()},{source:"user",scope:"document"})),this.disposables.add(t.listen(()=>{this.diffQueue.push(ji),this.schedulePersist()},{scope:"session"})),this.connect(r,i),this.documentTypes=new Set(Object.values(this.store.schema.types).filter(a=>a.scope==="document").map(a=>a.typeName))}debug(...t){this.isDebugging&&console.debug(...t)}async connect(t,e){this.debug("connecting");let s;try{s=await hp({persistenceKey:this.persistenceKey,sessionId:this.sessionId,didCancel:()=>this.didDispose})}catch(r){e(r),dp(),typeof window<"u"&&window.location.reload();return}if(this.debug("loaded data from store",s,"didDispose",this.didDispose),!this.didDispose)try{if(s){const r=Object.fromEntries(s.records.map(a=>[a.id,a])),i=s.sessionStateSnapshot??cp(r),o=this.store.schema.migrateStoreSnapshot({store:r,schema:s.schema??this.store.schema.serializeEarliestVersion()});if(o.type==="error"){console.error("failed to migrate store",o),e(new Error(`Failed to migrate store: ${o.reason}`));return}this.store.mergeRemoteChanges(()=>{this.store.put(Object.values(o.value).filter(a=>this.documentTypes.has(a.typeName)),"initialize")}),i&&ap(this.store,i)}this.channel.onmessage=({data:r})=>{var a,c;this.debug("got message",r);const i=r,o=this.store.schema.getMigrationsSince(i.schema);if(o.ok){if(o.value.length>0){this.debug("telling them to reload"),this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.shouldDoFullDBWrite=!0,this.persistIfNeeded();return}}else{if(Date.now()-this.initTime<5e3){e(new Error("Schema mismatch, please close other tabs and reload the page"));return}this.debug("reloading"),this.isReloading=!0,(c=(a=window==null?void 0:window.location)==null?void 0:a.reload)==null||c.call(a);return}i.type==="diff"&&(this.debug("applying diff"),Xe(()=>{this.store.mergeRemoteChanges(()=>{this.store.applyDiff(i.changes),this.store.ensureStoreIsUsable()})}))},this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.disposables.add(()=>{this.channel.close()}),t(this)}catch(r){if(this.debug("error loading data from store",r),this.didDispose)return;e(r);return}}close(){this.debug("closing"),this.didDispose=!0,this.disposables.forEach(t=>t())}schedulePersist(){this.debug("schedulePersist",this.scheduledPersistTimeout),!this.scheduledPersistTimeout&&(this.scheduledPersistTimeout=setTimeout(()=>{this.scheduledPersistTimeout=null,this.persistIfNeeded()},this.didLastWriteError?yp:mp))}persistIfNeeded(){this.debug("persistIfNeeded",{isPersisting:this.isPersisting,isReloading:this.isReloading,shouldDoFullDBWrite:this.shouldDoFullDBWrite,diffQueueLength:this.diffQueue.length,storeIsPossiblyCorrupt:this.store.isPossiblyCorrupted()}),this.scheduledPersistTimeout&&(clearTimeout(this.scheduledPersistTimeout),this.scheduledPersistTimeout=null),!this.isPersisting&&(this.isReloading||this.store.isPossiblyCorrupted()||(this.shouldDoFullDBWrite||this.diffQueue.length>0)&&this.doPersist())}async doPersist(){ke(!this.isPersisting,"persist already in progress"),this.isPersisting=!0,this.debug("doPersist start");const t=this.diffQueue;this.diffQueue=[];try{if(this.shouldDoFullDBWrite)this.shouldDoFullDBWrite=!1,await pp({persistenceKey:this.persistenceKey,schema:this.store.schema,snapshot:this.store.serialize(),didCancel:()=>this.didDispose,sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()});else{const e=ps(t.filter(s=>s!==ji));await up({persistenceKey:this.persistenceKey,changes:e,schema:this.store.schema,didCancel:()=>this.didDispose,sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()})}this.didLastWriteError=!1}catch(e){this.shouldDoFullDBWrite=!0,this.didLastWriteError=!0,console.error("failed to store changes in indexed db",e),lp(),typeof window<"u"&&window.location.reload()}this.isPersisting=!1,this.debug("doPersist end"),this.schedulePersist()}}function Ip({initialData:n,defaultName:t="",...e}){const s="schema"in e&&e.schema?e.schema:Hl({shapes:Pp(Zo("shapeUtils"in e&&e.shapeUtils?e.shapeUtils:[])),migrations:"migrations"in e?e.migrations:[]});return new ao({schema:s,initialData:n,props:{defaultName:t}})}function Pp(n){return Object.fromEntries(n.map(t=>[t.type,{props:t.props,migrations:t.migrations}]))}function Fi(n){const t=Ip(n);return n.snapshot&&t.loadSnapshot(n.snapshot),{store:t,opts:n}}function vp(n){const[t,e]=M.useState(()=>Fi(n));if(!qi(t.opts,n)){const s=Fi(n);return e(s),s.store}return t.store}function Cp({persistenceKey:n,sessionId:t,...e}){const[s,r]=M.useState(null),i=vp(e);return M.useEffect(()=>{const o=Ee();if(!n){r({id:o,storeWithStatus:{status:"not-synced",store:i}});return}r({id:o,storeWithStatus:{status:"loading"}});const a=l=>{r(d=>(d==null?void 0:d.id)===o?{id:o,storeWithStatus:l}:d)},c=new bp(i,{sessionId:t,persistenceKey:n,onLoad(){a({store:i,status:"synced-local"})},onLoadError(l){a({status:"error",error:l})}});return()=>{r(l=>(l==null?void 0:l.id)===o?null:l),c.close()}},[n,i,t]),(s==null?void 0:s.storeWithStatus)??{status:"loading"}}let ia=!1;if(typeof window<"u"){const n=window.navigator.userAgent,t=!!n.match(/iPad/i)||!!n.match(/iPhone/i),e=!!n.match(/WebKit/i);ia=t&&e&&!n.match(/CriOS/i)}function _p(){const n=N();M.useEffect(()=>{if(!ia)return;function t(e){(e.target instanceof HTMLInputElement&&e.target.type==="text"||e.target instanceof HTMLTextAreaElement)&&n.complete()}return document.addEventListener("focusout",t),()=>document.removeEventListener("focusout",t)},[n])}function Ep(){const n=N(),t=It();M.useEffect(()=>{const e=i=>t.style.setProperty("--tl-zoom",i.toString()),s=$a(e,100),r=new nn("useZoomCss",()=>{n.getCurrentPageShapeIds().size<300?e(n.getZoomLevel()):s(n.getZoomLevel())});return r.attach(),r.execute(),()=>{r.detach()}},[n,t])}const Tp=[],kp=[],Ef=M.memo(function({store:t,components:e,className:s,user:r,...i}){const[o,a]=ht.useState(null),c=M.useMemo(()=>r??Go(),[r]),l=(e==null?void 0:e.ErrorFallback)===void 0?No:e==null?void 0:e.ErrorFallback,d={...i,shapeUtils:i.shapeUtils??Tp,tools:i.tools??kp,components:e};return S.jsx("div",{ref:a,draggable:!1,className:ve("tl-container tl-theme__light",s),onPointerDown:bs,tabIndex:-1,children:S.jsx(Tn,{fallback:l,onError:h=>hr(h,{tags:{origin:"react.tldraw-before-app"}}),children:o&&S.jsx(Pd,{container:o,children:S.jsx(jh,{overrides:e,children:t?t instanceof ao?S.jsx(aa,{...d,store:t,user:c}):S.jsx(oa,{...d,store:t,user:c}):S.jsx(Mp,{...d,store:t,user:c})})})})})});function Mp(n){const{defaultName:t,snapshot:e,initialData:s,shapeUtils:r,persistenceKey:i,sessionId:o,user:a}=n,c=Cp({shapeUtils:r,initialData:s,persistenceKey:i,sessionId:o,defaultName:t,snapshot:e});return S.jsx(oa,{...n,store:c,user:a})}const oa=M.memo(function({store:t,user:e,...s}){const r=It();M.useLayoutEffect(()=>{e.userPreferences.get().isDarkMode&&(r.classList.remove("tl-theme__light"),r.classList.add("tl-theme__dark"))},[r,e]);const{LoadingScreen:i}=re();switch(t.status){case"error":throw t.error;case"loading":return i?S.jsx(i,{}):null}return S.jsx(aa,{...s,store:t.store,user:e})});function aa({onMount:n,children:t,store:e,tools:s,shapeUtils:r,user:i,initialState:o,autoFocus:a=!0,inferDarkMode:c}){const{ErrorFallback:l}=re(),d=It(),[h,p]=M.useState(null);M.useLayoutEffect(()=>{const g=new D({store:e,shapeUtils:r,tools:s,getContainer:()=>d,user:i,initialState:o,inferDarkMode:c});return p(g),()=>{g.dispose()}},[d,r,s,e,i,o,c]);const f=M.useSyncExternalStore(M.useCallback(g=>h?(h.on("crash",g),()=>h.off("crash",g)):()=>{},[h]),()=>(h==null?void 0:h.getCrashingError())??null),{Canvas:y}=re();return h?S.jsx(Tn,{fallback:l,onError:g=>h.annotateError(g,{origin:"react.tldraw",willCrashApp:!0}),children:f?S.jsx(Rp,{crashingError:f}):S.jsx(xs.Provider,{value:h,children:S.jsx(Ap,{autoFocus:a,onMount:n,children:t??(y?S.jsx(y,{}):null)})})}):null}function Ap({children:n,onMount:t,autoFocus:e}){return Ep(),Qu(),Ju(),_p(),np(),tp(e),Dp(t),S.jsx(S.Fragment,{children:n})}function Rp({crashingError:n}){throw n}function Tf({children:n}){return S.jsx("div",{className:"tl-loading",children:n})}function kf({children:n}){return S.jsx("div",{className:"tl-loading",children:n})}function Dp(n){const t=N(),e=ep(s=>{const r=n==null?void 0:n(s);return s.emit("mount"),window.tldrawReady=!0,r});ht.useLayoutEffect(()=>{if(t)return e==null?void 0:e(t)},[t,e])}function Mf({children:n,className:t="",...e}){return S.jsx("div",{...e,className:ve("tl-html-container",t),children:n})}function Op(n,t,e={}){const{newPoint:s,handle:r,scaleX:i,scaleY:o}=t,{minWidth:a=1,maxWidth:c=1/0,minHeight:l=1,maxHeight:d=1/0}=e;let h=n.props.w*i,p=n.props.h*o;const f=new m(0,0);if(h>0){if(h<a){switch(r){case"top_left":case"left":case"bottom_left":{f.x=h-a;break}case"top":case"bottom":{f.x=(h-a)/2;break}default:f.x=0}h=a}}else if(f.x=h,h=-h,h<a){switch(r){case"top_left":case"left":case"bottom_left":{f.x=-h;break}default:f.x=-a}h=a}if(p>0){if(p<l){switch(r){case"top_left":case"top":case"top_right":{f.y=p-l;break}case"right":case"left":{f.y=(p-l)/2;break}default:f.y=0}p=l}}else if(f.y=p,p=-p,p<l){switch(r){case"top_left":case"top":case"top_right":{f.y=-p;break}default:f.y=-l}p=l}const{x:y,y:g}=f.rot(n.rotation).add(s);return{x:y,y:g,props:{w:Math.min(c,h),h:Math.min(d,p)}}}class Af extends In{constructor(){super(...arguments);u(this,"onResize",(e,s)=>Op(e,s))}getGeometry(e){return new Wo({width:e.props.w,height:e.props.h,isFilled:!0})}getHandleSnapGeometry(e){return{points:this.getGeometry(e).bounds.cornersAndCenter}}}class ca extends Ot{constructor(){super(...arguments);u(this,"onPointerDown",e=>{this.parent.transition("pointing",e)});u(this,"onEnter",()=>{this.editor.setCursor({type:"cross",rotation:0})});u(this,"onCancel",()=>{this.editor.setCurrentTool("select")})}}u(ca,"id","idle");class la extends Ot{constructor(){super(...arguments);u(this,"markId","");u(this,"wasFocusedOnEnter",!1);u(this,"onEnter",()=>{this.wasFocusedOnEnter=!this.editor.getIsMenuOpen()});u(this,"onPointerMove",e=>{if(this.editor.inputs.isDragging){const{originPagePoint:s}=this.editor.inputs,r=this.parent.shapeType,i=Zt();this.markId=`creating:${i}`,this.editor.mark(this.markId),this.editor.createShapes([{id:i,type:r,x:s.x,y:s.y,props:{w:1,h:1}}]).select(i),this.editor.setCurrentTool("select.resizing",{...e,target:"selection",handle:"bottom_right",isCreating:!0,creationCursorOffset:{x:1,y:1},onInteractionEnd:this.parent.id,onCreate:this.parent.onCreate})}});u(this,"onPointerUp",()=>{this.complete()});u(this,"onCancel",()=>{this.cancel()});u(this,"onComplete",()=>{this.complete()});u(this,"onInterrupt",()=>{this.cancel()})}complete(){const{originPagePoint:e}=this.editor.inputs;if(!this.wasFocusedOnEnter)return;this.editor.mark(this.markId);const s=this.parent.shapeType,r=Zt();this.editor.mark(this.markId),this.editor.createShapes([{id:r,type:s,x:e.x,y:e.y}]);const i=this.editor.getShape(r),{w:o,h:a}=this.editor.getShapeUtil(i).getDefaultProps(),c=new m(o/2,a/2),l=this.editor.getShapeParentTransform(i);l&&c.rot(-l.rotation()),this.editor.updateShapes([{id:r,type:s,x:i.x-c.x,y:i.y-c.y}]),this.editor.setSelectedShapes([r]),this.editor.getInstanceState().isToolLocked?this.parent.transition("idle"):this.editor.setCurrentTool("select.idle")}cancel(){this.parent.transition("idle")}}u(la,"id","pointing");class Ws extends Ot{constructor(){super(...arguments);u(this,"onCreate")}}u(Ws,"id","box"),u(Ws,"initial","idle"),u(Ws,"children",()=>[ca,la]);function Rf(n){const t=N();return z("isEditing",()=>t.getEditingShapeId()===n,[t,n])}function Df(){return M.useId().replace(/:/g,"_")}function Of(n){const t=N();return M.useMemo(function(){const r=l=>{if(l.isKilled)return;if(l.button===2){t.dispatch({type:"pointer",target:"selection",handle:n,name:"right_click",...qe(l)});return}if(l.button!==0)return;const d=is(l.currentTarget);function h(){d.removeEventListener("pointerup",h),Cr(d,l)}vr(d,l),d.addEventListener("pointerup",h),t.dispatch({name:"pointer_down",type:"pointer",target:"selection",handle:n,...qe(l)}),bs(l)};let i,o;function a(l){l.isKilled||l.button===0&&(l.clientX===i&&l.clientY===o||(i=l.clientX,o=l.clientY,t.dispatch({name:"pointer_move",type:"pointer",target:"selection",handle:n,...qe(l)})))}return{onPointerDown:r,onPointerMove:a,onPointerUp:l=>{l.isKilled||l.button===0&&t.dispatch({name:"pointer_up",type:"pointer",target:"selection",handle:n,...qe(l)})}}},[t,n])}const jp=20,Fp=8;function jr(n,t=jp){return Math.max(Fp,Math.ceil(n/t))}class jf extends Lt{constructor(e){super({...e,isFilled:!1,isClosed:!1});u(this,"_center");u(this,"radius");u(this,"start");u(this,"end");u(this,"measure");u(this,"length");u(this,"angleStart");u(this,"angleEnd");const{center:s,radius:r,sweepFlag:i,largeArcFlag:o,start:a,end:c}=e;if(a.equals(c))throw Error("Arc must have different start and end points.");this.angleStart=m.Angle(s,a),this.angleEnd=m.Angle(s,c),this.measure=Ql(this.angleStart,this.angleEnd,i,o),this.length=this.measure*r,this.start=a,this.end=c,this._center=s,this.radius=r}nearestPoint(e){const{_center:s,measure:r,radius:i,angleEnd:o,angleStart:a,start:c,end:l}=this,d=li(r,a,o,s.angle(e));if(d<=0)return c;if(d>=1)return l;const h=s.clone().add(e.clone().sub(s).uni().mul(i));let p,f=1/0,y;for(const g of[c,l,h])y=m.Dist2(e,g),y<f&&(p=g,f=y);if(!p)throw Error("nearest point not found");return p}hitTestLineSegment(e,s){const{_center:r,radius:i,measure:o,angleStart:a,angleEnd:c}=this,l=Ps(e,s,r,i);return l===null?!1:l.some(d=>{const h=li(o,a,c,r.angle(d));return h>=0&&h<=1})}getVertices(){const{_center:e,measure:s,length:r,radius:i,angleStart:o}=this,a=[];for(let c=0,l=jr(Math.abs(r));c<l+1;c++){const d=c/l*s,h=o+d;a.push(To(e,i,h))}return a}}class Ff extends Lt{constructor(e){super({isClosed:!0,...e});u(this,"_center");u(this,"radius");u(this,"x");u(this,"y");this.config=e;const{x:s=0,y:r=0,radius:i}=e;this.x=s,this.y=r,this._center=new m(i+s,i+r),this.radius=i}getBounds(){return new $(this.x,this.y,this.radius*2,this.radius*2)}getVertices(){const{_center:e,radius:s}=this,r=ee*s,i=[];for(let o=0,a=jr(r);o<a;o++){const c=o/a*ee;i.push(To(e,s,c))}return i}nearestPoint(e){const{_center:s,radius:r}=this;return s.equals(e)?m.AddXY(s,r,0):s.clone().add(e.clone().sub(s).uni().mul(r))}hitTestLineSegment(e,s,r=0){const{_center:i,radius:o}=this;return Ps(e,s,i,o+r)!==null}}class Lp extends Mr{constructor(e){const{start:s,cp1:r,cp2:i,end:o}=e;super({...e,points:[s,o]});u(this,"a");u(this,"b");u(this,"c");u(this,"d");this.a=s,this.b=r,this.c=i,this.d=o}getVertices(){const e=[],{a:s,b:r,c:i,d:o}=this;for(let a=0,c=10;a<=c;a++){const l=a/c;e.push(new m((1-l)*(1-l)*(1-l)*s.x+3*((1-l)*(1-l))*l*r.x+3*(1-l)*(l*l)*i.x+l*l*l*o.x,(1-l)*(1-l)*(1-l)*s.y+3*((1-l)*(1-l))*l*r.y+3*(1-l)*(l*l)*i.y+l*l*l*o.y))}return e}midPoint(){return Bp(this,.5)}nearestPoint(e){let s,r=1/0,i,o;for(const a of this.segments)o=a.nearestPoint(e),i=m.Dist2(o,e),i<r&&(s=o,r=i);if(!s)throw Error("nearest point not found");return s}}function Bp(n,t){const{a:e,b:s,c:r,d:i}=n;return new m((1-t)*(1-t)*(1-t)*e.x+3*((1-t)*(1-t))*t*s.x+3*(1-t)*(t*t)*r.x+t*t*t*i.x,(1-t)*(1-t)*(1-t)*e.y+3*((1-t)*(1-t))*t*s.y+3*(1-t)*(t*t)*r.y+t*t*t*i.y)}class Lf extends Lt{constructor(e){super({...e,isClosed:!1,isFilled:!1});u(this,"points");u(this,"_segments");u(this,"_length");const{points:s}=e;this.points=s}get segments(){if(!this._segments){this._segments=[];const{points:e}=this,s=e.length,r=s-2,i=1.25;for(let o=0;o<s-1;o++){const a=o===0?e[0]:e[o-1],c=e[o],l=e[o+1],d=o===r?l:e[o+2],h=c,p=o===0?a:new m(c.x+(l.x-a.x)/6*i,c.y+(l.y-a.y)/6*i),f=o===r?l:new m(l.x-(d.x-c.x)/6*i,l.y-(d.y-c.y)/6*i),y=l;this._segments.push(new Lp({start:h,cp1:p,cp2:f,end:y}))}}return this._segments}get length(){return this._length||(this._length=this.segments.reduce((e,s)=>e+s.length,0)),this._length}getVertices(){const e=this.segments.reduce((s,r)=>s.concat(r.vertices),[]);return e.push(this.points[this.points.length-1]),e}nearestPoint(e){let s,r=1/0,i,o;for(const a of this.segments)o=a.nearestPoint(e),i=m.Dist2(o,e),i<r&&(s=o,r=i);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,s){return this.segments.some(r=>r.hitTestLineSegment(e,s))}}class zp extends Lt{constructor(e){super({...e,isClosed:!0});u(this,"w");u(this,"h");u(this,"_edges");this.config=e;const{width:s,height:r}=e;this.w=s,this.h=r}get edges(){if(!this._edges){const{vertices:e}=this;this._edges=[];for(let s=0,r=e.length;s<r;s++){const i=e[s],o=e[(s+1)%r];this._edges.push(new cr({start:i,end:o}))}}return this._edges}getVertices(){const e=Math.max(1,this.w),s=Math.max(1,this.h),r=e/2,i=s/2,o=Math.pow(r-i,2)/Math.pow(r+i,2),a=ue*(r+i)*(1+3*o/(10+Math.sqrt(4-3*o))),c=jr(a),l=ee/c,d=Math.cos(l),h=Math.sin(l);let p=0,f=1,y=0,g=1;const x=Array(c);for(let w=0;w<c;w++)x[w]=new m(r+r*f,i+i*p),y=h*f+d*p,g=d*f-h*p,p=y,f=g;return x}nearestPoint(e){let s,r=1/0,i,o;for(const a of this.edges)o=a.nearestPoint(e),i=m.Dist2(o,e),i<r&&(s=o,r=i);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,s){return this.edges.some(r=>r.hitTestLineSegment(e,s))}getBounds(){return new $(0,0,this.w,this.h)}}const at=18;class Bf extends zp{constructor(t){super({...t}),this.config=t}getVertices(){const t=Math.max(1,this.w),e=Math.max(1,this.h),s=t/2,r=e/2,i=Array(at);let o,a;if(e>t)for(let c=0;c<at-1;c++)o=-ue+ue*c/(at-2),a=ue*c/(at-2),i[c]=new m(s+s*Math.cos(o),s+s*Math.sin(o)),i[c+(at-1)]=new m(s+s*Math.cos(a),e-s+s*Math.sin(a));else for(let c=0;c<at-1;c++)o=-kn+ue*c/(at-2),a=kn+ue*-c/(at-2),i[c]=new m(t-r+r*Math.cos(o),e-r+r*Math.sin(o)),i[c+(at-1)]=new m(r-r*Math.cos(a),e-r+r*Math.sin(a));return i}}function Li(n,t,e,s,r){const i=fd,o=e?gd:0,a=n-o,c=n+o,l=s?0:i,d=r?t:t-i;return a<l?Math.min(1,(l-a)/i):c>d?-Math.min(1,(c-d)/i):0}function zf(n){if(!n.inputs.isDragging||n.inputs.isPanning||!n.getInstanceState().canMoveCamera)return;const{inputs:{currentScreenPoint:{x:t,y:e}}}=n,s=n.getZoomLevel(),r=n.getViewportScreenBounds(),i=r.w<1e3?.612:1,o=r.h<1e3?.612:1,{isCoarsePointer:a,insets:[c,l,d,h]}=n.getInstanceState(),p=Li(t,r.w,a,h,l),f=Li(e,r.h,a,c,d);if(p===0&&f===0)return;const y=n.user.getEdgeScrollSpeed()*pd,g=y*p*i/s,x=y*f*o/s,w=n.getCamera();n.setCamera({x:w.x+g,y:w.y+x})}async function Np({shouldReload:n=!0}={}){qa(),await Promise.all(Or().map(t=>Ia(t))),Ga(),n&&window.location.reload()}typeof window<"u"&&(window.__tldraw__hardReset=Np);function Nf(n,t="_blank"){_r.openWindow(n,t)}export{Ff as $,el as A,Ws as B,Cf as C,Ph as D,ss as E,nf as F,Il as G,_f as H,Jl as I,tf as J,ud as K,yu as L,Sn as M,hi as N,ol as O,ta as P,pf as Q,Ss as R,Ot as S,Yt as T,Ge as U,m as V,ei as W,rs as X,To as Y,Zh as Z,qo as _,z as a,Bl as a$,bf as a0,cr as a1,jf as a2,bi as a3,vf as a4,ue as a5,kn as a6,fe as a7,bs as a8,qe as a9,rr as aA,wl as aB,bl as aC,Op as aD,ws as aE,ee as aF,mf as aG,Pl as aH,vl as aI,Bf as aJ,zp as aK,xf as aL,us as aM,Cl as aN,_l as aO,Tl as aP,kl as aQ,Rl as aR,Dl as aS,Js as aT,nu as aU,Ds as aV,Lf as aW,ii as aX,Ol as aY,jl as aZ,Fl as a_,In as aa,ll as ab,dl as ac,Wo as ad,Is as ae,kt as af,Gi as ag,Ve as ah,Wh as ai,Rf as aj,$a as ak,Af as al,hl as am,ul as an,Mf as ao,tt as ap,Ut as aq,$t as ar,gf as as,pl as at,gl as au,Mr as av,of as aw,Sl as ax,xl as ay,ff as az,hs as b,zl as b0,Nl as b1,Ns as b2,zf as b3,He as b4,li as b5,Vl as b6,lu as b7,du as b8,zs as b9,_i as bA,ys as bB,Ir as bC,Ft as bD,cl as bE,al as bF,Ml as bG,Pr as bH,Io as bI,ef as bJ,Df as bK,ep as bL,Oh as bM,Pf as bN,kf as bO,Tf as bP,Ef as bQ,vp as bR,D as bS,q as bT,hc as bU,df as bV,Re as bW,K as bX,ye as bY,uf as bZ,hf as b_,Sf as ba,De as bb,En as bc,ls as bd,It as be,Hd as bf,af as bg,lf as bh,Ud as bi,dt as bj,Nf as bk,jt as bl,_o as bm,re as bn,Fh as bo,If as bp,Rt as bq,Te as br,T as bs,vr as bt,kd as bu,Cr as bv,Ji as bw,eo as bx,cf as by,di as bz,Of as c,An as d,Zu as e,Gt as f,Ih as g,yl as h,ke as i,rf as j,sf as k,Zt as l,G as m,Ee as n,Jp as o,F as p,wf as q,ar as r,he as s,ce as t,N as u,yf as v,$ as w,ze as x,zt as y,Dt as z};
